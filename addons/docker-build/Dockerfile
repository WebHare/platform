# syntax=docker/dockerfile:experimental
# https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md

# See https://github.com/phusion/baseimage-docker
FROM       phusion/baseimage:0.11
MAINTAINER WebHare bv <info@webhare.com>

# Environment variables
ENV WEBHARE_IN_DOCKER=1 \
  WEBHARE_UBUNTU=1804 \
  WEBHARE_DATAROOT=/opt/whdata \
  WEBHARE_BUILDDIR=/opt/whbuild/ \
  WEBHARE_DIR=/opt/wh/whtree \
  WEBHARE_CHECKEDOUT_TO=/opt/wh \
  WEBHARE_COMPILECACHE=/opt/wh/whtree/currentinstall/compilecache/ \
  WEBHARE_BABELCACHE=/opt/wh/whtree/currentinstall/babelcache/ \
  WEBHARE_MODULEPATHS=/opt/whmodules \
  WEBHARE_SECUREPORT_BINDIP=0.0.0.0 \
  DEBIAN_FRONTEND=noninteractive \
  APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 \
  PATH=/opt/wh/whtree/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/mssql-tools/bin

# Expose usual WebHare hostingports
EXPOSE 80 443 8000 8443 13684

# Set the run command
CMD [ "/opt/container/launch.sh" ]

# We no longer mark /opt/whdata as a volume so we can do our sanity check whether it really lives on a persistent volume
# VOLUME /opt/whdata

# Build up a clean OS addition layer
# Remove the waiting time generated by the embedded SSH key.
# For easier debugging: strace telnet iproute lsof tcpdump
# For envsubst: gettext-base
# Packages not needed for building: curl strace wget
# TODO - createrepo can go if we don't need WH1 to build repositories anymore
# TODO - remove certbot as soon as we can build a WH1 specific install
# openssh-server: needed for sftp server for sshfs mounts
# sshfs: needed to mount backups in the docker (mounting from outside is slow on mac)
# stunnel: some modules use it for connectivity. must be a stunnel version with PSK support
# liberation-fonts: fonts that look like Arial, Times New Roman, Courier New

# Remove /etc/java-8-openjdk/accessibility.properties to fix PDFBOX. see https://askubuntu.com/questions/695560/assistive-technology-not-found-error-while-building-aprof-plot

# Add the postgres user before installing the postgresql packages
RUN \
  useradd --system --uid 20003 --user-group postgres

# Chrome headless sometimes crashes if fonts are missing. Not sure why, but see https://bugs.chromium.org/p/chromium/issues/detail?id=695212
# Note that in the end, this still didn't seem to fix it, so perhaps fonts-open-sans can go away again
RUN \
  rm /etc/my_init.d/00_regen_ssh_host_keys.sh \
  && ( curl -sL https://deb.nodesource.com/setup_12.x | bash - ) \
  && apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8 \
  && apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 7FCC7D46ACCC4CF8 \
  && add-apt-repository 'deb [arch=amd64,i386,ppc64el] http://mariadb.mirror.triple-it.nl/repo/10.2/ubuntu xenial main' \
  && add-apt-repository 'deb http://apt.postgresql.org/pub/repos/apt/ bionic-pgdg main' \
  && ( curl -sL https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - ) \
  && ( curl -sL https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add ) \
  && ( echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list ) \
  && apt -q update \
  && install_clean \
    ccache \
    fontconfig \
    fonts-open-sans \
    letsencrypt \
    libfreetype6 \
    libfreetype6-dev \
    g++ \
    gettext-base \
    libgif-dev \
    git \
    google-chrome-stable \
    inotify-tools \
    openjdk-8-jre-headless \
    fonts-liberation \
    lftp \
    libmaxminddb-dev \
    libgit2-dev \
    libicu-dev \
    libjpeg-turbo8 \
    libjpeg-turbo8-dev \
    libpng16-16 \
    libpng-dev \
    libpq-dev \
    libssl-dev \
    libtiff-dev \
    libxml2-dev \
    make \
    nodejs \
    openssh-server \
    openssl \
    libpixman-1-dev \
    postgresql-11 \
    postgresql-client-11 \
    procps \
    python \
    rsync \
    samba-client \
    software-properties-common \
    sshfs \
    stunnel4 \
    tar \
    unixodbc-dev \
    unzip \
    valgrind && \
  rm /etc/java-8-openjdk/accessibility.properties && \
  ln -sf /usr/share/zoneinfo/Europe/Amsterdam /etc/localtime && \
  mkdir -p /opt/wh/whtree /opt/whdata /opt/whmodules /opt/wh/whtree/currentinstall/compilecache /opt/wh/whtree/currentinstall/babelcache && \
  ln -s /opt/whdata/dbase /opt/wh/whtree/dbase && \
  ln -s /opt/whdata/log /opt/wh/whtree/log && \
  ln -s /opt/whdata/output /opt/wh/whtree/output && \
  ln -s /opt/whdata/tmp /opt/wh/whtree/tmp && \
  ln -s /opt/whdata /opt/wh/whtree/var && \
  ln -s /opt/wh/whtree /opt/webhare && \
  certbot --version  # Updated 2019-10-02 (update this timestamp to pull in new dependencies)

# Install pdfapp
COPY pdfbox-app-2.0.11.jar /opt/wh/whtree/modules/system/data/engines/pdfbox-app.jar

# Get mariaodbc connector https://downloads.mariadb.com/Connectors/odbc/connector-odbc-2.0.15/
RUN curl https://downloads.mariadb.com/Connectors/odbc/connector-odbc-3.0.3/mariadb-connector-odbc-3.0.3-ga-debian-x86_64.tar.gz | tar -zxv -C /usr/local --strip-components 1 && \
     ( ( echo "[MariaDB]" ; echo "Driver = /usr/local/lib/libmaodbc.so"; echo "Description = MariaDB ODBC Connector"; echo ) >> /etc/odbcinst.ini )

# Install the microsoft odbc client - https://docs.microsoft.com/en-us/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server?view=sql-server-2017
# We cannot add this to the open source version, as it requires EULA acceptance
ARG WHBUILD_ODBC_SQLSERVER
RUN if [ -n "$WHBUILD_ODBC_SQLSERVER" ]; then \
      ( curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - ) && \
      ( curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list > /etc/apt/sources.list.d/mssql-release.list ) && \
      ACCEPT_EULA=Y install_clean msodbcsql17 mssql-tools ; \
    fi

# Install instantclient. We currently expect instantclient-linux_x86_64_10.2.0.3_20070103.zip
# We cannot add this to the open source version, as it requires EULA acceptance
ARG WHBUILD_INSTANTCLIENT_URL
RUN if [ -n "$WHBUILD_INSTANTCLIENT_URL" ]; then \
      cd /tmp && \
      curl -o instantclient.zip $WHBUILD_INSTANTCLIENT_URL && \
      unzip instantclient.zip && \
      cd instantclient-linux_x86_64*/ && \
      for P in *; do unzip $P; done && \
      cd */ && \
      cp -f libsqlplusic.* libociicus.* libclntsh.* libnnz*.* libsqlplus.* /usr/lib/ && \
      cp -f sqlplus /usr/bin/ && \
      cp -rf sdk/include/* /usr/include/ && \
      cd /usr/lib && \
      ln -sf libclntsh.so.10.1 libclntsh.so && \
      rm -rf /tmp/instantclient* ; \
    fi

# Install elasticsearch
COPY elasticsearch-oss-7.3.0-linux-x86_64.tar.gz /tmp/
RUN mkdir /opt/elasticsearch && \
    tar zx -C /opt/elasticsearch --strip-components=1 -f /tmp/elasticsearch-oss*.tar.gz && \
    useradd --system --uid 20002 --user-group elasticsearch && \
    chown -R elasticsearch /opt/elasticsearch && \
    runuser --user elasticsearch --group elasticsearch -- /opt/elasticsearch/bin/elasticsearch --version

# Add packaging stuff
COPY whtree-npm/ /opt/wh/whtree/

# Let's do the NPM work first, for better caching
# RUN cd /opt/wh/whtree && npm install --no-save && npm prune && npm dedupe && npm cache clear --force && rm -rf ~/.ccache /tmp/*
RUN --mount=type=tmpfs,target=/tmp/,readwrite --mount=type=tmpfs,target=/root/,readwrite --mount=type=cache,target=/tmp/npmcache \
   cd /opt/wh/whtree && \
   npm_config_cache=/tmp/npmcache npm install --no-save

# Add base source code and stuff needed to compile it
COPY tocompile/ /opt/wh/

# Build those parts.
RUN --mount=type=tmpfs,target=/opt/whbuild,readwrite --mount=type=tmpfs,target=/tmp,readwrite --mount=type=cache,target=/tmp/ccache \
    CCACHE_DIR=/tmp/ccache WHBUILD_NODEPS=1 WHBUILD_ALLOW=1 /opt/wh/whtree/bin/wh make install && \
    rm -fr /opt/wh/{README.md,addons,ap,base_makefile,blex,drawlib,harescript,parsers}

# Add geoip databases TODO: ensure redownload once a month "The GeoLite2 Country and City databases are updated on the first Tuesday of each month"
RUN /opt/wh/ap/tools/downloadshippedgeoip.sh

# Throw in the whtree and addons - note: builds will always stop caching after this step
COPY whtree /opt/wh/whtree

# Prepare the filsystem
RUN /opt/wh/whtree/modules/system/scripts/internal/fixup_image.sh

# Postinstall fixups
RUN --mount=type=tmpfs,target=/opt/whdata,readwrite /opt/wh/whtree/modules/system/scripts/internal/fixup_modules.sh

# Add other dropins
ADD dropins /

# Create the shrinkwrap
RUN --mount=type=tmpfs,target=/opt/whdata,readwrite /opt/wh/whtree/modules/system/scripts/internal/create_shrinkwrap.sh

# Add a label with the commit SHA, which we can retrieve from docker registry when checking if an image is newer
# Add a label describing the builder, so we have this information ready when inspecting images
ARG CI_COMMIT_SHA
ARG CI_PIPELINE_ID
ARG BUILDERTAG
LABEL com.webhare.webhare.git-commit-sha="$CI_COMMIT_SHA" \
      com.webhare.webhare.pipelineid="$CI_PIPELINE_ID" \
      com.webhare.webhare.buildertag="$BUILDERTAG" \
