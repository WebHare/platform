# We can't mark this script as executable as it shouldn't be run on a build host

# Updated 2019-10-02 (update this timestamp if nothing else to pull in new dependencies)

# Set up the image - the inital 'base' step that pulls in all the rarely changing Ubuntu packages

# Build up a clean OS addition layer
# Remove the waiting time generated by the embedded SSH key.
# For easier debugging: strace telnet iproute lsof tcpdump
# For envsubst: gettext-base
# Packages not needed for building: curl strace wget
# TODO - createrepo can go if we don't need WH1 to build repositories anymore
# openssh-server: needed for sftp server for sshfs mounts
# sshfs: needed to mount backups in the docker (mounting from outside is slow on mac)
# stunnel: some modules use it for connectivity. must be a stunnel version with PSK support
# liberation-fonts: fonts that look like Arial, Times New Roman, Courier New


# Add the postgres user before installing the postgresql packages
useradd --system --uid 20003 --user-group postgres

# From https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md#example-cache-apt-packages
rm -f /etc/apt/apt.conf.d/docker-clean
echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache

# Chrome headless sometimes crashes if fonts are missing. Not sure why, but see https://bugs.chromium.org/p/chromium/issues/detail?id=695212
# Note that in the end, this still didn't seem to fix it, so perhaps fonts-open-sans can go away again
rm /etc/my_init.d/00_regen_ssh_host_keys.sh
( curl -sL https://deb.nodesource.com/setup_12.x | bash - )
apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 7FCC7D46ACCC4CF8
add-apt-repository 'deb [arch=amd64,i386,ppc64el] http://mariadb.mirror.triple-it.nl/repo/10.2/ubuntu xenial main'
add-apt-repository 'deb http://apt.postgresql.org/pub/repos/apt/ bionic-pgdg main'
( curl -sL https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - )
( curl -sL https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add )
( echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list )

# Group for WebHare's data directory. Not fully used yet, but keeps chrome out of it
groupadd --gid 20000 whdata

# User and group for Chrome. We really want to keep a browser far away from our data
groupadd --gid 20001 chrome
useradd --create-home --uid 20001 --gid 20001 --shell /bin/false chrome

# User and group for Elasticsearch. already created in dockerfile, we just need to make sure elasticsearch can access its data folder
# ES has 20002
adduser elasticsearch whdata

# User and group for postgres. already created in dockerfile, we just need to make sure postgresql can access its data folder
# postgres has 20003
adduser postgres whdata

PACKAGES="ccache
    fontconfig
    fonts-open-sans
    letsencrypt
    libfreetype6
    libfreetype6-dev
    g++
    gettext-base
    libgif-dev
    git
    google-chrome-stable
    inotify-tools
    openjdk-8-jre-headless
    fonts-liberation
    lftp
    libmaxminddb-dev
    libgit2-dev
    libicu-dev
    libjpeg-turbo8
    libjpeg-turbo8-dev
    libpng16-16
    libpng-dev
    libpq-dev
    libssl-dev
    libtiff-dev
    libxml2-dev
    make
    nodejs
    openssh-server
    openssl
    libpixman-1-dev
    postgresql-11
    postgresql-client-11
    procps
    python
    rsync
    samba-client
    software-properties-common
    sshfs
    stunnel4
    tar
    unixodbc-dev
    unzip
    valgrind"

if ! ( apt-get -q update && apt-get -qy install --no-install-recommends $PACKAGES && apt-get -qy autoremove ); then
  echo "APT-GET failed"
  exit 1
fi

# Remove /etc/java-8-openjdk/accessibility.properties to fix PDFBOX. see https://askubuntu.com/questions/695560/assistive-technology-not-found-error-while-building-aprof-plot
rm /etc/java-8-openjdk/accessibility.properties

ln -sf /usr/share/zoneinfo/Europe/Amsterdam /etc/localtime
mkdir -p /opt/wh/whtree /opt/whdata /opt/whmodules /opt/wh/whtree/currentinstall/compilecache /opt/wh/whtree/currentinstall/babelcache
ln -s /opt/whdata/dbase /opt/wh/whtree/dbase
ln -s /opt/whdata/log /opt/wh/whtree/log
ln -s /opt/whdata/output /opt/wh/whtree/output
ln -s /opt/whdata/tmp /opt/wh/whtree/tmp
ln -s /opt/whdata /opt/wh/whtree/var
ln -s /opt/wh/whtree /opt/webhare

# TODO - remove certbot as soon as we have fully integrated it and WH1 no longer needs to host it
if ! certbot --version; then
  echo "Certbot failed!"
  exit 1
fi
