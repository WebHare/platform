<?wh
/* Test dealing with an assetpackmgr if compilation breaks */

LOADLIB "wh::files.whlib";

LOADLIB "mod::publisher/lib/control.whlib";
LOADLIB "mod::publisher/lib/testframework.whlib";

LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/services.whlib";

MACRO TestCrashJson()
{
  testfw->BeginWork();
  OBJECT siteroot := testfw->GetTestSite()->rootobject;
  OBJECT dynfolder := siteroot->CreateFolder( [ name:="dynfolder"
                                              , typens := "http://www.webhare.net/xmlns/webhare_testsuite/webdesign-dynfolder"
                                              ]);
  dynfolder->CreateFile([name := "index.shtml", typens := "http://www.webhare.net/xmlns/publisher/dynamicfoldercontents", publish := TRUE ]);
  testfw->CommitWork();
  WaitForPublishCompletion(siteroot->id);

  testfw->FlushTasks([ "webhare_testsuite:aftercompile" ]);
  TestEq(TRUE, ReadRegistryKey("webhare_testsuite.tests.lastaftercompile") > testfw->starttime, "aftercompile task was NOT invoked");

  TestEq(TRUE, testfw->browser->GotoWebPage(siteroot->objecturl || "dynfolder/"), testfw->browser->href);

  OBJECT assetpackcontrol := WaitForPromise(OpenWebHareService("publisher:assetpackcontrol"));
  RECORD extracted := ExtractBundleOutputTag(testfw->browser->document);
  WaitForPromise(assetpackcontrol->RecompileBundle(extracted.outputtag)); //don't want to wait for fswatch to pick it up
  WaitForPromise(assetpackcontrol->WaitForCompile(extracted.outputtag, FALSE));
  RECORD status := WaitForPromise(assetpackcontrol->GetBundleStatus(extracted.outputtag));

// Module not found: Error: Cannot resolve 'file' or 'directory' /opt/whdata/installedmodules/webhare_testsuite_tests/webhare_testsuite_temp/webdesigns/testdesign/js/testdesign in /opt/whdata/tmp
  //print( GetModuleinstallationroot("webhare_testsuite_temp") || "webdesigns/testdesign\n" );
  //DumpValue(ReadDiskDirectory( GetModuleinstallationroot("webhare_testsuite_temp") || "webdesigns/testdesign", "*"),'boxed');
  //DumpValue(ReadDiskDirectory( GetModuleinstallationroot("webhare_testsuite_temp") || "webdesigns/testdesign/js", "*"),'boxed');
  TestEq(FALSE, status.haserrors, "Could not compile valid bundle " || extracted.outputtag || "\n" || status.stats);

  //Now kill the package.json
  StoreDiskFile(GetModuleinstallationroot("webhare_testsuite_temp") || "webdesigns/testdesign/package.json", StringToBlob("This is not a JSON file"), [ overwrite := TRUE ]);
  WaitForPromise(assetpackcontrol->RecompileBundle(extracted.outputtag)); //don't want to wait for fswatch to pick it up
  WaitForPromise(assetpackcontrol->WaitForCompile(extracted.outputtag, FALSE));

  status := WaitForPromise(assetpackcontrol->GetBundleStatus(extracted.outputtag));
  TestEqLike("Package.json*not valid JSON", status.errors, "Wrong errors for bundle " || extracted.outputtag);
}

RunTestframework([ PTR PrepareTestModuleWebDesignWebsite("publisher:blank", [istemplate := TRUE, withcontent := FALSE ])
                 , PTR EnsureValidTestModuleWebDesignWebsiteBUndle
                 , PTR TestCrashJson
                 ]);
