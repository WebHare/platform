<?wh

LOADLIB "wh::datetime.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::internet/urls.whlib";

LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::wrd/lib/internal/auth/saml.whlib";


MACRO TestSAMLSigning()
{
  /** RSA 2048 bit private key
      Generated with
          OBJECT evpkey := GenerateCryptoKey("RSA", 2048);
          STRING privatekey := evpkey->privatekey;
  */
  STRING privatekey :=
      '-----BEGIN PRIVATE KEY-----\n' ||
      'MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDkT6t/6YbvtVcl\n' ||
      'xL8AfjrArFXCURrPvZpyI5BhRlQnGxCNl7E6QTEPRibycPoHNoTen51zENI0mxA5\n' ||
      'hSRz8xwwL4ISYyaKC9LzM80Xq0dqteJuxr5a1AGDbNu+1eu0miPUBCVA7uJYMe/7\n' ||
      'aX5ne94Y8lj9y6JewBZvJQVbk8yBluAZLebaToytRO/cFKpcqRDq1vaIgf9xQjdj\n' ||
      'OeJYx/RYkQVZiC2FHltfvSFTx2OByI0Ou0JMPseVkKwmb5wTg3kQl9m4B7hEzlvc\n' ||
      'u/zCmGncvFSvB7/HI6yLH4nBommbUms4Fuodfj+UkGNQDLZuGgDzpg2YXiwh7Zdt\n' ||
      'tcOuB46NAgMBAAECggEAP4kkUt5sHL08WVhdRwfZ1dCftQnZCkLbfjQDc+6ccJ2J\n' ||
      'h73VJj8KJhQBtqpWCjfT1hhZOrJNrTIR28//ivz2tTojWnaZPQV5WRDrXFDf+QRQ\n' ||
      '1T8dri0dlrNum7bwdzwGCHR24ZEZEC4leLOs56OC9TJMLaTDtNaD575HtWp2GQGb\n' ||
      'H0lV8s3J5M4sJse2WPDJERyqARdPArB75YzPrJL1vwsEo2HYWkhOwu9knfh8+XNo\n' ||
      'D7OjOz+s0zZDC8h7wQaLcpegbhURAg8mDN6bBPZ7s3eRPxZnrqscl5F2rov3SYgW\n' ||
      'kBa8W97mFIcUOIJpNoBlLkrGOvUz7rfBIXTSjA+YAQKBgQDz9NKtht4uYhfo8bnC\n' ||
      'prfTuej96OS7U16bsCtlkX+98G2lwTrf2EGg0RlegilFAgXpjrRo6ySyd1F28vLI\n' ||
      'ZfReQWXVxs2L0K3H75VUBM/YWxHdv31hSt198bf1mt9CCKd2PNFwIMF7ysaCVYmZ\n' ||
      '+Zs7b14/uP7di0DIl3x+H6NPAQKBgQDvlR7DzzCFHFIZLYIbjYduSu3fDVzAl/Vt\n' ||
      'LnwYplffdsDszDsPPRC0rCR7sKwWGyPyifDazHD32nZ6/Zfzvphj7JnfQS/a/0/v\n' ||
      'ldWAPNmZeuHmNXnSuMLIEPCSm3QopZHi3y4OoGozuW8F9PHdMXY2ssxqN1ygpdbH\n' ||
      'k7DV7LALjQKBgD4F4oJHpbk5K0cIHehFJrtnqrrTOUP/ADCo63+ZLFcIB3h61hMP\n' ||
      'EjBmuQJ0KTXoO8STiX6bOes9trJ9NgiJE0Xbbp6ZOqzvUx9f5CFGT+l7zeEIzEGu\n' ||
      'HP3mNJT22Qga1yiScdUGHurwNOPyB1fkQ/kqaVXeHL4Kp1/YU8hlFsoBAoGBAM4i\n' ||
      'DFVG96Ufh9eX2yDftY2EtIM8WPhwBj8JRsZioKpo33ceBRaIYM5CaiVuDbH7agNt\n' ||
      'AakPS4dFFLmfZVTXQQCAeqemy4juMJWf4hEyyboPCzvp+MYAJ77BLGvHirrKMen0\n' ||
      'QgldpeKZAlgqtsqsmtxXHB+rQGwMI+6VOQnmWlWlAoGAC2K0/mR40oCJA8SmGaW4\n' ||
      'xiWdx8hfG+Sa3L/WMHZXtHDvEMY6sN30sN8ZHfX4G5m3XO+9r06TFCPMS0k9vnzy\n' ||
      'ttr/of5ixQJIYxCx6V8qTSg2yIARBe1vuDV3eq8U/w0VtDX8lUEHwZsLpBQLpq3r\n' ||
      'H86smi5SwE9SSvUIWRsZeFQ=\n' ||
      '-----END PRIVATE KEY-----\n';

  /** Certificate for previous key. Generate using:
          GetPrimary()->BeginWork();
          OBJECT keypair := CreateKeyPair("samlkey", StringToBlob(privatekey), [ title := "samlkey", generateuniquename := TRUE ]);
          BLOB csr := keypair->GenerateCSR([ c := "NL", st := "Overijssel", l := "Enschede", o := "WebHare BV", cn := "SAML test certificate" ]);
          RECORD rec := keypair->SignCertificateRequest(csr, [ selfsign := TRUE, validuntil := MakeDate(2100, 1, 1) ]);
          STRING newcertificate := BlobToString(rec.certificate);
          Print(newcertificate||"\n");
  */
  STRING certificate :=
`-----BEGIN CERTIFICATE-----
MIIDoDCCAoigAwIBAgIQes0EXSxWROElRpEdKBNNuTANBgkqhkiG9w0BAQsFADBq
MQswCQYDVQQGEwJOTDETMBEGA1UECAwKT3Zlcmlqc3NlbDERMA8GA1UEBwwIRW5z
Y2hlZGUxEzARBgNVBAoMCldlYkhhcmUgQlYxHjAcBgNVBAMMFVNBTUwgdGVzdCBj
ZXJ0aWZpY2F0ZTAeFw0yMjA5MDQyMTExMDJaFw0wMDAxMDEwMDAwMDBaMGoxCzAJ
BgNVBAYTAk5MMRMwEQYDVQQIDApPdmVyaWpzc2VsMREwDwYDVQQHDAhFbnNjaGVk
ZTETMBEGA1UECgwKV2ViSGFyZSBCVjEeMBwGA1UEAwwVU0FNTCB0ZXN0IGNlcnRp
ZmljYXRlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5E+rf+mG77VX
JcS/AH46wKxVwlEaz72aciOQYUZUJxsQjZexOkExD0Ym8nD6BzaE3p+dcxDSNJsQ
OYUkc/McMC+CEmMmigvS8zPNF6tHarXibsa+WtQBg2zbvtXrtJoj1AQlQO7iWDHv
+2l+Z3veGPJY/cuiXsAWbyUFW5PMgZbgGS3m2k6MrUTv3BSqXKkQ6tb2iIH/cUI3
YzniWMf0WJEFWYgthR5bX70hU8djgciNDrtCTD7HlZCsJm+cE4N5EJfZuAe4RM5b
3Lv8wphp3LxUrwe/xyOsix+JwaJpm1JrOBbqHX4/lJBjUAy2bhoA86YNmF4sIe2X
bbXDrgeOjQIDAQABo0IwQDAdBgNVHQ4EFgQUfXxeFVZjar01I3906Hm/x6fBoXow
HwYDVR0jBBgwFoAUfXxeFVZjar01I3906Hm/x6fBoXowDQYJKoZIhvcNAQELBQAD
ggEBALHWpSlqdCBwfXyq8YNLeHdWIAHSIltrPf9ajZ551T174lpYcAt91UfEbMu3
Zf4O1gTDLtTQA6LI9kWv9EhMcZxC6XclT44pPH6rsXw6Q++ZpZj9AaH/96pLniAm
Vs/uFtOf67G6XlEi9saDAE9yXMJ+J8eNWmtY0D76AwEFVLUNyrRRlVRx3vS1xmeW
/rVsS8IIpzXjtW0JKzIVUtGCWnubMDhX1qIbgbD3MnSi0fKL6RSLOxIxlQGJgAvg
J5n7fFxcasOdwv+heJwwi8KRLmbwmuLcyWOPLRsOVr6D5fBDToXiprh/ZWB3rV50
FxQQ+f+xXvBD1hdRwFcZD+2TA04=
-----END CERTIFICATE-----`;


  RECORD request :=
      [ type :=               "AuthnRequest"
      , id :=                 "req-1"
      , version :=            "2.0"
      , issueinstant :=       MakeDate(2030, 1, 1)
      , issuer :=             [ value := "http://example.com/sp" ]
      , assertionconsumerserviceindex := 1 // respond via post (see generated SP metadata)
      , providername :=       "example.com"
      ];

  RECORD encoded := EncodeSAMLDocument(request, "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect", TRUE,
      [ sign :=         privatekey
      , destination :=  "http://example.com/destination"
      , relaystate :=   "relaystate-1"
      , signaturealgorithm := "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
      ]);

  RECORD webdata := GetSAMLData("urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect", encoded.url, GetAllVariablesFromUrl(encoded.url));

  RECORD decoded := DecodeSAMLMessage(webdata, TRUE);
  TestEQMembers(request, decoded.message, "*");

  // shouldn't throw
  decoded.validate(
      [ [ acceptuntil :=    MakeDate(2100, 1, 1)
        , data :=           WrapBlob(StringToBlob(certificate), "certificate.pem")
        ]
      ], CELL[]);

  // test optional signature handling
  webdata.signature := "";
  webdata.sigalg := "";
  decoded := DecodeSAMLMessage(webdata, TRUE);
  TestThrowsLike('The SAML document is not signed',PTR decoded.validate(
      [ [ acceptuntil :=    MakeDate(2100, 1, 1)
        , data :=           WrapBlob(StringToBlob(certificate), "certificate.pem")
        ]
      ], CELL[]));

  decoded.validate(
      [ [ acceptuntil :=    MakeDate(2100, 1, 1)
        , data :=           WrapBlob(StringToBlob(certificate), "certificate.pem")
        ]
      ], CELL[ signature_optional := TRUE ]);



  encoded := EncodeSAMLDocument(request, "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST", TRUE,
      [ sign :=         privatekey
      , destination :=  "http://example.com/destination"
      , relaystate :=   "relaystate-1"
      , signaturealgorithm := "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
      ]);

  TestEQ(
      [ type := 'form'
      , form :=
            [ action := "http://example.com/destination"
            , method := "POST"
            , vars :=
                [ [ name :=   'SAMLRequest'
                  , value :=  'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNhbWxwOkF1dGhuUmVxdWVzdCB4bWxucz0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnByb3RvY29sIiB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiB4bWxuczpzYW1scD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnByb3RvY29sIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYWluc3RhbmNlIiBJRD0icmVxLTEiIFZlcnNpb249IjIuMCIgSXNzdWVJbnN0YW50PSIyMDMwLTAxLTAxVDAwOjAwOjAwWiIgRGVzdGluYXRpb249Imh0dHA6Ly9leGFtcGxlLmNvbS9kZXN0aW5hdGlvbiIgQXNzZXJ0aW9uQ29uc3VtZXJTZXJ2aWNlSW5kZXg9IjEiIFByb3ZpZGVyTmFtZT0iZXhhbXBsZS5jb20iPjxzYW1sOklzc3Vlcj5odHRwOi8vZXhhbXBsZS5jb20vc3A8L3NhbWw6SXNzdWVyPjxkczpTaWduYXR1cmU+PGRzOlNpZ25lZEluZm8+PGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkczpSZWZlcmVuY2UgVVJJPSIjcmVxLTEiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM+PGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkczpEaWdlc3RWYWx1ZT5rOWR6NXJGSnJWMGZLZHdGTFp3TGl4bjhGN2xhM29ockgxOU5IUG12WXZzPTwvZHM6RGlnZXN0VmFsdWU+PC9kczpSZWZlcmVuY2U+PC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5QNFJ2YlpGbk1JOVA1ME1KelZZUTN6cDZTYzJjNXg3VENxd1NsaDdYb0ViREt6TUprblhMVDM3cjdBWnlqeW1lUWozd1cyNm4rZlB3YkVTMHpyQXRuT2MwYVRCaW5NMkN3WHc0UFdPdmlmanhabklZQURhMkZPYnFZcTdHNjAyWTc0NlA2b3lxOUtLVGtGUnYwK3ZyNzNwSVNqMWhORlRTOHBCVFdKZlZ6Q3dWY1U1MmV3bWVnNXJMZmpyTm44TGY0dm84dStIWG16UDRrVm9IWE1jUkdWdmFCNE1VcklXMU45a01VSTNWQW16SksyTVhsbUZRcUM1U2ZCRk55M3BhQlBhakxJNGpNZnc2bVFrZ2pGM1prSDIzdzNUTEZXcVlUb3B1Y3dGRktMS1FDc2NQYWFyZzJldnZERmpqRzc3NW5ib2hpU2tSbXFleTB5L1RYNlU2WWc9PTwvZHM6U2lnbmF0dXJlVmFsdWU+PC9kczpTaWduYXR1cmU+PC9zYW1scDpBdXRoblJlcXVlc3Q+Cg=='
                  ]
                , [ name := 'RelayState'
                  , value := 'relaystate-1'
                  ]
                ]
            ]
      ], encoded);

  webdata := GetSAMLData("urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST", encoded.form.action, encoded.form.vars);

  decoded := DecodeSAMLMessage(webdata, TRUE);
  TestEQMembers(request, decoded.message, "*");

  // shouldn't throw
  decoded.validate(
      [ [ acceptuntil :=    MakeDate(2100, 1, 1)
        , data :=           WrapBlob(StringToBlob(certificate), "certificate.pem")
        ]
      ], DEFAULT RECORD);

  FOREVERY (STRING signalg FROM
        [ "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
        , "http://www.w3.org/2001/04/xmldsig-more#rsa-sha224"
        , "http://www.w3.org/2001/04/xmldsig-more#rsa-sha384"
        , "http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"
        ])
  {
    encoded := EncodeSAMLDocument(request, "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect", TRUE,
        [ sign :=         privatekey
        , destination :=  "http://example.com/destination"
        , relaystate :=   "relaystate-1"
        , signaturealgorithm := signalg
        ]);

    webdata := GetSAMLData("urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect", encoded.url, GetAllVariablesFromUrl(encoded.url));

    decoded := DecodeSAMLMessage(webdata, TRUE);

    // shouldn't throw
    decoded.validate(
        [ [ acceptuntil :=    MakeDate(2100, 1, 1)
          , data :=           WrapBlob(StringToBlob(certificate), "certificate.pem")
          ]
        ], DEFAULT RECORD);

    encoded := EncodeSAMLDocument(request, "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST", TRUE,
        [ sign :=         privatekey
        , destination :=  "http://example.com/destination"
        , relaystate :=   "relaystate-1"
        ]);

    webdata := GetSAMLData("urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST", encoded.form.action, encoded.form.vars);

    decoded := DecodeSAMLMessage(webdata, TRUE);

    // shouldn't throw
    decoded.validate(
        [ [ acceptuntil :=    MakeDate(2100, 1, 1)
          , data :=           WrapBlob(StringToBlob(certificate), "certificate.pem")
          ]
        ], DEFAULT RECORD);
  }
}

RunTestFramework([ PTR TestSAMLSigning
                 ]);
