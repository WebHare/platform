<?wh

LOADLIB "wh::files.whlib";
LOADLIB "wh::filetypes/richdocument.whlib";

LOADLIB "mod::wrd/lib/api.whlib";

PUBLIC MACRO SetTestInstanceField(STRING wrdschemaname, INTEGER person, RECORD testinstance) {
  OpenWRDSchema(wrdschemaname)->^wrd_person->UpdateEntity(person, CELL[ testinstance ]);
}

PUBLIC RECORD FUNCTION GetTestInstanceField(STRING wrdschemaname, INTEGER person) {
  RETURN OpenWRDSchema(wrdschemaname)->^wrd_person->GetEntityField(person, "testinstance");
}

PUBLIC MACRO SetTestRichDocumentField(STRING wrdschemaname, INTEGER person, STRING html)
{
  OBJECT myrichdoc := NEW RichDocument;
  myrichdoc->ImportFromRecord([ htmltext := StringToBlob(html) ]);

  OpenWRDSchema(wrdschemaname)->^wrd_person->UpdateEntity(person,
      [ richie := myrichdoc->ExportAsRecord()
      ]);
}

PUBLIC RECORD FUNCTION GetTestRichDocumentField(STRING wrdschemaname, INTEGER person)
{
  RETURN OpenWRDSchema(wrdschemaname)->^wrd_person->GetEntityField(person, "richie");
}

PUBLIC MACRO SetTestIntExtLinkField(STRING wrdschemaname, INTEGER person, RECORD intextlink)
{
  intextlink := ValidateOptions([ internallink := 0, externallink := "", append := "" ], intextlink);

  OpenWRDSchema(wrdschemaname)->^wrd_person->UpdateEntity(person,
      [ linkie := intextlink
      ]);
}

PUBLIC RECORD FUNCTION GetTestIntExtLinkField(STRING wrdschemaname, INTEGER person)
{
  RETURN OpenWRDSchema(wrdschemaname)->^wrd_person->GetEntityField(person, "linkie");
}

PUBLIC STRING ARRAY FUNCTION GetWRDTypeEventMasks(STRING wrdschemaname, STRING typetag)
{
  RETURN OpenWRDSchema(wrdschemaname)->__GetTypeByTag(typetag)->GetEventMasks();
}


PUBLIC RECORD FUNCTION GetWRDEntityFields(STRING wrdschema, STRING type, INTEGER entityid, STRING ARRAY fields)
{
  RETURN OpenWRDSchema(wrdschema)->__GetTypeByTag(type)->GetEntityFields(entityid, fields);
}

PUBLIC MACRO UpdateWRDEntity(STRING wrdschema, STRING type, INTEGER entityid, RECORD updates)
{
  OpenWRDSchema(wrdschema)->__GetTypeByTag(type)->UpdateEntity(entityid, updates);
}
