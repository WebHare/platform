<?wh
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::tollium/lib/testframework.whlib";
LOADLIB "mod::wrd/lib/api.whlib";
LOADLIB "mod::webhare_testsuite/lib/internal/wrdtesthelpers.whlib";

ASYNC MACRO TestOpenSchema()
{
  testfw->BeginWork();

  OBJECT wrdschema2 := CreateWRDSchema("webhare_testsuite:schema2", [ initialize := TRUE
                                                                    , schemaresource := "mod::system/data/wrdschemas/default.wrdschema.xml"
                                                                    ]);

  testfw->GetUserObject("sysop")->UpdateGrant("grant", "wrd:readwrite", testfw->GetWRDSchema()->id, testfw->GetUserObject("marge"));
  testfw->GetUserObject("sysop")->UpdateGrant("grant", "wrd:readwrite", wrdschema2->id, testfw->GetUserObject("marge"));

  testfw->CommitWork();

  AWAIT ExpectScreenChange(+2, PTR TTLaunchApp("wrd:browser"));
  TestEq(TRUE, RecordExists(SELECT FROM topscreen->schemas->rows WHERE tag = testfw->GetWRDSchema()->tag));

  AWAIT ExpectScreenChange(-2, PTR topscreen->TolliumExecuteCancel());
}

ASYNC MACRO TestMarge()
{
  testfw->SetTestUser("marge");

  AWAIT ExpectScreenChange(+2, PTR TTLaunchApp("wrd:browser"));
  TestEq([[ tag := "webhare_testsuite:schema2" ]], SELECT tag FROM TT("schemas")->rows);
  AWAIT ExpectScreenChange(-2, PTR topscreen->TolliumExecuteCancel());
}

RunTestFramework([ PTR CreateWRDTestSchema
                 , PTR TestOpenSchema
                 , PTR TestMarge
                 ], [ testusers := [[ login := "sysop", grantrights := ["system:sysop"]]
                                   ,[ login := "marge" ]
                                   ]]);
