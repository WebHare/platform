<?wh
/* Test buckaroo
   WebHare.bv developers can obtain test credentials using:
   Q secrets/load-test-environment buckaroo
*/

LOADLIB "mod::system/lib/services.whlib";
LOADLIB "mod::system/lib/internal/browsers/chrome/connector.whlib";
LOADLIB "mod::system/lib/internal/browsers/chrome/page.whlib";
LOADLIB "mod::system/lib/internal/browsers/chrome/navigationwatcher.whlib";

LOADLIB "wh::os.whlib";
LOADLIB "wh::internet/urls.whlib";

LOADLIB "mod::tollium/lib/testframework.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::webhare_testsuite/lib/internal/wrdtesthelpers.whlib";

BOOLEAN offlineonly := GetEnvironmentVariable("TESTSECRET_BUCKAROO_WEBSITEID") = "" OR GetEnvironmentVariable("TESTSECRET_BUCKAROO_SECRETID") = "";

ASYNC MACRO SetupBuckaroo()
{
  OBJECT paymentapi := GetWRDTestPaymentAPI();
  AWAIT ExpectScreenChange(+1, PTR paymentapi->RunManagePaymentProvidersDialog(GetTestController()));

  AWAIT ExpectScreenChange(+1, PTR topscreen->addprovider->TolliumClick);
  TT("methods")->value := "wrd:buckaroo";
  AWAIT ExpectScreenChange(0, PTR TTClick(":Ok"));
  TT(":Website ID")->value := GetEnvironmentVariable("TESTSECRET_BUCKAROO_WEBSITEID") ?? "dummy-id";
  TT(":Secret ID")->value := GetEnvironmentVariable("TESTSECRET_BUCKAROO_SECRETID") ?? "dummy-secret";
  TT("paymentextension->testmode")->value := TRUE;
  IF(NOT offlineonly)
  {
    AWAIT ExpectAndAnswerMessageBox("OK", PTR TTClick("paymentextension->connect"), [ messagemask := "*succeeded*" ]);
  }

  TT("{select}:Methods")->selection := SELECT * FROM TT("{select}:Methods")->options WHERE ToUppercase(title) IN ["IDEAL"];
  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  AWAIT ExpectScreenChange(+1, PTR TTClick(":Edit"));
  TestEq(TRUE, TT("paymentextension->testmode")->value);
  TestEq(["iDEAL"], SELECT AS STRING ARRAY title FROM TT("{select}:Methods")->selection);
  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  AWAIT ExpectScreenChange(-1, PTR TTClick(":Close"));
}

IF(offlineonly)
  Print("*** Skipping some tests as TESTSECRET_BUCKAROO_WEBSITEID and TESTSECRET_BUCKAROO_SECRETID are unset\n\n");

RunTestframework([ PTR CreateWRDTestSchema
                 , PTR SetupBuckaroo
                 ]);
