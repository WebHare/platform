<?wh
LOADLIB "wh::crypto.whlib";
LOADLIB "wh::datetime.whlib";
LOADLIB "wh::files.whlib";

LOADLIB "wh::util/localization.whlib";

LOADLIB "mod::system/lib/resources.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

LOADLIB "mod::system/lib/cache.whlib";

LOADLIB "mod::publisher/lib/publisher.whlib";
LOADLIB "mod::publisher/lib/rtd.whlib";

LOADLIB "mod::wrd/lib/worldinfo/countries.whlib";
LOADLIB "mod::wrd/lib/objectapi.whlib";
LOADLIB "mod::webhare_testsuite/lib/internal/wrdtesthelpers.whlib";

MACRO TestSchema()
{
  testfw->BeginWork();
  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);

  OBJECT persontype := schemaobj->GetTypeByTag("WRD_PERSON");

  // Test all fields
  INTEGER testpersonid := persontype->Search("WRD_CONTACT_EMAIL", "other@example.com");
  OBJECT testpersonobj := persontype->GetEntity(testpersonid);

  testpersonobj->DeleteEntity();
  testfw->CommitWork();
}

MACRO TestAddress()
{
  RECORD ARRAY list := GetCountryList(["en","nl","de"]);
  TestEq([code := "AF", de := "Afghanistan", en := "Afghanistan", nl := "Afghanistan"], list[2]);
  TestEq([code := 'NL', de := "Niederlande" ,en := "Netherlands", nl := "Nederland"], RECORD(SELECT * FROM list WHERE code="NL"));

  list := GetWRDCountryList("nl","nl");
  TestEq([code := '', isempty := TRUE, selected := FALSE, title := ''], list[0]);
  TestEq([code := 'NL', isempty := FALSE, selected := TRUE, title := 'Nederland'], RECORD(SELECT * FROM list WHERE code="NL"));
  list := GetWRDCountryList("En","NL");
  TestEq([code := 'NL', isempty := FALSE, selected := TRUE, title := 'Netherlands'], RECORD(SELECT * FROM list WHERE code="NL"));

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  TestEq([code := "NL", country := "Netherlands"], RECORD(SELECT * FROM schemaobj->GetCountryListing() WHERE code="NL"));
}

MACRO ImageCache()
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");
  STRING baseurl := OpenTestsuitesite()->webroot;

  BLOB testimage_blob := GetWebhareResource("mod::system/web/tests/goudvis.png");
  INTEGER entityid1 := wrdperson->CreateEntity2([ test_image := WrapBlob(testimage_blob,"")
                                               ] )->id;
  INTEGER entityid2 := wrdperson->CreateEntity2([ test_array := [ [ test_image := WrapBlob(testimage_blob,"") ], DEFAULT RECORD ]
                                               ] )->id;

  RECORD entity := wrdperson->RunQuery( [ outputcolumns := [ imageid := "TEST_IMAGE.IMAGEId", arrayimages := "TEST_ARRAY.TEST_IMAGE.IMAGEID" ]
                                        , filters := [[ field := "WRD_ID", value := entityid1 ]
                                                     ]
                                        ]);
  TestEq(TRUE, entity.imageid != 0);
  INTEGER64 entityid1_imageid := entity.imageid;
  TestEq(0, Length(entity.arrayimages));

  entity := wrdperson->RunQuery( [ outputcolumns := [ imageid := "TEST_IMAGE.IMAGEID", arrayimages := "TEST_ARRAY.TEST_IMAGE.IMAGEID", test_array := "TEST_ARRAY" ]
                                 , filters := [[ field := "WRD_ID", value := entityid2 ]
                                              ]
                                 ]);

  TestEq(TRUE, entity.imageid = 0);
  TestEq(2, Length(entity.arrayimages));
  TestEq(TRUE, entity.arrayimages[0]!=0);
  TestEq(0i64, entity.arrayimages[1]);

  testfw->CommitWork();

  STRING legacy_imagelink := GetCachedWRDImageURL(baseurl, entityid1_imageid, [method := "none"]);
  STRING imagelink := GetCachedImageLink(wrdperson->GetEntityFields(entityid1, ["TEST_IMAGE"]).test_image, [ method := "none", baseurl := baseurl ]);
  TestEq(imagelink, Substitute(legacy_imagelink, "data.png", "noname.png"));

  RECORD wrappedinfo := GetWrappedSourceFromURL(imagelink);
  TestEq('noname.png', wrappedinfo.filename);
  TestEq(385, wrappedinfo.width);
}

MACRO TestGenderDomain()
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT persontype := schemaobj->GetTypeByTag("WRD_PERSON");
  RECORD ARRAY genderdomain := persontype->ListDomVals("WRD_GENDER");
  TEstEq(3,Length(genderdomain));

  testfw->CommitWork();
}

MACRO RichDoc()
{
  testfw->BeginWork();
  OBJECT destlink  := OpenTestsuiteSite()->OpenByPath("tmp")->EnsureFile([name := "destlink"]);
  OBJECT destlink2 := OpenTestsuiteSite()->OpenByPath("tmp")->EnsureFile([name := "destlink2"]);

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");

  INTEGER testpersonid := wrdperson->CreateEntity2([wrd_contact_email:="richdoc@example.com"])->id;
  OBJECT testpersonobj := wrdperson->GetEntity(testpersonid);
  TestEq(TRUE, ObjectExists(testpersonobj));

  OBJECT myrichdoc := NEW RichDocument;
  myrichdoc->ImportFromMHTML(testfw->GetModuleTestBlob("webhare_testsuite","system/testdata/b-lex.mht"));
  RECORD myrichexp := myrichdoc->ExportAsRecord();

  testpersonobj->UpdateFields([ richie := myrichexp
                              , testinstance := [ whfstype := "http://www.webhare.net/xmlns/beta/embedblock1"
                                                , id := "TestInstance-1"
                                                , fsref := destlink->id
                                                ]
                              , testintextlink := [ internallink := destlink->id, externallink := "", append := "#bla" ]
                              ] );
  //ensure updating works
  testpersonobj->UpdateFields([ testintextlink := [ internallink := destlink->id, externallink := "", append := "" ]
                              ] );
  testpersonobj->UpdateFields([ testintextlink := [ internallink := destlink->id, externallink := "", append := "#test" ]
                              ] );
  testfw->CommitWork();

  RECORD org_testrec1 := wrdperson->GetEntityFields(testpersonid, ["RICHIE", "TESTINSTANCE", "TESTINTEXTLINK"]);
  RECORD testrec1 := org_testrec1;

  BLOB fragment := GetRichDocumentAsHtmlFragment(testrec1.richie);

  FOREVERY (RECORD rec FROM testrec1.richie.embedded)
    TestEQ(TRUE, CellExists(rec, "WRD_SETTINGID"));

  myrichexp.embedded := RecurseDeleteSettingIds(myrichexp.embedded, ["HASH", "LINK"]);
  testrec1.richie.embedded  := RecurseDeleteSettingIds(testrec1.richie.embedded,  ["HASH", "LINK"]);
  TestEq(myrichexp, testrec1.richie);
  TestTestInstance(testrec1.testinstance);
  TestEq(OpenTestsuiteSite()->OpenByPath("tmp/destlink")->id, testrec1.testintextlink.internallink);
  TestEq("#test", testrec1.testintextlink.append);

  RECORD ARRAY queryres := wrdperson->RunQuery( [ outputcolumns := [ "RICHIE", "TESTINSTANCE", "TESTINTEXTLINK" ]
                                                , filters := [[ field := "WRD_ID", value := testpersonid ]]
                                                ]);
  TestEq(1,Length(queryres));

  FOREVERY (RECORD rec FROM queryres[0].richie.embedded)
  {
    TestEq(TRUE, CellExists(rec, "WRD_SETTINGID"));
    TestEq(TRUE, CellExists(rec, "__BLOBSOURCE"));
  }

  queryres[0].richie.embedded := RecurseDeleteSettingIds(queryres[0].richie.embedded, ["HASH", "LINK"]);
  TestEq(myrichexp, queryres[0].richie);
  TEstTestInstance( queryres[0].testinstance);
  TestEq(OpenTestsuiteSite()->OpenByPath("tmp/destlink")->id, queryres[0].testintextlink.internallink);
  TestEq("#test", queryres[0].testintextlink.append);

  /* Change only the htmltext, to make sure it's being detected */
  testfw->BeginWork();
  myrichexp.htmltext := StringToBlob("!!!" || BlobToString(myrichexp.htmltext,-1));
  testpersonobj->UpdateFields([ richie := myrichexp ] );
  RECORD org_testrec3 := wrdperson->GetEntityFields(testpersonid, ["RICHIE"]).richie;
  RECORD testrec3 := org_testrec3;
  testrec3.embedded := RecurseDeleteSettingIds(testrec3.embedded, ["HASH", "LINK"]);
  TestEq(myrichexp, testrec3);
//  TestEq(org_testrec1.embedded, org_testrec3.embedded); // Stability of image ids - not implemented.

  /* Now try updating it without images */
  myrichdoc->ImportFromPlainText("Hi Everybody!");
  myrichexp := myrichdoc->ExportAsRecord();
  testpersonobj->UpdateFields([ richie := myrichexp ] );
  testrec1 := wrdperson->GetEntityFields(testpersonid, ["RICHIE"]).richie;
  TestEq(myrichexp, testrec1);

  /* Again, change only the htmltext, to make sure it's being detected */
  myrichexp.htmltext := StringToBlob("!!!" || BlobToString(myrichexp.htmltext,-1));
  testpersonobj->UpdateFields([ richie := myrichexp ] );
  testrec1 := wrdperson->GetEntityFields(testpersonid, ["RICHIE"]).richie;
  TestEq(myrichexp, testrec1);

  // Let the link point to destlink2, delete it. Then reset the link to destlink
  // (was regression: could not store extlinks after delete)
  testpersonobj->UpdateFields([ testintextlink := [ internallink := destlink2->id, externallink := "", append := "" ]
                              ] );
  OpenTestsuiteSite()->OpenByPath("tmp/destlink2")->DeleteSelf();
  testpersonobj->UpdateFields([ testintextlink := [ internallink := destlink->id, externallink := "", append := "" ]
                              ] );
  TestEq(OpenTestsuiteSite()->OpenByPath("tmp/destlink")->id, wrdperson->GetEntity(testpersonid)->GetField("TESTINTEXTLINK").internallink);

  // Are source_fsobjects in embedded images stored?
  myrichdoc->ImportFromMHTML(testfw->GetModuleTestBlob("webhare_testsuite","system/testdata/b-lex.mht"));
  myrichexp := myrichdoc->ExportAsRecord();
  myrichexp.embedded[0].source_fsobject := destlink->id;
  testpersonobj->UpdateFields([ richie := myrichexp ] );
  TestEq(destlink->id, testpersonobj->GetField("RICHIE").embedded[0].source_fsobject);

  testfw->CommitWork();
}

MACRO RichDocEmbed()
{
  testfw->BeginWork();

  OBJECT destlink := OpenTestsuitesite()->OpenByPath("tmp")->EnsureFile([name := "destlink"]);

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");

  INTEGER testpersonid := wrdperson->CreateEntity2([wrd_contact_email:="richdocembedded2@example.com"])->id;
  OBJECT testpersonobj := wrdperson->GetEntity(testpersonid);

  /* Add a RTD with embedded objects */
  RECORD withembedded := wrdtest_withembedded;

  INTEGER destlinkid := OpenTestsuiteSite()->OpenByPath("tmp/destlink")->id;
  testpersonobj->UpdateFields2([ richie := withembedded
                               , testinstance := [ whfstype := "http://www.webhare.net/xmlns/beta/embedblock1"
                                                 , id := "TestInstance-1"
                                                 , fsref := destlinkid
                                                 ]
                               , testintextlink := [ internallink := destlinkid, externallink := "", append := "#jantje" ]
                               ] );
  RECORD testrec1 := wrdperson->GetEntityFields(testpersonid, ["RICHIE","TESTINSTANCE"]);
  TestRichieEmbedded(testrec1.richie);
  TestTestInstance(testrec1.testinstance);

  testfw->CommitWork();

  testfw->BeginWork();

  /* Update it with a different one. this takes a shortcut path through setwrdattribute4 which used to forget updating the whfs id */
  withembedded.instances[0].data.html := "UPDATED!";
  testpersonobj->UpdateFields([ richie := withembedded ] );
  testrec1 := wrdperson->GetEntityFields(testpersonid, ["RICHIE"]).richie;
  TestEq("UPDATED!", testrec1.instances.data.html);
  testfw->RollbackWork();
}

MACRO TestAttributes(STRING tag)
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT typeobj := schemaobj->GetTypeByTag(tag);
  TestEq(TRUE, ObjectExists(typeobj));

  RECORD ARRAY attrs := typeobj->GetAttributes(0);
  OBJECT entity := typeobj->CreateEntity2(DEFAULT RECORD); //create an empty, lonely entiy

  FOREVERY (RECORD attr FROM attrs)
  {
    IF (attr.isreadonly OR attr.tag IN ["WRD_CREATIONDATE","WRD_LIMITDATE","WRD_MODIFICATIONDATE","WRD_GUID"])
      CONTINUE;
    //PRINT("Doing attribute " || attr.tag || " " || attr.attributetype || "\n");

    VARIANT data := entity->GetField(attr.tag);

    RECORD ARRAY testvalues;
    SWITCH (attr.attributetype)
    {
    CASE 2
        { testvalues :=
            [ [ value := "", valid := NOT attr.isrequired ]
            , [ value := "a", valid := TRUE ]
            , [ value := GetStringOfLength(attr.maxlength), valid := TRUE ]
            , [ value := GetStringOfLength(attr.maxlength+1), valid := FALSE ]
            ];
        }
    CASE 15
        { testvalues :=
            [ [ value := 0, valid := NOT attr.isrequired ]
            , [ value := 1, valid := TRUE ]
            , [ value := 2, valid := TRUE ]
            ];
        }
    CASE 6, 12
        { testvalues :=
            [ [ value := DEFAULT DATETIME
              , valid := NOT attr.isrequired
              ]
            , [ value := MakeDate(2006, 10, 1), valid := TRUE ]
            ];
        }
    CASE 1
        {
          IF (attr.tag = "WRD_GENDER")
            CONTINUE;

          OBJECT type := schemaobj->GetType(attr.domain);
          RECORD ARRAY data := type->RunQuery([ outputcolumns := [ id := "WRD_ID" ]
                                              , filters := [[ field := "WRD_ID", matchtype := "!=", value := entity->id ]]
                                              ] );

          testvalues :=
            [ [ value := 0, valid := NOT attr.isrequired ]
            , [ value := (SELECT AS INTEGER id FROM data), valid := TRUE ]
            ];
        }
    CASE 8
        {
          OBJECT type := schemaobj->GetType(attr.domain);
          RECORD ARRAY data := RunWRDQuery([ sources := [ [ type := type, outputcolumns := [ id := "WRD_ID" ] ] ] ]);

          testvalues :=
            [ [ value := DEFAULT INTEGER ARRAY, valid := NOT attr.isrequired ]
            , ...( Length(data) >= 1 ? [[ value := [ SELECT AS INTEGER id FROM data ], valid := TRUE ]] : RECORD[]) //only insert if at least one value
            , [ value := (SELECT AS INTEGER ARRAY id FROM data), valid := TRUE ]
            ];
        }
    DEFAULT
        {
//          PRINT("Untestable type " || attr.attributetype || "\n");
          CONTINUE;
        }
    }

    FOREVERY (RECORD rec FROM testvalues)
    {
      RECORD result := entity->UpdateFields(CellInsert(DEFAULT RECORD, attr.tag, rec.value));
      TestEq(rec.valid, LENGTH(result.errors) = 0);

      IF (rec.valid)
      {
        VARIANT changeddata := entity->GetField(attr.tag);
        TestWRDAttributeValuesEqual(rec.value, changeddata);

        // See what query engine returns for current value
        RECORD data := RunWRDQuery([ sources := [ [ type := typeobj, historymode := "all", filters := [ [ field := "wrd_id", value := entity->id ] ], outputcolumns := [ value := attr.tag ] ] ] ]);
        TestWRDAttributeValuesEqual(rec.value, data.value);

        // See what query engine equality filtering is ok
        VARIANT different_value := testvalues[(#rec + 1) % LENGTH(testvalues)].value;
        IF(EncodeHSON(different_value) != EncodeHSON(rec.value))
        {
          data := RunWRDQuery([ sources := [ [ type := typeobj
                                             , historymode := "all"
                                             , filters := [ [ field := "wrd_id", value := entity->id ]
                                                          , [ field := attr.tag, value := different_value ]
                                                          ]
                                             , outputcolumns := [ id := "WRD_ID" ]
                                             ]
                                           ]
                              ]);
          TestEq(FALSE, RecordExists(data));
        }
        // See what query engine equality filtering is ok
        data := RunWRDQuery([ sources := [ [ type := typeobj, historymode := "all", filters := [ [ field := "wrd_id", value := entity->id ], [ field := attr.tag, value := rec.value ] ], outputcolumns := [ id := "WRD_ID" ] ] ] ]);
        TestEq([ id := entity->id ], data);

        // See what query engine inequality filtering is ok
        data := RunWRDQuery([ sources := [ [ type := typeobj, historymode := "all", filters := [ [ field := "wrd_id", value := entity->id ], [ field := attr.tag, match_type := "!=", value := rec.value ] ], outputcolumns := [ id := "WRD_ID" ] ] ] ]);
        TestEq(DEFAULT RECORD, data);
      }
    }

    entity->UpdateFields(CellInsert(DEFAULT RECORD, attr.tag, data));
    VARIANT backdata := entity->GetField(attr.tag);
    TestWRDAttributeValuesEqual(data, backdata);

    // See if the query engine returns the right value
    RECORD qdata := RunWRDQuery([ sources := [ [ type := typeobj, historymode := "all", filters := [ [ field := "wrd_id", value := entity->id ] ], outputcolumns := [ value := attr.tag ] ] ] ]);
    TestWRDAttributeValuesEqual(data, qdata.value);

    // See what query engine equality filtering is ok
    qdata := RunWRDQuery([ sources := [ [ type := typeobj, historymode := "all", filters := [ [ field := "wrd_id", value := entity->id ], [ field := attr.tag, value := data ] ], outputcolumns := [ id := "WRD_ID" ] ] ] ]);
    TestEq([ id := entity->id ], qdata);

    // See what query engine inequality filtering is ok
    qdata := RunWRDQuery([ sources := [ [ type := typeobj, historymode := "all", filters := [ [ field := "wrd_id", value := entity->id ], [ field := attr.tag, match_type := "!=", value := data ] ], outputcolumns := [ id := "WRD_ID" ] ] ] ]);
    TestEq(DEFAULT RECORD, qdata);
  }

  typeobj->DeleteEntity(entity->id);
  testfw->CommitWork();
}

MACRO TestHistoryMode()
{
  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");

 {
    testfw->BeginWork();

    OBJECT person := wrdperson->GetEntity(wrdperson->CreateEntity2([ wrd_lastname := "FuturePerson", wrd_creationdate := AddDaysToDate(1,GetCurrentdatetime()) ])->id);

    RECORD ARRAY results;
    results :=  wrdperson->RunQuery([ outputcolumns := [ id := "WRD_ID" ], filters := [[ field := "WRD_LASTNAME", value := "FuturePerson" ]]]);
    TestEq(0, Length(results));

    results := wrdperson->RunQuery(
        [ outputcolumns := [ id := "WRD_ID" ]
        , filters := [[ field := "WRD_LASTNAME", value := "FuturePerson" ]]
        , historymode := "all"
        ]);
    TestEq(1, Length(results));
    testEq(person->id, results[0].id);

    results := wrdperson->RunQuery(
        [ outputcolumns := [ id := "WRD_ID" ]
        , filters := [[ field := "WRD_LASTNAME", value := "FuturePerson" ]]
        , historymode := "range"
        , when_start := GetCurrentDatetime()
        , when_limit := MAX_DATETIME
        ]);
    TestEq(1, Length(results));
    testEq(person->id, results[0].id);

    testfw->RollbackWork();
  }
}

MACRO TestEnrichBulk()
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");

  INTEGER p2 := wrdperson->CreateEntity2( [ test_email := "bulk_p2@example.com", wrd_firstname := "Person 2", test_single_domain := "TEST_DOMAINVALUE_1_2"  ])->id;
  INTEGER p1 := wrdperson->CreateEntity2( [ test_email := "bulk_p1@example.com", wrd_firstname := "Person 1", test_single_domain := 0 ])->id;

  INTEGER p_gone := wrdperson->CreateEntity2( [ test_email := "bulk_pgone@example.com", wrd_firstname := "Person Gone" ])->id;
  wrdperson->DeleteEntity(p_gone);

  RECORD ARRAY result;

  result := wrdperson->Enrich([[ getid := p1 ]
                              ,[ getid := p2 ]
                              ], "GETID"
                              , [ email := "test_email", firstname := "wrd_firstname" ]);
  TestEq( [[ getid := p1, email := "bulk_p1@example.com", firstname := "Person 1"]
          ,[ getid := p2, email := "bulk_p2@example.com", firstname := "Person 2"]
          ], result);

  result := wrdperson->Enrich([[ getid := p1 ]
                              ,[ getid := p_gone ]
                              ,[ getid := 0 ]
                              ], "GETID"
                              , [ email := "test_email", firstname := "wrd_firstname" ]);

  TestEq( [[ getid := p1, email := "bulk_p1@example.com", firstname := "Person 1"]
          ], result);

  RECORD outputcols := [ email := "test_email", firstname := "wrd_firstname" ];
  RECORD ARRAY allitems := SELECT * FROM wrdperson->RunQuery([ outputcolumns := CellInsert(outputcols,"GETID","WRD_ID"), historymode := "all" ]) ORDER BY getid;
  RECORD ARRAY expectinner := [[ getid := p1, email := "bulk_p1@example.com", firstname := "Person 1"]
                              ,[ getid := p_gone, email := "", firstname := ""]
                              ,[ getid := 0, email := "", firstname := ""]
                              ];
  RECORD ARRAY joinwith := [[ getid := p1 ]
                              ,[ getid := p_gone ]
                              ,[ getid := 0 ]
                              ];

  //test that right outer join with missing records should not return 'wrdid:' but just ''
  result := wrdperson->Enrich(joinwith, "GETID", [ wrd_guid := "WRD_GUID"], [ rightouterjoin := TRUE ]);
  TestEq(3,Length(result));
  TestEq("",result[1].wrd_guid,'returned "wrd:" for missing refs earlier');

  result := wrdperson->Enrich(joinwith, "GETID", outputcols, [ rightouterjoin := TRUE ]);
  TestEq(expectinner, result);

  result := wrdperson->Enrich(joinwith, "GETID", outputcols, [ rightouterjoin := TRUE, leftouterjoin := CELL[] ]);

  RECORD ARRAY expectouter := expectinner CONCAT (SELECT getid,email,firstname FROM allitems WHERE getid NOT IN [p1,p_gone,0]);
  TestEq(expectouter,result);

  result := wrdperson->Enrich([[ getid := 0 ]
                              ], "GETID"
                              , outputcols
                              , [ rightouterjoin := TRUE ]);

  TestEq( [[ getid := 0, email := "", firstname := ""]
          ], result);

  //Using enrichment to enrich domain values
  OBJECT domvaltype := schemaobj->GetTypeByTag("TEST_DOMAIN_1");
  RECORD ARRAY base := SELECT * FROM wrdperson->RunQuery([ outputcolumns := [ id := "WRD_ID", test_single_domain := "TEST_SINGLE_DOMAIN" ]
                                                         , filters := [[ field := "WRD_ID", matchtype := "IN", value := [p1, p2] ]
                                                                      ]
                                                         ]) ORDER BY id;
  result := domvaltype->Enrich(base, "TEST_SINGLE_DOMAIN", [ x := "WRD_TITLE" ]);
  TestEq(1, Length(result));
  TestEq("Domain value 1.2", result[0].x);

  result := domvaltype->Enrich(base, "TEST_SINGLE_DOMAIN", [ test_single_domain := "WRD_TITLE" ]);

  TestEq(1, Length(result));
  TestEq("Domain value 1.2", result[0].test_single_domain);

  result := domvaltype->Enrich(base, "TEST_SINGLE_DOMAIN", [ test_single_domain := "WRD_TITLE" ], [rightouterjoin := TRUE]);

  TestEq(2, Length(result));
  TestEq("Domain value 1.2", result[0].test_single_domain);
  TestEq("", result[1].test_single_domain); //should be defaulted
  //ABORT(result,'boxed');

  testfw->RollbackWork();
}

MACRO TestWRDQuery()
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");
  INTEGER personid := wrdperson->CreateEntity2([ wrd_lastname := "QueryTest" ])->id;
  RECORD ARRAY results;

  OBJECT person := wrdperson->GetEntity(personid);
  TestEq(TRUE, ObjectExists(person));

  person->UpdateFields([ wrd_contact_email := "Test123@example.com" ]);

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , name := "" //empty name shouldn't crash it, but be treated like an anonymous name
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , value := "test123@example.com"
                                          , match_case := FALSE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq(DEFAULT RECORD ARRAY, RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , value := "test123@example.com"
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , value := "Test123@example.com"
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "LIKE"
                                          , value := "test123@example.com"
                                          , match_case := FALSE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq(DEFAULT RECORD ARRAY, RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "LIKE"
                                          , value := "test123@example.com"
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "LIKE"
                                          , value := "Test123@example.com"
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "LIKE"
                                          , value := "test*"
                                          , match_case := FALSE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq(DEFAULT RECORD ARRAY, RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "LIKE"
                                          , value := "test*"
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "LIKE"
                                          , value := "Test*"
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "IN"
                                          , value := [ "test123@example.com" ]
                                          , match_case := FALSE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq(DEFAULT RECORD ARRAY, RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "IN"
                                          , value := [ "test123@example.com" ]
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "IN"
                                          , value := [ "a", "Test123@example.com" ]
                                          , match_case := TRUE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n := "QueryTest" ] ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME" ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , match_type := "IN"
                                          , value := [ "a", "Test123@example.com" ]
                                          , match_case := FALSE
                                          ]
                                        ]
                          ]
                        ]
      ]));

  //test de-duplication
  INTEGER ARRAY lots_of_ids;
  FOR(INTEGER i:=0;i<2048;i:=i+1)
    INSERT personid INTO lots_of_ids AT END;

  RECORD ARRAY inquery := wrdperson->RunQUery( [ outputcolumns := [ id := "WRD_ID" ]
                                               , filters := [[ field := "WRD_ID", matchtype := "IN", value := lots_of_ids ]]
                                               ]);
  TestEq([[id := personid]], inquery);

  testfw->CommitWork();
}

MACRO TestWRDQuery_AfterFilters()
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");
  INTEGER personid := wrdperson->CreateEntity2(
      [ wrd_lastname := "QueryTest"
      , test_integer := -1
      ])->id;

  INTEGER ARRAY results;

  results := SELECT AS INTEGER ARRAY wrd_id FROM wrdperson->RunQuery(
      [ outputcolumns := [ "WRD_ID", "TEST_INTEGER" ]
      , filters := [ [ field := "TEST_INTEGER", match_type := "IN", value := [ 0, 1 ] ] ]
      ]);
  TestEQ(FALSE, personid IN results);

  results := SELECT AS INTEGER ARRAY wrd_id FROM wrdperson->RunQuery(
      [ outputcolumns := [ "WRD_ID", "TEST_INTEGER" ]
      , filters := [ [ field := "TEST_INTEGER", match_type := "IN", value := [ -1, 0 ] ] ]
      ]);
  TestEQ(TRUE, personid IN results);

  results := SELECT AS INTEGER ARRAY wrd_id FROM wrdperson->RunQuery(
      [ outputcolumns := [ "WRD_ID", "TEST_INTEGER" ]
      , filters := [ [ field := "TEST_INTEGER", match_type := "IN", value := [ 0 ] ] ]
      ]);
  TestEQ(FALSE, personid IN results);

  testfw->CommitWork();
}


MACRO TestWRDQuery_Password()
{
  testfw->BeginWork();
  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT persontype := schemaobj->GetTypeByTag("WRD_PERSON");

  INTEGER nopwd := persontype->CreateEntity2( [ wrd_contact_email := "nopwd@example.net", test_password := "" ])->id;
  INTEGER testpwd := persontype->CreateEntity2( [ wrd_contact_email := "testpwd@example.net", test_password := CreateWebHarePasswordHash("test") ])->id;
  INTEGER secretpwd := persontype->CreateEntity2( [ wrd_contact_email := "secretpwd@example.net", test_password := CreateWebHarePasswordHash("secret") ])->id;

  RECORD ARRAY results;
  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID" ]
                                   , filters := [[ field := "TEST_PASSWORD", value := "test"]]
                                   ]);
  TestEq(1, Length(results));
  TestEq(testpwd, results[0].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID" ]
                                   , filters := [[ field := "TEST_PASSWORD", value := ""]]
                                   ]);
  TestEq(1, Length(SELECT FROM results WHERE id IN [nopwd]));
  TestEq(0, Length(SELECT FROM results WHERE id IN [testpwd,secretpwd]));

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID" ]
                                   , filters := [[ field := "TEST_PASSWORD", match_type := "!=", value := ""]]
                                   ]);
  TestEq(2, Length(results));
  TestEq(1, Length(SELECT FROM results WHERE id IN [secretpwd]));
  TestEq(2, Length(SELECT FROM results WHERE id IN [testpwd,secretpwd]));

  testfw->CommitWork();
}

MACRO TestWRDQuery_ContainsAndMDEqual()
{
  testfw->BeginWork();
  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT persontype := schemaobj->GetTypeByTag("WRD_PERSON");

  //We still have  domainattr8: persontype->CreateAttribute("DOMAIN_MULTIPLE", "Multiple attribute", "", "TEST_MULTIPLE_DOMAIN", domain2_obj->tag);
  // possible domain values TEST_DOMAINVALUE_2_1, TEST_DOMAINVALUE_2_2 and TEST_DOMAINVALUE_2_3
  INTEGER dval2_1 := persontype->GetDomVal("TEST_MULTIPLE_DOMAIN", "TEST_DOMAINVALUE_2_1");
  INTEGER dval2_2 := persontype->GetDomVal("TEST_MULTIPLE_DOMAIN", "TEST_DOMAINVALUE_2_2");
  INTEGER dval2_3 := persontype->GetDomVal("TEST_MULTIPLE_DOMAIN", "TEST_DOMAINVALUE_2_3");
  TestEq(TRUE, dval2_1!=0);
  TestEq(TRUE, dval2_2!=0);
  TestEq(TRUE, dval2_3!=0);

  INTEGER t      := persontype->CreateEntity2( [ wrd_contact_email := "t@example.net", test_multiple_domain := DEFAULT INTEGER ARRAY])->id;
  INTEGER t1     := persontype->CreateEntity2( [ wrd_contact_email := "t1@example.net", test_multiple_domain := [ dval2_1,dval2_1 ]])->id;
  INTEGER t1_2   := persontype->CreateEntity2( [ wrd_contact_email := "t1_2@example.net" ])->id;
  INTEGER t1_2_3 := persontype->CreateEntity2( [ wrd_contact_email := "t1_2_3@example.net", test_multiple_domain := [ dval2_1, dval2_2, dval2_3 ]])->id;

  persontype->GetEntity(t1_2)->UpdateFields2([ test_multiple_domain := [ "TEST_DOMAINVALUE_2_1", "TEST_DOMAINVALUE_2_2", "TEST_DOMAINVALUE_2_1" ] ]);

  TestEq([dval2_1],                 SortArray(persontype->GetEntity(t1)->GetField("TEST_MULTIPLE_DOMAIN")));
  TestEq([dval2_1,dval2_2],         SortArray(persontype->GetEntity(t1_2)->GetField("TEST_MULTIPLE_DOMAIN")));
  TestEq([dval2_1,dval2_2,dval2_3], SortArray(persontype->GetEntity(t1_2_3)->GetField("TEST_MULTIPLE_DOMAIN")));

  RECORD ARRAY results;
  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "CONTAINS", value := dval2_2 ]]
                                   ]);
  results := SELECT * FROM results ORDER BY email;
  TestEq(2,Length(results));
  TestEq(t1_2,results[0].id);
  TestEq(t1_2_3,results[1].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "CONTAINS", value := dval2_3 ]]
                                   ]);
  results := SELECT * FROM results ORDER BY email;
  TestEq(1,Length(results));
  TestEq(t1_2_3,results[0].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "CONTAINS", value := dval2_3 ]]
                                   ]);
  results := SELECT * FROM results ORDER BY email;
  TestEq(1,Length(results));
  TestEq(t1_2_3,results[0].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "INTERSECTS", value := [dval2_2,dval2_3] ]]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;

  TestEq(2,Length(results));
  TestEq(t1_2,results[0].id);
  TestEq(t1_2_3,results[1].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "=", value := DEFAULT INTEGER ARRAY ]]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(1,Length(results));
  TestEq(t,results[0].id);

  // it shouldn't matter whether we look for 'dval2_2, dval2_1' or 'dval2_1, dval2_2'
  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "=", value := [  dval2_2, dval2_1 ] ]
                                                ]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(1,Length(results));
  TestEq(t1_2,results[0].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "=", value := [  dval2_1, dval2_2] ]
                                                ]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(1,Length(results));
  TestEq(t1_2,results[0].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "!=", value := [  dval2_2, dval2_1 ] ]
                                                ]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(3,Length(results));
  TestEq(t1,results[0].id);
  TestEq(t1_2_3,results[1].id);
  TestEq(t,results[2].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "!=", value := [  dval2_1 , dval2_2] ]
                                                ]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(3,Length(results));
  TestEq(t1,results[0].id);
  TestEq(t1_2_3,results[1].id);
  TestEq(t,results[2].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "=", value := [ dval2_1 ]]]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(1,Length(results));
  TestEq(t1,results[0].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "!=", value := DEFAULT INTEGER ARRAY ]]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(3,Length(results));
  TestEq(t1,results[0].id);
  TestEq(t1_2,results[1].id);
  TestEq(t1_2_3,results[2].id);

  results := persontype->RunQuery( [ outputcolumns := [ id := "WRD_ID", email := "WRD_CONTACT_EMAIL", domvals := "TEST_MULTIPLE_DOMAIN" ]
                                   , filters := [[ field := "TEST_MULTIPLE_DOMAIN", matchtype := "!=", value := [ dval2_1 ]]]
                                   ]);
  results := SELECT * FROM results WHERE id IN [ t, t1, t1_2, t1_2_3 ] ORDER BY email;
  TestEq(3,Length(results));
  TestEq(t1_2,results[0].id);
  TestEq(t1_2_3,results[1].id);
  TestEq(t,results[2].id);

  testfw->CommitWork();
}

MACRO TestWRDQuery_DeepOutputColumns()
{
  testfw->BeginWork();

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");
  OBJECT wrdrelation := schemaobj->GetTypeByTag("WRD_RELATION");
  INTEGER personid := wrdperson->CreateEntity2([ wrd_firstname := "Deep", wrd_lastname := "Test", wrd_contact_email := "deeptest@example.com" ])->id;

  OBJECT person := wrdperson->GetEntity(personid);
  person->UpdateFields([ personlink := personid, relationlink := personid ]);

  TestEq(TRUE, ObjectExists(person));

  TestEq([ [ n := "Test"
           , d := [ fn:="Deep",ln:="Test",email:="deeptest@example.com"] ]
         ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , outputcolumns := [ n := "WRD_LASTNAME", d := [ fn := "WRD_FIRSTNAME", ln := "WRD_LASTNAME", email := "WRD_CONTACT_EMAIL" ] ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , value := "deeptest@example.com"
                                          ]
                                        ]
                          ]
                        ]
      ]));

  TestEq([ [ n1 := "Test"
           , n2 := "Test"
           , d1 := [ fn:="Deep",ln:="Test",email:="deeptest@example.com"]
           , d2 := [ fn:="Deep",ln:="Test",email:="deeptest@example.com"]
           ]
         ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , name :=     "left"
                          , outputcolumns := [ n1 := "WRD_LASTNAME", d1 := [ fn := "WRD_FIRSTNAME", ln := "WRD_LASTNAME", email := "WRD_CONTACT_EMAIL" ] ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , value := "deeptest@example.com"
                                          ]
                                        ]
                          ]
                        , [ type :=     wrdperson
                          , name :=     "right"
                          , outputcolumns := [ n2 := "WRD_LASTNAME", d2 := [ fn := "WRD_FIRSTNAME", ln := "WRD_LASTNAME", email := "WRD_CONTACT_EMAIL" ] ]
                          ]
                        ]
      , links :=        [ [ left :=     "left"
                          , right :=    "right"
                          , field :=    "PERSONLINK"
                          ]
                        ]
      ]));

  TestEq([ [ n1 := "Test"
           , rightfullname := "Deep Test"
           , d1 := [ fn:="Deep",ln:="Test",email:="deeptest@example.com"]
           ]
         ], RunWRDQuery(
      [ sources :=      [ [ type :=     wrdperson
                          , name :=     "left"
                          , outputcolumns := [ n1 := "WRD_LASTNAME", d1 := [ fn := "WRD_FIRSTNAME", ln := "WRD_LASTNAME", email := "WRD_CONTACT_EMAIL" ] ]
                          , filters :=  [ [ field := "WRD_CONTACT_EMAIL"
                                          , value := "deeptest@example.com"
                                          ]
                                        ]
                          ]
                        , [ type :=     wrdrelation
                          , name :=     "right"
                          , outputcolumns := [ rightfullname := "WRD_TITLE"  ]
                          ]
                        ]
      , links :=        [ [ left :=     "left"
                          , right :=    "right"
                          , field :=    "RELATIONLINK"
                          ]
                        ]
      ]));

  testfw->CommitWork();

}

MACRO TestWRDQuery_Mentions_Single()
{
  testfw->BeginWork();

  /* FIXME
     test mentions 0
     */

  OBJECT schemaobj := OpenWRDSchema(testfw->GetWRDSchema()->id);
  OBJECT wrdperson := schemaobj->GetTypeByTag("WRD_PERSON");
  INTEGER dom11 := wrdperson->GetDomVal("TEST_ARRAY.TEST_SINGLE", "TEST_DOMAINVALUE_1_1");
  INTEGER dom12 := wrdperson->GetDomVal("TEST_ARRAY.TEST_SINGLE", "TEST_DOMAINVALUE_1_2");
  INTEGER dom13 := wrdperson->GetDomVal("TEST_ARRAY.TEST_SINGLE", "TEST_DOMAINVALUE_1_3");

  TestEq(FALSE, dom11 = 0);
  TestEq(FALSE, dom12 = 0);
  TestEq(FALSE, dom13 = 0);

  //simple test account
  INTEGER person1id := wrdperson->CreateEntity2([ wrd_firstname := "Mentions1"
                                               , wrd_lastname := "Test"
                                               , wrd_contact_email := "mentionstest1@example.com"
                                               , test_array := [[ test_single := dom11 ]
                                                               ,[ test_single := dom13 ]
                                                               ]
                                               ])->id;

  //one with multiple occurrences, which may only be returned once
  INTEGER person2id := wrdperson->CreateEntity2([ wrd_firstname := "Mentions2"
                                               , wrd_lastname := "Test"
                                               , wrd_contact_email := "mentionstest2@example.com"
                                               , test_array := [[ test_single := dom11 ]
                                                               ,[ test_single := dom11 ]
                                                               ,[ test_single := dom11 ]
                                                               ,[ test_single := dom11 ]
                                                               ]
                                               ])->id;

  //person with only dom12
  OBJECT person3 := wrdperson->CreateEntity2([ wrd_firstname := "Mentions3"
                                             , wrd_lastname := "Test"
                                             , wrd_contact_email := "mentionstest3@example.com"
                                             , wrd_creationdate := MakeDate(2014,1,1)
                                             ]);
  person3->UpdateFields([ test_array := [[ test_single := dom12
                                         , test_single_other := dom11  //setting this attribute to prove that MENTIONS actually looked at the proper attribute
                                         ]
                                        ]]);

  //person with both
  INTEGER person4id := wrdperson->CreateEntity2([ wrd_firstname := "Mentions4"
                                               , wrd_lastname := "Test"
                                               , wrd_contact_email := "mentionstest4@example.com"
                                               , test_array := [[ test_single := dom11 ]
                                                               ,[ test_single := dom12 ]
                                                               ]
                                               ])->id;


  TestThrowsLike("*", PTR RunWRDQuery([ sources := [[ type := wrdperson
                                                   , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                                   , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "=", value := dom11 ]
                                                                ]
                                                  ]]
                                     ]));

  RECORD ARRAY result := RunWRDQuery([ sources := [[ type := wrdperson
                                                   , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                                   , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "MENTIONS", value := dom11 ]
                                                                ]
                                                  ]]
                                     ]);
  result := SELECT * FROM result ORDER BY fn;
  TestEq([[fn := "Mentions1" ],[fn := "Mentions2" ],[fn := "Mentions4" ]], result);

  TestThrowsLike("*", PTR RunWRDQuery([ sources := [[ type := wrdperson
                                           , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                           , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "MENTIONS", value := 0 ]
                                                         ]
                                           ]]
                             ]));

  result := RunWRDQuery([ sources := [[ type := wrdperson
                                                   , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                                   , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "MENTIONS", value := dom12 ]
                                                                ]
                                                  ]]
                                     ]);
  result := SELECT * FROM result ORDER BY fn;
  TestEq([[fn := "Mentions3" ],[fn := "Mentions4" ]], result);

  result := RunWRDQuery([ sources := [[ type := wrdperson
                                                   , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                                   , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "MENTIONSANY", value := [dom12] ]
                                                                ]
                                                  ]]
                                     ]);
  result := SELECT * FROM result ORDER BY fn;
  TestEq([[fn := "Mentions3" ],[fn := "Mentions4" ]], result);

  result := RunWRDQuery([ sources := [[ type := wrdperson
                                                   , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                                   , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "MENTIONSANY", value := [dom11,dom12] ]
                                                                ]
                                                  ]]
                                     ]);
  result := SELECT * FROM result ORDER BY fn;
  TestEq([[fn := "Mentions1" ],[fn := "Mentions2" ],[fn := "Mentions3" ],[fn := "Mentions4" ]], result);

  // Bug: array elements closed will still be picked up for mentions
  OBJECT person4 := wrdperson->GetEntity(person4id);
  person4->UpdateFields(
      [ test_array := DEFAULT RECORD ARRAY
      ]);

  result := RunWRDQuery([ sources := [[ type := wrdperson
                                      , outputcolumns := [ fn := "WRD_FIRSTNAME" ]
                                      , filters := [[ field := "TEST_ARRAY.TEST_SINGLE", matchtype := "MENTIONSANY", value := [dom12] ]
                                                   ]
                                     ]]
                       ]);
  result := SELECT * FROM result ORDER BY fn;
  TestEq([[fn := "Mentions3" ]], result);

  // Mentions of FREE attribute
  person3->UpdateFields([ test_array := [ [ test_free := "1" ], [ test_free := "2" ], [ test_free := "1" ] ] ]);
  TestEQ([ [ wrd_id := person3->id ] ], wrdperson->RunQuery(
      [ outputcolumns := [ "WRD_ID" ]
      , filters := [ [ field := "TEST_ARRAY.TEST_FREE", matchtype := "MENTIONS", value := "1" ]]
      ]));

  // Search for non-existing values
  person3->UpdateFields([ test_array := [ [ test_free := "1" ], [ test_free := "2" ] ] ]);
  TestEQ(DEFAULT RECORD ARRAY, wrdperson->RunQuery(
      [ outputcolumns := [ "WRD_ID" ]
      , filters := [ [ field := "TEST_ARRAY.TEST_FREE", matchtype := "MENTIONS", value := "3" ]]
      ]));

  testfw->CommitWork();
}


RunTestframework([ PTR CreateWRDTestSchema
                 , PTR TestAddress
                 , PTR TestSchema
                 , PTR TestGenderDomain
                 , PTR ImageCache
                 , PTR RichDoc
                 , PTR RichDocEmbed
                 , PTR TestAttributes("WRD_PERSON")
                 , PTR TestAttributes("WRD_ORGANIZATION")
                 , PTR TestAttributes("TEST_DOMAIN_1")
                 , PTR TestHistoryMode

                 , PTR TestEnrichBulk

                 , PTR TestWRDQuery
                 , PTR TestWRDQuery_AfterFilters
                 , PTR TestWRDQuery_Password
                 , PTR TestWRDQuery_ContainsAndMDEqual
                 , PTR TestWRDQuery_Mentions_Single
                 , PTR TestWRDQuery_DeepOutputColumns
                 ], [ wrdauth := FALSE ]);
