<?wh
LOADLIB "wh::datetime.whlib";
LOADLIB "wh::datetime.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::tollium/lib/testframework.whlib";

MACRO InputValidations()
{
  OBJECT scr := GetTestController()->LoadScreen("webhare_testsuite:tests/basecomponents.inputvalidations");
  OBJECT work;

  FOREVERY(STRING check FROM ["url"])
  {
    scr->textedit->validationchecks := [ STRING (check) ];
    FOREVERY(RECORD mask FROM [ [ value := ":www.b-lex.nl",               acceptin := DEFAULT STRING ARRAY ]
                              , [ value := "http:www.b-lex.nl",           acceptin := DEFAULT STRING ARRAY ]
                              , [ value := "http:/www.wilminktheater.nl", acceptin := DEFAULT STRING ARRAY ]
                              , [ value := "//www.wilminktheater.nl",     acceptin := DEFAULT STRING ARRAY ]
                              , [ value := "http://www.b-lex.nl/",        acceptin := ["url"  ] ]
                              , [ value := "http://www.b-lex.nl/" || RepeatText("1", 2001-20), acceptin := DEFAULT STRING ARRAY ]
                              ])
    {
      scr->textedit->value := mask.value;
      work := scr->BeginFeedback();
      TestEq(check NOT IN mask.acceptin, work->HasFailed());
      work->Cancel();
    }
  }
}

MACRO SetValue(OBJECT prop, VARIANT toset)
{
  prop->value := toset;
}

MACRO DateTimeClamping() //test precision clamping
{
  OBJECT scr := GetTestController()->LoadScreen("webhare_testsuite:tests/basecomponents.datetimetest");

  TestEq(DEFAULT DATETIME, scr->bigdt->value, "bigdt = MAX_DATETIME"); //was never initted to max_datetime
  SetValue(scr->bigdt, MakeDatetime(1234567,8,13,23,59,57));
  TestEq(MakeDatetime(9999,8,13,23,59,57), scr->bigdt->value);

  TestThrowslike('Cannot represent*MAX_DATETIME*',PTR SetValue(scr->bigdt, MAX_DATETIME)); //only acceptable if value = max_datetime

  TestEq(MakeDate(2009,8,13), scr->da1->value);
  TestEq(MakeDateTime(2009,8,13,8,9,0), scr->dt1->value);
  TestEq(MakeDateTime(2009,8,13,8,9,18), scr->dt2->value);
  TestEq(AddTimeToDate(189,MakeDateTime(2009,8,13,8,9,18)), scr->dt3->value);

  TestEq(MakeDateTime(2009,8,13,8,9,0), scr->ti1->value);
  TestEq(MakeDateTime(2009,8,13,8,9,18), scr->ti2->value);
  TestEq(AddTimeToDate(189,MakeDateTime(2009,8,13,8,9,18)), scr->ti3->value);

  TestEq( (8*60 + 9) * 60 * 1000, scr->ti4->value);
  TestEq( ((8*60 + 9) * 60 + 18) * 1000, scr->ti5->value);
  TestEq( ((8*60 + 9) * 60 + 18) * 1000 + 189, scr->ti6->value);

  TestEq(MAX_DATETIME, scr->maxdt->value, "maxdt != MAX_DATETIME");
}

MACRO DateTimeLocalTZValue()
{
  testfw->SetTestUser("sysop");
  OBJECT scr := GetTestController()->LoadScreen("webhare_testsuite:tests/basecomponents.datetimetest");

  TestEq(DEFAULT DATETIME, scr->bigdt->value, "bigdt = MAX_DATETIME"); //was never initted to max_datetime
  SetValue(scr->bigdt, MakeDatetime(2020,5,11,9,0,0));
  TestEq(MakeDatetime(2020,5,11,9,0,0), scr->bigdt->value);
  TestEq(MakeDatetime(2020,5,11,9,0,0), scr->bigdt->localtzvalue);
  scr->bigdt->storeutc := TRUE;
  TestEq(MakeDatetime(2020,5,11,11,0,0), scr->bigdt->localtzvalue);
  scr->bigdt->localtzvalue := MakeDatetime(2020,5,11,12,0,0);
  TestEq(MakeDatetime(2020,5,11,12,0,0), scr->bigdt->localtzvalue);
  TestEq(MakeDatetime(2020,5,11,10,0,0), scr->bigdt->value);
  scr->bigdt->value := MakeDatetime(2020,5,11,9,0,0);
  TestEq(MakeDatetime(2020,5,11,11,0,0), scr->bigdt->localtzvalue);
}

MACRO TestBasicFieldsRegressions()
{
  //detect textedit incorrectly parsing XML given value using user personal settings
  GetTestController()->tolliumuser->decimalseparator:=",";
  GetTestController()->tolliumuser->thousandseparator:=".";
  OBJECT scr := GetTestController()->LoadScreen("webhare_testsuite:tests/regressions.basicfields");
  TestEq(5.0m, scr->moneyeditpoint->value);
  TestEq(5.0f, scr->floateditpoint->value);
  TestEq(50m, scr->moneyeditcomma->value);
  TestEq(50f, scr->floateditcomma->value);
}

ASYNC MACRO TestTextField()
{
  //also test linefeed handling (although this is also more a bit of clarification: it's not us but it's XML that gets rid of any non-&#10; break - https://www.w3.org/TR/xml/#AVNormalize)
  AWAIT ExpectScreenChange(+1, PTR GetTestController()->RunScreen(InlineScreens(`
    <screen name="test" implementation="none">
      <body>
        <text name="text1" value="this &lt;b>is&lt;/b> text

now lf:&#10;next line" />
        <text name="text2" htmlvalue="this &lt;b>is&lt;/b> text &#60;p>no para&#60;/p>" />
        <text name="text3" valuetid="webhare_testsuite:test.richtext" />
      </body>
    </screen>`)));

  TestEq("this <b>is</b> text  now lf:\nnext line", TT("text1")->value);
  TestEq("this &#60;b&#62;is&#60;/b&#62; text  now lf:<br />next line", TT("text1")->htmlvalue);

  TestEq("this is text no para", TT("text2")->value);
  TestEq("this <b>is</b> text no para", TT("text2")->htmlvalue,"verify <P> was completely ignored");

  TestEq("Dit is bold\nvolgende\nregel", TT("text3")->value);
  TestEq("Dit is <b>bold</b><br />volgende<br />regel", TT("text3")->htmlvalue);

  TT("text3")->htmlvalue := `Hey <a href="a&b">click</a> this!`;
  TestEq("Hey click this!", TT("text3")->value);
  TestEq(`Hey <a href="a&#38;b">click</a> this!`, TT("text3")->htmlvalue);

  AWAIT ExpectScreenChange(-1, PTR TTEscape);
}

Runtestframework( [ PTR InputValidations
                  , PTR DateTimeClamping
                  , PTR DateTimeLocalTZValue
                  , PTR TestBasicFieldsRegressions
                  , PTR TestTextField
                  ], [ testusers := [[ login := "sysop", grantrights := ["system:sysop"]]]
                  ]);
