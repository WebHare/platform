<?wh
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::tollium/lib/screenbase.whlib";
LOADLIB "mod::tollium/lib/testframework.whlib";
LOADLIB "mod::webhare_testsuite/lib/screens/tests/tabextensions.whlib";

ASYNC MACRO TestTabExtensions()
{
  AWAIT ExpectScreenChange(+1, PTR TTLaunchApp("webhare_testsuite:runscreen", [ params := [ "tests/tabextensions.test" ]]));
  TestEq(DEFAULT OBJECT, topscreen->parentscope);

  //this test will fail because the childnodes look wrong (incorrect namespace), so it's not proving anything about the lookup..
  RECORD loadinfo := topscreen->^tabs->LoadTabsExtension(`mod::webhare_testsuite/data/test/tollium/extensions.xml#tabsextension`);

  TestEQ(TRUE, loadinfo.fragment EXTENDSFROM TolliumTabsExtensionBase);

  OBJECT comp := SELECT AS OBJECT obj FROM ToRecordArray(loadinfo.components,"obj") AS objs WHERE objs.obj->name LIKE "*beschikbaarheid";
  TestEq('Beschikbaarheid',comp->title);
  topscreen->^tabs->RemoveTabsExtension(loadinfo);

  // Load extension with code
  TTClick("loadextension2");
  GetTestController()->GrabInstructions();

  TestEQ(TRUE, topscreen->loadinfo.fragment EXTENDSFROM ExtensionWithCode);
  TestEQ(topscreen->^tabs, got_tabs, "Tab extension should have its InitExtension method called");

  TestEq(TRUE, TTIsVisible(":addition"), "we should be able to find the textfield 'addition' generated by the intextlink");

  topscreen->^tabs->RemoveTabsExtension(topscreen->loadinfo);

  AWAIT ExpectScreenChange(-1, PTR TTEscape);
}

RunTestFramework( [ PTR TestTabExtensions
                  ], [ testusers :=
                       [ [ login := "sysop", grantrights := [ "system:sysop" ] ]
                       ]
                     ]);
