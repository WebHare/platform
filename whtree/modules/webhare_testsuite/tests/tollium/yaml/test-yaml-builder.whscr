<?wh

LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::tollium/lib/testframework.whlib";
LOADLIB "mod::tollium/lib/yamlcomponents.whlib";

ASYNC MACRO TestYamlInlineScreens()
{
  AWAIT ExpectScreenChange(+1, PTR RunYamlInlineScreen(GetTestController(),
     CELL[ body_lines :=
           [[ textedit :=
               [ title := "My textedit", value := "Hello, world!" ]]]
         ]));

  TestEq("Hello, world!", TT(":My textedit")->value);

  AWAIT ExpectScreenChange(-1, PTR TTEscape);
}

ASYNC MACRO TestConditions()
{
  AWAIT ExpectScreenChange(+1, PTR RunYamlScreen(GetTestController(), Resolve("data/basics.screens.yml#conditions")));

  TestEq(TRUE, TT(":Text edit")->AllowExternalUpdates());
  TestEq(TRUE, TT("cb_text_edit")->value);
  TT("cb_text_edit")->value := FALSE;
  TestEq(FALSE, TT(":Text edit")->AllowExternalUpdates());

  //Verify events
  TestEq("showtime-set", TT(":Events")->value, "showtime-set should have fired for screen init, even if no explicit value was set");
  TestEq(FALSE, TT("c_box")->value);
  TT("c_box")->value := TRUE;

  TestEq("showtime-set, showtime-set", TT(":Events")->value);

  //TOOD test corner cases where a field, during init, sets a future or past field. ensure that enough OnSets get fired

  AWAIT ExpectScreenChange(-1, PTR TTEscape);
}

RuntestFramework([
  PTR TestYamlInlineScreens,
  PTR TestConditions
  ]);
