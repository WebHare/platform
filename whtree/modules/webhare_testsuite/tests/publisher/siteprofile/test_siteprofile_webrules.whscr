<?wh
LOADLIB "wh::files.whlib";
LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

PUBLIC MACRO SetupSite()
{

  testfw->BeginWork();

  OBJECT testroot := GetTestsuiteTempFolder();

  OBJECT site2_subfolder := testroot->CreateFolder([name := "sub2"]);
  site2_subfolder->CreateFile([name:="x.html", data := StringToBlob("Een <b>test</b> pagina"), publish := TRUE, type := 5 ]);
  testfw->CommitWork();
  testfw->WaitForPublishCompletion(site2_subfolder->id);

  testfw->RefreshWebserverConfig(); //FIXME this should be done implicitly (automatically run on CommitWork), but how to properly wait for it ?

  testfw->browser->debug:=true;
  TestEq(TRUE, testfw->browser->GotoWebpage(testroot->objecturl || "subsub2/x.html"), testfw->browser->url);
  TestEq(FALSE, testfw->browser->GotoWebpage(testroot->objecturl || "sub3/x.html"), testfw->browser->url);

  TestEq(FALSE, testfw->browser->GotoWebpage(testroot->objecturl || "secret/x.html"), testfw->browser->url);
  TestEq(401, testfw->browser->GetHTTPStatusCode(), testfw->browser->url);
  testfw->browser->SetPassword(testroot->objecturl, "service","test");
  TestEq(FALSE, testfw->browser->GotoWebpage(testroot->objecturl || "secret/x.html"), testfw->browser->url);
  TestEq(401, testfw->browser->GetHTTPStatusCode(), testfw->browser->url);
  testfw->browser->SetPassword(testroot->objecturl, "service","protected");
  TestEq(TRUE, testfw->browser->GotoWebpage(testroot->objecturl || "secret/x.html"), testfw->browser->url);
}


RunTestFramework( [ PTR SetupSite
                  ],
                  [ relativeoutputfolders := TRUE //ensure config.whlib understands prefixing output folders
                  ]);
