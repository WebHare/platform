<?wh

LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::publisher/lib/forms/api.whlib";
LOADLIB "mod::publisher/lib/siteprofiles.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";
LOADLIB "mod::webhare_testsuite/lib/internal/testsite.whlib";

MACRO TestCoreFormAPI()
{
  OBJECT testfile := OpenTestsuiteSite()->OpenBypath("testpages/formtest");
  OBJECT webdesign := GetWebDesign(testfile->id);
  OBJECT coreform := webdesign->OpenForm("coretest", [ formref := "CORE-TEST-FORM"]);

  // this textedit has no value=""
  TestEq(0,coreform->^number->value);
  TestEq('',coreform->^number->textvalue);
  TestEq('', coreform->^number->__GetRenderData().value);
  TestEq(0, coreform->^number->GetRenderTree().value);
  TestEq('', coreform->^number->GetRenderTree().textvalue);

  // assigning the same value shouldn't set it
  TestEq(0,coreform->^number->value);
  TestEq('',coreform->^number->textvalue);
  TestEq('',coreform->^number->__GetRenderData().value);
  TestEq(0, coreform->^number->GetRenderTree().value);
  TestEq('', coreform->^number->GetRenderTree().textvalue);

  // this textedit value="0" emptyvalue=0" does set a textvale
  TestEq('0',coreform->^numberemptyvalue->textvalue);
  //and SHOULD be fowarded for consistency (we didn't do this up to 4.35.1)
  TestEq('0',coreform->^numberemptyvalue->__GetRenderData().value);
  TestEq(0, coreform->^numberemptyvalue->GetRenderTree().value);
  TestEq('0', coreform->^numberemptyvalue->GetRenderTree().textvalue);

  TestEq(FALSE, coreform->^number->emptyvalueisset);
  TestEq(0, coreform->^number->emptyvalue);

  TestEq(TRUE, coreform->^numberemptyvalue->emptyvalueisset);
  TestEq(0, coreform->^numberemptyvalue->emptyvalue);
  coreform->^numberemptyvalue->emptyvalue := -3;
  TestEq(-3, coreform->^numberemptyvalue->emptyvalue);

  TestEq('0',coreform->^numberemptyvalue->textvalue);
}

MACRO FormApitest()
{
  RECORD res := BuildCustomWebtoolForm2( [ addgtmdatalayer := "muhdata", addtslinecomp := TRUE, addtslinecompascustom := TRUE, addcheckboxfield := TRUE, addaddressfield := TRUE,checkboxes := TRUE, checkboxfieldconditions := FALSE, setmailresultsfields := TRUE, checkboxsubs := TRUE, addconditions := TRUE]);

  OBJECT formdefs := OpenWHFSFormDefinitionsFile(res.formfile);
  OBJECT formdef := formdefs->OpenFormDefinition("webtoolform");
  OBJECT formpage := formdef->GetPage(0);

  TestEq(DEFAULT OBJECT, formpage->LookupComponent("doesnotexist"), "requesting nonexisting component should not crash");

  // Ensure duplicated questions are cleared from pins and name, and have a new guid
  OBJECT firstname := formpage->LookupComponent("firstname");
  TestEq(TRUE, ObjectExists(firstname));
  TestEq(TRUE, firstname->GetAttribute("tid") != "");

  OBJECT firstname2 := formpage->DuplicateComponent(firstname);
  TestEq(TRUE, ObjectExists(firstname2));
  TestEq(firstname->GetAttribute("tid"), firstname2->GetAttribute("tid"));
  TestEq(TRUE, firstname2->IsSameNode(firstname->nextelementsibling), "component should be inserted right next to its source");
  TestEq(firstname->GetAttribute("title"), firstname2->GetAttribute("title"), "title should be copied");
  TestEq(FALSE, firstname2->HasAttribute("pins"));
  TestEq(FALSE, firstname2->HasAttribute("name"));
  TestEq(TRUE, firstname->GetAttribute("guid") != firstname2->GetAttribute("guid"));

  // Ensure duplicated <option>s have their subquestions duplicated too, and properly reset
  OBJECT checkboxes := formpage->LookupComponent("checkboxes");
  OBJECT checkboxes_option0 := checkboxes->QuerySelector("option");
  TestEq(DEFAULT OBJECT, formpage->LookupComponent(checkboxes_option0->GetAttribute("guid")), "LookupComponent should not match options");
  TestEq(DEFAULT OBJECT, formpage->LookupComponent(checkboxes_option0->GetAttribute("rowkey")), "LookupComponent should not match options");

  OBJECT checkboxes_option1_textedit := checkboxes->QuerySelectorAll("option")->Item(2)->QuerySelector("textedit");

  OBJECT checkboxes2 := formpage->DuplicateComponent(checkboxes);
  OBJECT checkboxes2_option0 := checkboxes2->QuerySelector("option");
  TestEq(FALSE, checkboxes->GetAttribute("guid") = checkboxes2->GetAttribute("guid"));
  TestEq(checkboxes->QuerySelectorAll("option")->length, checkboxes2->QuerySelectorAll("option")->length);

  OBJECT checkboxes2_option1_textedit := checkboxes2->QuerySelectorAll("option")->Item(2)->QuerySelector("textedit");
  TestEq(TRUE, ObjectExists(checkboxes2_option1_textedit));
  TestEq(TRUE, checkboxes_option1_textedit->GetAttribute("guid") != checkboxes2_option1_textedit->GetAttribute("guid"));

  // Ensure conditions are duplicated (their GUID must be new)
  OBJECT checkboxes_option2 := checkboxes->QuerySelectorAll("option")->Item(2);
  OBJECT checkboxes2_option2 := checkboxes2->QuerySelectorAll("option")->Item(2);

  TestEq(TRUE, checkboxes_option2->GetAttribute("visibleconditionid") != checkboxes2_option2->GetAttribute("visibleconditionid"));
  TestEq(formdefs->GetConditionAttribute(checkboxes_option2, "visibleconditionid"), formdefs->GetConditionAttribute(checkboxes2_option2, "visibleconditionid") );
}

RunTestframework([ PTR TestCoreFormAPI
                 , PTR FormApitest
                 ]);
