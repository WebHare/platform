<?wh

LOADLIB "wh::internet/urls.whlib";

LOADLIB "mod::tollium/lib/testframework.whlib";

LOADLIB "mod::publisher/lib/dialogs.whlib";
LOADLIB "mod::publisher/lib/siteapi.whlib";

LOADLIB "mod::system/lib/testframework.whlib";


MACRO TestAppLayout()
{
  OBJECT pwasite := OpenSiteByName("webhare_testsuite.pwa");

  //Test whether an update is needed
  STRING application := pwasite->webroot || "pwatest/";
  TestEq(TRUE, testfw->browser->GotoWebPage(application));
  RECORD config := DecodeJSON(testfw->browser->document->GetElementById("wh-config")->textcontent);

  TestEq(TRUE, testfw->browser->GotoWebPage(ResolveToAbsoluteURL(pwasite->webroot, "/.publisher/common/pwa/getversion.shtml?apptoken=" || EncodeURL(config.obj.pwasettings.apptoken))));

  RECORD versioninfo := DecodeJSONBlob(testfw->browser->content);
  TestEq(TRUE, versioninfo.updatetok != "");

  TestEq(TRUE, testfw->browser->GotoWebPage(ResolveToAbsoluteURL(pwasite->webroot, "/.publisher/common/pwa/getversion.shtml?apptoken=" || EncodeURL(config.obj.pwasettings.apptoken) || "&updatetok=" || EncodeURL(versioninfo.updatetok))));
  RECORD versioninfo2 := DecodeJSONBlob(testfw->browser->content);
  TestEq(versioninfo.updatetok, versioninfo2.updatetok);

  TestEq(TRUE, testfw->browser->GotoWebPage(ResolveToAbsoluteURL(pwasite->webroot, "/.wh/ea/ap/platform.pwaserviceworker/ap.mjs")), "our overlay isn't there");
  TestEq("/", testfw->browser->GetResponseHeader("Service-Worker-Allowed"));
}

ASYNC MACRO TestProps()
{
  INTEGER pwa := OpenSiteByName("webhare_testsuite.pwa")->OpenByPath("pwatest")->id;
  AWAIT ExpectScreenChange(+1, PTR RunFSObjectPropertiesDialog(GetTestController(), pwa));

  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  testfw->WaitForPublishCompletion(pwa);
}


RunTestframework([ PTR TestAppLayout
                 , PTR TestProps
                 ], [ testusers := [[ login := "sysop", grantrights := ["system:sysop"]]]
                    ]);
