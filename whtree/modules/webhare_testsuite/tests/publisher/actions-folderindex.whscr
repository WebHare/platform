<?wh
LOADLIB "mod::publisher/lib/internal/actions.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/whfs.whlib";
LOADLIB "mod::tollium/lib/internal/support.whlib";
LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";


MACRO TestFolderIndex()
{
  testfw->BeginWork();

  OBJECT folder_contentlisting := GetTestsuiteTempFolder()->CreateFolder([name := "contentlisting" ]);
  AddDefaultIndexToFolder(folder_contentlisting->id);

  OBJECT indexfile := folder_contentlisting->OpenByName("index.html");
  TestEq(TRUE, ObjectExists(indexfile));
  TestEq(24, indexfile->type);
  TestEq(TRUE, indexfile->publish);

  OBJECT folder_newfile := GetTestsuiteTempFolder()->CreateFolder([name := "newfile" ]);
  TEstEQ(0, folder_newfile->indexdoc);
  AddDefaultIndexToFolder(folder_newfile->id);

  folder_newfile := OpenWHFSObject(folder_newfile->id);
  TEstEQ(TRUE, folder_newfile->indexdoc != 0);
  indexfile := OpenWHFSObject(folder_newfile->indexdoc);
  TestEq("http://www.webhare.net/xmlns/publisher/richdocumentfile", indexfile->typens);
  TestEq("index", indexfile->name);
  //Just like a contentindex is published by default, we'll assume you're doing this because you want new folders to appear by default, so create the index
  TestEq(TRUE, indexfile->publish);

  testfw->RollbackWork();

  testfw->BeginWork();
  OBJECT foreignfolder_newfile := GetTestsuiteTempFolder()->CreateFolder([name := "newfile", typens := "http://www.webhare.net/xmlns/publisher/foreignfolder" ]);
  AddDefaultIndexToFolder(foreignfolder_newfile->id);

  //refresh
  foreignfolder_newfile := OpenWHFSObject(foreignfolder_newfile->id);
  TEstEQ(0, foreignfolder_newfile->indexdoc, "indexdoc should not have been created");
  foreignfolder_newfile->RecycleSelf();
  testfw->CommitWork();
}

MACRO TestTypeChanges() {
  OBJECT work := NEW FeedbackObjectBase(GetPrimary(),"");

  OBJECT basefolder := GetTestsuiteTempFolder()->CreateFolder([name := "newfile" ]);
  OBJECT folder := basefolder->CreateFolder([name := "normalfolder" ]);
  AddDefaultIndexToFolder(folder->id);

  TestEq(TRUE, ObjectExists(folder->OpenByName("index")));

  UpdateFSObjTypes(work, INTEGER[folder->id], OpenWHFSType("http://www.webhare.net/xmlns/webhare_testsuite/applytestfolder")->id);
  TestEq(TRUE, ObjectExists(folder->OpenByName("index")));

  testfw->RollbackWork();
}

RunTestFramework ([
  PTR TestFolderIndex,
  PTR TestTypeChanges
]);
