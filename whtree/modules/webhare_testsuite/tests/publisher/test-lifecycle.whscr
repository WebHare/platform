<?wh
LOADLIB "wh::datetime.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::internal/testfuncs.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/services.whlib";
LOADLIB "mod::system/lib/whfs.whlib";
LOADLIB "mod::system/lib/tasks.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/webserver/management.whlib";
LOADLIB "mod::system/lib/internal/dbschema.whlib";
LOADLIB "mod::system/lib/internal/whfs/scheduledtasks.whlib";

LOADLIB "mod::publisher/lib/control.whlib";
LOADLIB "mod::publisher/lib/database.whlib";
LOADLIB "mod::publisher/lib/internal/tasks.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

//TODO We only need to a true 'scheduledtask, wait' cycle only once. After that we should be able to trust 'ExecuteAllTasksNow()'

RECORD FUNCTION UnparseTask(INTEGER event, INTEGER folder)
{
  SWITCH(event)
  {
    CASE 6
    {
      RETURN CELL [ task := "replacewith", taskdata := [ source := folder ]];
    }
    DEFAULT
    {
      RETURN DEFAULT RECORD;
    }
  }
}

RECORD FUNCTION ParseTask(OBJECT taskedobj, STRING task, RECORD taskdata)
{
  RECORD data;
  SWITCH(task)
  {
    CASE "replacewith"
    {
      taskdata := ValidateOptions([ source := 0 ], taskdata, [ title := "taskdata", required := [ "source" ]]);

      RECORD sourceinfo := SELECT id, type, isfolder FROM system.fs_objects WHERE id = taskdata.source;
      ValidateReplaceWith(taskedobj, sourceinfo);

      data := CELL[ event := 6 //replacewith
                  , folder := taskdata.source
                  ];
      RETURN data;
    }
    DEFAULT
    {
      THROW NEW Exception(`Unknown task type '${task}'`);
    }
  }
}

/** Add a task
    @param when When to execute the task. Times in the past are okay, but default/max are not.
    @param tasktype Task to execute at the specified date. Eg "replacewith"
    @param taskdata Settings for the task
    @cell(integer) taskdata.source Source for 'replacewith' tasks
    @return New task id */
PUBLIC INTEGER FUNCTION AddScheduledTask(OBJECT fsobject, DATETIME when, STRING tasktype, RECORD taskdata DEFAULTSTO DEFAULT RECORD)
{
  // insert the event
  RECORD task := CELL[ ...ParseTask(fsobject, tasktype, taskdata)
                     , when
                     , file := fsobject->id
                     , modifiedby := GetEffectiveUserID()
                     , id := MakeAutonumber(publisher.schedule, "ID")
                     ];

  INSERT task INTO publisher.schedule;

  // mark the file as having a schedule attached
  UPDATE system.fs_objects
         SET published := SetFlagsInPublished(published, PublishedFlag_Scheduled, TRUE)
         WHERE id = fsobject->id;

  ScheduleTimedTask("publisher:scheduledtasks", CELL[when]);
  RETURN task.id;
}

/** List scheduled tasks */
PUBLIC RECORD ARRAY FUNCTION ListScheduledTasks(OBJECT fsobject)
{
  RECORD ARRAY tasks := SELECT id, when, unparsed := UnparseTask(event,folder), modifiedby FROM publisher.schedule WHERE file = fsobject->id;
  RETURN SELECT id, when, task := unparsed.task, taskdata := unparsed.taskdata, owner := modifiedby
           FROM tasks
          WHERE RecordExists(unparsed)
       ORDER BY when;
}





/** Wait for all publisher scheduled tasks triggered before a certain time
    to finish
    @param timeaftertrigger All scheduled tasks triggered before this time will be finished when this function returns
    @param deadline Error out when the wait hasn't completed after this time
*/
MACRO WaitForPublisherScheduledTasks(DATETIME timeaftertrigger, DATETIME deadline)
{
  WHILE (TRUE)
  {
    RECORD ARRAY tasks_to_execute :=
        SELECT * FROM publisher.schedule
         WHERE COLUMN when <= VAR timeaftertrigger;

    IF (NOT RecordExists(tasks_to_execute))
      BREAK;

    Sleep(10);
    IF(GetCurrentDatetime() >= deadline)
      ABORT("Task isn't completing");
  }

  // Wait for the postcommit effects of the scheduled tasks to finish too
  WHILE (TRUE)
  {
    RECORD executetaskstatus :=
         SELECT tag, currentstart, nexttime
           FROM system_internal.tasks
          WHERE tag = "publisher.scheduledtasks";

    IF (executetaskstatus.currentstart = DEFAULT DATETIME
        AND (executetaskstatus.nexttime = DEFAULT DATETIME
             OR GetDatetimeDIfference(GetCurrentDatetime(),executetaskstatus.nexttime).totalmsecs >= 60*60*1000)) //also ignore tasks after next hour in case you actually scheduled stuff
      BREAK;

    Sleep(10);
    IF(GetCurrentDatetime() >= deadline)
      ABORT("publisher.scheduledtasks isn't completing");
  }
}

/** Wait for all event completions to finish
    @param deadline Error out when the wait hasn't completed after this time
*/
MACRO WaitForEventCompletions(DATETIME deadline)
{
  OBJECT eventcompletionlink := ConnectToManagedPort("system:eventcompletion", "webserver");
  WHILE (TRUE)
  {
    /* A single request is usually enough for synchronization, because it handles all
       completions between requests
    */
    RECORD rec := eventcompletionlink->DoRequest( [ type := "havependingcompletions" ]);
    IF (NOT rec.msg.result)
      BREAK;

    Sleep(10);
    IF(GetCurrentDatetime() >= deadline)
      ABORT("system:eventcompletion isn't completing");
  }
  eventcompletionlink->Close();
}

/** Wait for output analyser scans to finish
    @param folderids Ids of folders that must be completed
    @param deadline Error out when the wait hasn't completed after this time
*/
MACRO WaitForOutputAnalyzer(INTEGER ARRAY folderids, DATETIME deadline)
{
  OBJECT outputanalyzer := WaitForPromise(OpenWebHareService("publisher:outputanalyzer"));
  WHILE (TRUE)
  {
    RECORD state := WaitForPromise(outputanalyzer->GetState());
    INTEGER ARRAY scheduled := WaitForPromise(outputanalyzer->TestFoldersScheduled(folderids));
    //DumpValue(CELL[ state, scheduled ], "tree");
    IF (IsDefaultValue(scheduled))
      BREAK;

    Sleep(10);
    IF(GetCurrentDatetime() >= deadline)
      ABORT("outputanalyzer isn't completing");
  }
  outputanalyzer->CloseService();
}

MACRO ExecuteAllTasksNow()
{
  FOREVERY (RECORD task FROM GetScheduledTasksToExecute())
    ExecuteScheduledTask(task);
}

MACRO EnsureTasksExecuted(DATETIME when)
{
  DATETIME deadline := AddTimeToDate(60000,GetCurrentDatetime());

  WaitForPublisherScheduledTasks(when, deadline);
  WaitForEventCompletions(deadline);
  WaitForOutputAnalyzer(INTEGER [ GetTestsuiteTempFolder()->id ], deadline);

  testfw->WaitForPublishCompletion(GetTestsuiteTempFolder()->id);
  //PRINT("Tasks & publisher finished\n");
}

/** Wait for a file to have been published. Use this if you know that a file should be republish within a few seconds */
BOOLEAN FUNCTION WaitForBeenPublished(INTEGER fileid, DATETIME sincewhen)
{
  /* We loop because even if we EnsureTasksExecuted, there's no way to ensure
     that the publisher:executetasks post-commit completions have been sent
     to the completion handler (we could  see that the completions queue is empty,
     but is that because it hasn't received anything yet of because it's done ?) */

  DATETIME deadline := AddTimeToDate(15000,GetCurrentDatetime());
  WHILE (GetCurrentDatetime() <= deadline)
  {
    IF(IsBeingPublishedSince(fileid, sincewhen))
      RETURN TRUE;
    Sleep(100);
  }
  RETURN FALSE;
}

MACRO TestLifeCycle()
{
  testfw->BeginWork();

  OBJECT autokill_now := GetTestsuiteTempFolder()->CreateFile([ name:= "autokill_now"]);
  OBJECT autokill_soon := GetTestsuiteTempFolder()->CreateFile([ name:= "autokill_soon"]);

  autokill_now->SetInstanceData("http://www.webhare.net/xmlns/publisher/lifecycle", [deletion := AddTimeToDate(-1,GetCurrentDatetime())]);
  autokill_soon->SetInstanceData("http://www.webhare.net/xmlns/publisher/lifecycle", [deletion := AddTimeToDate(60000,GetCurrentDatetime())]);

  ExecuteLifecycleCleanup();

  TestEq(TRUE,  ObjectExists(GetTestsuiteTempFolder()->OpenByName("autokill_soon")));
  TestEq(FALSE, ObjectExists(GetTestsuiteTempFolder()->OpenByName("autokill_now")));
  TestEq(FALSE, RecordExists(SELECT FROM system.fs_objects WHERE id = autokill_now->id)); //permanenetly gone!

  testfw->CommitWork();
}

MACRO PublicationMoveFile()
{
  testfw->BeginWork();

  OBJECT tomovefile := GetTestsuiteTempFolder()->CreateFile(
      [ name:=        "tomove.html"
      , type :=       24
      , publish :=    TRUE
      ]);
  OBJECT destfolder := GetTestsuiteTempFolder()->CreateFolder([name := "destfolder"]);
  OBJECT deletedfolder := GetTestsuiteTempFolder()->CreateFolder([name := "deletedfolder"]);

  DATETIME now := GetCurrentDateTime();
  AddFileTask(tomovefile->id, now, 3, destfolder->id); // move

  testfw->CommitWork();
  EnsureTasksExecuted(now);

  tomovefile := OpenWHFSObject(tomovefile->id);
  TestEq(destfolder->id, tomovefile->parent);

  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(tomovefile->id, now, 3, deletedfolder->id); //move file into a delted folder
  deletedfolder->RecycleSelf();
  testfw->CommitWork();
  EnsureTasksExecuted(now);

  tomovefile := OpenWHFSObject(tomovefile->id);
  TestEq(deletedfolder->id, tomovefile->parent);
}

MACRO TestReplaceContents()
{
  testfw->BeginWork();

  OBJECT dummyhtml := GetTestsuiteTempFolder()->CreateFile(
      [ name:=        "dummy.html"
      , type :=       24
      , publish :=    FALSE
      ]);

  OBJECT toreplacefile := GetTestsuiteTempFolder()->CreateFile(
    [ name := "toreplace.rtd"
    , typens := "http://www.webhare.net/xmlns/publisher/richdocumentfile"
    , title := "Index"
    , publish := TRUE
    , ispinned := TRUE
    ], [setindex := TRUE]);
  toreplacefile->SetInstanceData("http://www.webhare.net/xmlns/webhare_testsuite/nocopyprops", [ idfield :="dont-overwrite" ]);
  toreplacefile->SetInstanceData("http://www.webhare.net/xmlns/publisher/richdocumentfile",
                          [ data := [ htmltext := StringToBlob('<html><body><p class="normal">First document</p></body></html>') ]
                          ]);


  OBJECT replacement1 := GetTestsuiteTempFolder()->CreateFile(
    [ name := "v1.rtd"
    , typens := "http://www.webhare.net/xmlns/publisher/richdocumentfile"
    , publish := FALSE
    , title := "V1"
    , ispinned := FALSE
    ]);
  replacement1->SetInstanceData("http://www.webhare.net/xmlns/webhare_testsuite/nocopyprops", [ idfield := "replace1" ]);
  replacement1->SetInstanceData("http://www.webhare.net/xmlns/publisher/richdocumentfile",
            [ data := [ htmltext := StringToBlob('<html><body><p class="normal">V1</p></body></html>') ]
            ]);

  OBJECT replacement2 := GetTestsuiteTempFolder()->CreateFile(
    [ name := "v2.rtd"
    , typens := "http://www.webhare.net/xmlns/publisher/richdocumentfile"
    , publish := TRUE
    , title := "V2"
    , ispinned := TRUE
    ]);
  replacement2->SetInstanceData("http://www.webhare.net/xmlns/publisher/richdocumentfile",
            [ data := [ htmltext := StringToBlob('<html><body><p class="normal">V2</p></body></html>') ]
            ]);

  testfw->CommitWork();
  WaitForPublishCompletion(GetTestsuiteTempFolder()->id);

  testfw->BeginWork();
  TestEQ(TRUE, GetEffectiveUserID() != 0);

  TestThrowsLike("Folders do not support*", PTR AddScheduledTask(GetTestsuiteTempFolder(),GetCurrentDatetime(), "replacewith",  [ source := GetTestsuiteTempFolder()->parent ]));
  TestThrowsLike("*cannot*self*", PTR AddScheduledTask(toreplacefile,GetCurrentDatetime(), "replacewith",  [ source := toreplacefile->id ]));
  TestThrowsLike("*must be of*same type*", PTR AddScheduledTask(toreplacefile,GetCurrentDatetime(), "replacewith", [ source := dummyhtml->id ]));
  TestThrowsLike("*does not exist*", PTR AddScheduledTask(toreplacefile,GetCurrentDatetime(), "replacewith", [ source := 1999999999 ]));

  TestEq(0, Length(ListScheduledTasks(toreplacefile)));
  DATETIME now := GetCurrentDatetime();
  INTEGER replacetask1 := AddScheduledTask(toreplacefile, now, "replacewith", [ source := replacement1->id ]);
  TestEq([[ id := replacetask1, task := "replacewith", when := now, taskdata := [ source := replacement1->id ], owner := GetEffectiveUserID() ]], ListScheduledTasks(toreplacefile));

  ExecuteAllTasksNow();
  testfw->CommitWork();

  TestEq(0, Length(ListScheduledTasks(toreplacefile)));

  toreplacefile := OpenWHFSObject(toreplacefile->id);  //not sure if it's needed, but safer
  TestEq(TRUE, toreplacefile->publish);
  TestEq(`<html><body><p class="normal">V1</p></body></html>`, BlobToString(toreplacefile->GetInstanceData("http://www.webhare.net/xmlns/publisher/richdocumentfile").data.htmltext));

  RECORD ARRAY recycledfiles := SearchRecycleBin(CELL[ fromdate := testfw->starttime
                                                     , site := GetTestsuiteTempFolder()->parentsite
                                                     , owner := GetEffectiveUserID()
                                                     , namecontains := "toreplace.rtd"
                                                     ]);
  TestEq(1,Length(recycledfiles));
  TestEq(`<html><body><p class="normal">First document</p></body></html>`, BlobToString(OpenWHFSObject(recycledfiles[0].id)->GetInstanceData("http://www.webhare.net/xmlns/publisher/richdocumentfile").data.htmltext));


  testfw->BeginWork();

  AddScheduledTask(toreplacefile, now, "replacewith", [ source := replacement2->id ]);
  ExecuteAllTasksNow();

  TestEq(`<html><body><p class="normal">V2</p></body></html>`, BlobToString(toreplacefile->GetInstanceData("http://www.webhare.net/xmlns/publisher/richdocumentfile").data.htmltext));

  testfw->CommitWork();
}

MACRO PublicationDeleteFile()
{
  testfw->BeginWork();

  OBJECT tokillfile := GetTestsuiteTempFolder()->CreateFile(
      [ name:=        "todelete.html"
      , type :=       24
      , publish :=    TRUE
      ]);

  DATETIME now := GetCurrentDateTime();
  AddFileTask(tokillfile->id, now, 4, 0); // delete
  testfw->CommitWork();
  EnsureTasksExecuted(now);

  tokillfile := OpenWHFSObject(tokillfile->id);
  TestEq(FALSE, tokillfile->isactive);

}

MACRO PublicationDeleteFolder()
{
  testfw->BeginWork();

  OBJECT tokillfolder := GetTestsuiteTempFolder()->CreateFolder(
      [ name:=        "todelete"
      ]);
  OBJECT tokillfile := tokillfolder->CreateFile(
      [ name:=        "todelete.html"
      , type :=       24
      , publish :=    TRUE
      ]);

  DATETIME now := GetCurrentDateTime();
  AddFileTask(tokillfolder->id, now, 4, 0); // delete
  testfw->CommitWork();
  EnsureTasksExecuted(now);

  tokillfolder := OpenWHFSObject(tokillfolder->id);
  TestEq(FALSE, tokillfolder->isactive);

}

MACRO PublicationStartStopTest()
{
  testfw->BeginWork();

  OBJECT indexfile := GetTestsuiteTempFolder()->CreateFile(
      [ name:=        "index.html"
      , type :=       24
      , publish :=    TRUE
      ]);

  OBJECT testfile := GetTestsuiteTempFolder()->CreateFile(
      [ name:=        "test.html"
      , data :=       StringToBlob("Dit is tekst")
      , publish :=    FALSE
      ]);

  testfw->CommitWork();
  testfw->WaitForPublishCompletion(GetTestsuiteTempFolder()->id);

  testfw->BeginWork();
  DATETIME now := GetCurrentDateTime();
  AddFileTask(testfile->id, now, 1, 0); // Start publish NOW -> sets published to true, must republish all
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  //this tests that both testfile and indexfile have been (re)queued for republication since the last 'now'
  TestEQ(TRUE, IsBeingPublishedSince(testfile->id, now), `Testfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
  TestEQ(TRUE, IsBeingPublishedSince(indexfile->id, now), `Indexfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);

  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(testfile->id, now, 1, 0); // Republish only testfile, now
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  //this tests that testfile has been (re)queued for republication since the last 'now', but not indexfile
  TestEQ(TRUE, IsBeingPublishedSince(testfile->id, now), `Testfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
  TestEQ(FALSE, IsBeingPublishedSince(indexfile->id, now), `Indexfile ${indexfile->id} shouldn't have been republished since ${AnyToString(now, "tree")}`);

  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(testfile->id, now, 2, 0); // Unpublish file
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  TestEQ(TRUE, WaitForBeenPublished(indexfile->id, now), `Indexfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
  testfile->Refresh();
  TestEQ(FALSE, testfile->publish);

  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(testfile->parent, now, 1, 0); // Publish folder
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  TestEQ(TRUE, IsBeingPublishedSince(testfile->id, now), `Testfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
  TestEQ(TRUE, IsBeingPublishedSince(indexfile->id, now), `Indexfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);

  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(testfile->parent, now, 1, 0); // Republish folder
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  TestEQ(TRUE, IsBeingPublishedSince(testfile->id, now), `Testfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
  TestEQ(TRUE, IsBeingPublishedSince(indexfile->id, now), `Indexfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);

  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(testfile->parent, now, 2, 0); // Unpublish folder
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  indexfile->Refresh();
  TestEQ(FALSE, indexfile->publish);
  testfile->Refresh();
  TestEQ(FALSE, testfile->publish);

  // Publish everything
  testfw->BeginWork();
  now := GetCurrentDateTime();
  AddFileTask(testfile->parent, now, 1, 0); // Publish folder
  testfw->CommitWork();

  EnsureTasksExecuted(now);
}

MACRO SetIndexDocTest()
{
  OBJECT indexfile := GetTestsuiteTempFolder()->OpenByPath("index.html");
  OBJECT testfile := GetTestsuiteTempFolder()->OpenByPath("test.html");

  testfw->BeginWork();
  indexfile->UpdateMetadata([ name := "test2.html" ]);
  testfw->CommitWork();

  TestEQ(indexfile->id, GetTestsuiteTempFolder()->indexdoc);

  // Make sure any republication is done
  EnsureTasksExecuted(GetCurrentDatetime());

  testfw->BeginWork();
  DATETIME now := GetCurrentDateTime();
  AddFileTask(testfile->id, now, 5, 0);
  testfw->CommitWork();

  EnsureTasksExecuted(now);

  GetTestsuiteTempFolder()->Refresh();
  TestEQ(testfile->id, GetTestsuiteTempFolder()->indexdoc);

  TestEQ(TRUE, IsBeingPublishedSince(testfile->id, now), `Testfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
  TestEQ(TRUE, IsBeingPublishedSince(indexfile->id, now), `Indexfile ${indexfile->id} should have been republished since ${AnyToString(now, "tree")}`);
}

RunTestFramework([ PTR TestLifecycle
                 , PTR TestReplaceContents
                 , PTR PublicationDeleteFile
                 , PTR PublicationDeleteFolder
                 , PTR PublicationMoveFile
                 , PTR PublicationStartStopTest
                 , PTR SetIndexDocTest
                 ], [ testusers :=
                      [ [ login := "sysop", grantrights := [ "system:sysop" ] ]
                      ]
                    ]);
