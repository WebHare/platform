<?wh
LOADLIB "wh::files.whlib";

LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::tollium/lib/testframework.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

MACRO PublishFiles()
{
  testfw->BeginWork();
  OBJECT testloc := GetTestsuiteTempFolder()->EnsureFolder([ name := "markdown" ]);
  OBJECT mdempty := testloc->CreateFile([ name := "mdempty", typens := "http://www.webhare.net/xmlns/publisher/markdownfile", publish := TRUE]);
  OBJECT mdsimple := testloc->CreateFile([ name := "mdsimple", typens := "http://www.webhare.net/xmlns/publisher/markdownfile", publish := TRUE]);
  mdsimple->SetInstanceData("http://www.webhare.net/xmlns/publisher/markdownfile",
    [ data := [ type := "publisher:markdown"
              , text := StringToBlob(`## Markdown file\nHello world!`)
              , embedded := [ CELL[...WrapBlob(GetHarescriptResource("mod::system/web/tests/snowbeagle.jpg"), "bob.jpg", [ extractdominantcolor := TRUE ])
                                  , contentid := "imagecid-81400"
                                  ]
                            ]
              ]
    ]);
  testfw->CommitWork();

  testfw->WaitForPublishCompletion(testloc->id);

  TestEq(TRUE, testfw->browser->GotoWebPage(mdempty->url));
  TestEq(TRUE, testfw->browser->GotoWebPage(mdsimple->url));
  TestEqLike(`*<h2 class="heading2">Markdown file</h2>*<p class="normal">Hello world!</p>*`, BlobToString(testfw->browser->content));
}

RunTestframework([ PTR PublishFiles
                 ]);
