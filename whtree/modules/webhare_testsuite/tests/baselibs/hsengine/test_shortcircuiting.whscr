<?wh
/// @short Short circuiting tests

LOADLIB "wh::internal/hsselftests.whlib";

// This module tests shortcicuiting for AND and OR

INTEGER secounter;

BOOLEAN FUNCTION SideEffect(BOOLEAN val)
{
  secounter := secounter + 1;
  RETURN val;
}

MACRO AndTest()
{
  OpenTest("TestShortCircuiting: AndTest");

  BOOLEAN result;

  // Basic conformance

  TestEq(TRUE, TRUE AND TRUE);
  TestEq(FALSE, TRUE AND FALSE);
  TestEq(FALSE, FALSE AND TRUE);
  TestEq(FALSE, FALSE AND FALSE);

  // Side effects
  secounter := 0;
  TestEq(TRUE, TRUE AND SideEffect(TRUE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(FALSE, TRUE AND SideEffect(FALSE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(FALSE, FALSE AND SideEffect(TRUE));
  TestEq(0, secounter);

  secounter := 0;
  TestEq(FALSE, FALSE AND SideEffect(FALSE));
  TestEq(0, secounter);

  secounter := 0;
  TestEq(TRUE, SideEffect(TRUE) AND SideEffect(TRUE));
  TestEq(2, secounter);

  secounter := 0;
  TestEq(FALSE, SideEffect(TRUE) AND SideEffect(FALSE));
  TestEq(2, secounter);

  secounter := 0;
  TestEq(FALSE, SideEffect(FALSE) AND SideEffect(TRUE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(FALSE, SideEffect(FALSE) AND SideEffect(FALSE));
  TestEq(1, secounter);

  CloseTest("TestShortCircuiting: AndTest");
}

MACRO OrTest()
{
  OpenTest("TestShortCircuiting: OrTest");

  BOOLEAN result;

  // Basic conformance

  TestEq(TRUE, TRUE OR TRUE);
  TestEq(TRUE, TRUE OR FALSE);
  TestEq(TRUE, FALSE OR TRUE);
  TestEq(FALSE, FALSE OR FALSE);

  // Side effects
  secounter := 0;
  TestEq(TRUE, TRUE OR SideEffect(TRUE));
  TestEq(0, secounter);

  secounter := 0;
  TestEq(TRUE, TRUE OR SideEffect(FALSE));
  TestEq(0, secounter);

  secounter := 0;
  TestEq(TRUE, FALSE OR SideEffect(TRUE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(FALSE, FALSE OR SideEffect(FALSE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(TRUE, SideEffect(TRUE) OR SideEffect(TRUE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(TRUE, SideEffect(TRUE) OR SideEffect(FALSE));
  TestEq(1, secounter);

  secounter := 0;
  TestEq(TRUE, SideEffect(FALSE) OR SideEffect(TRUE));
  TestEq(2, secounter);

  secounter := 0;
  TestEq(FALSE, SideEffect(FALSE) OR SideEffect(FALSE));
  TestEq(2, secounter);

  CloseTest("TestShortCircuiting: OrTest");
}

AndTest();
OrTest();
