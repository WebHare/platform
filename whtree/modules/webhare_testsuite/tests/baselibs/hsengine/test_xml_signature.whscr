<?wh

LOADLIB "wh::crypto.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::filetypes/pkcs.whlib";
LOADLIB "wh::xml/dom.whlib";
LOADLIB "wh::xml/signature.whlib";
LOADLIB "wh::internal/testfuncs.whlib";

RECORD FUNCTION GetCanonicalizeOptions(STRING query)
{
  RETURN [ nodelist :=
           [ namespaces := [[ prefix := "ietf", namespaceuri:= "http://www.ietf.org"]
                           ]
           , query := query
           ]
         ];
}

MACRO TestXMLDSigCases() //https://www.w3.org/TR/xmldsig2ed-tests/#TestCases-C14n11
{
  OBJECT indoc ;

  indoc := MakeXMLDocument(StringToBlob(`<?xml version="1.0" encoding="UTF-8"?>
<ietf:c14n11Xmllang xmlns:ietf="http://www.ietf.org"
xmlns:w3c="http://www.w3.org">
   <ietf:e1 xml:lang="EN">
      <ietf:e11>
         <ietf:e111 />
      </ietf:e11>
      <ietf:e12 at="2">
         <ietf:e121 />
      </ietf:e12>
   </ietf:e1>
   <ietf:e2 >
      <ietf:e21 />
   </ietf:e2>
</ietf:c14n11Xmllang>`));

  //Test case c14n11/xmllang-1
  TestEq(`<ietf:e1 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org" xml:lang="EN">
      <ietf:e11>
         <ietf:e111></ietf:e111>
      </ietf:e11>
      <ietf:e12 at="2">
         <ietf:e121></ietf:e121>
      </ietf:e12>
   </ietf:e1>`, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions('(//. | //@* | //namespace::*)[ancestor-or-self::ietf:e1]'))));

  // Test case c14n11/xmllang-2
  TestEq(`<ietf:e2 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org">
      <ietf:e21></ietf:e21>
   </ietf:e2>`, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions('(//. | //@* | //namespace::*)[ancestor-or-self::ietf:e2]'))));

  //  Test case c14n11/xmllang-3
  TestEq(`<ietf:e11 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org" xml:lang="EN">
         <ietf:e111></ietf:e111>
      </ietf:e11>`, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions('(//. | //@* | //namespace::*)[ancestor-or-self::ietf:e11]'))));

  // Test case c14n11/xmllang-4
  TestEq(`<ietf:e11 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org" xml:lang="EN">
         <ietf:e111></ietf:e111>
      </ietf:e11><ietf:e12 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org" at="2" xml:lang="EN">
         <ietf:e121></ietf:e121>
      </ietf:e12>`, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions('(//. | //@* | //namespace::*)[ancestor-or-self::ietf:e11 or ancestor-or-self::ietf:e12]'))));

  //Test case xmldsig/defCan-1


  indoc := MakeXMLDocument(StringToBlob(`<?xml version="1.0" encoding="UTF-8"?>
<ietf:c14n11XmlIdDoc1 xmlns:ietf="http://www.ietf.org"
xmlns:w3c="http://www.w3.org">
   <ietf:e1 xml:id="IdInterop">
      <ietf:e11>
         <ietf:e111 />
      </ietf:e11>
      <ietf:e12 at="2">
         <ietf:e121 />
      </ietf:e12>
   </ietf:e1>
   <ietf:e2 >
      <ietf:e21 />
   </ietf:e2>
</ietf:c14n11XmlIdDoc1>`));

 //Test case c14n11/xmlid-1

  TestEq(`<ietf:e1 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org" xml:id="IdInterop">
      <ietf:e11>
         <ietf:e111></ietf:e111>
      </ietf:e11>
      <ietf:e12 at="2">
         <ietf:e121></ietf:e121>
      </ietf:e12>
   </ietf:e1>`, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions('(//. | //@* | //namespace::*) [ancestor-or-self::ietf:e1]'))));

  TestEq(`<ietf:e11 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org">
         <ietf:e111></ietf:e111>
      </ietf:e11><ietf:e12 xmlns:ietf="http://www.ietf.org" xmlns:w3c="http://www.w3.org" at="2">
         <ietf:e121></ietf:e121>
      </ietf:e12>`, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions('(//. | //@* | //namespace::*) [ancestor-or-self::ietf:e11 or ancestor-or-self::ietf:e12]'))));
  //TestEq(``, BlobToString(indoc->GetCanonicalizedDocument("C14N 1.1", GetCanonicalizeOptions(''))));
}


STRING ns_saml20_assertion := "urn:oasis:names:tc:SAML:2.0:assertion";
//STRING ns_saml20_metadata := "urn:oasis:names:tc:SAML:2.0:metadata";
//STRING ns_xmldsig := "http://www.w3.org/2000/09/xmldsig#";

RECORD ARRAY docs :=
    [ // Random response from https://support.signicat.com/display/SUP/SAML
      // Disabled because we don't support DSA yet
/*      [ assertion_ns := "urn:oasis:names:tc:SAML:1.0:assertion"
      , doc :=
          '<?xml version="1.0" ?>\n' ||
          '<Response xmlns="urn:oasis:names:tc:SAML:1.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:1.0:assertion" xmlns:samlp="urn:oasis:names:tc:SAML:1.0:protocol" IssueInstant="2007-02-08T07:17:28.707Z" MajorVersion="1" MinorVersion="1" Recipient="https://www.myhost.no" ResponseID="c3d4a4bd903dcd9d901baf22d2ae9a8a"><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">\n' ||
          '<ds:SignedInfo>\n' ||
          '<ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:CanonicalizationMethod>\n' ||
          '<ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#dsa-sha1"></ds:SignatureMethod>\n' ||
          '<ds:Reference URI="#c3d4a4bd903dcd9d901baf22d2ae9a8a">\n' ||
          '<ds:Transforms>\n' ||
          '<ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"></ds:Transform>\n' ||
          '<ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"><ec:InclusiveNamespaces xmlns:ec="http://www.w3.org/2001/10/xml-exc-c14n#" PrefixList="#default code ds kind rw saml samlp typens"></ec:InclusiveNamespaces></ds:Transform>\n' ||
          '</ds:Transforms>\n' ||
          '<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></ds:DigestMethod>\n' ||
          '<ds:DigestValue>pzySGqjY3lnRDQCwp1C50/AGwR4=</ds:DigestValue>\n' ||
          '</ds:Reference>\n' ||
          '</ds:SignedInfo>\n' ||
          '<ds:SignatureValue>JPSjJTr5DCjSeAvK1ythhrz+XK90GoSz/a1i8hMn5ziqoOr9LhVjxw==</ds:SignatureValue>\n' ||
          '<ds:KeyInfo>\n' ||
          '<ds:X509Data>\n' ||
          '<ds:X509Certificate>\n' ||
          'MIIDLTCCAusCBEQ0FXgwCwYHKoZIzjgEAwUAMHwxCzAJBgNVBAYTAk5PMQ8wDQYDVQQIEwZOb3J3\n' ||
          'YXkxEjAQBgNVBAcTCVRyb25kaGVpbTETMBEGA1UEChMKS2FudGVnYSBBUzETMBEGA1UECxMKS2Fu\n' ||
          'dGVnYSBBUzEeMBwGA1UEAxMVaWQua2FudGVnYS5uby9wcmVwcm9kMB4XDTA2MDQwNTE5MDczNloX\n' ||
          'DTA3MDQwNTE5MDczNlowfDELMAkGA1UEBhMCTk8xDzANBgNVBAgTBk5vcndheTESMBAGA1UEBxMJ\n' ||
          'VHJvbmRoZWltMRMwEQYDVQQKEwpLYW50ZWdhIEFTMRMwEQYDVQQLEwpLYW50ZWdhIEFTMR4wHAYD\n' ||
          'VQQDExVpZC5rYW50ZWdhLm5vL3ByZXByb2QwggG4MIIBLAYHKoZIzjgEATCCAR8CgYEA/X9TgR11\n' ||
          'EilS30qcLuzk5/YRt1I870QAwx4/gLZRJmlFXUAiUftZPY1Y+r/F9bow9subVWzXgTuAHTRv8mZg\n' ||
          't2uZUKWkn5/oBHsQIsJPu6nX/rfGG/g7V+fGqKYVDwT7g/bTxR7DAjVUE1oWkTL2dfOuK2HXKu/y\n' ||
          'IgMZndFIAccCFQCXYFCPFSMLzLKSuYKi64QL8Fgc9QKBgQD34aCF1ps93su8q1w2uFe5eZSvu/o6\n' ||
          '6oL5V0wLPQeCZ1FZV4661FlP5nEHEIGAtEkWcSPoTCgWE7fPCTKMyKbhPBZ6i1R8jSjgo64eK7Om\n' ||
          'dZFuo38L+iE1YvH7YnoBJDvMpPG+qFGQiaiD3+Fa5Z8GkotmXoB7VSVkAUw7/s9JKgOBhQACgYEA\n' ||
          'wTsCn5RYunZA+0mzh7pEJLKE11o4nHfVccE8zO1oXBDLGeap4pr155XJ0Dcsyu5aN6gvn8ZPav2s\n' ||
          'i3mZn+CuRt1o9+tMJhPKExtM1uetGGCQHHoOUA44E0As2E7PaxQHGlhrcxE0eoILSNYCSl/WOIn5\n' ||
          '1dn1K3Q9W1EdiuxQr70wCwYHKoZIzjgEAwUAAy8AMCwCFGY4syTuHDUBkwLpNnD+cUpornEYAhRa\n' ||
          'gtA/LTUSX7q25nFYyF8cYiO6bA==\n' ||
          '</ds:X509Certificate>\n' ||
          '</ds:X509Data>\n' ||
          '</ds:KeyInfo></ds:Signature><Status><StatusCode Value="samlp:Success"></StatusCode></Status><Assertion xmlns="urn:oasis:names:tc:SAML:1.0:assertion" AssertionID="a6b8fbd33189cca292f99b475d6eea6c" IssueInstant="2007-02-08T07:17:28.707Z" Issuer="https://test.kantega.no/id" MajorVersion="1" MinorVersion="1"><Conditions NotBefore="2007-02-08T07:17:28.706Z" NotOnOrAfter="2007-02-08T07:17:58.706Z"></Conditions><AuthenticationStatement AuthenticationInstant="2007-02-08T07:17:28.475Z" AuthenticationMethod="urn:ksi:names:SAML:2.0:ac:BankID-NO"><Subject><NameIdentifier Format="urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName">CN=TINKY-WINKY TELETUBBIE,serialNumber=9578-6000-4-2592,O=BankID - TestBank1,C=NO</NameIdentifier><SubjectConfirmation><ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</ConfirmationMethod></SubjectConfirmation></Subject></AuthenticationStatement><AttributeStatement><Subject><NameIdentifier Format="urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName">CN=TINKY-WINKY TELETUBBIE,serialNumber=9578-6000-4-2592,O=BankID - TestBank1,C=NO</NameIdentifier><SubjectConfirmation><ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</ConfirmationMethod></SubjectConfirmation></Subject><Attribute AttributeName="firstname" AttributeNamespace="bankid.certificate"><AttributeValue>TINKY-WINKY</AttributeValue></Attribute><Attribute AttributeName="lastname" AttributeNamespace="bankid.certificate"><AttributeValue>TELETUBBIE</AttributeValue></Attribute><Attribute AttributeName="issuer-dn" AttributeNamespace="bankid.certificate"><AttributeValue>CN=BankID TestBank1 Bank CA 1,OU=123456789,O=TestBank1 AS,C=NO</AttributeValue></Attribute><Attribute AttributeName="plain-name" AttributeNamespace="bankid.certificate"><AttributeValue>TINKY-WINKY TELETUBBIE</AttributeValue></Attribute><Attribute AttributeName="serialnumber" AttributeNamespace="bankid.certificate"><AttributeValue>272838</AttributeValue></Attribute><Attribute AttributeName="unique-id" AttributeNamespace="bankid.certificate"><AttributeValue>9578-6000-4-2592</AttributeValue></Attribute><Attribute AttributeName="valid-from" AttributeNamespace="bankid.certificate"><AttributeValue>2005-07-05</AttributeValue></Attribute><Attribute AttributeName="valid-to" AttributeNamespace="bankid.certificate"><AttributeValue>2007-07-05</AttributeValue></Attribute><Attribute AttributeName="date-of-birth" AttributeNamespace="bankid.certificate"><AttributeValue>1974-05-17</AttributeValue></Attribute><Attribute AttributeName="fnr" AttributeNamespace="bankid.va"><AttributeValue>17057401192</AttributeValue></Attribute></AttributeStatement></Assertion></Response>\n' ||
          '\n'
      , cert :=
          'MIIDLTCCAusCBEQ0FXgwCwYHKoZIzjgEAwUAMHwxCzAJBgNVBAYTAk5PMQ8wDQYDVQQIEwZOb3J3 YXkxEjAQBgNVBAcTCVRyb25kaGVpbTETMBEGA1UEChMKS2FudGVnYSBBUzETMBEGA1UECxMKS2Fu dGVnYSBBUzEeMBwGA1UEAxMVaWQua2FudGVnYS5uby9wcmVwcm9kMB4XDTA2MDQwNTE5MDczNloX DTA3MDQwNTE5MDczNlowfDELMAkGA1UEBhMCTk8xDzANBgNVBAgTBk5vcndheTESMBAGA1UEBxMJ VHJvbmRoZWltMRMwEQYDVQQKEwpLYW50ZWdhIEFTMRMwEQYDVQQLEwpLYW50ZWdhIEFTMR4wHAYD VQQDExVpZC5rYW50ZWdhLm5vL3ByZXByb2QwggG4MIIBLAYHKoZIzjgEATCCAR8CgYEA/X9TgR11 EilS30qcLuzk5/YRt1I870QAwx4/gLZRJmlFXUAiUftZPY1Y+r/F9bow9subVWzXgTuAHTRv8mZg t2uZUKWkn5/oBHsQIsJPu6nX/rfGG/g7V+fGqKYVDwT7g/bTxR7DAjVUE1oWkTL2dfOuK2HXKu/y IgMZndFIAccCFQCXYFCPFSMLzLKSuYKi64QL8Fgc9QKBgQD34aCF1ps93su8q1w2uFe5eZSvu/o6 6oL5V0wLPQeCZ1FZV4661FlP5nEHEIGAtEkWcSPoTCgWE7fPCTKMyKbhPBZ6i1R8jSjgo64eK7Om dZFuo38L+iE1YvH7YnoBJDvMpPG+qFGQiaiD3+Fa5Z8GkotmXoB7VSVkAUw7/s9JKgOBhQACgYEA wTsCn5RYunZA+0mzh7pEJLKE11o4nHfVccE8zO1oXBDLGeap4pr155XJ0Dcsyu5aN6gvn8ZPav2s i3mZn+CuRt1o9+tMJhPKExtM1uetGGCQHHoOUA44E0As2E7PaxQHGlhrcxE0eoILSNYCSl/WOIn5 1dn1K3Q9W1EdiuxQr70wCwYHKoZIzjgEAwUAAy8AMCwCFGY4syTuHDUBkwLpNnD+cUpornEYAhRa gtA/LTUSX7q25nFYyF8cYiO6bA=='
      ]

      // SAML response from SURFconext
    ,*/

      [ doc := `<DirectoryReq xmlns="http://www.idealdesk.com/ideal/messages/mer-acq/3.3.1" version="3.3.1"><createDateTimestamp>2019-04-08T04:19:25.454Z</createDateTimestamp><Merchant><merchantID>003069727</merchantID><subID>0</subID></Merchant><Signature xmlns="http://www.w3.org/2000/09/xmldsig#"><SignedInfo><CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/><SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/><Reference URI=""><Transforms><Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/></Transforms><DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/><DigestValue>Aqh2U9qwEh/9QiEMKV3m/IaVqOnd2h1A4L4jDS5G9wk=</DigestValue></Reference></SignedInfo><SignatureValue>iUm6JzJRKfVsXZSf5Mwge7h79UFZYNl3v8vCmzPFtxH+6mBVWuPP35VDX39TeKf8wfvpljUXcR8eEzuGxY9aAOx2mp4fZWRFsLTFuXmudU0qwVSjELNY5HemDdrc7L42NEZxkOADVcpETRbYpP0cVkTnW0EkgSbSwxnbD0z+HSX4HBiKYwjaEvWTajjvkuGHcrA10SHkFVub8gT4PCCjPU5vdrGKpPhZaiwFE42WUN+/DfZYZKGWoZniZFaKNft28xhleH3OTFh0Rzb01FE+PQYGLdxHvAQfjQsa56NkBP+dyH5vshalFugkP/0LOovzQGeDy9Mtdzww5m1SDalntQ==</SignatureValue><KeyInfo><KeyName>1EC8349CA5DBA1E47E6902B5F5532AB1A87BEC10</KeyName></KeyInfo></Signature></DirectoryReq>`
      , cert := `-----BEGIN CERTIFICATE-----
MIIDtTCCAp2gAwIBAgIJANJOtQSOupsiMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
BAYTAk5MMRMwEQYDVQQIEwpPdmVyaWpzc2VsMSEwHwYDVQQKExhJbnRlcm5ldCBX
aWRnaXRzIFB0eSBMdGQwHhcNMTYxMjA3MDkzNzA2WhcNMjExMjA2MDkzNzA2WjBF
MQswCQYDVQQGEwJOTDETMBEGA1UECBMKT3Zlcmlqc3NlbDEhMB8GA1UEChMYSW50
ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEAyTWoFvETOWbeWOm7FePT1LB2PmCPAZvfflI/O+ow1UAsj5qOYSyakqr9
z13H0NdGLddhpyUMRhqT0Hls7l5if9gFI2fJMGNVaVPG2l1WoWletw8Q6y3aYpUN
GQuFkkucPY5NRqEajDTUZP0clA1dDUiOOkoi+RFykMOmIivgxlQkQQsx2Nu/VRV3
LPaIF/QiLK2k5e6NETnKP4dNVZWK1CDfk1TIoW4rYSfooSrDiJ31FpzK6kQEPHgf
6c8YzM6uaKtl0xxbmOgj4djgu2eqV2BcVT+kmHLREmnogr0Nc3WQFR8R+1GmwtAI
zFZxQaBpDa5u3AFTAGiOo8mWrhWTmQIDAQABo4GnMIGkMB0GA1UdDgQWBBRiF7l+
0Z4RvHybovfZSnCUeVijujB1BgNVHSMEbjBsgBRiF7l+0Z4RvHybovfZSnCUeVij
uqFJpEcwRTELMAkGA1UEBhMCTkwxEzARBgNVBAgTCk92ZXJpanNzZWwxITAfBgNV
BAoTGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZIIJANJOtQSOupsiMAwGA1UdEwQF
MAMBAf8wDQYJKoZIhvcNAQELBQADggEBAL/TV2uq7oHCc9DCZxitMWHC4TPSTgoC
mfJwQgSq9EOMmoCIOrp6b5PzyM6K1StT2dHo4ZkFjqLdyZi2+H8Xdg994wt9rIuo
Wm7EsubkfFSZDfVWpd1h98uUfzG2xhjsl/zJvZbEsUIimdUavaQrJP/KtAvrHKcP
G2XUSjZ8J4xTgTHM+WSBMYVsgbmIL3u6eQdCOKsbb4I/QehJI6lFKj+u1yPtcWF2
RmE44rTZj55a+pKGKjrxcSYvXmv0ioN2OFXyZFlYpuVE6cYzVcN3gney8K8FCVbp
XVmrNpuOl3Ke7NIzjdlEELvC/GuskCIc7EeZi+TTRbqCIvHnxXq63WY=
-----END CERTIFICATE-----
`
      ]

    , [ doc := `<DirectoryReq xmlns="http://www.idealdesk.com/ideal/messages/mer-acq/3.3.1" version="3.3.1"><createDateTimestamp>2019-04-08T21:46:25.510Z</createDateTimestamp><Merchant><merchantID>123456789</merchantID><subID>0</subID></Merchant><Signature xmlns="http://www.w3.org/2000/09/xmldsig#"><SignedInfo><CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/><SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/><Reference URI=""><Transforms><Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/></Transforms><DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/><DigestValue>lIKStyHuuKEf7VmR7glhtaxiCoBst5snJ0QSIGn2HuE=</DigestValue></Reference></SignedInfo><SignatureValue>oNQvZZD24kK5ZGRADCf70w3aYryhiXAUuqe1BfHpldlaTtoWOe/bQkBfx3bNAqSOIHLB6F0hGsrBtNxC0xG3jeTTYPgKlETfyHkl2vr5yXLqLqLBJQPYx/B+NgycQ/m7oxpxxrzMmYE+suH0l7BORK+2q/oYuGzM8qZ6OElDHJP48G44rOGS8KU9FJScMaZgpIaFHe7NLgAugmMoClg0Xg/FiSjvoV9G7UYZtugfK+2ankuN8fBxIu0h9nDj/XiPnuPJTKA12NS7TwomHbGHVOQRp5ciUlLhJQWbTM/46RWW80kC6xottf6jerAT1/oOVz1uekXTf+ZLhWXf8VNoSw==</SignatureValue><KeyInfo><KeyName>B4845CB5CBCEE3E1E0AFEF2662552A2365960E72</KeyName></KeyInfo></Signature></DirectoryReq>`
      , cert := `-----BEGIN CERTIFICATE-----
MIID+zCCAuOgAwIBAgIBADANBgkqhkiG9w0BAQsFADCBsjELMAkGA1UEBhMCTkwx
EDAOBgNVBAgMB0RyZW50aGUxDzANBgNVBAcMBk1lcHBlbDEVMBMGA1UECgwMQ29k
ZUJyYWluIEJWMRcwFQYDVQQLDA5pREVBTCBDaGVja291dDEmMCQGA1UEAwwdaHR0
cHM6Ly93d3cuaWRlYWwtY2hlY2tvdXQubmwxKDAmBgkqhkiG9w0BCQEWGXN1cHBv
cnRAaWRlYWwtY2hlY2tvdXQubmwwHhcNMTkwMjI3MTI1MDM2WhcNMjQwMjI2MTI1
MDM2WjCBsjELMAkGA1UEBhMCTkwxEDAOBgNVBAgMB0RyZW50aGUxDzANBgNVBAcM
Bk1lcHBlbDEVMBMGA1UECgwMQ29kZUJyYWluIEJWMRcwFQYDVQQLDA5pREVBTCBD
aGVja291dDEmMCQGA1UEAwwdaHR0cHM6Ly93d3cuaWRlYWwtY2hlY2tvdXQubmwx
KDAmBgkqhkiG9w0BCQEWGXN1cHBvcnRAaWRlYWwtY2hlY2tvdXQubmwwggEiMA0G
CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDnhW0IUhvN3lv1EyActGXWqL6gVD9d
ZYTtRLvTGEFXJw3XZjUGGPtyOFP1zt67+Bl+uqO7s0UiqOMuq/jq4bWEOlwX6gi5
1pNVFTUEsKerULoqLqFrBTL0XbhI5pAiTuzHrvgCGB7ebMQTj4SodABMetnmugCN
iJ/mu70RFk+PswsplE8KOWihhTZtjuMpLD59DUlAJn0efYw4n2zJInU6gEP3n8go
Z6O1pkdi9De28+zVD2XPSBFtwunVXKDKY4mltFUy5PDFvU86JyWWZcP6PLzAR937
8FpFnWivyIXxCWvBWhQpvKvzga0uHf8fblfdR115bxxKEV65ePIgChgTAgMBAAGj
GjAYMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMA0GCSqGSIb3DQEBCwUAA4IBAQCP
IU2Q23W36lGCVJg/l3GRpzF5JxQ7UdCb2SlC6dsp6HAkqKAQJyHR303qE6CXvsaC
7u8wFWeEDa29kRijWBODWt+WFHd4tUjS0cS/6HljYQZww0I3ILOzgLH4cWHPxQmV
UcKPXd7KXCtZnuZ9NDfRu1CchLQ7IdWBWWG/3h8yIC6fDBrTnPVxznUOjWjj8l11
z0t/URz+vhMEq0tLiQUsFEX+UPj9nInpFnPERLpsQgaw9uowx42Aa5uIHUoa+z7O
KWZvUn8LV2UFDOozJHfTcI4Bh6h+rX1xq5zwPDiiRv5grArspZuZI6c3IxvjOOP2
v6JOi66TCdG+rAbQzegK
-----END CERTIFICATE-----`
      ]
    ];

MACRO TestMultipleDocs()
{
  FOREVERY (RECORD rec FROM docs)
  {
    OBJECT response := MakeXMLDocument(StringToBlob(rec.doc));

    //PRINT("Testing " || #rec || ":\n" || BlobToString(response->GetDocumentBlob(TRUE), -1));

    OBJECT signcontext;
    IF (CellExists(rec, "assertion_ns"))
    {
      OBJECT assertion := response->GetElementsByTagNameNS(rec.assertion_ns, "Assertion")->Item(0);
      IF(NOT ObjectExists(assertion))
        THROW NEW Exception("No assertion");

      signcontext := GetXMLSignatureContextByNodes([ OBJECT(assertion) ]);
    }
    ELSE
    {
      signcontext := GetXMLSignatureContextByNodes([ OBJECT(response->documentelement) ]);
    }


    signcontext->SetX509Certificate(rec.cert);
    signcontext->ValidateSignature();

    OBJECT signed_doc := signcontext->GetSignedXMLDocument();
    IF (CellExists(rec, "assertion_ns"))
    {
      OBJECT assertion := signed_doc->GetElementsByTagNameNS(rec.assertion_ns, "Assertion")->Item(0);

      IF(NOT ObjectExists(assertion))
        THROW NEW Exception("No assertion in signed doc");
    }
  }
}

/// Tests the lowlevel sign/verify functions
MACRO TestLowLevelSignVerify()
{
  /** RSA 2048 bit private key
      Generated with
          OBJECT evpkey := GenerateCryptoKey("RSA", 2048);
          STRING privatekey := evpkey->privatekey;
  */
  STRING privatekey :=
      '-----BEGIN PRIVATE KEY-----\n' ||
      'MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDkT6t/6YbvtVcl\n' ||
      'xL8AfjrArFXCURrPvZpyI5BhRlQnGxCNl7E6QTEPRibycPoHNoTen51zENI0mxA5\n' ||
      'hSRz8xwwL4ISYyaKC9LzM80Xq0dqteJuxr5a1AGDbNu+1eu0miPUBCVA7uJYMe/7\n' ||
      'aX5ne94Y8lj9y6JewBZvJQVbk8yBluAZLebaToytRO/cFKpcqRDq1vaIgf9xQjdj\n' ||
      'OeJYx/RYkQVZiC2FHltfvSFTx2OByI0Ou0JMPseVkKwmb5wTg3kQl9m4B7hEzlvc\n' ||
      'u/zCmGncvFSvB7/HI6yLH4nBommbUms4Fuodfj+UkGNQDLZuGgDzpg2YXiwh7Zdt\n' ||
      'tcOuB46NAgMBAAECggEAP4kkUt5sHL08WVhdRwfZ1dCftQnZCkLbfjQDc+6ccJ2J\n' ||
      'h73VJj8KJhQBtqpWCjfT1hhZOrJNrTIR28//ivz2tTojWnaZPQV5WRDrXFDf+QRQ\n' ||
      '1T8dri0dlrNum7bwdzwGCHR24ZEZEC4leLOs56OC9TJMLaTDtNaD575HtWp2GQGb\n' ||
      'H0lV8s3J5M4sJse2WPDJERyqARdPArB75YzPrJL1vwsEo2HYWkhOwu9knfh8+XNo\n' ||
      'D7OjOz+s0zZDC8h7wQaLcpegbhURAg8mDN6bBPZ7s3eRPxZnrqscl5F2rov3SYgW\n' ||
      'kBa8W97mFIcUOIJpNoBlLkrGOvUz7rfBIXTSjA+YAQKBgQDz9NKtht4uYhfo8bnC\n' ||
      'prfTuej96OS7U16bsCtlkX+98G2lwTrf2EGg0RlegilFAgXpjrRo6ySyd1F28vLI\n' ||
      'ZfReQWXVxs2L0K3H75VUBM/YWxHdv31hSt198bf1mt9CCKd2PNFwIMF7ysaCVYmZ\n' ||
      '+Zs7b14/uP7di0DIl3x+H6NPAQKBgQDvlR7DzzCFHFIZLYIbjYduSu3fDVzAl/Vt\n' ||
      'LnwYplffdsDszDsPPRC0rCR7sKwWGyPyifDazHD32nZ6/Zfzvphj7JnfQS/a/0/v\n' ||
      'ldWAPNmZeuHmNXnSuMLIEPCSm3QopZHi3y4OoGozuW8F9PHdMXY2ssxqN1ygpdbH\n' ||
      'k7DV7LALjQKBgD4F4oJHpbk5K0cIHehFJrtnqrrTOUP/ADCo63+ZLFcIB3h61hMP\n' ||
      'EjBmuQJ0KTXoO8STiX6bOes9trJ9NgiJE0Xbbp6ZOqzvUx9f5CFGT+l7zeEIzEGu\n' ||
      'HP3mNJT22Qga1yiScdUGHurwNOPyB1fkQ/kqaVXeHL4Kp1/YU8hlFsoBAoGBAM4i\n' ||
      'DFVG96Ufh9eX2yDftY2EtIM8WPhwBj8JRsZioKpo33ceBRaIYM5CaiVuDbH7agNt\n' ||
      'AakPS4dFFLmfZVTXQQCAeqemy4juMJWf4hEyyboPCzvp+MYAJ77BLGvHirrKMen0\n' ||
      'QgldpeKZAlgqtsqsmtxXHB+rQGwMI+6VOQnmWlWlAoGAC2K0/mR40oCJA8SmGaW4\n' ||
      'xiWdx8hfG+Sa3L/WMHZXtHDvEMY6sN30sN8ZHfX4G5m3XO+9r06TFCPMS0k9vnzy\n' ||
      'ttr/of5ixQJIYxCx6V8qTSg2yIARBe1vuDV3eq8U/w0VtDX8lUEHwZsLpBQLpq3r\n' ||
      'H86smi5SwE9SSvUIWRsZeFQ=\n' ||
      '-----END PRIVATE KEY-----\n';

  /** Certificate for previous key
      Generated with code that looks like (rebuilt after losing it)
          GetPrimary()->BeginWork();
          OBJECT keypair := CreateKeyPair("samlkey", BobToString(privatekey), [ title := "samlkey", generateuniquename := TRUE ]);
          BLOB csr := keypair->GenerateCSR([ c := "NL", st := "Overijssel", l := "Enschede", o := "WebHare BV", cn := "SAML test certificate" ]);
          RECORD rec := keypair->SignCertificateRequest(csr, [ selfsign := TRUE, validuntil := MakeDate(2100, 1, 1) ]);
          STRING certificate := BlobToString(rec.certificate);
  */
  STRING certificate :=
      '-----BEGIN CERTIFICATE-----\n' ||
      'MIIDqDCCApCgAwIBAgIQGUnNhxoRxY1evmg7vV9jsDANBgkqhkiG9w0BAQsFADBu\n' ||
      'MQ4wDAYDVQQLDAVUZXN0czELMAkGA1UEBhMCTkwxEzARBgNVBAgMCk92ZXJpanNz\n' ||
      'ZWwxETAPBgNVBAcMCEVuc2NoZWRlMRMwEQYDVQQKDApXZWJoYXJlIEJWMRIwEAYD\n' ||
      'VQQDDAl3ZWJzZXJ2ZXIwHhcNMjAxMTMwMTA1NjI5WhcNMDAwMTAxMDAwMDAwWjBu\n' ||
      'MQ4wDAYDVQQLDAVUZXN0czELMAkGA1UEBhMCTkwxEzARBgNVBAgMCk92ZXJpanNz\n' ||
      'ZWwxETAPBgNVBAcMCEVuc2NoZWRlMRMwEQYDVQQKDApXZWJoYXJlIEJWMRIwEAYD\n' ||
      'VQQDDAl3ZWJzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDk\n' ||
      'T6t/6YbvtVclxL8AfjrArFXCURrPvZpyI5BhRlQnGxCNl7E6QTEPRibycPoHNoTe\n' ||
      'n51zENI0mxA5hSRz8xwwL4ISYyaKC9LzM80Xq0dqteJuxr5a1AGDbNu+1eu0miPU\n' ||
      'BCVA7uJYMe/7aX5ne94Y8lj9y6JewBZvJQVbk8yBluAZLebaToytRO/cFKpcqRDq\n' ||
      '1vaIgf9xQjdjOeJYx/RYkQVZiC2FHltfvSFTx2OByI0Ou0JMPseVkKwmb5wTg3kQ\n' ||
      'l9m4B7hEzlvcu/zCmGncvFSvB7/HI6yLH4nBommbUms4Fuodfj+UkGNQDLZuGgDz\n' ||
      'pg2YXiwh7ZdttcOuB46NAgMBAAGjQjBAMB0GA1UdDgQWBBR9fF4VVmNqvTUjf3To\n' ||
      'eb/Hp8GhejAfBgNVHSMEGDAWgBR9fF4VVmNqvTUjf3Toeb/Hp8GhejANBgkqhkiG\n' ||
      '9w0BAQsFAAOCAQEAagUH93/uug1P+5lKqwF0rRrlyaXcojzWhQwnbC7/nR0Q8KZc\n' ||
      'UwtCet2SW46uwXNSnwdY5jtXVkLDDAgw7y2vSTdc2GahF0qXBqvdgHLuhFHQL694\n' ||
      'UaZV7whHV+FeZBRPPOqqJ+dinzX+5XOcTjVQ3OnRZAWbdJgUrsUqITsDux0OEA5c\n' ||
      '6h4OXiTeTjRZ/zCX0g/9Y+N2rnCzJPx3qwQrem9kI7JgUKSR+4hUdx6jGxrvf4DA\n' ||
      '1FkaX7QCXMEI0p0Z/ohXSK5uSKEeOjb0r8slVAvKz5ntv/2qbM4zwLLHV0eVztbX\n' ||
      'C9VrcpdNNIRXq6F9RAM5s7B37QtUSnyU9hB/vQ==\n' ||
      '-----END CERTIFICATE-----\n';

  FOREVERY (STRING algo FROM
        [ "http://www.w3.org/2001/04/xmldsig-more#rsa-sha224"
        , "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
        , "http://www.w3.org/2001/04/xmldsig-more#rsa-sha384"
        , "http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"
        ])
  {
    STRING to_sign := "blablabla";
    STRING signature := CreateXMLSignature(algo, to_sign, privatekey, "");
    TestEQ(TRUE, VerifyXMLSignature(algo, to_sign, signature, DecodePEMFile(certificate).subjectpublickey));

    // see if GetDigestAlgorithmFromSignatureAlgorithm returns the right digest algorithm
    STRING method := `SHA-${SubString(algo, SearchLastSubString(algo, "-") + 4)}`;
    STRING digestalgo := GetDigestAlgorithmFromSignatureAlgorithm(algo);
    STRING method2 := `SHA-${SubString(digestalgo, SearchLastSubString(digestalgo, "#") + 4)}`;
    TestEQ(method, method2);

    // test digest encoding
    TestEQ(EncodeBase64(GetHashForString(to_sign, method)), GetXMLSignatureDigest(digestalgo, to_sign));
  }
}

/* ADDME: test if signing works correctly
   ADDME: test if GetSignedXMLDocument works correctly
*/

TestXMLDSigCases();
TestMultipleDocs();
TestLowLevelSignVerify();

