<?wh

LOADLIB "wh::internal/hsselftests.whlib";
LOADLIB "wh::util/semver.whlib";

MACRO TestSemVer_Increment()
{
  OpenTest("TestSemVer_Increment");

  STRING version := "0.1.0-release-candidate.1+2015-09-01-123456";
  TestEq(TRUE, IsValidVersion(version));
  RECORD decoded := DecodeVersion(version);
  TestEq(TRUE, RecordExists(decoded));
  TestEq(0, decoded.major);
  TestEq(1, decoded.minor);
  TestEq(0, decoded.patch);
  TestEq("release-candidate.1", decoded.prerelease);
  TestEq("2015-09-01-123456", decoded.build);
  TestEq(version, EncodeVersion(decoded));

  version := IncrementVersionPatch(version);
  TestEq(TRUE, IsValidVersion(version));
  decoded := DecodeVersion(version);
  TestEq(TRUE, RecordExists(decoded));
  TestEq(0, decoded.major);
  TestEq(1, decoded.minor);
  TestEq(1, decoded.patch);
  TestEq("release-candidate.1", decoded.prerelease);
  TestEq("2015-09-01-123456", decoded.build);
  TestEq(version, EncodeVersion(decoded));

  version := IncrementVersionMinor(version);
  TestEq(TRUE, IsValidVersion(version));
  decoded := DecodeVersion(version);
  TestEq(TRUE, RecordExists(decoded));
  TestEq(0, decoded.major);
  TestEq(2, decoded.minor);
  TestEq(0, decoded.patch);
  TestEq("release-candidate.1", decoded.prerelease);
  TestEq("2015-09-01-123456", decoded.build);
  TestEq(version, EncodeVersion(decoded));

  version := IncrementVersionMajor(version);
  TestEq(TRUE, IsValidVersion(version));
  decoded := DecodeVersion(version);
  TestEq(TRUE, RecordExists(decoded));
  TestEq(1, decoded.major);
  TestEq(0, decoded.minor);
  TestEq(0, decoded.patch);
  TestEq("release-candidate.1", decoded.prerelease);
  TestEq("2015-09-01-123456", decoded.build);
  TestEq(version, EncodeVersion(decoded));

  CloseTest("TestSemVer_Increment");
}

MACRO TestSemVer_Precedence()
{
  OpenTest("TestSemVer_Precedence");

  // 1.0.0 < 2.0.0 < 2.1.0 < 2.1.1
  TestEq(TRUE, IsVersionNewer("1.0.0", "2.0.0"));
  TestEq(FALSE, IsVersionNewer("2.0.0", "1.0.0"));
  TestEq(TRUE, IsVersionNewer("2.0.0", "2.1.0"));
  TestEq(FALSE, IsVersionNewer("2.1.0", "2.0.0"));
  TestEq(TRUE, IsVersionNewer("2.1.0", "2.1.1"));
  TestEq(FALSE, IsVersionNewer("2.1.1", "2.1.0"));

  // 1.0.0-alpha < 1.0.0
  TestEq(TRUE, IsVersionNewer("1.0.0-alpha", "1.0.0"));
  TestEq(FALSE, IsVersionNewer("1.0.0", "1.0.0-alpha"));

  // 1.0.0-alpha < 1.0.0-alpha.1 < 1.0.0-alpha.beta < 1.0.0-beta < 1.0.0-beta.2 < 1.0.0-beta.11 < 1.0.0-rc.1 < 1.0.0
  TestEq(TRUE, IsVersionNewer("1.0.0-alpha", "1.0.0-alpha.1"));
  TestEq(FALSE, IsVersionNewer("1.0.0-alpha.1", "1.0.0-alpha"));
  TestEq(TRUE, IsVersionNewer("1.0.0-alpha.1", "1.0.0-alpha.beta"));
  TestEq(FALSE, IsVersionNewer("1.0.0-alpha.beta", "1.0.0-alpha.1"));
  TestEq(TRUE, IsVersionNewer("1.0.0-alpha.beta", "1.0.0-beta"));
  TestEq(FALSE, IsVersionNewer("1.0.0-beta", "1.0.0-alpha.beta"));
  TestEq(TRUE, IsVersionNewer("1.0.0-beta", "1.0.0-beta.2"));
  TestEq(FALSE, IsVersionNewer("1.0.0-beta.2", "1.0.0-beta"));
  TestEq(TRUE, IsVersionNewer("1.0.0-beta.2", "1.0.0-beta.11"));
  TestEq(FALSE, IsVersionNewer("1.0.0-beta.11", "1.0.0-beta.2"));
  TestEq(TRUE, IsVersionNewer("1.0.0-beta.11", "1.0.0-rc.1"));
  TestEq(FALSE, IsVersionNewer("1.0.0-rc.1", "1.0.0-beta.11"));
  TestEq(TRUE, IsVersionNewer("1.0.0-rc.1", "1.0.0"));
  TestEq(FALSE, IsVersionNewer("1.0.0", "1.0.0-rc.1"));

  //ADDME: Test precedence with build identifiers

  CloseTest("TestSemVer_Precedence");
}

/** The lrt and gtr tests copied from https://github.com/npm/node-semver/, at commit 44cbc84

    License:

The ISC License

Copyright (c) Isaac Z. Schlueter and Contributors

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR
IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
*/

/* The loose parser isn't implemented, so the loose tests are disabled (these
   have 'true' as third element)
   Other disabled tests are commented out, with attached reason.
*/

VARIANT ARRAY ltr_tests := VARIANT[
    ['~1.2.2', '1.2.1'],
    ['~0.6.1-1', '0.6.1-0'],
    ['1.0.0 - 2.0.0', '0.0.1'],
    ['1.0.0-beta.2', '1.0.0-beta.1'],
    ['1.0.0', '0.0.0'],
    ['>=2.0.0', '1.1.1'],
    ['>=2.0.0', '1.2.9'],
    ['>2.0.0', '2.0.0'],
    ['0.1.20 || 1.2.4', '0.1.5'],
    ['2.x.x', '1.0.0'],
    ['1.2.x', '1.1.0'],
    ['1.2.x || 2.x', '1.0.0'],
    ['2.*.*', '1.0.1'],
    ['1.2.*', '1.1.3'],
    ['1.2.* || 2.*', '1.1.9999'],
    ['2', '1.0.0'],
    ['2.3', '2.2.2'],
    ['~2.4', '2.3.0'], // >=2.4.0 <2.5.0
    ['~2.4', '2.3.5'],
    ['~>3.2.1', '3.2.0'], // >=3.2.1 <3.3.0
    ['~1', '0.2.3'], // >=1.0.0 <2.0.0
    ['~>1', '0.2.4'],
    ['~> 1', '0.2.3'],
    ['~1.0', '0.1.2'], // >=1.0.0 <1.1.0
    ['~ 1.0', '0.1.0'],
    ['>1.2', '1.2.0'],
    ['> 1.2', '1.2.1'],
//    ['1', '0.0.0beta', true],
    ['~v0.5.4-pre', '0.5.4-alpha'],
    ['~v0.5.4-pre', '0.5.4-alpha'],
    ['=0.7.x', '0.6.0'],
    ['=0.7.x', '0.6.0-asdf'],
    ['>=0.7.x', '0.6.0'],
    ['~1.2.2', '1.2.1'],
    ['1.0.0 - 2.0.0', '0.2.3'],
    ['1.0.0', '0.0.1'],
    ['>=2.0.0', '1.0.0'],
    ['>=2.0.0', '1.9999.9999'],
    ['>=2.0.0', '1.2.9'],
    ['>2.0.0', '2.0.0'],
    ['>2.0.0', '1.2.9'],
    ['2.x.x', '1.1.3'],
    ['1.2.x', '1.1.3'],
    ['1.2.x || 2.x', '1.1.3'],
    ['2.*.*', '1.1.3'],
    ['1.2.*', '1.1.3'],
    ['1.2.* || 2.*', '1.1.3'],
    ['2', '1.9999.9999'],
    ['2.3', '2.2.1'],
    ['~2.4', '2.3.0'], // >=2.4.0 <2.5.0
    ['~>3.2.1', '2.3.2'], // >=3.2.1 <3.3.0
    ['~1', '0.2.3'], // >=1.0.0 <2.0.0
    ['~>1', '0.2.3'],
    ['~1.0', '0.0.0'], // >=1.0.0 <1.1.0
    ['>1', '1.0.0'],
//    ['2', '1.0.0beta', true],
//    ['>1', '1.0.0beta', true],
//    ['> 1', '1.0.0beta', true],
    ['=0.7.x', '0.6.2'],
    ['=0.7.x', '0.7.0-asdf'],
    ['^1', '1.0.0-0'],
    ['>=0.7.x', '0.7.0-asdf'],
//    ['1', '1.0.0beta', true],
    ['>=0.7.x', '0.6.2']
//    ['>1.2.3', '1.3.0-alpha'] // Rob: Not sure why this should be less
  ];


VARIANT ARRAY ltr_neg_tests := VARIANT[ // Version should NOT be less than range
    ['~ 1.0', '1.1.0'],
    ['~0.6.1-1', '0.6.1-1'],
    ['1.0.0 - 2.0.0', '1.2.3'],
    ['1.0.0 - 2.0.0', '2.9.9'],
    ['1.0.0', '1.0.0'],
    ['>=*', '0.2.4'],
//    ['', '1.0.0', true],
    ['*', '1.2.3'],
    ['>=1.0.0', '1.0.0'],
    ['>=1.0.0', '1.0.1'],
    ['>=1.0.0', '1.1.0'],
    ['>1.0.0', '1.0.1'],
    ['>1.0.0', '1.1.0'],
    ['<=2.0.0', '2.0.0'],
    ['<=2.0.0', '1.9999.9999'],
    ['<=2.0.0', '0.2.9'],
    ['<2.0.0', '1.9999.9999'],
    ['<2.0.0', '0.2.9'],
    ['>= 1.0.0', '1.0.0'],
    ['>=  1.0.0', '1.0.1'],
    ['>=   1.0.0', '1.1.0'],
    ['> 1.0.0', '1.0.1'],
    ['>  1.0.0', '1.1.0'],
    ['<=   2.0.0', '2.0.0'],
    ['<= 2.0.0', '1.9999.9999'],
    ['<=  2.0.0', '0.2.9'],
    ['<    2.0.0', '1.9999.9999'],
    ['<\t2.0.0', '0.2.9'],
    ['>=0.1.97', 'v0.1.97'],
    ['>=0.1.97', '0.1.97'],
    ['0.1.20 || 1.2.4', '1.2.4'],
    ['0.1.20 || >1.2.4', '1.2.4'],
    ['0.1.20 || 1.2.4', '1.2.3'],
    ['0.1.20 || 1.2.4', '0.1.20'],
    ['>=0.2.3 || <0.0.1', '0.0.0'],
    ['>=0.2.3 || <0.0.1', '0.2.3'],
    ['>=0.2.3 || <0.0.1', '0.2.4'],
    ['||', '1.3.4'],
    ['2.x.x', '2.1.3'],
    ['1.2.x', '1.2.3'],
    ['1.2.x || 2.x', '2.1.3'],
    ['1.2.x || 2.x', '1.2.3'],
    ['x', '1.2.3'],
    ['2.*.*', '2.1.3'],
    ['1.2.*', '1.2.3'],
    ['1.2.* || 2.*', '2.1.3'],
    ['1.2.* || 2.*', '1.2.3'],
    ['1.2.* || 2.*', '1.2.3'],
    ['*', '1.2.3'],
    ['2', '2.1.2'],
    ['2.3', '2.3.1'],
    ['~2.4', '2.4.0'], // >=2.4.0 <2.5.0
    ['~2.4', '2.4.5'],
    ['~>3.2.1', '3.2.2'], // >=3.2.1 <3.3.0
    ['~1', '1.2.3'], // >=1.0.0 <2.0.0
    ['~>1', '1.2.3'],
    ['~> 1', '1.2.3'],
    ['~1.0', '1.0.2'], // >=1.0.0 <1.1.0
    ['~ 1.0', '1.0.2'],
    ['>=1', '1.0.0'],
    ['>= 1', '1.0.0'],
    ['<1.2', '1.1.1'],
    ['< 1.2', '1.1.1'],
    ['~v0.5.4-pre', '0.5.5'],
    ['~v0.5.4-pre', '0.5.4'],
    ['=0.7.x', '0.7.2'],
    ['>=0.7.x', '0.7.2'],
    ['<=0.7.x', '0.6.2'],
    ['>0.2.3 >0.2.4 <=0.2.5', '0.2.5'],
    ['>=0.2.3 <=0.2.4', '0.2.4'],
    ['1.0.0 - 2.0.0', '2.0.0'],
    ['^3.0.0', '4.0.0'],
    ['^1.0.0 || ~2.0.1', '2.0.0'],
    ['^0.1.0 || ~3.0.1 || 5.0.0', '3.2.0'],
/*    ['^0.1.0 || ~3.0.1 || 5.0.0', '1.0.0beta', true],
    ['^0.1.0 || ~3.0.1 || 5.0.0', '5.0.0-0', true],
    ['^0.1.0 || ~3.0.1 || >4 <=5.0.0', '3.5.0'],
    ['^1.0.0alpha', '1.0.0beta', true],
    ['~1.0.0alpha', '1.0.0beta', true],
    ['^1.0.0-alpha', '1.0.0beta', true],
    ['~1.0.0-alpha', '1.0.0beta', true],*/
    ['^1.0.0-alpha', '1.0.0-beta'],
    ['~1.0.0-alpha', '1.0.0-beta'],
    ['=0.1.0', '1.0.0']
  ];


VARIANT ARRAY gtr_tests := VARIANT[ //  Version should be greater than range
    ['~1.2.2', '1.3.0'],
    ['~0.6.1-1', '0.7.1-1'],
    ['1.0.0 - 2.0.0', '2.0.1'],
    ['1.0.0', '1.0.1-beta1'],
    ['1.0.0', '2.0.0'],
    ['<=2.0.0', '2.1.1'],
    ['<=2.0.0', '3.2.9'],
    ['<2.0.0', '2.0.0'],
    ['0.1.20 || 1.2.4', '1.2.5'],
    ['2.x.x', '3.0.0'],
    ['1.2.x', '1.3.0'],
    ['1.2.x || 2.x', '3.0.0'],
    ['2.*.*', '5.0.1'],
    ['1.2.*', '1.3.3'],
    ['1.2.* || 2.*', '4.0.0'],
    ['2', '3.0.0'],
    ['2.3', '2.4.2'],
    ['~2.4', '2.5.0'], // >=2.4.0 <2.5.0
    ['~2.4', '2.5.5'],
    ['~>3.2.1', '3.3.0'], // >=3.2.1 <3.3.0
    ['~1', '2.2.3'], // >=1.0.0 <2.0.0
    ['~>1', '2.2.4'],
    ['~> 1', '3.2.3'],
    ['~1.0', '1.1.2'], // >=1.0.0 <1.1.0
    ['~ 1.0', '1.1.0'],
    ['<1.2', '1.2.0'],
    ['< 1.2', '1.2.1'],
//    ['1', '2.0.0beta', true],
    ['~v0.5.4-pre', '0.6.0'],
    ['~v0.5.4-pre', '0.6.1-pre'],
    ['=0.7.x', '0.8.0'],
    ['=0.7.x', '0.8.0-asdf'],
    ['<0.7.x', '0.7.0'],
    ['~1.2.2', '1.3.0'],
    ['1.0.0 - 2.0.0', '2.2.3'],
    ['1.0.0', '1.0.1'],
    ['<=2.0.0', '3.0.0'],
    ['<=2.0.0', '2.9999.9999'],
    ['<=2.0.0', '2.2.9'],
    ['<2.0.0', '2.9999.9999'],
    ['<2.0.0', '2.2.9'],
    ['2.x.x', '3.1.3'],
    ['1.2.x', '1.3.3'],
    ['1.2.x || 2.x', '3.1.3'],
    ['2.*.*', '3.1.3'],
    ['1.2.*', '1.3.3'],
    ['1.2.* || 2.*', '3.1.3'],
    ['2', '3.1.2'],
    ['2.3', '2.4.1'],
    ['~2.4', '2.5.0'], // >=2.4.0 <2.5.0
    ['~>3.2.1', '3.3.2'], // >=3.2.1 <3.3.0
    ['~1', '2.2.3'], // >=1.0.0 <2.0.0
    ['~>1', '2.2.3'],
    ['~1.0', '1.1.0'], // >=1.0.0 <1.1.0
    ['<1', '1.0.0'],
//    ['1', '2.0.0beta', true],
//    ['<1', '1.0.0beta', true],
//    ['< 1', '1.0.0beta', true],
    ['=0.7.x', '0.8.2'],
    ['<0.7.x', '0.7.2']
  ];

VARIANT ARRAY gtr_neg_tests := VARIANT[ //  Version should not be greater than range
    ['~0.6.1-1', '0.6.1-1'],
    ['1.0.0 - 2.0.0', '1.2.3'],
    ['1.0.0 - 2.0.0', '0.9.9'],
    ['1.0.0', '1.0.0'],
    ['>=*', '0.2.4'],
//    ['', '1.0.0', true],
    ['*', '1.2.3'],
//    ['*', 'v1.2.3-foo'],
    ['>=1.0.0', '1.0.0'],
    ['>=1.0.0', '1.0.1'],
    ['>=1.0.0', '1.1.0'],
    ['>1.0.0', '1.0.1'],
    ['>1.0.0', '1.1.0'],
    ['<=2.0.0', '2.0.0'],
    ['<=2.0.0', '1.9999.9999'],
    ['<=2.0.0', '0.2.9'],
    ['<2.0.0', '1.9999.9999'],
    ['<2.0.0', '0.2.9'],
    ['>= 1.0.0', '1.0.0'],
    ['>=  1.0.0', '1.0.1'],
    ['>=   1.0.0', '1.1.0'],
    ['> 1.0.0', '1.0.1'],
    ['>  1.0.0', '1.1.0'],
    ['<=   2.0.0', '2.0.0'],
    ['<= 2.0.0', '1.9999.9999'],
    ['<=  2.0.0', '0.2.9'],
    ['<    2.0.0', '1.9999.9999'],
    ['<\t2.0.0', '0.2.9'],
    ['>=0.1.97', 'v0.1.97'],
    ['>=0.1.97', '0.1.97'],
    ['0.1.20 || 1.2.4', '1.2.4'],
    ['0.1.20 || >1.2.4', '1.2.4'],
    ['0.1.20 || 1.2.4', '1.2.3'],
    ['0.1.20 || 1.2.4', '0.1.20'],
    ['>=0.2.3 || <0.0.1', '0.0.0'],
    ['>=0.2.3 || <0.0.1', '0.2.3'],
    ['>=0.2.3 || <0.0.1', '0.2.4'],
    ['||', '1.3.4'],
    ['2.x.x', '2.1.3'],
    ['1.2.x', '1.2.3'],
    ['1.2.x || 2.x', '2.1.3'],
    ['1.2.x || 2.x', '1.2.3'],
    ['x', '1.2.3'],
    ['2.*.*', '2.1.3'],
    ['1.2.*', '1.2.3'],
    ['1.2.* || 2.*', '2.1.3'],
    ['1.2.* || 2.*', '1.2.3'],
    ['1.2.* || 2.*', '1.2.3'],
    ['*', '1.2.3'],
    ['2', '2.1.2'],
    ['2.3', '2.3.1'],
    ['~2.4', '2.4.0'], // >=2.4.0 <2.5.0
    ['~2.4', '2.4.5'],
    ['~>3.2.1', '3.2.2'], // >=3.2.1 <3.3.0
    ['~1', '1.2.3'], // >=1.0.0 <2.0.0
    ['~>1', '1.2.3'],
    ['~> 1', '1.2.3'],
    ['~1.0', '1.0.2'], // >=1.0.0 <1.1.0
    ['~ 1.0', '1.0.2'],
    ['>=1', '1.0.0'],
    ['>= 1', '1.0.0'],
    ['<1.2', '1.1.1'],
    ['< 1.2', '1.1.1'],
//    ['1', '1.0.0beta', true],
    ['~v0.5.4-pre', '0.5.5'],
    ['~v0.5.4-pre', '0.5.4'],
    ['=0.7.x', '0.7.2'],
    ['>=0.7.x', '0.7.2'],
    ['=0.7.x', '0.7.0-asdf'],
    ['>=0.7.x', '0.7.0-asdf'],
    ['<=0.7.x', '0.6.2'],
    ['>0.2.3 >0.2.4 <=0.2.5', '0.2.5'],
    ['>=0.2.3 <=0.2.4', '0.2.4'],
    ['1.0.0 - 2.0.0', '2.0.0'],
    ['^1', '0.0.0-0'],
    ['^3.0.0', '2.0.0'],
    ['^1.0.0 || ~2.0.1', '2.0.0'],
    ['^0.1.0 || ~3.0.1 || 5.0.0', '3.2.0'],
//    ['^0.1.0 || ~3.0.1 || 5.0.0', '1.0.0beta', true],
//    ['^0.1.0 || ~3.0.1 || 5.0.0', '5.0.0-0', true],
    ['^0.1.0 || ~3.0.1 || >4 <=5.0.0', '3.5.0']
    ];

/** Satisfyability tests
*/
RECORD ARRAY satis_tests :=
    [ [ range := "",                  matches := [ "2.1.0" ], nonmatches := STRING[] ]
    , [ range := "*",                 matches := [ "2.1.0" ], nonmatches := STRING[] ]
    , [ range := ">=2.1.0",           matches := [ "2.1.0", "2.1.1", "2.2.2", "3.0.0" ], nonmatches := [ "2.0.9", "2.1.0-prerelease", "2.2.0-prerelease" ] ]
    , [ range := ">2.1.0",            matches := [ "2.1.1", "2.2.2", "3.0.0" ], nonmatches := [ "2.1.0", "2.0.9", "2.1.0-prerelease", "2.2.0-prerelease" ] ]
    , [ range := ">2.1.0-pre.1",      matches := [ "2.1.0-prerelease", "2.1.0", "2.1.1", "2.2.2", "3.0.0" ], nonmatches := [ "2.0.9", "2.2.0-prerelease" ] ]
    , [ range := "=2.1.0 || 2.1.1",   matches := [ "2.1.0", "2.1.1" ], nonmatches := [ "2.0.9", "2.1.0-prerelease", "2.2.0-prerelease", "2.2.2", "3.0.0" ] ]
    , [ range := "2.1.x",             matches := [ "2.1.0", "2.1.1" ], nonmatches := [ "2.0.9", "2.1.0-prerelease", "2.2.0-prerelease", "2.2.2", "3.0.0" ] ]
    , [ range := "2.x.x",             matches := [ "2.1.0", "2.1.1", "2.9.9" ], nonmatches := [ "1.9.9", "2.1.0-prerelease", "2.2.0-prerelease", "3.0.0" ] ]
    , [ range := "~2.1.1",            matches := [ "2.1.1", "2.1.2" ], nonmatches := [ "2.0.9", "2.1.0", "2.1.0-prerelease", "2.2.0-prerelease", "2.2.2", "3.0.0" ] ]
    , [ range := "~2.1.1-pre.1",      matches := [ "2.1.1-pre.1", "2.1.1-pre.2", "2.1.1", "2.1.2" ], nonmatches := [ "2.0.9", "2.1.0", "2.1.1-pre.0", "2.2.0-prerelease", "2.2.2", "3.0.0" ] ]
    , [ range := "~2",                matches := [ "2.0.0", "2.1.0", "2.2.2" ], nonmatches := [ "1.9.9", "2.1.0-prerelease", "2.2.0-prerelease", "3.0.0" ] ]
    , [ range := "^0.0.3",            matches := [ "0.0.3" ], nonmatches := [ "0.0.3-prerelease", "0.0.4-prerelease", "0.0.4" ] ]
    , [ range := "^0.2.3",            matches := [ "0.2.3", "0.2.4" ], nonmatches := [ "0.2.3-prerelease", "0.2.4-prerelease", "0.3.0" ] ]
    , [ range := "^1.2.3",            matches := [ "1.2.3", "1.2.4", "1.3.0" ], nonmatches := [ "0.2.3-prerelease", "0.2.4-prerelease", "2.0.0" ] ]
    , [ range := "1.0.1 - 1.1.3",     matches := [ "1.0.1", "1.0.2", "1.1.3", "1.1.2" ], nonmatches := [ "1.0.0", "1.1.4", "1.2.0" ] ]
    , [ range := "git://bla",         matches := [ "git://bla", "git://bla#0123456789012345678901234567890123456789" ], nonmatches := [ "git://blab.git" ] ]
    , [ range := "git://bla.git",     matches := [ "git://bla.git", "git://bla.git#0123456789012345678901234567890123456789" ], nonmatches := [ "git://blab.git" ] ]
    ];


MACRO TestSemVer_Ranges()
{
  FOREVERY (VARIANT v FROM ltr_tests)
  {
    RECORD cmp := __CompareSemverRangeWithVersion(v[0], v[1]);
    IF (NOT cmp.smaller)
      ABORT(v);
  }

  FOREVERY (VARIANT v FROM ltr_neg_tests)
  {
    RECORD cmp := __CompareSemverRangeWithVersion(v[0], v[1]);
    IF (cmp.smaller AND NOT cmp.satisfies)
      ABORT(v);
  }

  FOREVERY (VARIANT v FROM gtr_tests)
  {
    RECORD cmp := __CompareSemverRangeWithVersion(v[0], v[1]);
    IF (NOT cmp.larger)
      ABORT(v);
  }

  FOREVERY (VARIANT v FROM gtr_neg_tests)
  {
    RECORD cmp := __CompareSemverRangeWithVersion(v[0], v[1]);
    IF (cmp.larger AND NOT cmp.satisfies)
      ABORT(v);
  }

  FOREVERY (RECORD r FROM satis_tests)
  {
    FOREVERY (STRING match FROM r.matches)
      IF (NOT VersionSatisfiesRange(match, r.range))
        ABORT(CELL[ r.range, match ]);
    FOREVERY (STRING nonmatch FROM r.nonmatches)
      IF (VersionSatisfiesRange(nonmatch, r.range))
        ABORT(CELL[ r.range, nonmatch ]);
  }
}


Print("\n === Running TestSemVer\n");

//ADDME: Test various valid and invalid version strings
TestSemVer_Increment();
TestSemVer_Precedence();
TestSemVer_Ranges();
