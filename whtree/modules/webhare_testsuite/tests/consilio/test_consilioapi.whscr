<?wh
LOADLIB "wh::datetime.whlib";
LOADLIB "mod::consilio/lib/api.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

MACRO TestConsilioAPI()
{
  OBJECT catalog := OpenConsilioCatalog(testfw->GetCatalogName_1());
  TestEq(TRUE, ObjectExists(catalog));

  testfw->BeginWork();
  OBJECT newcatalog := catalog->AddPublisherContentSource(OpenTestsuiteSite()->OpenByPath("testpages")->id);
  testfw->CommitWork();
  newcatalog->WaitForIndexingDone([ verbose := TRUE
                                  , deadline := AddTimeToDate(5 * 60 * 1000,GetCurrentDatetime())
                                  ]);

  RECORD result := RunConsilioSearch(testfw->GetCatalogName_1(), CQParseUserQuery("simpletest"));
  TestEq(TRUE, Length(result.results) > 0);
}

RunTestframework(
    [ PTR TestConsilioAPI
    ],
    [ consilio := TRUE
    ]);
