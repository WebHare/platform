<?wh

LOADLIB "wh::datetime.whlib";
LOADLIB "wh::internet/urls.whlib";

LOADLIB "mod::system/lib/logging.whlib";


PUBLIC STRING ARRAY FUNCTION TestInvoke_GetPxlLogFiles(STRING sessionid, STRING rangestart)
{
  RETURN FilterRecentHits(sessionid, MakeDateFromText(rangestart));
}

// Borrowed from mod::system/lib/internal/cache/imgcache.whlib
STRING ARRAY FUNCTION FilterRecentHits(STRING sessionid, DATETIME rangestart)
{
  OBJECT accesslog := OpenWebHareLogStream("pxl", rangestart, GetCurrentDateTime());
  STRING ARRAY lines;
  WHILE (TRUE)
  {
    RECORD row := accesslog->ReadRecord();
    IF (NOT RecordExists(row))
      BREAK;

    IF(GetVariableFromURL(row.url,"ps") = sessionid)
      INSERT row.url INTO lines AT END;
  }
  RETURN lines;
}
