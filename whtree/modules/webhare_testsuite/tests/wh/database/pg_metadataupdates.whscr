<?wh

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::webhare_testsuite/lib/db/tablecreate.whlib";


MACRO TestByteaConversion()
{
  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="byteaconversiontest" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256" nullable="0"/>
    </d:table>
  </databaseschema>
`);
  TABLE< INTEGER id, STRING name > tbl_text := BindTransactionToTable(GetPrimary()->id, "webhare_testsuite_temp.byteaconversiontest");
  testfw->BeginWork();
  INSERT [ id := 1, name := `E'\\000'` ] INTO tbl_text;
  testfw->CommitWork();

  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="byteaconversiontest" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:bytea name="name" maxlength="256" />
    </d:table>
  </databaseschema>
`);

  TestEQ(
      [ [ id := 1, name := `E'\\000'` ]
      ], SELECT * FROM tbl_text ORDER BY id);
}

MACRO TestIndexDrops()
{
  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="indextest1" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256" nullable="0"/>
      <d:index name="idx1" columns="name(20)" />
    </d:table>
    <d:table name="indextest2" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256" nullable="0"/>
      <d:index name="idx1" columns="name(20)" />
    </d:table>
  </databaseschema>
`);

  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="indextest1" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256" nullable="0"/>
      <d:obsoleteindex name="idx1" columns="name(20)" />
    </d:table>
    <d:obsoletetable name="indextest2" />
  </databaseschema>
`);
}

MACRO TestColumnAttributes()
{
  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="attrtest" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256"/>
    </d:table>
  </databaseschema>
`);

  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="attrtest" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="512" unique="true" nullable="false"/>
    </d:table>
  </databaseschema>
`);

  //and revert
  ApplyTempDatabaseSchema(`
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="attrtest" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256"/>
    </d:table>
  </databaseschema>
`);
}

RunTestframework([ PTR SetupTempSchema
                 , PTR TestByteaConversion
                 , PTR TestIndexDrops
                 , PTR TestColumnAttributes
                 ]);
