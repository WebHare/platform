<?wh

LOADLIB "wh::datetime.whlib";
LOADLIB "wh::internet/jwt.whlib";

LOADLIB "mod::system/lib/testframework.whlib";


MACRO JWTTest()
{
  RECORD test_payload :=
      [ iat := MakeDateTime(2015, 2, 1, 8, 33, 58)
      , loggedInAs := "admin"
      ];
  RECORD test_payload_translations :=
      CELL[ "loggedInAs" ];

  STRING key_id := "testkey";

  // wh sql '?generaterandomtext(32,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_")'
  STRING hs256_key := "vK8nPk52L4na1Z85_rt5-jxspDlPoX1r";
  // wh sql '?generaterandomtext(48,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_")'
  STRING hs384_key := "pD-cODl8zkS2nPeFdWVPVm4AjssXUtCrAmcpDJCgpnvPIcRF";
  // wh sql '?generaterandomtext(64,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_")'
  STRING hs512_key := "Jw-9_HLo2jv9Aem0ev3rBPEMTYemotg1yR386O8xMQy_-sk9KNclOLO5jeGExiul";

  // openssl genrsa -out rsa1024-key.pem 1024
  STRING rsa1024_key := `-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQCp0zmr5DnmgdQKc9vEkV1o4HMYUo3O3aRG3yDlyoXZNCWZCHMw
2Yf9NwF01h7mmGJKP96GVcsXS5Y9YJZnjabafnyA6g3+az9LDMHq2yEBWMBhzl70
ZE+VuHZeLZlRjeGYj+LvyxvL/0aAg8OZgYrH+ML/eAqMtuPW8TRdIOj8xQIDAQAB
AoGAYETT+YQb6naIXBCHcWuyFwS9WflaV/0+5coQ3RKsQ4+TDKhEnFmEBF/NHI1Q
4QlbFpoUK/SwdxkrJsn9GOCsx1zrsklMdAi6+edQgWUksZMKSxwvY7b2de3o3CrH
9y3K40h9gPCYpLQ/PSlTyxG4yy5heS2+2ZmGrJ6assGuLNUCQQDR1G87Cn82GpeX
TLSOCbATTc/tFDPYARW3N14MH5YqngNO7c2WytdBTcOW6sGpzEBphh3T8Po5K0RX
7sRgNWx3AkEAzzFaXiip38e0kPTKUyP92KLIoYqzDa/hqmOY1VMMHXd2m5Y3gMzQ
5183EUrztmTMWWG4/2HQHqrdqIMZ+Sa7owJAMJuzwMunuJLkdypP0W+xGGe4OUWq
1Ok7bJwo70oJ8Yl1Xr18GOiYgQpQuw9bGci1SzzEgCqc7M13IZ+wYlE99QJAZJ0R
xiG3BG2FONM2oRMcRSQfi5rAAoiDbGu7HvSaMID/vuQ+hbRwSbsKEcK1AMCIH2t+
G74TA6FzzE4FweDWQwJBAL+nrPEDYfUhiDlGuA+muuW3OyfacD5z7KWU3FYEq160
tWK1xdM289SBFRShNDexkPUx0+Io0YBxrc+cbyuvhJA=
-----END RSA PRIVATE KEY-----
`;
  // openssl genrsa -out rsa2048-key.pem 2048
  STRING rsa2048_key := `-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA0Z21Anm79hISMaoIL17tCgF+vTQmu6gK2vDgDSm/G2HggO1Q
1ByaFvw29sVTHhLVAN9W/cWNQeNZp053T/OP23iIwTzt7V6GiSFcUzyJDsZEg26k
WQjsGVaklrTfWi8MzOjHAej79Moki+/+nwRlQHk7DrJHD8WnPdO886vt7JY03lOL
cAqpld0xYojQZJ7Ku2eSyrArcZeL/Sgt97ZwpJ8hk+mVnSYK8GhlCKjHNH08UXVo
rkA0du//djPLL+Ylldq1X0/3NfEolo89nm5ZZEQxeeiMTyf6UNZV795v2yeShLpp
LARSo/k+P6b3nlxz8ccgdzOvyChDtzHL0KgdzwIDAQABAoIBAQDJr+bEdQEnqQec
ha/OdJW69OlPf2htUyjutKm/wJVC8ZAkPTNyg/q3dwIjuoVZAGG2ry5yiqx54xkW
Y+dlJEMctwNOeyOrKzJjq5e79xkhACBYHhNAH9ecIcPHxkzJ5093sdoZumUDiaRU
iR0DQCV0PbFXWK4LPPDICn1aL+mDot0c/PMmdR1cNgleipFwA7tv4CBcmU4PLJTR
DmUSYE3wqfDzeF5D1MMzh23nGR/9QgY0P9N2UjmPgK9t9yYJ3qJuw5G5kiHuD5d1
lj4BjZqmL7J4nk1w0MFhClalUOS64ayZifI5kPsGBAbb/sDYaazEQqFGmVRNUB+j
uviKyNjxAoGBAPF6iQCpf+Wyf1VbrV182XF+4tdkidf/SQAONzA4S615q66tyu0K
bBX1Os6LvJA8k6lGTZMmq5OPXvDfMmYjur9gAlUPglqFca5AUIvKM7jGlOt1RhLM
pZ+mR9xBttms5/DFRQU3nUPt3i2ihJJVoj9bLSVSTuQG3uG18O1wTJptAoGBAN44
qPvNMNvNhxFUOnBm9VAQHVp9X3PAiSMUWeUNnEYbb2DiVKmUQ9JwiO9DuYdAp6/P
VLhMfPHEkg9d383mFAOLZHGiVqvhWMxph6qUQcm501JLJC7+FlsUxvCNImwlmYI/
VJrWIM4ZsgLZ5OtfgB8tams4iElkyZgZAB9h1nOrAoGBAKdJBQoRYknk+zNN3G8M
Y7KtfUZMHvYkoxTHxFHCXiLiTB4pxY+rDa+0gDXANjQR0xWMX4dWXbxOsS3a4ZZC
oEedol/864f8NAHMCkCdJnGWGGp5hr7VSNOtpNCgMaTglJmGf8cafPcnHSiuEnsx
mcGcT00wlPiBDfx9R1el2VuNAoGABYz6w5djggoHNqqY7xfTRtWwNgNtr/F+O28V
s7/8SFAFHzFoFfhLHWWMNhXF+5fk2GJgZl4avNtBHrskjPsTQudnceMxMQfm9Owp
5FvhrM1EdwjDdZ0JJ+tD8NxFoNfrlrJIRbnVhfBkXufcbPistZqnztfRp6up0W/G
bgI+nhMCgYAV48ldmkOkuSmU4zC7bX7nM8iMMBc3WwTHdrRm/BlF7tbrfR23+uPl
nssXZPP0RSPp7+egXm2rV7wYdTVhBSaVkZgtxbZCYIVG/O/KtynjBjCn1h0Xfbmi
AJxNsTR+50+0l5mXfLqF3OSkoHY2ER4AX/ciqtLWZhQDbAQnoUGvxw==
-----END RSA PRIVATE KEY-----
`;
  // openssl rsa -in rsa2048-key.pem -pubout -out rsa2048-pub.pem
  STRING rsa2048_key_pub := `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0Z21Anm79hISMaoIL17t
CgF+vTQmu6gK2vDgDSm/G2HggO1Q1ByaFvw29sVTHhLVAN9W/cWNQeNZp053T/OP
23iIwTzt7V6GiSFcUzyJDsZEg26kWQjsGVaklrTfWi8MzOjHAej79Moki+/+nwRl
QHk7DrJHD8WnPdO886vt7JY03lOLcAqpld0xYojQZJ7Ku2eSyrArcZeL/Sgt97Zw
pJ8hk+mVnSYK8GhlCKjHNH08UXVorkA0du//djPLL+Ylldq1X0/3NfEolo89nm5Z
ZEQxeeiMTyf6UNZV795v2yeShLppLARSo/k+P6b3nlxz8ccgdzOvyChDtzHL0Kgd
zwIDAQAB
-----END PUBLIC KEY-----
`;

  // openssl ecparam -name prime256v1 -genkey -noout -out prime256v1-key.pem
  STRING ec256_key := `-----BEGIN EC PRIVATE KEY-----
MHcCAQEEIDIUPGggV0kaA0EsEJ2MQmisWM6LMRxmJKOz7sK3DGDuoAoGCCqGSM49
AwEHoUQDQgAEzsc8VxLRJFPhnihLK1Ji0dkFfU/jWfH60YoDC+xmxhXj7MUDALvV
sOKchPyvS05GWLHLb0KojLBpuua//O4pqQ==
-----END EC PRIVATE KEY-----
`;
  // openssl ec -in prime256v1-key.pem -pubout -out prime256v1-pub.pem
  STRING ec256_key_pub := `-----BEGIN PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEzsc8VxLRJFPhnihLK1Ji0dkFfU/j
WfH60YoDC+xmxhXj7MUDALvVsOKchPyvS05GWLHLb0KojLBpuua//O4pqQ==
-----END PUBLIC KEY-----
`;
  // openssl ecparam -name secp384r1 -genkey -noout -out secp384r1-key.pem
  STRING ec384_key := `-----BEGIN EC PRIVATE KEY-----
MIGkAgEBBDAGCIHQBF1k6dh0GhywT+o3NJ9f0ys+iMSEjggAwRdraq4+lZKPFYyl
KNlx6uk+blqgBwYFK4EEACKhZANiAATvWbjRaOdWdh2WfP3NWWszARc7S6N1qc32
YHi/IF4qULO6lR5pJ29s3R4sBxXC3wPyIlNkQtOKuDmBivGPcMWPM0ozoYo5FzxQ
DMHPjQYvJx8slq5cWRsNcQ7z8/WNi/E=
-----END EC PRIVATE KEY-----
`;
  // openssl ecparam -name secp521r1 -genkey -noout -out secp521r1-key.pem
  STRING ec521_key := `-----BEGIN EC PRIVATE KEY-----
MIHbAgEBBEGtvBuChFjMEraxYT3QCxHdodHqrgF0nD31VKCn5UN03RKU9kUaOCeT
7vJhths8beTqYrGiXhartzYrGoIya3/J16AHBgUrgQQAI6GBiQOBhgAEAVItej8f
25Ure36UHoKAaIfrlb5GE48/+6P/kefamDU8xiQg8g0YUzWr16YSN2/KyCC8E3li
jTu2VmLTXYIFr39KAAtMKWgek7pD5PiMFltaA0M5sHB+ExEb9gGPokIYKv2erPvW
+55e9ms8H0VPaOvheHG8QOSS7CyUZfqNflmRYy11
-----END EC PRIVATE KEY-----
`;

  // Hard-coded auth values are generated using http://jwt.io/

  // none
  OBJECT jwt_token := NEW JSONWebToken("none", "");
  jwt_token->SetPayload(test_payload, test_payload_translations);

  STRING authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.", authvalue);

  TestThrowsLike("Invalid signature \'AQ\' for algorithm \'none\' for JWT token", PTR VerifyJSONWebToken(MakeAuthValueInvalid(authvalue), [ alg := [ "none" ], translations := test_payload_translations ]));
  OBJECT verified := VerifyJSONWebToken(authvalue, [ alg := [ "none" ], translations := test_payload_translations ]);
  TestEq(test_payload, verified->payload);

  // HS256
  TestThrowsLike("Invalid key size 10 for algorithm \'HS256\'", PTR TestMakeJSONWebToken("HS256", "secret_key")); // key length mismatch
  jwt_token := NEW JSONWebToken("HS256", hs256_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.H8Q840O4Uc3LrXR76M0KVbi-vN-HV3WDevAw3_g_F1E", authvalue);

  verified := VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", hs256_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJIUzI1NiIsImtpZCI6InRlc3RrZXkiLCJ0eXAiOiJKV1QifQ.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.lT9vvFawWnafMffffnNy_NjHNQNTXwWH_96lckQ3iPE", authvalue);

  // Test secret/key callback
  TestThrowsLike("Empty secret or key is not accepted for JWT token alg \'HS256\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], translations := test_payload_translations ]));
  verified := VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret(key_id, hs256_key, #1) ]);
  TestThrowsLike("Invalid key size 7 for algorithm \'HS256\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("other_key", hs256_key, #1) ]));

  // This token has 'loggedInAs' and 'iat' in the payload and 'typ' and 'kid' in the header not in alphabetical order
  verified := VerifyJSONWebToken("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InRlc3RrZXkifQ.eyJsb2dnZWRJbkFzIjoiYWRtaW4iLCJpYXQiOjE0MjI3Nzk2Mzh9.3j8S8_Fy5e-Rphxh8ZSc-Plq0r1V1_YcL35iyyqKsHM", [ alg := [ "HS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", hs256_key, #1) ]);

  // HS384
  TestThrowsLike("Invalid key size 32 for algorithm \'HS384\'", PTR TestMakeJSONWebToken("HS384", hs256_key)); // key length mismatch
  jwt_token := NEW JSONWebToken("HS384", hs384_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJIUzM4NCIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.nEcLUzcaIh_l2BVlPS8pPZ_MT3d7wFxjm3mLESQIe7KNF-DZrCZ406qttqWZYtw5", authvalue);

  verified := VerifyJSONWebToken(authvalue, [ alg := [ "HS384" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", hs384_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJIUzM4NCIsImtpZCI6InRlc3RrZXkiLCJ0eXAiOiJKV1QifQ.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.Aekbj_ZgncjHvG5wOYgdaNYk-W9hJb_3C-9_jdj7lF4zifu-09YjGKbxeBcwgxTF", authvalue);

  // HS512
  TestThrowsLike("Invalid key size 32 for algorithm \'HS512\'", PTR TestMakeJSONWebToken("HS512", hs256_key)); // key length mismatch
  TestThrowsLike("Invalid key size 48 for algorithm \'HS512\'", PTR TestMakeJSONWebToken("HS512", hs384_key)); // key length mismatch
  jwt_token := NEW JSONWebToken("HS512", hs512_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.F43j8yKgsuh9c1KtflGkg8jeu2-owSV8jMRbqI6Vg196prmlbzhIxDu6rdorf1g0wLu-3GJFpUR8dSrsuvvQNQ", authvalue);

  verified := VerifyJSONWebToken(authvalue, [ alg := [ "HS512" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", hs512_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJIUzUxMiIsImtpZCI6InRlc3RrZXkiLCJ0eXAiOiJKV1QifQ.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.vRJvHs_ipJfFxR2qBgrvxC1uyug2r3mIMz3dI5Vs39PB5BAKiEB4UZn7zqd9tTseoGsMoZyhq2qbdY2o8xKgJg", authvalue);

  // RS256
  TestThrowsLike("Invalid key type \'EC\' for algorithm \'RS256\'", PTR TestMakeJSONWebToken("RS256", ec256_key)); // key type mismatch
  TestThrowsLike("Invalid key size 1024 for algorithm \'RS256\'", PTR TestMakeJSONWebToken("RS256", rsa1024_key)); // key length mismatch
  jwt_token := NEW JSONWebToken("RS256", rsa2048_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.PmDCtUy0wyyj7THcHmpY7tjC12IkRZm1FQRn4y8WbjFTKKJI2ZiW1H9UfFWS6wZyx2raJqWZ7poCE9Z1ot-ltbPmAh4HQhqwnR8sMEkmO4zsvue1W4Ks6y-eSMHo24SrsXrrhV6GgY1aJ4BfPsiZZpSTvwp99v-u6qP_MxkPa4PHgM3w7yXq8UW7VVRnJ2dY-caUPVuQgbVZm9OJkH0UUssZBmDG3LIF4GGyowJM1qAxx-W6xC13poP8uA7v0HBCy0gPJHc2zi3ijVIgZ2ZRBDuIia0Znh3uzgiaJUPSP6b9PlC5JOL0Km6yIo4h0oAPGKP3DQzAegvxogf5r5xJcw", authvalue);

  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "RS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", rsa2048_key, #1) ]);
  TestEq(test_payload, verified->payload);
  TestEq(FALSE, verified->verifyonly);

  // Verifying using a public key yields a verify-only token
  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "RS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", rsa2048_key_pub, #1) ]);
  TestEq(test_payload, verified->payload);
  TestEq(TRUE, verified->verifyonly);
  TestEq("", verified->GetAuthorizationValue());

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJSUzI1NiIsImtpZCI6InRlc3RrZXkiLCJ0eXAiOiJKV1QifQ.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.oE7S48l_V4hSJjMh9Jz-hf12kCEnAQkWBBgkJRLHxyM3k6vsDrWWawWDCPEbfUb8h-idcPYg9oIBMj0wCq8N30Bau5VohHJdtlcP-fzgl2PtZWpEYJdMQmKDrmv8dc3knSI8Gx5_E2AMbUsCH2eXv_3YZggtti4GapRUi_hCOpM5rPSc0nIYFfUoP8Dq6CVjLeaA9tsQDfRVtDEnFw0PK7dfTw6r8scxCmuP64_8Vqbt2nywgEd1bPnXOtb1mrBrbdMRVJHBp8R0gebGg00fUN41ifCr_zNxCxD6-IeoMP5UdOZ0ivWYhCbfSeK7xZtadp92U9zmqbt0aObMxD-kBQ", authvalue);

  // Test secret/key callback
  TestThrowsLike("Empty secret or key is not accepted for JWT token alg \'RS256\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "RS256" ], translations := test_payload_translations ]));
  verified := VerifyJSONWebToken(authvalue, [ alg := [ "RS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret(key_id, rsa2048_key_pub, #1) ]);
  TestThrowsLike("Could not read secret key", PTR VerifyJSONWebToken(authvalue, [ alg := [ "RS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("other_key", rsa2048_key_pub, #1) ]));

  // RS384
  jwt_token := NEW JSONWebToken("RS384", rsa2048_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJSUzM4NCIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.wVeCXYDI6mjJdUBogvtqB60w8d9N6U9IfJbCJzAFWiRi3u5w6gCogX5gICPgkguVlCcnfub-ILcH4kPPuJmmTNPR3J8XINS-raLsDHBz2Tf80fh6UhUGyZWMAbE5FjXqKa8p8z8RJPgOoA8EBwlO0Jp7mKRMl5UxCYd93258SbzJiCD37HVWXuyB-WRB4OeRDtPTvvIBHVSp0kaFTppBoyYVCDjBh-QknwDtQpeJKPbDecWCuD7OhSTNJqKlC-lREqwLSwJRxFwPVsnxCg129M2du21bWswjGticYQlPNlumHC958p-m6Xh6OUzFijm4kLGql2dx3g6RrKifHlNKQw", authvalue);

  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "RS384" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", rsa2048_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJSUzM4NCIsImtpZCI6InRlc3RrZXkiLCJ0eXAiOiJKV1QifQ.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.JiLNmorcJYxnVIfjKiMW2AcfMs7P12OatCwvq0fUQlXc93QlSEIgm4fRctElOPTzx1OldvINXweHtPGFQ_xmUHjy3ms2SQ0DJoaCHgVaYoasFH9egxy7Mlc_r3npQEK342sS0OZiJlorRfDY1yZtyaQ71UTxGHxkeUqR1Mf2c14GtfqbKtFzm5DI9ILOqhV0BF-KJZL-mS-bVTDcNX9wrIy8yV_rjmDbajHck12zKHlVgO3q5OnotXAQ9LSZw8Kzp2MFq7GOgwS9WtuTpg7D8MR3ci67Z8BMwFG7-6GK9fhAMGwZJbHCmFlIcSavd0P1s3AICjEJa0KsjTmSk-nskg", authvalue);

  // RS512
  jwt_token := NEW JSONWebToken("RS512", rsa2048_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.LQVboMlwIcGfO95LHZLciU10NDhQVaJB12GTPuPyjonRWifAUVzcYgW2WUOoK2JyCkIYQGq4XxAXjirivlsxcGjmaKKfcBwnwzYhkkYuw1d3NXpIW2wAKYwcCmVAdYGYNv7n-ZyKUB4Raph9ZCb18GhwU3ZTKtf2vbl3tGD9CbAVrKflXKjgUeUP7v2sY9UADmcU8yIDZZ46SYUokotjjsV2dNwgwpujxOuahqRc7W6zbGkBt6wOLBqUcsnn452SOD5xaTS2E0d3PdmXkY7ZxQCa_5mh_DYrABC_cZpTsvcX36RS8AvSvxXoUSjPtFEZmhPU7AOa2W5YZawz0PYyRg", authvalue);

  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "RS512" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", rsa2048_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();
  TestEq("eyJhbGciOiJSUzUxMiIsImtpZCI6InRlc3RrZXkiLCJ0eXAiOiJKV1QifQ.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.YYhYmxnjE2YPvEOCiYt2qRzi221W-NTStXdcqUM2RtfrRZfQ_PoktnVevf41D4_CrUoGnwRSyKfHJV5WvbbYlH8A_XjcTfXPBe8Qnq5-zOomEWdJ46Gfg5wpZLCn4Xw966bhwxvGXUywtrBD682z0c3WpzKcG8j-VLA1sW2kNLiy8QKcYRYX-pBZBPmGMqn1VzrY5uK2_DrhYrHFXxGYBHFP3sgFKMZO5qf8r5kO28LspGLNcuJmrDY_-PMDENiYrqz2G1I_DeeHaSo7bsBNQVQxAIR73LNq5aJ-Pwqxsu2CRi4P8qjN9u-eb3t1Dc6xvnKbGjuyDEx5V6vQ5qi2nw", authvalue);

  // ES256
  verified := VerifyJSONWebToken("eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.kAMktyvnoiuAj_ZDGYWUdbzp4N3Bio7mmZAvniC6FOe1KxDXPYzrS0UEQvRdZA1K7QAFTbWUMOmA16WX5dLXlg", CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key, #1) ]);
  TestEq(FALSE, verified->verifyonly);
  TestThrowsLike("Invalid signature \'kAMktyvnoiuAj_ZDGYWUdbzp4N3Bio7mmZAvniC6FOe1KxDXPYzrS0UEQvRdZA1K7QAFTbWUMOmA16WX5dLXlw\' for algorithm \'ES256\' for JWT token", PTR VerifyJSONWebToken(MakeAuthValueInvalid("eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.kAMktyvnoiuAj_ZDGYWUdbzp4N3Bio7mmZAvniC6FOe1KxDXPYzrS0UEQvRdZA1K7QAFTbWUMOmA16WX5dLXlg"), CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key, #1) ]));

  // Verify using public key
  verified := VerifyJSONWebToken("eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.kAMktyvnoiuAj_ZDGYWUdbzp4N3Bio7mmZAvniC6FOe1KxDXPYzrS0UEQvRdZA1K7QAFTbWUMOmA16WX5dLXlg", CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key_pub, #1) ]);
  TestEq(TRUE, verified->verifyonly);
  // A public key cannot be used to sign a token
  jwt_token := NEW JSONWebToken("ES256", ec256_key_pub);
  TestEq(TRUE, jwt_token->verifyonly);
  TestEq("", jwt_token->GetAuthorizationValue());

  TestThrowsLike("Invalid key type \'RSA\' for algorithm \'ES256\'", PTR TestMakeJSONWebToken("ES256", rsa2048_key)); // key type mismatch
  TestThrowsLike("Invalid key size 384 for algorithm \'ES256\'", PTR TestMakeJSONWebToken("ES256", ec384_key)); // key length mismatch
  TestThrowsLike("Invalid key size 521 for algorithm \'ES256\'", PTR TestMakeJSONWebToken("ES256", ec521_key)); // key length mismatch
  jwt_token := NEW JSONWebToken("ES256", ec256_key);
  TestEq(FALSE, jwt_token->verifyonly);
  TestThrowsLike("Invalid key type \'EC\' for algorithm \'RS256\'", PTR TestSetJWTAlg(jwt_token, "RS256")); // cannot change algorithm, key type mismatch
  TestThrowsLike("Invalid key size 256 for algorithm \'ES384\'", PTR TestSetJWTAlg(jwt_token, "ES384")); // cannot change algorithm, key length mismatch
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();
  TestEq(FALSE, authvalue = jwt_token->GetAuthorizationValue()); // should generate a new signature each time

  TestThrowsLike("Invalid signature \'*\' for algorithm \'ES256\' for JWT token", PTR VerifyJSONWebToken(MakeAuthValueInvalid(authvalue), CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key, #1) ]));
  TestThrowsLike("Unexpected JWT token alg \'ES256\', expected one of \'RS256\'", PTR VerifyJSONWebToken(authvalue, CELL[ alg := [ "RS256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key, #1) ]));
  TestThrowsLike("Unexpected JWT token alg \'ES256\', expected one of \'ES384\'", PTR VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES384" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key, #1) ]));
  TestThrowsLike("Invalid key type \'RSA\' for algorithm \'ES256\'", PTR VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", rsa2048_key, #1) ]));
  TestThrowsLike("Invalid key size 384 for algorithm \'ES256\'", PTR VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec384_key, #1) ]));
  TestThrowsLike("Invalid key size 521 for algorithm \'ES256\'", PTR VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec521_key, #1) ]));
  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec256_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();

  // Test secret/key callback
  TestThrowsLike("Empty secret or key is not accepted for JWT token alg \'ES256\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "ES256" ], translations := test_payload_translations ]));
  verified := VerifyJSONWebToken(authvalue, [ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret(key_id, ec256_key_pub, #1) ]);
  TestThrowsLike("Could not read secret key", PTR VerifyJSONWebToken(authvalue, [ alg := [ "ES256" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("other_key", ec256_key_pub, #1) ]));

  // ES384
  verified := VerifyJSONWebToken("eyJhbGciOiJFUzM4NCIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0MjI3Nzk2MzgsImxvZ2dlZEluQXMiOiJhZG1pbiJ9.z1cV2zVGxejaQ7oz79M114AxY5G0jfSwDO17WZ7m7109S_WNwbmKHsQZtVF_ReRyH6rzxD4ZroIZvaM5E4_bLkD-Qa229-7J7JlvZ9MD7O3eEl9uZ29XHp-YzfYoW8M4", CELL[ alg := [ "ES384" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec384_key, #1) ]);

  TestThrowsLike("Invalid key type \'RSA\' for algorithm \'ES384\'", PTR TestMakeJSONWebToken("ES384", rsa2048_key)); // key type mismatch
  TestThrowsLike("Invalid key size 256 for algorithm \'ES384\'", PTR TestMakeJSONWebToken("ES384", ec256_key)); // key length mismatch
  TestThrowsLike("Invalid key size 521 for algorithm \'ES384\'", PTR TestMakeJSONWebToken("ES384", ec521_key)); // key length mismatch
  jwt_token := NEW JSONWebToken("ES384", ec384_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();

  TestThrowsLike("Invalid signature \'*\' for algorithm \'ES384\' for JWT token", PTR VerifyJSONWebToken(MakeAuthValueInvalid(authvalue), CELL[ alg := [ "ES384" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec384_key, #1) ]));
  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES384" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec384_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();

  // ES512
  TestThrowsLike("Invalid key type \'RSA\' for algorithm \'ES512\'", PTR TestMakeJSONWebToken("ES512", rsa2048_key)); // key type mismatch
  TestThrowsLike("Invalid key size 256 for algorithm \'ES512\'", PTR TestMakeJSONWebToken("ES512", ec256_key)); // key length mismatch
  TestThrowsLike("Invalid key size 384 for algorithm \'ES512\'", PTR TestMakeJSONWebToken("ES512", ec384_key)); // key length mismatch
  jwt_token := NEW JSONWebToken("ES512", ec521_key);
  jwt_token->SetPayload(test_payload, test_payload_translations);

  authvalue := jwt_token->GetAuthorizationValue();

  TestThrowsLike("Invalid signature \'*\' for algorithm \'ES512\' for JWT token", PTR VerifyJSONWebToken(MakeAuthValueInvalid(authvalue), CELL[ alg := [ "ES512" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec521_key, #1) ]));
  verified := VerifyJSONWebToken(authvalue, CELL[ alg := [ "ES512" ], translations := test_payload_translations, secret_callback := PTR ReturnSecret("", ec521_key, #1) ]);
  TestEq(test_payload, verified->payload);

  jwt_token->kid := key_id;
  authvalue := jwt_token->GetAuthorizationValue();

  // Test against bypassing authorization value check by setting the alg value to "none"
  jwt_token := NEW JSONWebToken("none", "");
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike("Non-empty secret or key is not accepted for JWT token alg \'none\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "none", "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "ES256", "ES384", "ES512" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // "none" is not accepted if a secret key is supplied

  // Check algorithm
  jwt_token := NEW JSONWebToken("HS256", hs256_key);
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike("Missing required cell \'ALG\' in options", PTR VerifyJSONWebToken(authvalue)); // alg is required
  TestThrowsLike("No valid algorithm values supplied: \'hs256\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "hs256" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // case sensitive
  TestThrowsLike("Unexpected JWT token alg \'HS256\', expected one of \'HS384\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS384" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Unexpected JWT token alg \'HS256\', expected one of \'RS256\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "RS256" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("No valid algorithm value supplied: \'\'", PTR VerifyJSONWebToken(authvalue, [ alg := STRING[], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // invalid algorithm
  TestThrowsLike("No valid algorithm values supplied: \'\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // invalid algorithm
  TestThrowsLike("No valid algorithm values supplied: \'nonexisting\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "nonexisting" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // invalid algorithm
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "none", "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "ES256", "ES384", "ES512" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));

  // Check issuer
  TestThrowsLike("Invalid value \'\' for field \'ISS\'", PTR jwt_token->SetPayload([ iss := "" ])); // cannot be empty when specified
  TestThrowsLike("Invalid value \':test\' for field \'ISS\'", PTR jwt_token->SetPayload([ iss := ":test" ])); // invalid uri
  TestThrowsLike("Invalid value \'test:\' for field \'ISS\'", PTR jwt_token->SetPayload([ iss := "test:" ])); // invalid uri
  jwt_token->payload := [ iss := "test" ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike("Invalid value \'test\' for field \'iss\', expected one of \'\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], iss := [ "" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Invalid value \'test\' for field \'iss\', expected one of \'Test\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], iss := [ "Test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // case sensitive
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], iss := [ "test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], iss := [ "test", "other" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));

  // Check subject
  TestThrowsLike("Invalid value \'\' for field \'SUB\'", PTR jwt_token->SetPayload([ sub := "" ])); // cannot be empty when specified
  TestThrowsLike("Invalid value \':test\' for field \'SUB\'", PTR jwt_token->SetPayload([ sub := ":test" ])); // invalid uri
  TestThrowsLike("Invalid value \'test:\' for field \'SUB\'", PTR jwt_token->SetPayload([ sub := "test:" ])); // invalid uri
  jwt_token->payload := [ sub := "test" ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike("Invalid value \'test\' for field \'sub\', expected one of \'\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], sub := [ "" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Invalid value \'test\' for field \'sub\', expected one of \'Test\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], sub := [ "Test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // case sensitive
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], sub := [ "test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], sub := [ "test", "other" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));

  // Check audience, either single value or array of values
  TestThrowsLike("Invalid value \'\' for field \'AUD\'", PTR jwt_token->SetPayload([ aud := "" ])); // cannot be empty when specified
  TestThrowsLike("Invalid value \':test\' for field \'AUD\'", PTR jwt_token->SetPayload([ aud := ":test" ])); // invalid uri
  TestThrowsLike("Invalid value \'test:\' for field \'AUD\'", PTR jwt_token->SetPayload([ aud := "test:" ])); // invalid uri
  TestThrowsLike("Invalid value \'\' for field \'AUD\'", PTR jwt_token->SetPayload([ aud := [ "", "test:" ] ])); // cannot be empty when specified, invalid uri
  TestThrowsLike("Invalid value \'\' for field \'AUD\'", PTR jwt_token->SetPayload([ aud := [ "", "test" ] ])); // cannot be empty when specified
  jwt_token->payload := [ aud := "test" ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike("Invalid value \'test\' for field \'aud\', expected one of \'\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Invalid value \'test\' for field \'aud\', expected one of \'Test\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "Test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // case sensitive
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));
  jwt_token->payload := [ aud := [ "test", "other" ] ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike("Invalid value \'test\' for field \'aud\', expected one of \'\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Invalid value \'other\' for field \'aud\', expected one of \'test\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "test" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Invalid value \'test\' for field \'aud\', expected one of \'other\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "other" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ]));
  TestThrowsLike("Invalid value \'test\' for field \'aud\', expected one of \'Test\', \'other\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "Test", "other" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // case sensitive
  TestThrowsLike("Invalid value \'other\' for field \'aud\', expected one of \'test\', \'Other\'", PTR VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "test", "Other" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])); // case sensitive
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "test", "other" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, [ alg := [ "HS256" ], aud := [ "test", "other", "third" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ])));

  // Check expiration date
  RECORD verifyparams := [ alg := [ "HS256" ], secret_callback := PTR ReturnSecret("", hs256_key, #1) ];
  DATETIME now := GetRoundedDatetime(GetCurrentDateTime(), 1000); //encoding/decodindg drops ms, so round our DT for safer comparisons
  jwt_token->payload := [ exp := AddDaysToDate(-1, now) ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike('*expired*',PTR VerifyJSONWebToken(authvalue, verifyparams));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-1000, AddDaysToDate(-1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-31000, AddDaysToDate(-1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-30000, AddDaysToDate(-1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(30000, AddDaysToDate(-1, now)) ])));
  TestThrowsLike('*expired*',PTR VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(31000, AddDaysToDate(-1, now)) ]));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(31000, AddDaysToDate(-1, now)), grace_period := 31000 ])));

  // Check not valid before
  jwt_token->payload := [ nbf := AddDaysToDate(1, now) ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike('*not valid before*',PTR VerifyJSONWebToken(authvalue, verifyparams));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddDaysToDate(1, now) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(30000,AddDaysToDate(1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(31000,AddDaysToDate(1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-30000,AddDaysToDate(1, now)) ])));
  TestThrowsLike('*not valid before*',PTR VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-31000, AddDaysToDate(-1, now)) ]));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-31000,AddDaysToDate(1, now)), grace_period := 31000 ])));

  // Check issued before today. iat = issued at
  jwt_token->payload := [ iat := AddDaysToDate(1, now) ];
  authvalue := jwt_token->GetAuthorizationValue();
  TestThrowsLike('*issued in the future*',PTR VerifyJSONWebToken(authvalue, CELL[ ...verifyparams ]));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddDaysToDate(1, now) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(31000, AddDaysToDate(1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(30000, AddDaysToDate(1, now)) ])));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-30000, AddDaysToDate(1, now)) ])));
  TestThrowsLike('*issued in the future*',PTR VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-31000, AddDaysToDate(1, now)) ]));
  TestEq(TRUE, ObjectExists(VerifyJSONWebToken(authvalue, CELL[ ...verifyparams, verify_at := AddTimeToDate(-31000, AddDaysToDate(1, now)), grace_period := 31000 ])));
}

STRING FUNCTION GetSecretKey(STRING keys, STRING kid)
{
  RECORD keyinfo := DecodeJSON(keys);
  RECORD match := SELECT * FROM keyinfo.keys WHERE keys.kid = VAR kid;
  IF(NOT RecordExists(match))
    THROW NEW Exception(`Key '${kid}' not found`);

  RETURN GetPEMPublicKeyFromJWK(match);
}

MACRO OpenIDConnectTest() {
  { // Verify parse UT (AD Login) tokens
    CONSTANT STRING idtoken := "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImtnMkxZczJUMENUaklmajRydDZKSXluZW4zOCJ9.eyJhdWQiOiI3NmZlOGQ1OC1jYWQ2LTQ2OTctYmY0NS0yM2U2ZjExYjI2NTEiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vZjFlYzg3NDMtY2IxMS00MGFlLTk4MmEtNDVlMzIxYWY5OGI0L3YyLjAiLCJpYXQiOjE2MDczMzc1NzUsIm5iZiI6MTYwNzMzNzU3NSwiZXhwIjoxNjA3MzQxNDc1LCJyaCI6IjAuQUFBQVE0ZnM4UkhMcmtDWUtrWGpJYS1ZdEZpTl9uYld5cGRHdjBVajV2RWJKbEZmQUMwLiIsInN1YiI6IlRoUVFYUHJZUWVXYURnODBSTWl3MzBFUVpMWXVOM09JMmdDcGJxNkFSalEiLCJ0aWQiOiJmMWVjODc0My1jYjExLTQwYWUtOTgyYS00NWUzMjFhZjk4YjQiLCJ1dGkiOiJHSWdPc2tmRE8wMmJEWVE3c1Y3Y0FBIiwidmVyIjoiMi4wIiwiZW1wbG95ZWVpZCI6IngxMDAxMzQ1In0.C98Y5MVe16vH6wIvaMxZ_bahxgQE_AgtV4FUPXx8sTSMJuP4qwQmzgZ0cFUFFURq98v-9SOxBzzFVBh41Vecz3bvwEQ7SaPYREI-h3fDj7WQjESitDz7EMMmdOdDViKKKKQXL7l9a4R0_9zg8DnMDRNwDBjOqFn5mHeN9UtNSRpYD1w_kbQI9hJRvJd0AGg4B078ZozsFRBeHBUlxMn8EnDEW2pJERdfqGtnTyYV7XD_WQBfFJqX-IKMFDFwRdL-H6nZSB1r2zOjaAcmGpsfh1TbaLpmx9Wi8tPLLbOUoxAsHryEBqE-pKy8Pi3cEXOx4Edsut8SSPH4mX2aLJT2XA";
    CONSTANT STRING keys := `{"keys":[{"kty":"RSA","use":"sig","kid":"kg2LYs2T0CTjIfj4rt6JIynen38","x5t":"kg2LYs2T0CTjIfj4rt6JIynen38","n":"yTKa6m5GFOllz7oIHFCkvRJoBv7wLMuKIPLHbFGh5yOiO8o3akoqMhf1x6MxINGhZo6dkIrhVlVfWJhEJZPVaQdvyvVmlIZruhcbz3PGMqPAbjq2JqbB1mMnsyGHx-ovP0Cm5xj8sgI8wm67p3nosqzqFvg6mPKVO-w1QBr5seDU2AwU2DR88LF2v03Zjgn4mGvPdUOXihTQoNlf-nJFduXMDyRgZabnR2HlYHhagHwy1beWW1WtEaPz8iBN_0bGkGw705aDBUHJkdTty1mzsCZRur_n0imqXu9IzoSyiq5d0yKrRA5xkA-K3DMeRMquZ5QvPT9Eee4EZfFL97zBfQ","e":"AQAB","x5c":["MIIDBTCCAe2gAwIBAgIQQiR8gZNKuYpH6cP+KIE5ijANBgkqhkiG9w0BAQsFADAtMSswKQYDVQQDEyJhY2NvdW50cy5hY2Nlc3Njb250cm9sLndpbmRvd3MubmV0MB4XDTIwMDgyODAwMDAwMFoXDTI1MDgyODAwMDAwMFowLTErMCkGA1UEAxMiYWNjb3VudHMuYWNjZXNzY29udHJvbC53aW5kb3dzLm5ldDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMkymupuRhTpZc+6CBxQpL0SaAb+8CzLiiDyx2xRoecjojvKN2pKKjIX9cejMSDRoWaOnZCK4VZVX1iYRCWT1WkHb8r1ZpSGa7oXG89zxjKjwG46tiamwdZjJ7Mhh8fqLz9ApucY/LICPMJuu6d56LKs6hb4OpjylTvsNUAa+bHg1NgMFNg0fPCxdr9N2Y4J+Jhrz3VDl4oU0KDZX/pyRXblzA8kYGWm50dh5WB4WoB8MtW3lltVrRGj8/IgTf9GxpBsO9OWgwVByZHU7ctZs7AmUbq/59Ipql7vSM6EsoquXdMiq0QOcZAPitwzHkTKrmeULz0/RHnuBGXxS/e8wX0CAwEAAaMhMB8wHQYDVR0OBBYEFGcWXwaqmO25Blh2kHHAFrM/AS2CMA0GCSqGSIb3DQEBCwUAA4IBAQDFnKQ98CBnvVd4OhZP0KpaKbyDv93PGukE1ifWilFlWhvDde2mMv/ysBCWAR8AGSb1pAW/ZaJlMvqSN/+dXihcHzLEfKbCPw4/Mf2ikq4gqigt5t6hcTOSxL8wpe8OKkbNCMcU0cGpX5NJoqhJBt9SjoD3VPq7qRmDHX4h4nniKUMI7awI94iGtX/vlHnAMU4+8y6sfRQDGiCIWPSyypIWfEA6/O+SsEQ7vZ/b4mXlghUmxL+o2emsCI1e9PORvm5yc9Y/htN3Ju0x6ElHnih7MJT6/YUMISuyob9/mbw8Vf49M7H2t3AE5QIYcjqTwWJcwMlq5i9XfW2QLGH7K5i8"],"issuer":"https://login.microsoftonline.com/f1ec8743-cb11-40ae-982a-45e321af98b4/v2.0"},{"kty":"RSA","use":"sig","kid":"5Of9P5F9gCCwCmF2BOHHxDDQ-Dk","x5t":"5Of9P5F9gCCwCmF2BOHHxDDQ-Dk","n":"2y6laZzXOPwGpMOhh0RcZq-Cng12HRv4EHT_Y6w5WOuNWZxzGFjF77qfTKtp_izFIGlr0IwJnbJsDqmTfAXdDMsfRXpWE6DZ6D0s49coNgu-nEFT7UdkuyfUnfPfU8lZLLzxB4fPp0CpUZIacZWb9Ci83dkqS6yEkppftf8bZOW1Cmz6SQuBbZgDyrm7hKBK8NxmSxJvnqUN6CDdOpxJdLSvIon8EUMcA0VEhNx0acgzZmjedZJEGWO6zs8jrRROkX0_fhpjW1BP4nq5OI6JpXMRgV6LuqCdmg9s3Qvw2k27baa97pxAJprMKwBnHSLcbrjkldREZgQ9NweYbLX-JQ","e":"AQAB","x5c":["MIIDBTCCAe2gAwIBAgIQNmD9my1yu4hPh6X2ySAQMjANBgkqhkiG9w0BAQsFADAtMSswKQYDVQQDEyJhY2NvdW50cy5hY2Nlc3Njb250cm9sLndpbmRvd3MubmV0MB4XDTIwMTExNTE4NTMyMFoXDTI1MTExNDE4NTMyMFowLTErMCkGA1UEAxMiYWNjb3VudHMuYWNjZXNzY29udHJvbC53aW5kb3dzLm5ldDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANsupWmc1zj8BqTDoYdEXGavgp4Ndh0b+BB0/2OsOVjrjVmccxhYxe+6n0yraf4sxSBpa9CMCZ2ybA6pk3wF3QzLH0V6VhOg2eg9LOPXKDYLvpxBU+1HZLsn1J3z31PJWSy88QeHz6dAqVGSGnGVm/QovN3ZKkushJKaX7X/G2TltQps+kkLgW2YA8q5u4SgSvDcZksSb56lDegg3TqcSXS0ryKJ/BFDHANFRITcdGnIM2Zo3nWSRBljus7PI60UTpF9P34aY1tQT+J6uTiOiaVzEYFei7qgnZoPbN0L8NpNu22mve6cQCaazCsAZx0i3G645JXURGYEPTcHmGy1/iUCAwEAAaMhMB8wHQYDVR0OBBYEFEhEsQJa9KyDIqzLnHtB0fPwqAv2MA0GCSqGSIb3DQEBCwUAA4IBAQAl4wkCQOD4UCaiuxVCFzs8PXGxhLJJseuN4TbMxvmmzgBaRPeazEmLqvqUW/VxCAWHiCzK6nVXThpAk9SPxN37HnlLt/wzEfQTapVxTzKj5PTzsEm582dDyw+0WDdNtb37a1BoAEpv6J4zVHTQLprfx4ccCQq4m3v6IDuKHrT/U0TlQz0negsUlDr4iwr3lPCdpnbLbgki8JnP5a/Kh/XMs5qXsJRF2IHqEF+yTupEN+fpNvTItfmGAfoGm+6AIBWhH+SEe6sshDpW7rngVJoLAxCrqDlzrXae1pq1pyvfbeMtHkjY7yl74wdFcDD/J0gOA2u30X/2Ld+5AglZIlBm"],"issuer":"https://login.microsoftonline.com/f1ec8743-cb11-40ae-982a-45e321af98b4/v2.0"},{"kty":"RSA","use":"sig","kid":"18pnMg3UmrWvBK_tkDAbjgM5CmA","x5t":"18pnMg3UmrWvBK_tkDAbjgM5CmA","n":"v3tn90CVkqJ57gTZu8bbC37NX0RloPlEnelHmqobAEiDLRuqw7Hv2M5o9iRFhF4sSw64fr6P33stLWKpzVmm4y6HUi89QeQmYCNYzxQy2V-tBiLxWX3vtVYgUFwfZDz4TIEu_Ia7rgTg8aHJ8t_b6mz_xPaWlLJWSFBlNY22z2KX87ULrE5AVNMr125aaPWLhxCGWYrnk5KdMrDGb1cuOExzX4S-_fQrRAWTpQWhqi0bEn9Y0vIWKD9-2CkLmZlJGgOueICSuKwwWXm87RKergHVS9sEGkSaBwWOtCPWLsv01Nc0sZymNs3BkPZsQKioYkdox6beXSQwYsmXtBZHjQ","e":"AQAB","x5c":["MIIC8TCCAdmgAwIBAgIQSoIG9pq9C4lOtPUfxLmCSDANBgkqhkiG9w0BAQsFADAjMSEwHwYDVQQDExhsb2dpbi5taWNyb3NvZnRvbmxpbmUudXMwHhcNMjAwOTEzMDAwMDAwWhcNMjUwOTEzMDAwMDAwWjAjMSEwHwYDVQQDExhsb2dpbi5taWNyb3NvZnRvbmxpbmUudXMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC/e2f3QJWSonnuBNm7xtsLfs1fRGWg+USd6UeaqhsASIMtG6rDse/Yzmj2JEWEXixLDrh+vo/fey0tYqnNWabjLodSLz1B5CZgI1jPFDLZX60GIvFZfe+1ViBQXB9kPPhMgS78hruuBODxocny39vqbP/E9paUslZIUGU1jbbPYpfztQusTkBU0yvXblpo9YuHEIZZiueTkp0ysMZvVy44THNfhL799CtEBZOlBaGqLRsSf1jS8hYoP37YKQuZmUkaA654gJK4rDBZebztEp6uAdVL2wQaRJoHBY60I9Yuy/TU1zSxnKY2zcGQ9mxAqKhiR2jHpt5dJDBiyZe0FkeNAgMBAAGjITAfMB0GA1UdDgQWBBTuNouNBOGNFuUdRuSpaTYO2ZRL6DANBgkqhkiG9w0BAQsFAAOCAQEAKZD3Hn+79D/S9Xby/8zSHhYlsXM4FrxDUggt29o15EdBdxyLHCwc3bXZI2PMn0u5vBoz9T0U/MnzoUIxdkmSI9qhfpaxrz7LPEFsMLN6uqRfN9XbypaGcHXP4Qb4xLjLqlmqc8TCUAi0MAokCVSLl83lIbF8/Kw4hSYWMs7HdiuJLHwIgWSd9mguaPks+w64268bw7yZnKutE8xj1x3f6f6AqD3yZr6B1IfnVgrWX4kQIF8z0XB4J5jPaCcORRRB1GV/aSKhNFXWbJ7Z2UnX5f27dX1mgrnFb48jAZLuoeRn7M7+gtj/wPzRiYN845c9wyx91HDo4xqvq/dFtRQ3dQ=="],"issuer":"https://login.microsoftonline.com/f1ec8743-cb11-40ae-982a-45e321af98b4/v2.0"}]}`;
    RECORD tok := DecodeVerifyJWT(keys, idtoken, MakeDatetime(2020,12,7,11,44,0), [ algorithms := ["RS256"], issuer := ["https://login.microsoftonline.com/f1ec8743-cb11-40ae-982a-45e321af98b4/v2.0"] ]);
    TestEq("x1001345", tok.employeeid);
  }

  { // Verify parse MS X5T tokens
    CONSTANT STRING keys := `{"keys":[{"kty":"RSA","use":"sig","kid":"PoVKeirIOvmTyLQ9G9BenBwos7k","x5t":"PoVKeirIOvmTyLQ9G9BenBwos7k","n":"ruYyUq1ElSb8QCCt0XWWRSFpUq0JkyfEvvlCa4fPDi0GZbSGgJg3qYa0co2RsBIYHczXkc71kHVpktySAgYK1KMK264e-s7Vymeq-ypHEDpRsaWric_kKEIvKZzRsyUBUWf0CUhtuUvAbDTuaFnQ4g5lfoa7u3vtsv1za5Gmn6DUPirrL_-xqijP9IsHGUKaTmB4M_qnAu6vUHCpXZnN0YTJDoK7XrVJFaKj8RrTdJB89GFJeTFHA2OX472ToyLdCDn5UatYwmht62nXGlH7_G1kW1YMpeSSwzpnMEzUUk7A8UXrvFTHXEpfXhsv0LA59dm9Hi1mIXaOe1w-icA_rQ","e":"AQAB","x5c":["MIIC/jCCAeagAwIBAgIJAM52mWWK+FEeMA0GCSqGSIb3DQEBCwUAMC0xKzApBgNVBAMTImFjY291bnRzLmFjY2Vzc2NvbnRyb2wud2luZG93cy5uZXQwHhcNMjUwMzIwMDAwNTAyWhcNMzAwMzIwMDAwNTAyWjAtMSswKQYDVQQDEyJhY2NvdW50cy5hY2Nlc3Njb250cm9sLndpbmRvd3MubmV0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAruYyUq1ElSb8QCCt0XWWRSFpUq0JkyfEvvlCa4fPDi0GZbSGgJg3qYa0co2RsBIYHczXkc71kHVpktySAgYK1KMK264e+s7Vymeq+ypHEDpRsaWric/kKEIvKZzRsyUBUWf0CUhtuUvAbDTuaFnQ4g5lfoa7u3vtsv1za5Gmn6DUPirrL/+xqijP9IsHGUKaTmB4M/qnAu6vUHCpXZnN0YTJDoK7XrVJFaKj8RrTdJB89GFJeTFHA2OX472ToyLdCDn5UatYwmht62nXGlH7/G1kW1YMpeSSwzpnMEzUUk7A8UXrvFTHXEpfXhsv0LA59dm9Hi1mIXaOe1w+icA/rQIDAQABoyEwHzAdBgNVHQ4EFgQUcZ2MLLOas+d9WbkFSnPdxag09YIwDQYJKoZIhvcNAQELBQADggEBABPXBmwv703IlW8Zc9Kj7W215+vyM5lrJjUubnl+s8vQVXvyN7bh5xP2hzEKWb+u5g/brSIKX/A7qP3m/z6C8R9GvP5WRtF2w1CAxYZ9TWTzTS1La78edME546QejjveC1gX9qcLbEwuLAbYpau2r3vlIqgyXo+8WLXA0neGIRa2JWTNy8FJo0wnUttGJz9LQE4L37nR3HWIxflmOVgbaeyeaj2VbzUE7MIHIkK1bqye2OiKU82w1QWLV/YCny0xdLipE1g2uNL8QVob8fTU2zowd2j54c1YTBDy/hTsxpXfCFutKwtELqWzYxKTqYfrRCc1h0V4DGLKzIjtggTC+CY="],"cloud_instance_name":"microsoftonline.com"},{"kty":"RSA","use":"sig","kid":"_jNwjeSnvTTK8XEdr5QUPkBRLLo","x5t":"_jNwjeSnvTTK8XEdr5QUPkBRLLo","n":"tJt2QCzZVnqP35tVsxvqIPFyYh0Muz5H2JtVkKinANHtG7TCX0Plxj-mZ1OtRQWX8a7d_2legFkf-0UJDs9LxWxHj8zV9WdNO1KYucXqiyPSo6Z7Gaww6zkLHaHHqhEWVi4yXHw1pbxdDPCBQ6FLtspLtEbFkagCY5vON5cw0GUjfMPcRfyVylq8lxy3JhLQa2CuDstDYQ491oTAUP5Xn3lAIyp1SbJ038E0gfxx5EpTxw1Ef14SlRqfg6Izy82BUz8aJtv097IVxM5fjfMH1de7dGXAyaCagTMMCySUk7vLdY0jOOhQNQ69IQbCllR1NMCk_bliXYUjDg5k1FeoYQ","e":"AQAB","x5c":["MIIC/jCCAeagAwIBAgIJAJD6gin3pOAKMA0GCSqGSIb3DQEBCwUAMC0xKzApBgNVBAMTImFjY291bnRzLmFjY2Vzc2NvbnRyb2wud2luZG93cy5uZXQwHhcNMjUwNDA5MDgwMzQwWhcNMzAwNDA5MDgwMzQwWjAtMSswKQYDVQQDEyJhY2NvdW50cy5hY2Nlc3Njb250cm9sLndpbmRvd3MubmV0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtJt2QCzZVnqP35tVsxvqIPFyYh0Muz5H2JtVkKinANHtG7TCX0Plxj+mZ1OtRQWX8a7d/2legFkf+0UJDs9LxWxHj8zV9WdNO1KYucXqiyPSo6Z7Gaww6zkLHaHHqhEWVi4yXHw1pbxdDPCBQ6FLtspLtEbFkagCY5vON5cw0GUjfMPcRfyVylq8lxy3JhLQa2CuDstDYQ491oTAUP5Xn3lAIyp1SbJ038E0gfxx5EpTxw1Ef14SlRqfg6Izy82BUz8aJtv097IVxM5fjfMH1de7dGXAyaCagTMMCySUk7vLdY0jOOhQNQ69IQbCllR1NMCk/bliXYUjDg5k1FeoYQIDAQABoyEwHzAdBgNVHQ4EFgQU7Iuc3W2qX7BqcsnyHsXO0TwI1ZMwDQYJKoZIhvcNAQELBQADggEBAJPUFzBQ+khAL6K7d0ctRBkPfvT84bILRW6xcw8GCAdyEmqm+jG0N+VWp7NM70nMuM5jrGarFuUJwEewQHLXu0gHDcZ+28i5bMgHQSlwiVyNTzesy3cJu76BgYWTLfXTI/9/aZMBfdJhtHDorj4hxTrROcwdlFQpK0Ld6ZUhgIGMY7nBsQ+n0SoI2AYtJt+MpwcsHbzklHQJAucOwEOqIaaJagSYbOVGq5M+d8bdaQsuvepzj8V0H9QTLcnJnIhCeq7RZ205hZcsPu1ATSN4qGYYLoCiAVnEMiPzKXLF0ZqkJDOBPQjXsmJ2Dhnvt8RvkjLy0GEiayzbHGSkII+GIHo="],"cloud_instance_name":"microsoftonline.com"},{"kty":"RSA","use":"sig","kid":"-cgAvjmmQ24Ks20zIpDB4SW894w","x5t":"-cgAvjmmQ24Ks20zIpDB4SW894w","n":"otM7AZjL81wdSVdrkQtt6shrQiAT8OZJeIKTeRJgrDYXKzaVXs0WFXVCjCv9GuCktF-tereotfZlcskamfuupe574o76CJy6AUtuY7wt0OKqxoSJMRuUJvA_NNkT50C_dTDHTtF7kiGBwWvHEkHeZAgT52E8bfNJswV28GsPscM9vG2ylUPyiaEIsGi0cg_JllbnfBjGhfA_lzmrB9Iw75E3f1Hnk2uAs1KcHJGSH3EwHJ5tUeo9WtLGjRAfH1kGtPjkktNaw3V8EukEzgIfILV8udpWYE79A_p5jFUnTNkQxsviNxG537JMooa1ZoYveDv_f6LCj1o7MNZQVlD3tw","e":"AQAB","x5c":["MIIC6TCCAdGgAwIBAgIIU6yE1PeZiB0wDQYJKoZIhvcNAQELBQAwIzEhMB8GA1UEAxMYbG9naW4ubWljcm9zb2Z0b25saW5lLnVzMB4XDTI1MDMwNjE3MDIxMFoXDTMwMDMwNjE3MDIxMFowIzEhMB8GA1UEAxMYbG9naW4ubWljcm9zb2Z0b25saW5lLnVzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAotM7AZjL81wdSVdrkQtt6shrQiAT8OZJeIKTeRJgrDYXKzaVXs0WFXVCjCv9GuCktF+tereotfZlcskamfuupe574o76CJy6AUtuY7wt0OKqxoSJMRuUJvA/NNkT50C/dTDHTtF7kiGBwWvHEkHeZAgT52E8bfNJswV28GsPscM9vG2ylUPyiaEIsGi0cg/JllbnfBjGhfA/lzmrB9Iw75E3f1Hnk2uAs1KcHJGSH3EwHJ5tUeo9WtLGjRAfH1kGtPjkktNaw3V8EukEzgIfILV8udpWYE79A/p5jFUnTNkQxsviNxG537JMooa1ZoYveDv/f6LCj1o7MNZQVlD3twIDAQABoyEwHzAdBgNVHQ4EFgQU3EskzzkGT8sZ1hAEn+cJIrUfDkswDQYJKoZIhvcNAQELBQADggEBAB3T/AA53U6c0mmdckiw/Evh27tluqKDwzF1l95zJTmmNzj8ND5KsS6J+g7Xzg8H8sccxhvrUPuJLzSJKGS4vygDAJHJvuXSwUWSf/n6O6u3pinIu/uqm8sQRo/yDrsI7LjvSeIVFbpNBOW/hoYH3GbRVCXqFX9Sztj8my60cSzV9JcNbIDse+GEfbFf5L2kfa1XydThFOvc/lXDFPPorNF4u8djP8u5BojO6QdylRHPWIoG1Q8l4yqLPf+sgBkzQ4pyOpgdAvefunCHeAwYyIZj0SOZgarNeplcicAYDFUZgPu1WbiIK2cREcY5XUnyMYtyq28AJrdMEKkCtXWI8jQ="],"cloud_instance_name":"microsoftonline.us"},{"kty":"RSA","use":"sig","kid":"Km8oaDUbb_pVUGsT38eHX87v078","x5t":"Km8oaDUbb_pVUGsT38eHX87v078","n":"ikFbcYO8PviJWVrHaVEp3eDnVEvFJRl7a32NQldBBGUWtkiLuMFKJMYvVik36AtJQ1_TDwfP46VHBDv8dMus8dxFWTAK25spIrW7avPa_Ok77aqFoeLi0f1iKRGkKDzqPpl7J9xvwQyLnzxBFWIYq2THkO0EO3vH-8tGO9kr6vF8l6j20cBuJ7dcOUz3W-dwEAQ-GxoLqPs9jxUNHJ84fnz64XEZWo1L4ZRBVh2IqjYUKdfurBhffqYZM8U4GBq0wc3KJY6-RA7Q9dMA2m2GPe1j33GoFVqFpQy8IhOz_CSPiVNt2olEM4ANwOBsndn9ldsRNsIp6BobOawcMT9vtw","e":"AQAB","x5c":["MIIC6TCCAdGgAwIBAgIIP8cyEA0NDykwDQYJKoZIhvcNAQELBQAwIzEhMB8GA1UEAxMYbG9naW4ubWljcm9zb2Z0b25saW5lLnVzMB4XDTI1MDMyMzE2MDEzN1oXDTMwMDMyMzE2MDEzN1owIzEhMB8GA1UEAxMYbG9naW4ubWljcm9zb2Z0b25saW5lLnVzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAikFbcYO8PviJWVrHaVEp3eDnVEvFJRl7a32NQldBBGUWtkiLuMFKJMYvVik36AtJQ1/TDwfP46VHBDv8dMus8dxFWTAK25spIrW7avPa/Ok77aqFoeLi0f1iKRGkKDzqPpl7J9xvwQyLnzxBFWIYq2THkO0EO3vH+8tGO9kr6vF8l6j20cBuJ7dcOUz3W+dwEAQ+GxoLqPs9jxUNHJ84fnz64XEZWo1L4ZRBVh2IqjYUKdfurBhffqYZM8U4GBq0wc3KJY6+RA7Q9dMA2m2GPe1j33GoFVqFpQy8IhOz/CSPiVNt2olEM4ANwOBsndn9ldsRNsIp6BobOawcMT9vtwIDAQABoyEwHzAdBgNVHQ4EFgQUumi3x/LmmEju66W1mDxz934H6TwwDQYJKoZIhvcNAQELBQADggEBAHrVrhnTWoEDYiPeakkmVRP9fb13cPHDdj4fIbkIP8aOgZgF2mGjWc/AH/7vSeJ8dNxbzArfaLwcvYqa3QGbuhzEC/z3TV0j2OkOh49N8GydbcVEpcMgGj2QnJEyQEvcZgZp2ugdJYWkQ5GlkjOPxEvVaiaFvg47BAa9Cz1wxVYaXwGVr2qN4dmTOxxcgzpeG8UtZGQpTjh+Cl5Anu3ca8OfZxYq/KS/Suh1gDrtPi0lyEuIeZTm9lX9JBBA77zXIFHAZVqYKAKgs/9eDCTtjajjdZP+ws+gzdnFZDaMV63L+XrbXGV9hXU8Sjx7MPzbG3pX2ssCMlsDb8a3/8QqjIg="],"cloud_instance_name":"microsoftonline.us"}]}`;
    CONSTANT STRING idtoken := "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Il9qTndqZVNudlRUSzhYRWRyNVFVUGtCUkxMbyIsImtpZCI6Il9qTndqZVNudlRUSzhYRWRyNVFVUGtCUkxMbyJ9.eyJhdWQiOiI1NzgwYmYzZi1jMGM5LTRjYjQtYWFlMy1iOWRhNTU0YWYwYTAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83OGNjYzZhYy02ZDFiLTQzMDYtYjE2MC05NmFhZjIzOWRmNjEvIiwiaWF0IjoxNzUyMjI1NzEyLCJuYmYiOjE3NTIyMjU3MTIsImV4cCI6MTc1MjIyOTYxMiwiYW1yIjpbInB3ZCIsIm1mYSJdLCJmYW1pbHlfbmFtZSI6Ikdlc3ByZWtrZW5hcHAiLCJnaXZlbl9uYW1lIjoiTGVpZGluZ2dldmVuZGUiLCJpcGFkZHIiOiI3Ny4yMjIuODcuMTE2IiwibmFtZSI6Ikdlc3ByZWtrZW5hcHAsIEwgKExlaWRpbmdnZXZlbmRlKSIsIm9pZCI6ImY0MzI2MTY1LTM3MzktNDljMy1hOTdlLTNkNTJkNTAzMzQzZiIsIm9ucHJlbV9zaWQiOiJTLTEtNS0yMS00MDU1NjA3ODgxLTE3NjUyNzQxNzktMzEyMzQ5NDYxOS03Mzk3MTgiLCJyaCI6IjEuQVFzQXJNYk1lQnR0QmtPeFlKYXE4am5mWVQtX2dGZkp3TFJNcXVPNTJsVks4S0NFQUFNTEFBLiIsInNpZCI6IjAwNmM4NTU5LTQ3ZDItNGMxOC1jNjY3LWNhZmFkMTYwNmVhYiIsInN1YiI6InB2ZkJaUURpQjRuRzVsMHExd2w2QXhSR3JSNUpQajF4Q3R3dHh1dnZtYjgiLCJ0aWQiOiI3OGNjYzZhYy02ZDFiLTQzMDYtYjE2MC05NmFhZjIzOWRmNjEiLCJ1bmlxdWVfbmFtZSI6ImwuZ2VzcHJla2tlbmFwcEBjYXJtZWwubmwiLCJ1cG4iOiJsLmdlc3ByZWtrZW5hcHBAY2FybWVsLm5sIiwidXRpIjoieTVZOGlkeHFJMFdPa09SdTZ5QW1BQSIsInZlciI6IjEuMCJ9.rJYS2qT1R1yaCAmjGTliDiCD6X5-eh5D18tu2nBKTDXQaKPctKK9XCi1iM5C8_eayBEtGJbdZfkCTd-exr5xpy4_zDEpJdLrbAAeNGPPS4EZ5IaNKLthrM9r_noNKbU0I2El8ljWSeMVIz5BPj-X6lDzOfgwBTf6nHBmKfpuFuN5T7_Iv5PVHEkVc5C7t1WvabhQBoeQEIcwHzpUg2UVW6IUK2GayAnoe3T8GYxIxA3gla6smnVaSiLtpZ_YcanHdKwA8uJ7Ltap2CT0zfL9uQ1NfNtGtaE4o4JsagnsT27lDIoioIVF1Eyza66c7Weu2Cn0n6nufJNWPXDMCUxA-w";
    RECORD tok := DecodeVerifyJWT(keys, idtoken, MakeDatetime(2025,7,11,9,44,0), [ algorithms := ["RS256"], issuer := ["https://sts.windows.net/78ccc6ac-6d1b-4306-b160-96aaf239df61/"] ]);
    Testeq("f4326165-3739-49c3-a97e-3d52d503343f", tok.oid);
  }
}

STRING FUNCTION ReturnSecret(STRING expected_key_id, STRING secret_to_return, STRING header_key_id)
{
  IF (expected_key_id = "" OR header_key_id = expected_key_id)
    RETURN secret_to_return;
  RETURN "INVALID";
}

OBJECT FUNCTION TestMakeJSONWebToken(STRING alg, STRING secret)
{
  RETURN NEW JSONWebToken(alg, secret);
}

MACRO TestSetJWTAlg(OBJECT token, STRING alg)
{
  token->alg := alg;
}

STRING FUNCTION MakeAuthValueInvalid(STRING authvalue)
{
  STRING ARRAY parts := Tokenize(authvalue, ".");
  STRING signature := DecodeUFS(parts[2]);
  signature := Left(signature, Length(signature) - 1) || ByteToString((GetByteValue(Right(signature, 1)) + 1) % 256);
  parts[2] := EncodeUFS(signature);
  RETURN Detokenize(parts, ".");
}

RunTestframework([ PTR JWTTest
                 , PTR OpenIDConnectTest
                 ]);
