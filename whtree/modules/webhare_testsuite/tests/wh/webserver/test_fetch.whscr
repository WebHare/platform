<?wh
LOADLIB "wh::files.whlib";
LOADLIB "wh::internet/fetch.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/testframework.whlib";

MACRO TestFetch()
{
  OBJECT response := FetchSync(GetPrimaryWebHareInterfaceURL() || "tollium_todd.res/webhare_testsuite/tests/getrequestdata.shtml",
     [ headers := [ accept := "application/json" ]]);

  TestEq(200, response->status);
  TestEq(TRUE, response->ok);
  TestEqLike(`{*}`, response->text());

  TestEq("application/json", response->headers->get("content-type"));

  //TODO shouldn't requesting as json() (or even another text() request) fail?
  //ABORT(response->json());

  response := FetchSync(GetPrimaryWebHareInterfaceURL() || "tollium_todd.res/webhare_testsuite/tests/getrequestdata.shtml",
     [ method := "POST"
     , headers := [ accept := "application/json", "content-type" := "application/json" ]
     , body := EncodeJSON([x:=42])], [debug:=true]);

  RECORD responsejson := response->json();
  TestEq(`{"x":42}`, responsejson.body);

  TestRejectedLike("The operation was aborted due to timeout", Fetch(GetPrimaryWebHareInterfaceURL() || ".webhare_testsuite/tests/consilio/timeout.shtml", CELL[], [ debug := TRUE, timeout := 1000 ]));

  response := FetchSync(GetPrimaryWebHareInterfaceURL() || "tollium_todd.res/webhare_testsuite/tests/getrequestdata.shtml",
     [ method := "POST"
     , headers := [ accept := "application/json", "content-type" := "application/json" ]
     , body := EncodeJSON([x:=42])], [debug:=true]);

  TestEq(`{"x":42}`, DecodeJSONBlob(response->AsBlob()).body);
}

RunTestFramework([ PTR TestFetch ]);

