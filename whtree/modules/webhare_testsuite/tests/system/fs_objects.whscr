<?wh

LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/whfs.whlib";
LOADLIB "mod::system/lib/internal/whfs/support.whlib";

LOADLIB "mod::publisher/lib/testframework.whlib";


MACRO TestURL()
{
  OBJECT site := testfw->GetTestSite();

  STRING baseurl := site->rootobject->url;


  OBJECT testfolder, testfile, testfile2;

  testfw->BeginWork();

  testfile := site->rootobject->CreateFolder([ name := "test" ]);
  TestEQ(baseurl || "test/", testfile->url);
  TestEQ(baseurl || "test/", CalculateFSObjectFullPathAndURL(testfile->id).url);
  testfile->RecycleSelf();

  testfile := site->rootobject->CreateFile([ name := "test.html" ]);
  TestEQ(baseurl || "test.html", CalculateFSObjectFullPathAndURL(testfile->id).url);
  TestEQ(baseurl || "test.html", CalculateFSObjectFullPathAndURL(testfile->id).url);
  testfile->RecycleSelf();

  testfile := site->rootobject->CreateFile([ name := "index.html" ]);
  site->rootobject->UpdateMetadata([ indexdoc := testfile->id ]);
  testfile->Refresh();
  TestEQ(baseurl || "", testfile->url);
  TestEQ(baseurl || "", CalculateFSObjectFullPathAndURL(testfile->id).url);
  site->rootobject->UpdateMetadata([ indexdoc := 0 ]);
  testfile->RecycleSelf();

  testfile := site->rootobject->CreateFile([ name := "test.link", type := 18, externallink := "http://example.com" ]);
  testfile->Refresh();
  TestEQ("http://example.com", testfile->url);
  TestEQ("http://example.com", CalculateFSObjectFullPathAndURL(testfile->id).url);
  TestEQ(baseurl || "test.link/", CalculateFSObjectFullPathAndURL(testfile->id, [ followlinks := FALSE]).url);
  site->rootobject->UpdateMetadata([ indexdoc := 0 ]);
  testfile->RecycleSelf();

  testfolder := site->rootobject->CreateFolder([ name := "test" ]);
  testfile := testfolder->CreateFile([ name := "index.html" ]);
  testfolder->UpdateMetadata([ indexdoc := testfile->id ]);
  testfile->Refresh();
  TestEQ(baseurl || "test/", testfile->url);
  TestEQ(baseurl || "test/", CalculateFSObjectFullPathAndURL(testfile->id).url);
  testfile->UpdateMetadata([ name := "test.html" ]);
  TestEQ(baseurl || "test/", testfile->url); // still index
  testfile->Refresh();
  TestEQ(baseurl || "test/", testfile->url); // still index
  TestEQ(baseurl || "test/", CalculateFSObjectFullPathAndURL(testfile->id).url); // still index
  testfolder->UpdateMetadata([ indexdoc := 0 ]);
  testfile->Refresh();
  TestEQ(baseurl || "test/test.html", testfile->url); // still index
  TestEQ(baseurl || "test/test.html", CalculateFSObjectFullPathAndURL(testfile->id).url); // still index
  testfile->RecycleSelf();
  testfolder->RecycleSelf();

  testfile := site->rootobject->CreateFile([ name := "test.html" ]);
  testfile2 := site->rootobject->CreateFile([ name := "test2.link", type := 19, filelink := testfile->id ]);
  TestEQ(testfile->url, testfile2->url);
  TestEQ(testfile->url, CalculateFSObjectFullPathAndURL(testfile2->id).url);
  TestEQ(baseurl || "test2.link/", CalculateFSObjectFullPathAndURL(testfile2->id, [ followlinks := FALSE ]).url);
  testfile->RecycleSelf();
  testfile2->RecycleSelf();

  INTEGER type_rtd := OpenWHFSType("http://www.webhare.net/xmlns/publisher/richdocumentfile")->id;

  // published as subdir
  testfolder := site->rootobject->CreateFolder([ name := "test" ]);
  testfile := testfolder->CreateFile([ name := "test2.rtd", type := type_rtd ]);
  TestEQ(baseurl || "test/test2/", testfile->url); // with /, is published as folder, stripped extension
  TestEQ(baseurl || "test/test2/", CalculateFSObjectFullPathAndURL(testfile->id).url); // with /, is published as folder, stripped extension
  testfolder->UpdateMetadata([ indexdoc := testfile->id ]);
  testfile->Refresh();
  TestEQ(baseurl || "test/", testfile->url);
  TestEQ(baseurl || "test/", CalculateFSObjectFullPathAndURL(testfile->id).url);
  testfile2 := site->rootobject->CreateFile([ name := "test3.link", type := 20, filelink := testfile->id ]);
  TestEQ(baseurl || "test3.link/", testfile2->url); // .link is not an hidden extension
  TestEQ(baseurl || "test3.link/", CalculateFSObjectFullPathAndURL(testfile2->id).url);
  TestEQ(baseurl || "test3.link/", CalculateFSObjectFullPathAndURL(testfile2->id, [ followlinks := FALSE ]).url);
  testfile2->UpdateMetadata([ name := "test3.rtd" ]);
  TestEQ(baseurl || "test3/", testfile2->url); // .rtd is an hidden extension
  TestEQ(baseurl || "test3/", CalculateFSObjectFullPathAndURL(testfile2->id).url);
  TestEQ(baseurl || "test3/", CalculateFSObjectFullPathAndURL(testfile2->id, [ followlinks := FALSE ]).url);
  testfile->UpdateMetadata([ type := 5 ]); // unknown type, not published (kill stripextension flag) too
  testfile2->RecycleSelf();
  testfile2 := site->rootobject->CreateFile([ name := "test3.rtd", type := 20, filelink := testfile->id ]);
  TestEQ(baseurl || "test3.rtd", testfile2->url); // .rtd is an hidden extension, but type 0 doesn't hide extensions
  TestEQ(baseurl || "test3.rtd", CalculateFSObjectFullPathAndURL(testfile2->id).url);
  TestEQ(baseurl || "test3.rtd", CalculateFSObjectFullPathAndURL(testfile2->id, [ followlinks := FALSE ]).url);
  testfolder->RecycleSelf();

  testfw->CommitWork();
}


// Tests for fs_objects custom column fields and their harescript equivalents

RunTestFramework(
    [ PTR PrepareTestModuleWebDesignWebsite("webhare_testsuite:basetest", [ istemplate := FALSE, witherrors := TRUE, withcontent := FALSE ])
    , PTR TestURL
    ]);
