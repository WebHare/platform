<?wh
LOADLIB "wh::files.whlib";

LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/whfs.whlib";
LOADLIB "mod::publisher/lib/control.whlib";
LOADLIB "mod::system/lib/internal/whfs/drafts.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";


MACRO Prep()
{
  testfw->BeginWork();
  OBJECT testfolderobj2 := GetTestsuiteTempFolder()->CreateFolder([ name := "sub" ]);

  OBJECT newfile := testfolderobj2->CreateFile([name:="test.html",title:="A new title", keywords := "my new keywords", description := "d", data:=StringToBlob("I'm a jolly good file"), type := 5 ]);
  OBJECT betatype := OpenWHFSType("http://www.webhare.net/xmlns/beta/test");
  betatype->SetInstanceData(newfile->id, [ stringarray := ["a","b","d"] ]);

  testfw->CommitWork();
}

MACRO DraftingTest()
{
  testfw->BeginWork();
  testfw->SetTestUser("firstowner");

  OBJECT testfile := GetTestsuiteTempFolder()->OpenByPath("sub/test.html");
  TestEq(TRUE, ObjectExists(testfile));

  //There shouldn't be anything being editted about this file
  TestEq(0, Length(GetDrafts(testfile->id)));

  TestEQ(FALSE, TestFlagFromPublished(testfile->published, PublishedFlag_HasPublicDraft));
//PublishedFlag_HasDraft

  //Start editting this document. Create a private draft.
  OBJECT draft := CreateDraft(testfile, testfile->id, FALSE);
  TestEq(FALSE, draft->ispublic);
  TestEq(TRUE, ObjectExists(draft->fsobject));
  TestEq(FALSE, draft->fsobject->isactive);

  RECORD betadata := draft->fsobject->GetInstanceData("http://www.webhare.net/xmlns/beta/test");
  TestEq(['a','b','d'], betadata.stringarray);

  RECORD ARRAY drafts := GetDrafts(testfile->id);
  TestEq(1, Length(drafts));
  TestEq(FALSE, drafts[0].ispublic);
  TestEq(draft->id, drafts[0].id);
  TestEq(testfw->GetUserAuthobjectId("firstowner"), drafts[0].user);
  TestEq(TRUE, drafts[0].mine);

  //Let's create another draft. Ignore it though
  CreateDraft(testfile, testfile->id, FALSE);
  TestEq(2, Length(GetDrafts(testfile->id)));

  //Get autosaves for this user
  RECORD ARRAY autosaves := ListUserWHFSDrafts(GetEffectiveUserID());
  TestEq(2,Length(autosaves));

  testfw->CommitWork();
}

MACRO ComplexInstancesAndDrafts()
{
  testfw->BeginWork();

  OBJECT testfile := GetTestsuiteTempFolder()->EnsureFile([name:="testfile"]);
  TestEq(TRUE, ObjectExists(testfile));

  OBJECT autosave := CreateDraft(testfile, testfile->id, FALSE);
  RECORD testform := [ text := StringToBlob(`
      <formdefinitions xmlns="http://www.webhare.net/xmlns/publisher/forms">
        <form name="webtoolform">
          <page>
            <richtext textid="Yl98JQ8ztbgW3-KdqLzYBA" title="asdf def" guid="wtfrm:9A757BDEF63422BC86F6C5586FDA3508"/>
          </page>
        </form>
      </formdefinitions>`)
                     , type := "publisher:formdefinition"
                     , instances := [[ instanceid := 'Yl98JQ8ztbgW3-KdqLzYBA'
                                     , data := [ whfstype := 'http://www.webhare.net/xmlns/publisher/richdocumentfile'
                                               , data := [ htmltext := StringToBlob(`<html><body><p class="normal">asdf def</p></body></html>`) ]
                                               ]
                                    ]]];

  autosave->fsobject->SetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool", [data:=testform]);

  TestEq(1, Length(autosave->fsobject->GetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool").data.instances));

  OBJECT publicdraft := CreateDraft(testfile, testfile->id, TRUE);
  autosave->SaveToPublicDraft([ contenttypes := ["http://www.webhare.net/xmlns/publisher/formwebtool"] ]);

  TestEq(1, Length(publicdraft->fsobject->GetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool").data.instances));

  autosave := CreateDraft(testfile, testfile->id, FALSE);
  autosave->fsobject->SetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool", publicdraft->fsobject->GetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool"));
  TestEq(1, Length(autosave->fsobject->GetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool").data.instances));

  autosave->SaveToPublicDraft([ contenttypes := ["http://www.webhare.net/xmlns/publisher/formwebtool"] ]);
  testfw->CommitWork();
  TestEq(1, Length(publicdraft->fsobject->GetInstanceData("http://www.webhare.net/xmlns/publisher/formwebtool").data.instances));
}

RunTestframework([ PTR Prep
                 , PTR DraftingTest
                 , PTR ComplexInstancesAndDrafts
                 ]
                ,[ testusers := [[ login := "firstowner", grantrights := DEFAULT STRING ARRAY ]
                                ,[ login := "newowner", grantrights := DEFAULT STRING ARRAY ]
                                ]
                 , profile := TRUE
                 ]);
