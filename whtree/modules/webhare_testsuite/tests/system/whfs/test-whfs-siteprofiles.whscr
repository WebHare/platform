<?wh
LOADLIB "wh::files.whlib";

LOADLIB "mod::publisher/lib/siteapi.whlib";
LOADLIB "mod::publisher/lib/siteprofiles.whlib";
LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::system/lib/whfs.whlib";

STRING basesiteprofile :=
  '<siteprofile xmlns="http://www.webhare.net/xmlns/publisher/siteprofile" xmlns:xyz="urn:xyz">'
  || '<apply>'
  || '<to type="all" />'
  || '<xyz:test test="2" />'
  || '</apply>'
  || '</siteprofile>';

STRING includingsiteprofile :=
  '<siteprofile xmlns="http://www.webhare.net/xmlns/publisher/siteprofile" xmlns:xyz="urn:xyz">'
  || '<apply>'
  || '<to type="all" />'
  || '<xyz:test test="1" />'
  || '</apply>'
  || '<applysiteprofile path="/base.siteprl" />'
  || '</siteprofile>';

STRING including_nolangsiteprofile :=
  '<siteprofile xmlns="http://www.webhare.net/xmlns/publisher/siteprofile" xmlns:xyz="urn:xyz">'
  || '<applysiteprofile path="/base.siteprl" />'
  || '</siteprofile>';

STRING baselang_default :=
  '<?xml version="1.0" encoding="UTF-8" ?>'
  || '<language xmlns="http://www.webhare.net/xmlns/tollium/screens" xml:lang="nl" xmlns:h="http://www.w3.org/1999/xhtml">'
  || '  <textgroup gid="global">'
  || '    <text tid="text0">Text Zero</text>'
  || '  </textgroup>'
  || '</language>';

STRING lang_default :=
  '<?xml version="1.0" encoding="UTF-8" ?>'
  || '<language xmlns="http://www.webhare.net/xmlns/tollium/screens" xml:lang="nl" xmlns:h="http://www.w3.org/1999/xhtml">'
  || '  <textgroup gid="global">'
  || '    <text tid="text1">Text <h:b>1</h:b> &amp;NL</text>'
  || '  </textgroup>'
  || '</language>';

STRING lang_en :=
  '<?xml version="1.0" encoding="UTF-8" ?>'
  || '<language xmlns="http://www.webhare.net/xmlns/tollium/screens" xml:lang="en" xmlns:h="http://www.w3.org/1999/xhtml">'
  || '  <textgroup gid="global">'
  || '    <text tid="text1">Text 1 EN</text>'
  || '  </textgroup>'
  || '</language>';

STRING dummysiteprofile :=
     '<siteprofile xmlns="http://www.webhare.net/xmlns/publisher/siteprofile" />';

STRING embeddingsiteprofile :=
     '<siteprofile xmlns="http://www.webhare.net/xmlns/publisher/siteprofile" xmlns:xyz="urn:xyz"  xmlns:h="http://www.w3.org/1999/xhtml">'
  || '  <language xmlns="http://www.webhare.net/xmlns/tollium/screens">'
  || '    <textgroup gid="global">'
  || '      <text tid="text1">Text <h:b>1</h:b> &amp;embedded NL</text>'
  || '      <text tid="paramtext">text1-<param p="1"/>-<ifparam p="1" value="1"><param p="2"/><else /><param p="3"/></ifparam>X</text>'
  || '    </textgroup>'
  || '  </language>'
  || '  <language xmlns="http://www.webhare.net/xmlns/tollium/screens" xml:lang="en">'
  || '    <textgroup gid="global">'
  || '      <text tid="text1">Text <h:b>1</h:b> &amp;embedded<h:br/> EN</text>'
  || '      <text tid="paramtext">detext1-<param p="1"/>-<ifparam p="1" value="1"><param p="2"/><else /><param p="3"/></ifparam>X</text>'
  || '    </textgroup>'
  || '  </language>'
  || '</siteprofile>';

OBJECT site;

MACRO Prepare()
{
  testfw->BeginWork();

  STRING sitename := "webhare_testsuite.inclusion";
  OBJECT siteroot := testfw->GetWHFSTestRoot()->CreateFolder( [ name := sitename ] );
  site := CreateSiteFromFolder(siteroot->id);

  OBJECT dummysiteprof := site->rootobject->CreateFile([name:="dummy.siteprl", data := StringToBlob(dummysiteprofile)]);
  OBJECT basesiteprof := site->rootobject->CreateFile([name:="base.siteprl", data := StringToBlob(basesiteprofile)]);
  OBJECT includingsiteprof := site->rootobject->CreateFile([name:="including.siteprl", data := StringToBlob(includingsiteprofile)]);
  OBJECT including_nolangsiteprof := site->rootobject->CreateFile([name:="including_nolang.siteprl", data := StringToBlob(including_nolangsiteprofile)]);
  OBJECT embeddingsiteprof := site->rootobject->CreateFile([name:="embedding.siteprl", data := StringToBlob(embeddingsiteprofile)]);

  OBJECT designfolder := siteroot->CreateFolder([name := "design"]);

  OBJECT languagefolder := designfolder->CreateFolder([name := "language"]);
  TestEq(TRUE, site->AssignSiteProfile(dummysiteprof->id)); //dummy to make sure we don't get stuck on the 'first' siteprofile
  TestEq(TRUE, site->AssignSiteProfile(includingsiteprof->id));
  testfw->CommitWork();
}

MACRO TestInclusion()
{
  RECORD ARRAY custom := GetCustomSiteProfileSettings("urn:xyz", "test", site->id);
  TestEq(2, Length(custom));
  TestEq("1", custom[0].node->GetAttribute("test"));
  TestEq("2", custom[1].node->GetAttribute("test"));

  //However, it should not apply to random other sites
  custom := GetCustomSiteProfileSettings("urn:xyz", "test", 1); //test against repository
  TestEq(0,Length(custom));
}

RunTestFramework( [ PTR Prepare
                  , PTR TestInclusion
                  ]);
