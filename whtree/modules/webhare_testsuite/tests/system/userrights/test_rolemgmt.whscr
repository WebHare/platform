<?wh
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::tollium/lib/testframework.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

LOADLIB "mod::wrd/lib/internal/auth/exchange.whlib";

ASYNC MACRO TestAddRoleToUsers()
{
  OBJECT unit := testfw->GetUnit();

  OBJECT usr := testfw->GetUserObject("user1");
  TestEQ(TRUE, usr->ExistsInDatabase());

  AWAIT ExpectScreenChange(+1, PTR TTLaunchApp("system:userrights"));
  TT("unittree->unitlist")->selection := SELECT * FROM TT("unittree->unitlist")->rows WHERE title="webhare_testsuite.unit";
  topscreen->frame->focused := TT("unitcontents->userandrolelist");

  // Grant to a single user (selecting role)
  TT("unitcontents->userandrolelist")->selection := SELECT * FROM TT("unitcontents->userandrolelist")->rows WHERE name="role1";
  TestEq(INTEGER[], GetTestController()->userapi->GetRoleMembers(testfw->GetRoleObject("role1")->entityid));
  TestEq(INTEGER[], GetTestController()->userapi->GetUserRoles(testfw->GetUserObject("user1")->entityid));

  //Grant a right to the role
  AWAIT ExpectScreenChange(+1, PTR TTClick("unitcontents->addrighttousers"));
  TT("objecttree->objectlist->thelist")->selection := SELECT * FROM TT("objecttree->objectlist->thelist")->rows WHERE title = "Miscellaneous";
  TT("rightslist")->value := "webhare_testsuite:globalright";
  TT("comment")->Value := "I have my reasons";
  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  AWAIT ExpectScreenChange(+1, PTR TTClick("userrolerightslist->adduserstorole"));

  // Test search
  TT("selectuserrole->searchfor")->value := "user1";
  TTClick(":Search");
  TestEq(["user1@beta.webhare.net"],SELECT AS STRING ARRAY email FROM TT("selectuserrole->unitcontents->userandrolelist")->rows);
  TT("selectuserrole->unitcontents->userandrolelist")->selection := TT("selectuserrole->unitcontents->userandrolelist")->rows;
  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  TestEq(INTEGER[testfw->GetUserObject("user1")->entityid], GetTestController()->userapi->GetRoleMembers(testfw->GetRoleObject("role1")->entityid));
  TestEq(INTEGER[testfw->GetRoleObject("role1")->entityid], GetTestController()->userapi->GetUserRoles(testfw->GetUserObject("user1")->entityid));

  TT("userrolerightslist->rightstabs")->selectedtab := TT("userrolerightslist->userstab");
  TestEq(1, Length(TT("userrolerightslist->userlistbyrole")->rows));
  topscreen->frame->focused := TT("userrolerightslist->userlistbyrole");
  TT("userrolerightslist->userlistbyrole")->selection :=TT("userrolerightslist->userlistbyrole")->rows;
  AWAIT ExpectAndAnswerMessagebox("YES", PTR TTClick("userrolerightslist->removeusersfromrole"));
  TestEq(0, Length(TT("userrolerightslist->userlistbyrole")->rows));

  // Grant to a single user (selecting user)
  TT("unitcontents->userandrolelist")->selection := SELECT * FROM TT("unitcontents->userandrolelist")->rows WHERE email="user1@beta.webhare.net";
  AWAIT ExpectScreenChange(+1, PTR TTClick("userrolerightslist->addroletousers"));

  TT("selectuserrole->unittree->unitlist")->value := unit->entityid;
  TT("selectuserrole->unitcontents->userandrolelist")->value := testfw->GetRoleObject("role1")->entityid;
  TT(":Comments")->value := "WebHareTestSuite is testing this";

  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  TestEQ(TRUE, testfw->GetUserObject("user1")->HasRole(testfw->GetRoleObject("role1")));
  TestEQ(FALSE, testfw->GetUserObject("user1")->HasRightOn("system:manageroles", testfw->GetRoleObject("role1")->authobjectid));

  topscreen->frame->focused := TT("userrolerightslist->directpermissions");
  TestEq(2, Length(TT("userrolerightslist->directpermissions")->rows));
  TT("userrolerightslist->directpermissions")->selection := SELECT * FROM TT("userrolerightslist->directpermissions")->rows WHERE name="role1";

  AWAIT ExpectScreenChange(+1, PTR TTClick("userrolerightslist->edit"));
  TestEq("WebHareTestSuite is testing this", TT("comment")->value);
  TestEqLike("*sysop@beta.webhare.net*", TT("grantor")->value);
  AWAIT ExpectScreenChange(-1, PTR TTEscape);

  //Remove the rolegrant again
  AWAIT ExpectAndAnswerMessagebox("YES", PTR TTClick("userrolerightslist->revokefromusers"));
  TestEq(0, Length(TT("userrolerightslist->directpermissions")->rows));

  // Grant to multiple users
  topscreen->frame->focused := TT("unitcontents->userandrolelist");
  TT("unitcontents->userandrolelist")->selection := SELECT * FROM TT("unitcontents->userandrolelist")->rows WHERE email IN ["user1@beta.webhare.net","user2@beta.webhare.net"];

  AWAIT ExpectScreenChange(+1, PTR TTClick("unitcontents->addroletousers"));
  TT("selectuserrole->unittree->unitlist")->value := unit->entityid;
  TT("selectuserrole->unitcontents->userandrolelist")->value := testfw->GetRoleObject("role1")->entityid;

  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  TestEQ(TRUE, testfw->GetUserObject("user1")->HasRole(testfw->GetRoleObject("role1")));
  TestEQ(TRUE, testfw->GetUserObject("user2")->HasRole(testfw->GetRoleObject("role1")));
  TestEQ(FALSE, testfw->GetUserObject("user1")->HasRightOn("system:manageroles", testfw->GetRoleObject("role1")->authobjectid));
  TestEQ(FALSE, testfw->GetUserObject("user2")->HasRightOn("system:manageroles", testfw->GetRoleObject("role1")->authobjectid));

  AWAIT ExpectScreenChange(-1, PTR TTEscape);
}

ASYNC MACRO TestEditRole()
{
  AWAIT ExpectScreenChange(+1, PTR TTLaunchApp("system:userrights"));

  TT("unittree->unitlist")->selection := SELECT * FROM TT("unittree->unitlist")->rows WHERE title="webhare_testsuite.unit";

  AWAIT ExpectScreenChange(+1, PTR TTClick("unitcontents->newrole"));
  TT(":Name")->value := "role1-new";
  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));
  TestEq("role1-new", TT("unitcontents->userandrolelist")->selection[0].name);

  topscreen->frame->focused := TT("unitcontents->userandrolelist");
  TT("unitcontents->userandrolelist")->selection := SELECT * FROM TT("unitcontents->userandrolelist")->rows WHERE name="role1";

  AWAIT ExpectScreenChange(+1, PTR TTClick("unitcontents->edit"));
  TT(":Name")->value := "role1-renamed";
  AWAIT ExpectScreenChange(-1, PTR TTClick(":Ok"));

  AWAIT ExpectAndAnswerMessagebox("YES", PTR TTClick("unitcontents->delete"));

  AWAIT ExpectScreenChange(-1, PTR TTEscape);
}

MACRO TestExport()
{
  //Test the export
  RECORD ARRAY userexport := ListRightsAndRolesForExport(testfw->userapi);
  //dumpvalue(userexport,'boxed');
  RECORD ARRAY grants := SELECT * FROM userexport WHERE type = "GRANT";

  TestEq(1,Length(grants)); //this is the initial assignment by testfw
  TestEq("Granted by RunTestframework", grants[0].comment);
  TestEq("", grants[0].grantor);
  TestEq(TRUE, grants[0].withgrantoption);

  RECORD ARRAY rolegrants := SELECT * FROM userexport WHERE type = "ROLEGRANT";
  TestEq(2,Length(rolegrants));
  TestEq(TRUE, RecordExists(rolegrants[0].grantordata));
  TestEq("sysop@beta.webhare.net", rolegrants[0].grantor);
  TestEq(FALSE, rolegrants[0].withgrantoption);
}

RunTestframework( [ PTR TestAddRoleToUsers
                  , PTR TestEditRole
                  , PTR EnsureUserMgmtStateClean
                  , PTR TestExport
                  ], [ testusers := [[ login := "sysop", grantrights := ["system:sysop"] ]
                                    ,[ login := "user1"]
                                    ,[ login := "user2"]
                                    ]
                     , testroles := [[ role := "role1" ]]
                     ]
                  );
