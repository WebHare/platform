<?wh
LOADLIB "mod::webhare_testsuite/lib/database.whlib";
LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/internal/rightsmgmt.whlib";
LOADLIB "mod::system/lib/userrights.whlib";

RECORD ARRAY FUNCTION ClearCreationDate(RECORD ARRAY a)
{
  FOREVERY (RECORD r FROM a)
  {
    a[#r].creationdate := DEFAULT DATETIME;
    IF(RecordExists(a[#r].grantordata))
      a[#r].grantordata := [ login := a[#r].grantordata.login ];
    a[#r] := CellDelete(a, "GRANTID");
  }

  RETURN a;
}

INTEGER ARRAY FUNCTION FilterByKnownUsers(INTEGER ARRAY a)
{
  INTEGER ARRAY results;
  INTEGER ARRAY known := [ INTEGER(testfw->GetUserAuthobjectid("mysysop")), testfw->GetUserAuthobjectid("limited"), testfw->GetUserAuthobjectid("limited2")];

  FOREVERY (INTEGER i FROM a)
    IF (i IN known)
      INSERT i INTO results AT END;

  RETURN SortArray(results);
}



MACRO InitDB()
{
  EnsureUserMgmtStateClean();
  testfw->StartTrans("sysop", TRUE);
  testfw->BeginWork();

  DELETE FROM webhare_testsuite.rights_tree;

  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (1, "root", 0);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (2, "child-1", 1);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (3, "child-2", 1);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (4, "child-1-1", 2);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (5, "child-1-2", 2);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (6, "child-1-2-1", 5);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (7, "child-2-1", 3);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (8, "child-2-2", 3);
  INSERT INTO webhare_testsuite.rights_tree(id, name, parent) VALUES (9, "child-2-2-1", 8);

  testfw->CommitWork();

  //unit := GetTestUnit();

//  Print(AnyToString(GetObjectIdsOfDirectGrantsTo(limited_user, "webhare_testsuite:globalright"), "tree"));

  testfw->BeginWork();
  testfw->GetUserObject("sysop")->UpdateRoleGrant("grant", testfw->GetRoleObject("sysoprole")->authobjectid, testfw->GetUserObject("mysysopusingrole"), [ comment := "Granted by your sysop"]);
  TestEqMembers([ comment := "Granted by your sysop"], ExplainRoleGrantedTo(testfw->GetRoleObject("sysoprole")->authobjectid, testfw->GetUserObject("mysysopusingrole")->EnsureAuthObject()), "*");
  testfw->GetUserObject("sysop")->UpdateRoleGrant("update", testfw->GetRoleObject("sysoprole")->authobjectid, testfw->GetUserObject("mysysopusingrole"), [ comment := "Updated by your sysop"]);
  TestEqMembers([ comment := "Updated by your sysop"], ExplainRoleGrantedTo(testfw->GetRoleObject("sysoprole")->authobjectid, testfw->GetUserObject("mysysopusingrole")->EnsureAuthObject()), "*");

  TestEq(0, LENGTH(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", testfw->GetUserObject("mysysop")->EnsureAuthObject(), FALSE)));
  TestEq(0, LENGTH(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", testfw->GetUserObject("limited")->EnsureAuthObject(), FALSE)));
  TestEq(0, LENGTH(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", testfw->GetUserObject("limited2")->EnsureAuthObject(), FALSE)));
  TestEq(0, LENGTH(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", testfw->GetRoleObject("role1")->EnsureAuthObject(), FALSE)));
  TestEq(FALSE, testfw->GetUserObject("mysysop")->HasRole(testfw->GetRoleObject("role1")));
  TestEq(TRUE, testfw->GetUserObject("mysysop")->HasRole(testfw->GetRoleObject("sysoprole")));
  TestEq(FALSE, testfw->GetUserObject("limited")->HasRole(testfw->GetRoleObject("role1")));
  TestEq(FALSE, testfw->GetUserObject("limited2")->HasRole(testfw->GetRoleObject("role1")));

  TestEq(TRUE, testfw->GetUserObject("sysop")->HasAnyGrantableRight());
  TestEq(TRUE, testfw->GetUserObject("mysysop")->HasAnyGrantableRight());
  TestEq(TRUE, testfw->GetUserObject("mysysopusingrole")->HasAnyGrantableRight());

  testfw->CommitWork();
  testfw->EndTrans();
}

MACRO DefaultRightsTest()
{
  testfw->StartTrans("~webhare", TRUE);

  OBJECT sysop_user := testfw->GetUserObject("mysysop");
  OBJECT limited_user := testfw->GetUserObject("limited");
  OBJECT limited2_user := testfw->GetUserObject("limited2");

  TestEq(TRUE, sysop_user->HasRight("system:sysop"));
  TestEq(TRUE, sysop_user->HasRight("webhare_testsuite:globalright"));
  TestEq(TRUE, sysop_user->HasRightOn("webhare_testsuite:objectright", 0));
  TestEq(TRUE, sysop_user->HasRightOn("webhare_testsuite:objectright", 1));
  TestEq(TRUE, sysop_user->HasRightOn("webhare_testsuite:objectright", 7));
  TestEq(TRUE, sysop_user->HasRightOnAny("webhare_testsuite:objectright"));
  TestEq([ 0 ], sysop_user->HasRightOnMultiple("webhare_testsuite:objectright", [ 0 ]));
  TestEq([ 0, 1 ], sysop_user->HasRightOnMultiple("webhare_testsuite:objectright", [ 0, 1 ]));
  TestEq([ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ], sysop_user->HasRightOnMultiple("webhare_testsuite:objectright", [ 9, 9, 8, 8, 7, 7, 6, 6, 5, 4,3, 2, 1, 0 ]));
  TestEq([ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ], sysop_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 9, 9, 8, 8, 7, 7, 6, 6, 5, 4,3, 2, 1, 0 ]));
  TestEq([ [ objectid := 0, path := [0] ]
         , [ objectid := 1, path := [0,1] ]
         , [ objectid := 2, path := [0,1,2] ]
         , [ objectid := 3, path := [0,1,3] ]
         , [ objectid := 4, path := [0,1,2,4] ]
         , [ objectid := 5, path := [0,1,2,5] ]
         , [ objectid := 6, path := [0,1,2,5,6] ]
         , [ objectid := 7, path := [0,1,3,7] ]
         , [ objectid := 8, path := [0,1,3,8] ]
         , [ objectid := 9, path := [0,1,3,8,9] ]
         ], GetObjectsPaths([ "webhare_testsuite:objectright2" ], sysop_user, [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ], DEFAULT INTEGER ARRAY));
  TestEq([0, 1, 7], sysop_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [0, 1, 7]));
  TestEq(TRUE, sysop_user->CanManageRight("system:sysop"));
  TestEq(TRUE, sysop_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(TRUE, sysop_user->CanManageRightOn("webhare_testsuite:objectright", 0));
  TestEq(TRUE, sysop_user->CanManageRightOn("webhare_testsuite:objectright", 1));
  TestEq(TRUE, sysop_user->CanManageRightOn("webhare_testsuite:objectright", 7));
  TestEq(TRUE, sysop_user->CanManageRightOn("webhare_testsuite:objectflatright", 0));
  TestEq(TRUE, sysop_user->CanManageRightOn("webhare_testsuite:objectflatright", 1));
  TestEq(TRUE, sysop_user->CanManageRightOn("webhare_testsuite:objectflatright", 7));

  TestEq(FALSE, limited_user->HasRight("system:sysop"));
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited_user->HasRightOn("webhare_testsuite:objectright", 0));
  TestEq(FALSE, limited_user->HasRightOn("webhare_testsuite:objectright", 1));
  TestEq(FALSE, limited_user->HasRightOn("webhare_testsuite:objectright", 7));
  TestEq(FALSE, limited_user->HasRightOnAny("webhare_testsuite:objectright"));
  TestEq(DEFAULT INTEGER ARRAY, limited_user->HasRightOnMultiple("webhare_testsuite:objectright", [ 9, 9, 8, 8, 7, 7, 6, 6, 5, 4,3, 2, 1, 0 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 9, 9, 8, 8, 7, 7, 6, 6, 5, 4,3, 2, 1, 0 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [0, 1, 7]));
  TestEq(FALSE, limited_user->CanManageRight("system:sysop"));
  TestEq(FALSE, limited_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectright", 0));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectright", 1));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectright", 7));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectflatright", 0));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectflatright", 1));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectflatright", 7));

  TestEq([ [ objectid := 0, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 1, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 2, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 3, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 4, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 5, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 6, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 7, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 8, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 9, path := DEFAULT INTEGER ARRAY ]
         ], GetObjectsPaths([ "webhare_testsuite:objectright2" ], limited_user, [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ], DEFAULT INTEGER ARRAY));

  TestThrowsLike('*does not exist*', PTR limited_user->HasRightOn("webhare_testsuite:unknownright", 7));

  testfw->EndTrans();
}

MACRO UsersTest()
{
  OBJECT sysop_user := testfw->GetUserObject("mysysop");
  OBJECT limited_user := testfw->GetUserObject("limited");
  OBJECT limited2_user := testfw->GetUserObject("limited2");

  RECORD ARRAY toenrich := [[ g := sysop_user->entity->guid ], [ g := limited_user->entity->guid ]];
  toenrich := testfw->userapi->EnrichUsers("G", toenrich, [ celltype := "guid" ]);
  TestEq(2,Length(toenrich));
  TestEq("mysysop@beta.webhare.net", toenrich[0].login);
  TestEq("limited@beta.webhare.net", toenrich[1].login);
}

RECORD ARRAY FUNCTION GenPath(INTEGER ARRAY ids)
{
  RETURN
      SELECT *
           , name :=    (SELECT AS STRING name FROM webhare_testsuite.rights_tree WHERE COLUMN id = row.id)
           , icon :=    id = 0 ? "" : "tollium:smileys/wink"
        FROM ToRecordArray(ids, "ID") AS row;
}

MACRO GrantTest()
{
  testfw->StartTrans("sysop", FALSE);

  OBJECT sysop_user := testfw->GetUserObject("mysysop");
  OBJECT limited_user := testfw->GetUserObject("limited");
  OBJECT limited2_user := testfw->GetUserObject("limited2");

  testfw->GetUserObject("sysop")->UpdateGrant("grant", "webhare_testsuite:globalright", 0, limited_user);
  TestEq(FALSE, limited_user->HasRight("system:sysop"));
  TestEq(TRUE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEqMembers([ [ grantedright    := "webhare_testsuite:globalright"
                  , comment := ""
                  , withgrantoption := FALSE
                  ]
                ], ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 0, FALSE), '*');

  testfw->GetUserObject("sysop")->UpdateGrant("update", "webhare_testsuite:globalright", 0, limited_user, [ comment := "updated"]);
  TestEqMembers([ [ grantedright    := "webhare_testsuite:globalright"
                  , comment := "updated"
                  , withgrantoption := FALSE
                  ]
                ], ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 0, FALSE), '*');

  testfw->GetUserObject("sysop")->UpdateGrant("update", "webhare_testsuite:globalright", 0, limited_user, [ withgrantoption := TRUE]);
  TestEqMembers([ [ grantedright    := "webhare_testsuite:globalright"
                  , comment := "updated"
                  , withgrantoption := TRUE
                  ]
                ], ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 0, FALSE), '*');

  testfw->GetUserObject("sysop")->RevokeRightFrom("webhare_testsuite:globalright", limited_user, FALSE);
  TestEq(FALSE, limited_user->HasRight("system:sysop"));
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));
  // The following tests now fails because it is now legal to grant from any user (FIXME: check if this is what arnold meant to do)
  //TestThrows(PTR sysop_user->GrantRightTo("webhare_testsuite:globalright", limited_user, FALSE));

  testfw->Commit();

  testfw->StartTrans("mysysop", FALSE);
  sysop_user->GrantRightTo("webhare_testsuite:globalright", limited_user, FALSE);
  TestEq(FALSE, limited_user->HasRight("system:sysop"));
  TestEq(TRUE, limited_user->HasRight("webhare_testsuite:globalright"));

  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectright2", 0));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectright2", 2));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectright2", 7));
  TestEq(TRUE, limited_user->HasRightOnAny("webhare_testsuite:objectright2"));

  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectflatright", 0));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectflatright", 1));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectflatright", 2));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectflatright", 7));
  TestEq(TRUE, limited_user->HasRightOnAny("webhare_testsuite:objectflatright"));

  TestEq([ 0 ], limited_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0 ]));
  TestEq([ 0, 1 ], limited_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0, 1 ]));
  TestEq([ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9], limited_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ]));
  TestEq([ [ objectid := 0, path := [0] ]
         , [ objectid := 1, path := [0,1] ]
         , [ objectid := 2, path := [0,1,2] ]
         , [ objectid := 3, path := [0,1,3] ]
         , [ objectid := 4, path := [0,1,2,4] ]
         , [ objectid := 5, path := [0,1,2,5] ]
         , [ objectid := 6, path := [0,1,2,5,6] ]
         , [ objectid := 7, path := [0,1,3,7] ]
         , [ objectid := 8, path := [0,1,3,8] ]
         , [ objectid := 9, path := [0,1,3,8,9] ]
         ], GetObjectsPaths([ "webhare_testsuite:objectright2" ], limited_user, [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ], DEFAULT INTEGER ARRAY));

  TestEq([ visible := TRUE, path := GenPath([ 0 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 0));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 1));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 2 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 2));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 3 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 3));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 2, 4 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 4));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 2, 5 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 5));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 2, 5, 6 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 6));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 3, 7 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 7));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 3, 8 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 8));
  TestEq([ visible := TRUE, path := GenPath([ 0, 1, 3, 8, 9 ]) ], limited_user->GetObjectPath("webhare_testsuite:testobjecttype", 9));

  TestEq([ 0, 1, 7 ], limited_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 0, 1, 7 ]));
  TestEq([ 1, 7 ], limited_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 1, 7 ]));
  TestEq(FALSE, limited_user->CanManageRight("system:sysop"));
  TestEq(FALSE, limited_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectright", 0));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectright", 1));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectright", 7));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectflatright", 0));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectflatright", 1));
  TestEq(FALSE, limited_user->CanManageRightOn("webhare_testsuite:objectflatright", 7));

  sysop_user->RevokeRightFrom("webhare_testsuite:globalright", limited_user, FALSE);
  TestEq(FALSE, limited_user->HasRight("system:sysop"));
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));

  testfw->Commit();

  testfw->StartTrans("limited", FALSE);
  TestThrowsLike('*only * global*', PTR limited_user->GrantRightTo("webhare_testsuite:objectright", limited2_user, FALSE));
  TestEq(FALSE, limited2_user->HasRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright", 0));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright", 7));
  TestEq(FALSE, limited2_user->HasRightOnAny("webhare_testsuite:objectright"));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright", [ 0, 1, 2, 3 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright", [ 1, 2, 3, 9 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 1, 2, 3, 9 ]));
  testfw->Commit();

  // Grant with grant right (use objectright2, because it is implied by globalright)

  testfw->StartTrans("mysysop", FALSE);
  TestThrowsLike('*lacks the right*', PTR limited_user->GrantRightTo("webhare_testsuite:globalright", limited2_user, FALSE));
  sysop_user->GrantRightTo("webhare_testsuite:globalright", limited_user, TRUE);

  TestEq(TRUE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited_user->CanManageRight("system:sysop"));
  TestEq(TRUE, limited_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(TRUE, limited_user->CanManageRightOn("webhare_testsuite:objectright2", 0));
  TestEq(TRUE, limited_user->CanManageRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, limited_user->CanManageRightOn("webhare_testsuite:objectright2", 7));

  testfw->Commit();

  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 0));

  // Make sure references to object 0 can commit
  testfw->StartTrans("limited", FALSE);
  limited_user->GrantRightToOn("webhare_testsuite:objectright2", limited2_user, 0, FALSE);
  testfw->Commit();

  testfw->StartTrans("limited", FALSE);
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 0));
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 7));
  TestEq(TRUE, limited2_user->HasRightOnAny("webhare_testsuite:objectright2"));

  TestEq([ 0 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0 ]));
  TestEq([ 0, 1 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0, 1 ]));
  TestEq([ 1 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 1 ]));
  TestEq([ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ]));

  TestEq(FALSE, limited2_user->CanManageRight("system:sysop"));
  TestEq(FALSE, limited2_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectright", 0));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectright", 1));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectright", 7));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectflatright", 0));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectflatright", 1));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectflatright", 7));

  // no longer throws as it is a no-op TestThrows(PTR limited_user->RevokeRightFromOn("webhare_testsuite:objectright2", limited2_user, 1, FALSE));
  limited_user->RevokeRightFromOn("webhare_testsuite:objectright2", limited2_user, 0, FALSE);

  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 0));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 1));
  TestEq(FALSE, limited2_user->HasRightOnAny("webhare_testsuite:objectright2"));

  // See if withgrantoption works for inherited rights
  limited_user->GrantRightToOn("webhare_testsuite:objectright2", limited2_user, 2, TRUE);
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 0));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 3));
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 5));
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 6));
  TestEq(TRUE, limited2_user->HasRightOnAny("webhare_testsuite:objectright2"));

  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 0 ]));
  TestEq([ 2 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 2 ]));
  TestEq([ 2 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 2 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 3 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 3 ]));
  TestEq([ 2, 4, 5, 6 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]));
  TestEq([ 2, 4, 5, 6 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]));
  TestEq([ 2, 4, 5, 6 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 2, 4, 5, 6 ]));

  TestEq([ [ objectid := 0, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 1, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 2, path := [2] ]
         , [ objectid := 3, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 4, path := [2,4] ]
         , [ objectid := 5, path := [2,5] ]
         , [ objectid := 6, path := [2,5,6] ]
         , [ objectid := 7, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 8, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 9, path := DEFAULT INTEGER ARRAY ]
         ], GetObjectsPaths([ "webhare_testsuite:objectright2" ], limited2_user, [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ], DEFAULT INTEGER ARRAY));
  TestEq([ [ objectid := 0, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 1, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 2, path := [2] ]
         , [ objectid := 3, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 4, path := [2,4] ]
         , [ objectid := 5, path := [2,5] ]
         , [ objectid := 6, path := [2,5,6] ]
         , [ objectid := 7, path := DEFAULT INTEGER ARRAY ]
         , [ objectid := 8, path := [8] ]
         , [ objectid := 9, path := [8,9] ]
         ], GetObjectsPaths([ "webhare_testsuite:objectright2" ], limited2_user, [ 9, 9, 8, 8, 7, 6, 5, 4,3, 2, 1, 0, 0 ], [ 8 ]));

  TestEq([ visible := FALSE, path := DEFAULT RECORD ARRAY ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 0));
  TestEq([ visible := FALSE, path := DEFAULT RECORD ARRAY ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 1));
  TestEq([ visible := TRUE, path := GenPath([ 2 ]) ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 2));
  TestEq([ visible := FALSE, path := DEFAULT RECORD ARRAY ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 3));
  TestEq([ visible := TRUE, path := GenPath([ 2, 4 ]) ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 4));
  TestEq([ visible := TRUE, path := GenPath([ 2, 5 ]) ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 5));
  TestEq([ visible := TRUE, path := GenPath([ 2, 5, 6 ]) ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 6));
  TestEq([ visible := FALSE, path := DEFAULT RECORD ARRAY ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 7));
  TestEq([ visible := FALSE, path := DEFAULT RECORD ARRAY ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 8));
  TestEq([ visible := FALSE, path := DEFAULT RECORD ARRAY ], limited2_user->GetObjectPath("webhare_testsuite:testobjecttype", 9));

  TestEq(FALSE, limited2_user->CanManageRight("system:sysop"));
  TestEq(FALSE, limited2_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectright2", 0));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, limited2_user->CanManageRightOn("webhare_testsuite:objectright2", 2));
  TestEq(TRUE, limited2_user->CanManageRightOn("webhare_testsuite:objectright2", 4));
  TestEq(TRUE, limited2_user->CanManageRightOn("webhare_testsuite:objectright2", 6));
  TestEq(FALSE, limited2_user->CanManageRightOn("webhare_testsuite:objectright2", 9));

  testfw->Commit();

  testfw->StartTrans("mysysop", FALSE);
  sysop_user->RevokeRightFrom("webhare_testsuite:globalright", limited_user, FALSE);
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));

  // Non-recursive, please.
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));

  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright2", limited2_user, 2, FALSE);
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));

  testfw->Commit();

  testfw->StartTrans("mysysop", FALSE);
  sysop_user->GrantRightToOn("webhare_testsuite:objectright2_impl", limited2_user, 2, FALSE);

  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 0 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 2 ]));
  TestEq([ 2 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 2 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 3 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 3 ]));
  TestEq(DEFAULT INTEGER ARRAY, limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2", [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]));
  TestEq([ 2, 4, 5, 6 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]));
  TestEq([ 2, 4, 5, 6 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectright2_impl", [ 2, 4, 5, 6 ]));

  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright2_impl", limited2_user, 2, FALSE);
  testfw->Commit();

  // Grant to 0 for flat right (implies all)
  testfw->StartTrans("mysysop", FALSE);
  sysop_user->GrantRightToOn("webhare_testsuite:objectflatright", limited2_user, 0, FALSE);
  TestEq([ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]));
  TestEq([ 4, 8 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 4, 8 ]));
  sysop_user->RevokeRightFromOn("webhare_testsuite:objectflatright", limited2_user, 0, FALSE);
  testfw->Commit();

  // Grant to 2 for flat right (implies only 2)
  testfw->StartTrans("mysysop", FALSE);
  sysop_user->GrantRightToOn("webhare_testsuite:objectflatright", limited2_user, 2, FALSE);
  TestEq([ 2 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]));
  TestEq([ 2 ], limited2_user->HasRightOnMultiple("webhare_testsuite:objectflatright", [ 2 ]));
  sysop_user->RevokeRightFromOn("webhare_testsuite:objectflatright", limited2_user, 2, FALSE);
  testfw->Commit();
}

MACRO RolesTest()
{
  testfw->StartTrans("sysop", FALSE);

  OBJECT sysop_user := testfw->GetUserObject("mysysop");
  OBJECT limited_user := testfw->GetUserObject("limited");
  OBJECT limited2_user := testfw->GetUserObject("limited2");
  OBJECT role1 := testfw->GetRoleObject("role1");

  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEq(FALSE, role1->HasRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited_user->HasRole(testfw->GetRoleObject("role1")));

  testfw->GetUserObject("sysop")->GrantRightTo("webhare_testsuite:globalright", role1, TRUE);
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEq(TRUE, role1->HasRight("webhare_testsuite:globalright"));

  testfw->GetUserObject("sysop")->GrantRoleTo(testfw->GetRoleObject("role1"), limited_user, [ comment := "TestComment" ]);
  TestEq(TRUE, limited_user->HasRole(testfw->GetRoleObject("role1")));
  TestEq(TRUE, limited_user->HasRight("webhare_testsuite:globalright"));

  // See if withgrantoption works for inherited rights from roles
  testfw->Commit();
  testfw->StartTrans("limited", FALSE);

  TestEq(TRUE, limited_user->CanManageRight("webhare_testsuite:globalright"));
  TestEq(FALSE, limited2_user->HasRight("webhare_testsuite:globalright"));
  limited_user->GrantRightTo("webhare_testsuite:globalright", limited2_user, FALSE);
  TestEq(TRUE, limited2_user->HasRight("webhare_testsuite:globalright"));
  limited_user->RevokeRightFrom("webhare_testsuite:globalright", limited2_user, FALSE);
  TestEq(FALSE, limited2_user->HasRight("webhare_testsuite:globalright"));

  TestEq(TRUE, limited_user->CanManageRightOn("webhare_testsuite:objectright2", 2));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));
  limited_user->GrantRightToOn("webhare_testsuite:objectright2", limited2_user, 2, FALSE);
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));
  limited_user->RevokeRightFromOn("webhare_testsuite:objectright2", limited2_user, 2, FALSE);
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));

  testfw->Commit();
  testfw->StartTrans("sysop", FALSE);

  testfw->GetUserObject("sysop")->RevokeRightFrom("webhare_testsuite:globalright", role1, FALSE);
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEq(FALSE, role1->HasRight("webhare_testsuite:globalright"));

  testfw->GetUserObject("sysop")->GrantRightToOn("webhare_testsuite:objectright2", role1, 1, TRUE);
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, role1->HasRightOn("webhare_testsuite:objectright2", 1));
  TestEq(TRUE, limited_user->HasRightOn("webhare_testsuite:objectright2", 2));
  TestEq(TRUE, role1->HasRightOn("webhare_testsuite:objectright2", 2));

  // See if withgrantoption works for inherited rights from roles
  testfw->Commit();
  testfw->StartTrans("limited", FALSE);

  TestEq(FALSE, limited_user->CanManageRight("webhare_testsuite:globalright"));

  TestEq(TRUE, limited_user->CanManageRightOn("webhare_testsuite:objectright2", 1));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 1));
  limited_user->GrantRightToOn("webhare_testsuite:objectright2", limited2_user, 1, FALSE);
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 1));
  limited_user->RevokeRightFromOn("webhare_testsuite:objectright2", limited2_user, 1, FALSE);
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 1));

  TestEq(TRUE, limited_user->CanManageRightOn("webhare_testsuite:objectright2", 2));
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));
  limited_user->GrantRightToOn("webhare_testsuite:objectright2", limited2_user, 2, FALSE);
  TestEq(TRUE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));
  limited_user->RevokeRightFromOn("webhare_testsuite:objectright2", limited2_user, 2, FALSE);
  TestEq(FALSE, limited2_user->HasRightOn("webhare_testsuite:objectright2", 2));

  testfw->Commit();

  // FIXME test with grant option!!!

  testfw->StartTrans("sysop", FALSE);

  testfw->GetUserObject("sysop")->RevokeRoleFrom(testfw->GetRoleObject("role1"), limited_user);
  TestEq(FALSE, limited_user->HasRight("webhare_testsuite:globalright"));

  testfw->GetUserObject("sysop")->RevokeRightFromOn("webhare_testsuite:objectright2", role1, 1, FALSE);

  testfw->Commit();
}

MACRO EnumTest()
{
  testfw->StartTrans("mysysop", FALSE);

  OBJECT sysop_user := testfw->GetUserObject("mysysop");
  OBJECT limited_user := testfw->GetUserObject("limited");
  OBJECT limited2_user := testfw->GetUserObject("limited2");


  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", limited_user->EnsureAuthObject(), FALSE));
  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), FALSE));

  sysop_user->GrantRightTo("webhare_testsuite:globalright", limited_user, FALSE);
  TestEq([ 0 ], GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", limited_user->EnsureAuthObject(), FALSE));
  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), FALSE));

  sysop_user->GrantRightToOn("webhare_testsuite:objectright", limited_user, 1, FALSE);
  sysop_user->GrantRightToOn("webhare_testsuite:objectright", limited_user, 3, FALSE);
  sysop_user->GrantRightToOn("webhare_testsuite:objectright", limited_user, 7, FALSE);

  TestEq([ 1, 3, 7], SortArray(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), FALSE)));

  sysop_user->GrantRightToOn("webhare_testsuite:objectright", limited_user, 0, FALSE);
  TestEq([ 0, 1, 3, 7], SortArray(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), FALSE)));

  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright", limited_user, 7, FALSE);
  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright", limited_user, 3, FALSE);
  TestEq([ 0, 1 ], SortArray(GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), FALSE)));

  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright", limited_user, 0, FALSE);
  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright", limited_user, 1, FALSE);
  sysop_user->RevokeRightFrom("webhare_testsuite:globalright", limited_user, FALSE);

  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", limited_user->EnsureAuthObject(), FALSE));
  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), FALSE));

  sysop_user->GrantRightTo("webhare_testsuite:globalright", limited_user, FALSE, FALSE, "Test Grant");
  TestEq(
        [ [ inherited       := FALSE
          , grantedright    := "webhare_testsuite:globalright"
          , grantedobject   := 0
          , grantor         := sysop_user->authobjectid
          , grantee         := limited_user->authobjectid
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := FALSE
          , comment         := "Test Grant"
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:globalright", limited_user->EnsureAuthObject(), 0, FALSE)));

  TestEq(DEFAULT RECORD ARRAY, ExplainRightGrantedToOn("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), 0, FALSE));
  TestEq(
        [ [ inherited       := TRUE
          , grantedright    := "webhare_testsuite:globalright"
          , grantedobject   := 0
          , grantor         := sysop_user->authobjectid
          , grantee         := limited_user->authobjectid
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := FALSE
          , comment         := "Test Grant"
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 0, FALSE)));

  TestEq(
        [ [ inherited       := TRUE
          , grantedright    := "webhare_testsuite:globalright"
          , grantedobject   := 0
          , grantor         := sysop_user->authobjectid
          , grantee         := limited_user->authobjectid
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := FALSE
          , comment         := "Test Grant"
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 7, FALSE)));

  TestEq(DEFAULT RECORD ARRAY, ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 7, TRUE));

  sysop_user->GrantRightToOn("webhare_testsuite:objectright", limited_user, 1, TRUE);

  TestEq(DEFAULT RECORD ARRAY, ExplainRightGrantedToOn("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), 0, FALSE));
  TestEq(
        [ [ inherited       := FALSE
          , grantedright    := "webhare_testsuite:objectright"
          , grantedobject   := 1
          , grantor         := sysop_user->authobjectid
          , grantee         := limited_user->authobjectid
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := TRUE
          , comment         := ""
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), 1, FALSE)));
  TestEq(
        [ [ inherited       := TRUE
          , grantedright    := "webhare_testsuite:objectright"
          , grantedobject   := 1
          , grantor         := sysop_user->authobjectid
          , grantee         := limited_user->authobjectid
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := TRUE
          , comment         := ""
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), 2, FALSE)));
  TestEq(DEFAULT RECORD ARRAY, ExplainRightGrantedToOn("webhare_testsuite:objectright", limited_user->EnsureAuthObject(), 7, TRUE));

  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", limited2_user->EnsureAuthObject(), FALSE));
  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright", limited2_user->EnsureAuthObject(), FALSE));

  TestEQ(TRUE, testfw->GetRoleAuthobjectid("sysoprole") IN GetGrantedAuthObjects("system:sysop", 0));
  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:globalright", 0)));
  TestEq([ INTEGER(limited_user->authobjectid) ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:globalright", 0, [ inherited := FALSE ])));
  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright2", 7)));

  TestEq([ INTEGER(sysop_user->authobjectid) ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0)));
  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 1)));
  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ anyobject := TRUE ])));
  TestEq(DEFAULT INTEGER ARRAY, FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright2", 7, [ expandroles := FALSE, inherited := FALSE ])));

  sysop_user->RevokeRightFrom("webhare_testsuite:globalright", limited_user, FALSE);
  sysop_user->RevokeRightFromOn("webhare_testsuite:objectright", limited_user, 1, FALSE);

  TestEq([ INTEGER(sysop_user->authobjectid) ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ anyobject := TRUE ])), "Verify limited_user no longer has rights on any objects");

  OBJECT role1 := testfw->GetRoleObject("role1");

  sysop_user->GrantRightTo("webhare_testsuite:globalright", role1, FALSE);
  sysop_user->GrantRightToOn("webhare_testsuite:objectright", role1, 1, FALSE);
  TestEq(TRUE, role1->authobjectid IN GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ expandroles := FALSE, anyobject :=TRUE ]));
  sysop_user->GrantRoleTo(testfw->GetRoleObject("role1"), limited_user);

  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ anyobject := TRUE ])), "It has access again through role1");
  TestEq([ INTEGER(sysop_user->authobjectid) ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ anyobject := TRUE, dontexpandauthobjects := INTEGER[role1->authobjectid] ])), "remove limited1 when role1 ignored");

  //grant through multiple routes
  OBJECT role2 := testfw->GetRoleObject("role2");
  sysop_user->GrantRightToOn("webhare_testsuite:objectright", role2, 2, FALSE);
  sysop_user->GrantRoleTo(role2, limited_user);
  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ anyobject := TRUE ])), "It has access again through role1");

  sysop_user->GrantRightToOn("webhare_testsuite:objectright", limited_user, 3, FALSE);
  TestEq([ INTEGER(sysop_user->authobjectid), limited_user->authobjectid ], FilterByKnownUsers(GetGrantedAuthObjects("webhare_testsuite:objectright", 0, [ anyobject := TRUE ])), "It has access again through role1");


  TestEq(TRUE, limited_user->HasRight("webhare_testsuite:globalright"));
  TestEq(
        [ [ inherited       := TRUE
          , grantedright    := "webhare_testsuite:globalright"
          , grantedobject   := 0
          , grantor         := sysop_user->authobjectid
          , grantee         := testfw->GetRoleAuthobjectid("role1")
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := FALSE
          , comment         := ""
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:globalright", limited_user->EnsureAuthObject(), 0, FALSE)));
  TestEq(
        [ [ inherited       := TRUE
          , grantedright    := "webhare_testsuite:globalright"
          , grantedobject   := 0
          , grantor         := sysop_user->authobjectid
          , grantee         := testfw->GetRoleAuthobjectid("role1")
          , creationdate    := DEFAULT DATETIME
          , withgrantoption := FALSE
          , comment         := ""
          , grantordata     := [ login := "mysysop@beta.webhare.net" ]
          ]
        ], ClearCreationDate(ExplainRightGrantedToOn("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), 2, FALSE)));

  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:globalright", limited_user->EnsureAuthObject(), FALSE));
  TestEq(DEFAULT INTEGER ARRAY, GetObjectIdsOfDirectGrantsTo("webhare_testsuite:objectright2", limited_user->EnsureAuthObject(), FALSE));

  testfw->Commit();
}

MACRO UnitTest()
{
  EnsureUserMgmtStateClean();

  testfw->BeginWork();

  TestThrowsLike('*WRD_TITLE*', PTR testfw->userapi->CreateUnit([name := "testunit"]));

  testfw->userapi->CreateUnit([wrd_title := "testunit"]);

  testfw->RollbackWork();
}

RunTestframework( [ PTR InitDB
                  , PTR DefaultRightsTest
                  , PTR UsersTest
                  , PTR GrantTest
                  , PTR RolesTest
                  , PTR EnumTest
                  , PTR UnitTest
                  ], [ testusers := [[ login := "sysop", grantrights := ["system:sysop"] ]
                                    ,[ login := "mysysop", grantroles := ["sysoprole"]]
                                    ,[ login := "mysysopusingrole"]
                                    ,[ login := "limited"]
                                    ,[ login := "limited2"]
                                    ]
                     , testroles := [[ role := "role1" ]
                                    ,[ role := "role2" ]
                                    ,[ role := "sysoprole", grantrights := ["system:sysop"] ]
                                    ]
                     ]
                  );
