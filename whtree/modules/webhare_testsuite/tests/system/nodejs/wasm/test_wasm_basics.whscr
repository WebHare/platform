<?wh
LOADLIB "wh::crypto.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::internal/wasm.whlib";
LOADLIB "wh::util/algorithms.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/resources.whlib";
LOADLIB "mod::system/lib/testframework.whlib";

LOADLIB "mod::tollium/lib/gettid.whlib";

PUBLIC MACRO RunWasmtest()
{
  TestEq("81DC9BDB52D04DC20036DBD8313ED055", EncodeBase16(GetHashForBlob(StringToBlob("1234"),"MD5")));

  TestEqLike("*/modules/system/", GetModuleInstallationRoot("system"));
  TestEq("", GetModuleInstallationRoot("__nosuchmodule__"), "should NOT throw");
  TestEq("Cancel", GetTid("~cancel"));

  TestAssert(GetWebHareVersionNumber() >= 50300);

  STRING ARRAY mods := GetInstalledModuleNames();
  TestEq(TRUE, "system" IN mods);
  TestEq(TRUE, "webhare_testsuite" IN mods);

  RECORD config := GetWebHareConfiguration();
  TestEqLike("/?*", config.basedataroot);
  TestEqLike("/?*", config.ephemeralroot);

  //Do wasm-specific tests *last* so it's easier to manually test us under native
  TestEq(TRUE, IsWASM(), "We should be tested under wasm!");
  TestThrowsLike("*no such *syscall*notthere*", PTR EM_Syscall("notthere"));
}

RunWasmTest(); //TODO RunTestFramework isn't supported yet
