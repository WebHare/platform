<?wh

LOADLIB "wh::os.whlib";

LOADLIB "mod::publisher/lib/analytics.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/internal/tasks/geoipdownload.whlib";

PUBLIC RECORD FUNCTION GetGeoIPCapabilities() __ATTRIBUTES__(EXTERNAL "system_geoip");

MACRO TestGEOIP()
{
  RECORD result := UpdateGEOIPDatabases(GetTestSecret("GEOIP2_LICENSEKEY") ?? ReadRegistryKey("system.services.geoip2.licensekey"));
  DumpValue(result,'tree');
  IF(NOT result.success)
  {
    ABORT("GEOIP download failed");
  }
  TestEq(TRUE, GetGeoIPCapabilities().have_city);
  TestEq(TRUE, GetGeoIPCapabilities().have_country);
  TestEq("NL", GetGeoIPCountryForIP("212.238.237.85")); //gateway.sf.webhare.nl
  TestEq("NL", GetGeoIPInfoForIP("212.238.237.85").country_code);
  TestEq("Netherlands", GetGeoIPInfoForIP("212.238.237.85").country_name);
  TestEqStructure([ city := "", country_code := "", country_name := ""
                  , latitude := 0f, longitude := 0f, postal_code := ""
                  , region_code := "", region_name := ""], GetGeoIPInfoForIP("212.238.237.85"));

  TestEq("", GetGeoIPCountryForIP("10.144.201.112")); //internal IPs should never return a match
  TestEq(DEFAULT RECORD, GetGeoIPInfoForIP("10.144.201.112")); //internal IPs should never return a match

  //an IP similar to this one returned a record with all values set to default (ie country_code = "") instead of default record.
  RECORD res := GetGeoIPInfoForIP("192.42.116.13");
  TestAssert(NOT RecordExists(res) OR res.country_code != ""); //it's a DEFAULT RECORD *now* but might resolve at some point in the future
}

RunTestframework([ PTR TestGEOIP
                 ]);
