<?wh
LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::tollium/lib/screenbase.whlib";
LOADLIB "mod::tollium/lib/testframework.whlib";
LOADLIB "mod::webhare_testsuite/lib/screens/tests/tabextensions.whlib";

MACRO TestTabExtensions()
{
  OBJECT scr := GetTestController()->LoadScreen("webhare_testsuite:tests/tabextensions.test");
  TestEq(TRUE, ObjectExists(scr));
  TestEq(DEFAULT OBJECT, scr->parentscope);

  //Verify we can remove the extension too
  scr->tabs->extendcomponents := [[ name := "externalradiogroup", component := scr->mainradio ]];

  //FIXME __selector is still a hack. depreacte it!
  TestThrows(PTR scr->tabs->LoadTabsExtension("moduledata::webhare_testsuite/test/tollium/extensions.xml", '__selector://*[local-name()="level42"]'), "should have thrown, level42 should not be recognized");
  RECORD loadinfo := scr->tabs->LoadTabsExtension("moduledata::webhare_testsuite/test/tollium/extensions.xml", '__selector://*[local-name()="level42"]/*[local-name()="tabsextension"]');

  TestEQ(TRUE, loadinfo.fragment EXTENDSFROM TolliumTabsExtensionBase);

  OBJECT comp := SELECT AS OBJECT obj FROM ToRecordArray(loadinfo.components,"obj") AS objs WHERE objs.obj->name LIKE "*beschikbaarheid";
  TestEq('(cannot find text: webhare_testsuite:test.beschikbaarheid)',comp->title); //it's outside tidscanner sight too... but it's a hack!
  scr->tabs->RemoveTabsExtension(loadinfo);

  // Load extension with code
  loadinfo := scr->tabs->LoadTabsExtension("moduledata::webhare_testsuite/test/tollium/extensions.xml", '__selector://*[local-name()="level43"]/*[local-name()="tabsextension"]');
  TestEQ(TRUE, loadinfo.fragment EXTENDSFROM ExtensionWithCode);
  TestEQ(scr->tabs, got_tabs, "Tab extension should have its InitExtension method called");

  scr->tabs->RemoveTabsExtension(loadinfo);
}

RunTestFramework( [ PTR TestTabExtensions
                  ]);
