<?wh

LOADLIB "mod::system/lib/testframework.whlib";

PUBLIC MACRO ValidateFormRenderTree(RECORD rendertree)
{
  TestEq(FALSE, CellExists(rendertree,'config'), "top-level onfig was eliminated");
  TestEqLike("?*", rendertree.target);

  FOREVERY(RECORD page FROM rendertree.pages)
  {
    TestEq(FALSE, CellExists(page,'config'), "page-level onfig was eliminated");
    TestEq(RECORD[], SELECT * FROM page.fields WHERE CellExists(fields,'title'), "Fields should have 'htmltitle' not 'title'");
    TestEq(RECORD[], SELECT * FROM page.fields WHERE CellExists(fields,'prefix'), "Fields should have 'htmlprefix' not 'prefix'");
    TestEq(RECORD[], SELECT * FROM page.fields WHERE CellExists(fields,'suffix'), "Fields should have 'htmlsuffix' not 'suffix'");
    TestEq(RECORD[], SELECT * FROM page.fields WHERE CellExists(fields,'label'), "Fields should have 'htmllabel' not 'label'");

    FOREVERY(RECORD field FROM page.fields)
    {
      //Ensure that fields, if they exist, have the expected type
      TestEq("STRING", GetTypeName(TYPEID(field.htmltitle)));
      TestEq("RECORD", GetTypeName(TYPEID(field.groupdataset)));
      TestEq("RECORD", GetTypeName(TYPEID(field.visiblecondition)));

      IF(CellExists(field,'orientation')) //TODO or should ALL fields have orientations?
        TestEq(TRUE, field.orientation IN ['horizontal','vertical']);

      IF(CellExists(field,'type')) //TODO or should ALL fields have types?
      {
        IF(field.type = "checkbox")
        {
          //A checkbox is in the forms either a <select type=checkbox> (group of checkboxes) or <checkbox> but when rendering, equalize those!
          TestEq(FALSE, CellExists(field,'value'), "No 'value' in a checkbox");
          TestEq(FALSE, CellExists(field,'label'), "No 'label' in a checkbox");
          TestEq(FALSE, CellExists(field,'htmllabel'), "No 'htmllabel' in a checkbox");
          TestEq("RECORD ARRAY", GetTypeName(TYPEID(field.options)));
          TestEq(TRUE, field.orientation IN ["horziontal","vertical"]);
        }
      }

      TestEqLike("?*#?*", field.qname, "Must be a valid qname");
      TestEq(TRUE, SearchSubstring(field.qname,'?') = -1, "Qname shouldn't contain a ?");
    }
  }

}
