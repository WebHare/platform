<?wh
LOADLIB "wh::datetime.whlib";

LOADLIB "mod::system/lib/services.whlib";

/** Wait for output analyser scans to finish
    @param folderids Ids of folders that must be completed
    @param deadline Error out when the wait hasn't completed after this time
*/
PUBLIC MACRO WaitForOutputAnalyzer(INTEGER ARRAY folderids, DATETIME deadline)
{
  OBJECT outputanalyzer := WaitForPromise(OpenWebHareService("publisher:outputanalyzer"));
  WHILE (TRUE)
  {
    RECORD state := WaitForPromise(outputanalyzer->GetState());
    INTEGER ARRAY scheduled := WaitForPromise(outputanalyzer->TestFoldersScheduled(folderids));
    //DumpValue(CELL[ state, scheduled ], "tree");
    IF (IsDefaultValue(scheduled))
      BREAK;

    Sleep(10);
    IF(GetCurrentDatetime() >= deadline)
      ABORT("outputanalyzer isn't completing");
  }
  outputanalyzer->CloseService();
}

