<?wh
LOADLIB "wh::crypto.whlib";
LOADLIB "mod::system/lib/database.whlib";

STRING libgeneration;

BOOLEAN FUNCTION HasDB()
{
  BOOLEAN hastrans := GetPrimaryWebharetransaction() != 0;
  BOOLEAN hasbinding := RecordExists(GetBindingFromSchema(system));
  IF(hastrans AND NOT hasbinding)
    THROW NEW Exception("Inconsistent state - we have a primary transaction but no binding");
  IF(hasbinding AND NOT hastrans)
    THROW NEW Exception("Inconsistent state - we have a binding but no primary transaction");
  RETURN hastrans;
}

PUBLIC OBJECTTYPE TestLocalService
<
  STRING guid;

  MACRO NEW(STRING dummy)
  {
    IF(dummy!="abc")
      THROW NEW Exception("Parameter passing failed");

    this->guid := GenerateUFS128BitId();
    IF(NOT HasDB())
      THROW NEW Exception("No transaction");
  }
  PUBLIC STRING FUNCTION GetGuid()
  {
    IF(NOT HasDB())
      THROW NEW Exception("No transaction");
    RETURN this->guid;
  }
  PUBLIC INTEGER FUNCTION GetEffectiveUserID()
  {
    RETURN GetEffectiveUserID();
  }
  PUBLIC MACRO ThrowMeABone()
  {
    THROW NEW Exception("Bone");
  }
  PUBLIC MACRO TestRecurse()
  {
    OBJECT myservice := OpenLocalService("webhare_testsuite:test", "abc");
    libgeneration := GenerateUFS128BitId();
    //make sure this NEW version did not create its own weblet
    IF(libgeneration != myservice->GetGeneration())
      THROW NEW Exception("A new weblet was created");
  }
  PUBLIC STRING FUNCTION GetGeneration()
  {
    RETURN libgeneration;
  }
  PUBLIC BOOLEAN FUNCTION HasDB()
  {
    RETURN HasDB();
  }
>;

PUBLIC OBJECTTYPE TestNoDBService
<
  STRING serviceid;

  MACRO NEW()
  {
    IF(HasDB())
      THROW NEW Exception("Unexpected primary transaction #" || GetPrimaryWebharetransaction());
  }
  PUBLIC MACRO OpenDB()
  {
    OpenPrimary();
  }
  PUBLIC MACRO CloseDB()
  {
    GetPrimary()->Close();
  }
  PUBLIC BOOLEAN FUNCTION HasDB()
  {
    RETURN HasDB();
  }
  PUBLIC STRING FUNCTION GetId(STRING defaultid)
  {
    this->serviceid := this->serviceid ?? defaultid;
    RETURN this->serviceid;
  }
>;
