<?wh

LOADLIB "wh::datetime.whlib";

LOADLIB "mod::publisher/lib/siteapi.whlib";

LOADLIB "mod::system/lib/testframework.whlib";
LOADLIB "mod::system/lib/internal/userrights/resync.whlib";

LOADLIB "mod::wrd/lib/internal/dbschema.whlib";

PUBLIC OBJECT FUNCTION OpenTestsuiteSite()
{
  RETURN OpenSiteByName("WebHare testsuite site");
}
PUBLIC OBJECT FUNCTION GetTestsuiteTempFolder()
{
  RETURN OpenSiteByName("WebHare testsuite site")->OpenByPath("tmp");
}

PUBLIC OBJECT FUNCTION OpenTestsuiteAltSite()
{
  RETURN OpenSiteByName("WebHare testsuite site - alt host");
}

PUBLIC MACRO EnsureUserMgmtStateClean()
{
  testfw->BeginWork();
  RECORD ARRAY resync := testfw->userapi->ResyncToSystemTables();
  IF(Length(resync)>0)
  {
    PRINT("UNEXPECTED RESYNC ACTIONS\n");
    DumpValue(resync,'tree');
    ABORT("There were unexpected changes made by ResyncToSystemTables - our incremental updates might be bad. (Once this state is triggered you may need to manually resync userrights)");
  }

  RECORD ARRAY reconnects := FixUnconnectedItems(testfw->userapi->wrdschema);
  IF(Length(reconnects)>0)
  {
    PRINT("UNEXPECTED RECONNECT ACTIONS\n");
    DumpValue(reconnects,'tree');
    ABORT("There were unexpected changes made by FixUnconnectedItems. (Once this state is triggered you may need to manually resync userrights)");
  }
  testfw->CommitWork();
}

DATETIME lastcheck;

PUBLIC RECORD FUNCTION TestAuditEvent(RECORD expected)
{
  RECORD ARRAY auditevents := SELECT *, DELETE id, DELETE creationdate, DELETE wrdschema, DELETE country
                                FROM wrd.auditevents
                               WHERE auditevents.wrdschema = testfw->GetWRDSchema()->id
                                     AND creationdate > lastcheck;

  // add defaults for impersonator
  IF (RecordExists(expected) AND NOT expected.impersonated)
    expected := CELL[ impersonator_entity := expected.byentity, impersonator_login := expected.bylogin, ...expected ];

  IF(NOT CellExists(expected,'IP')) //some tests do not care about IP address (prevent connecting to webhareinterface from causing issues)
    auditevents := SELECT *, DELETE ip FROM auditevents;
  TestEq(RecordExists(expected) ? [ expected ] : RECORD[], auditevents);
  lastcheck := GetCurrentDatetime();
  Sleep(1);
  RETURN auditevents;
}
