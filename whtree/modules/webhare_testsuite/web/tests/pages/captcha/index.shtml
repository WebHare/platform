<?wh
LOADLIB "wh::witty.whlib";

LOADLIB "mod::platform/lib/captcha/captchamgmt.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";
LOADLIB "mod::system/lib/webserver.whlib";
LOADLIB "mod::system/lib/testfw/testpage.whlib";
LOADLIB "mod::system/lib/webserver/whdebug.whlib";

LOADLIB "mod::publisher/lib/siteprofiles.whlib";

LOADLIB "mod::webhare_testsuite/lib/system/tests.whlib";

MACRO RunBody(OBJECT testcontext)
{
  OBJECT context := GetWebContext(OpenTestsuiteSite()->id);
  STRING useurl := IsWHDebugOptionSet("nsc") ? "mock" : GetRequestURL();
  RECORD provider := GetCaptchaProvider(useurl);
  LoadWittyLibrary(Resolve("testpage-captcha.witty"),"HTML")->Run(
    [ feedbackurl := GetRequestURL()

    , provider := EncodeJSON(provider)
    , webcontextcaptchaaccept := IsRequestPost() ? VerifyCaptchaResponse(useurl, GetWebVariable("captcharesult")) ? "YES":"NO": ""
    ]);
}

ProcessWHDebugVariablesUnchecked();
OpenPrimary();
InvokeTestPage(PTR RunBody, [ jsfile := "testpage-captcha"
                             ]);
