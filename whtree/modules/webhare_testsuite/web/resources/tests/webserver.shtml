<?wh
LOADLIB "mod::system/lib/webserver.whlib";
LOADLIB "mod::system/lib/webserver/errors.whlib";
LOADLIB "mod::system/lib/internal/resourcemanager.whlib";
LOADLIB "wh::datetime.whlib";


IF(GetWebVariable("contentdisp")!="")
  AddHTTPHeader("Content-Disposition", GetWebVariable("contentdisp"), FALSE);

SWITCH(GetWebVariable("type"))
{
  CASE "refreshconfig"
  {
    ReloadWebhareConfig(TRUE, FALSE);
  }
  CASE "echorequest"
  {
    SendWebFile(EncodeHSONBlob([ allvars := GetAllWebVariables() ]));
  }
  CASE "echobody"
  {
    SendWebFile(GetRequestBody());
  }
  CASE "echo"
  {
    IF(GetWebVariable("mimetype")!="")
      AddHTTPHeader("Content-Type",GetWebVariable("mimetype"),FALSE);
    SendWebFile(GetWebBlobVariable("data"));
  }
  CASE "flushwebresponse"
  {
    AddHTTPHeader("Content-Type","text/plain", FALSE);
    Print("First test flush web response");
    FlushWebResponse(MAX_DATETIME);
    Print("Second test flush web response");
    FlushWebResponse(MAX_DATETIME);
    LogWebserverError("EXPECT HareScript error: Cannot AddHeader after flushing the response");
    AddHTTPHeader("Content-Type","text/html", FALSE);
    ABORT("This point shouldn't be reached (above code should've triggered ABORT)");
  }
  CASE "flushwebresponse2"
  {
    FOR(INTEGER i:=0;i<10;i:=i+1)
    {
      Print(i||"\r\n");
      FlushWebResponse(MAX_DATETIME);
      Sleep(500);
    }
  }
  CASE "404"
  {
    AddHTTPHeader("Status","404 Bla Bla", FALSE);
  }
  CASE "statusbad"
  {
    AddHTTPHeader("Status","404 Bad\r\nBad: Header\r\nBad bad bad!\r\n\0Even: worse", FALSE); //must not end in a line feed, the error
  }
  CASE "statuslong"
  {
     AddHTTPHeader("Status","404 " || RepeatText("I'm a lumberjack and I'm okay, I sleep all night and I work all day.",1000), FALSE);
  }
  CASE "getmyip"
  {
    Print(GeTClientRemoteIP());
  }
  CASE "getrequesturl"
  {
    Print(GetRequestUrl());
  }
  CASE "describe"
  {
    Print(EncodeJSON( [ remoteip := GetClientRemoteIP()
                      , url := GetRequestURL()
                      ]));
  }
  CASE "redirect"
  {
    STRING status := GetWebVariable("status");
    AddHTTPHeader("Status",status, FALSE);
    AddHTTPHeader("Location","http://www.test.invalid/"||status, FALSE);
  }
  CASE "redirectencoding"
  {
    AddHTTPHeader("X-Test-2","\r\nX-Test-3: 4", FALSE);
    Redirect("/.wrd/auth/gologin?x\"><script>alert(1)</script>x=1\r\nTest: 1");
  }
  DEFAULT
  {
    ABORT("Unknown test type '" || GetWebVariable("type") || "'");
  }
}

/*
GET /tollium_todd.res/beta/tests/webserver.shtml?type=flushwebresponse2 HTTP/1.0
Host: webhare.moe.btc.b-lex
*/
