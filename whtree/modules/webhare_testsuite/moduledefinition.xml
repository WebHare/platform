<?xml version="1.0" encoding="UTF-8"?>
<module xmlns="http://www.webhare.net/xmlns/system/moduledefinition">

  <meta>
    <description>Alpha and beta testing of WebHare, Tollium and add-on modules</description>
    <version excludefromfeedbackversions="true">4.31.0</version>
    <validation>
      <exclude mask="tests/tollium/language/gettid.whscr" why="gettid.whscr tries to test invalid GetTid, don't blame the file for that" />
      <exclude mask="tests/publisher/siteprofile/data/test*.siteprl.xml" why="these testfiles contain errors on purpose" />
      <exclude mask="tests/system/modules/data/brokenscreen.xml" why="these testfiles contain errors on purpose" />
      <exclude mask="tests/tollium/nodejs/test_gettid.es" why="these testfiles contain errors on purpose" />
      <!-- <exclude mask="tests/*/data/*" why="don't validate test data, its often broke" /> -->
      <exclude mask="*testdata_loadlib_circ_?.whlib" why="These libraries are supposed to fail to compile" />
      <eslint mask="nosuch.js" />
    </validation>
  </meta>

  <servicemanager>
    <runonce       tag="setuptestsite" script="scripts/whcommands/reset.whscr" when="poststart" ifenvironset="WEBHARE_CI" />
    <runonce       tag="setuppwasite" script="tests/publisher/pwa/setuppwasite.whscr" when="poststart" ifenvironset="WEBHARE_CI" />
    <task          tag="singleshottest" script="scripts/tasks/singleshottest.whscr" description="Test singleshot tasks">
      <arg>ARG1 SHOT</arg>
      <arg>arg2</arg>
    </task>
    <task          tag="resettestsite" runat="5 0 * * *" runtz="Europe/Amsterdam" script="scripts/whcommands/reset.whscr" description="Periodically reset testsite and testdata" />

    <taskcluster harescriptworkers="2" tag="testcluster" />

    <managedtask   type="aftercompile" library="lib/internal/tasks.whlib" objectname="aftercompiletask"/> <!-- used by assetmgr-brokentest -->
    <managedtask   type="applyruletask" library="lib/internal/tasks.whlib" objectname="applyruletask"/> <!-- used by actions.whscr -->
    <managedtask   type="ping" objectname="lib/internal/tasks.whlib#pingtask" failreschedule="4000" />
    <managedtask   type="pingretry2" objectname="lib/internal/tasks.whlib#pingtask" maxfailures="1"/>
    <managedtask   type="cancellable" objectname="lib/internal/tasks.whlib#cancellabletask"/>
    <managedtask   type="temporaryfailure" objectname="lib/internal/tasks.whlib#TemporaryFailingTask"/>
    <managedtask   type="timelimitedtask" objectname="lib/internal/tasks.whlib#TimelimitedTask" timeout="300" />
    <managedtask   type="usereditedtask" objectname="lib/internal/tasks.whlib#UserEditedTask" />
    <managedtask   type="doublescheduletask" objectname="lib/internal/tasks.whlib#DoubleScheduleTask" cluster="testcluster" />
    <ephemeraltask type="ping" objectname="lib/internal/tasks.whlib#ephpingtask"/>
    <ephemeraltask type="nodetask" library="js/task.es" />
  </servicemanager>

  <portal>
    <linkapp name="localtests" group="system:development" link="/tests/" tid="localtests.apptitle" isdeveloperapp="true">
      <accesscheck>
        <requireright right="system:sysop"/>
      </accesscheck>
    </linkapp>

    <application name="runscreen" startmacro="lib/tollium.whlib#RunScreen">
      <accesscheck />
    </application>
    <application name="testdocs" startmacro="tests/tollium/shell/data/testdocs.whlib#starttestdocs">
      <accesscheck />
    </application>
    <application name="anycomponent" startmacro="lib/screens/tests/anycomponent.whlib#RunAnyComponent">
      <accesscheck />
    </application>
    <application name="appstarttest" screen="/screens/tests/comm.xml#appstart">
      <accesscheck />
    </application>
    <application name="human" screen="/screens/tests/human.xml#main">
      <accesscheck />
    </application>
    <application name="testsiteversioning"
                 icon="tollium:applications/versioning"
                 startmacro="/lib/publisher/versioningapp.whlib#StartVersioningApp">
      <accesscheck>
        <requireright right="system:sysop" />
      </accesscheck>
    </application>
    <application name="demo" screen="tolliumapps/demo/main.xml#main" title="Demo &amp; dev">
      <accesscheck />
    </application>

    <!-- temp, have to add a main.xml / tollium.xml which opens this? -->
    <application name="imagemap" screen="tolliumapps/demo/imagemap-editor/imagemap_editor.xml#main" title="Imagemap editor">
      <accesscheck />
    </application>
    <application name="dymodemo" screen="tolliumapps/demo/dymo/dymo.xml#main">
      <accesscheck />
    </application>
    <application name="wrddemo" screen="tolliumapps/demo/wrd/wrddemo.xml#main" supportedlanguages="en">
      <accesscheck />
    </application>
    <application name="mapdemo" screen="tolliumapps/demo/socialite/mapdemo.xml#maps">
      <accesscheck />
    </application>

    <notification name="eventservertest" tid="module.eventservertest" descriptiontid="module.eventservertest-desc" defaultenabled="true" />
  </portal>

  <tollium>
    <components namespace="http://www.webhare.net/xmlns/webhare_testsuite/testcomponents" xmlschema="testcomponents.xsd"/>
  </tollium>

  <services>
    <webservice name="test" transports="jsonrpc whremoting" library="lib/webservicetest.whlib" requirewhaccount="true" primarytrans="auto" prefix="RPC_">
      <accesscheck>
        <requireright right="system:sysop"/>
      </accesscheck>
      <addheader header=" X-Test-Header :  * "/>
    </webservice>
    <webservice name="testnoauth" transports="jsonrpc whremoting" library="lib/webservicetest.whlib" prefix="RPC_">
      <accesscheck>
      </accesscheck>
    </webservice>

    <webservice name="sharedtests" transports="jsonrpc" library="lib/sharedtests.whlib" prefix="RPC_">
      <accesscheck>
      </accesscheck>
    </webservice>

    <apprunnerconfig configfunction="lib/internal/support.whlib#getapprunnerconfig" />
  </services>


  <rights>
    <!-- Rights for tests -->
    <objecttype name="testobjecttype"
                describer="lib/internal/rights.whlib#betatreeobjecttypedescriber"
                parentfield="parent"
                table=".rights_tree"
                title="Test rights objecttype for table beta.rights_tree" />
    <objecttype name="testflatobjecttype"
                describer="lib/internal/rights.whlib#betatreeflatobjecttypedescriber"
                table=".rights_tree"
                title="Test rights objecttype for table beta.rights_tree, without parent field" />

    <right name="globalright" title="webhare_testsuite globalright">
      <impliedby right="system:sysop" />
    </right>
    <right name="objectright" objecttype="testobjecttype">
      <impliedby right="system:sysop" />
    </right>
    <right name="objectright2" objecttype="testobjecttype">
      <impliedby right="globalright" />
    </right>
    <right name="objectright2_impl" objecttype="testobjecttype">
      <impliedby right="objectright2" />
    </right>
    <right name="objectflatright" objecttype="testflatobjecttype">
      <impliedby right="globalright" />
    </right>
    <right name="betatesting" title="Allow acces to beta test apps">
      <impliedby right="system:sysop" />
    </right>
  </rights>

  <backend>
    <webrule path="root:/.webhare_testsuite/tests/" match="initial" maxservertype="development" allowallmethods="true" redirecttodir="web:/tests/" />
    <webrule path="root:/.webhare_testsuite/tests/csp" match="initial">
      <csp policy="frame-ancestors [webhare];script-src 'self'" />
    </webrule>
    <webrule path="root:/.webhare_testsuite/tests/pages/captcha" match="initial">
      <csp policy="frame-ancestors [webhare];script-src 'self' https://www.google.com https://www.gstatic.com" /> <!-- needed for publisher.components.test-captcha -->
    </webrule>
    <webrule path="root:/.webhare_testsuite/tests/searchallcases/" match="initial" maxservertype="development" allowallmethods="true" redirecttodir="web:/tests/" searchallcases="true" />

    <webruleset name="testset" tid="module.webruleset">
      <webrule match="initial" path="/xyz/" redirecttoscript="urls/xyz.shtml"/>
    </webruleset>
    <webruleset name="testframework" title="WebHare test framework: B-Lex testsuite testsite">
      <webrule path="/" match="initial" wrdschema="wrd:testschema"/>
    </webruleset>
    <webrule match="initial" path="root:/betatesting/testset/" applyruleset="webhare_testsuite:testset"/>

    <webruleset name="thirdpartytest" title="Testsuite: testwrdauthplugin thirdpartytest">
      <webrule path="/wrd/authtest/webhare_testsuite.shtml" match="exact" handlebyscript="web/tests/wrd/authdebug.shtml" />
      <webrule path="/wrd/authtest/accessruleaccounts/" authmode="ipandaccess" match="initial" authscript="webdesigns/basetest/lib/webhare-auth-portal1.whscr" requirewhaccount="true" handlebydir="web/tests/" />
    </webruleset>

    <webruleset name="securityheaders" title="Testsuite: security headers">
      <webrule path="/" match="initial">
        <addheader header="X-Frame-Options" value="SAMEORIGIN"/>
        <addheader header="Strict-Transport-Security" value="max-age=15552000"/>
        <addheader header="X-XSS-Protection" value="1; mode=block"/>
        <csp policy="script-src 'self'"/>
      </webrule>
    </webruleset>
    <restapi path="root:/.webhare_testsuite/restapi/" apispec="tests/wh/webserver/remoting/restapi/restapi.xml" />

    <webrule path="root:/.webhare_testsuite/datastorage/" match="initial">
      <tryfolder path="storage::webhare_testsuite/tmp/folderdirect/" />
      <tryfolder resolver="sha256b16" path="storage::webhare_testsuite/tmp/foldersha/" />
      <tryfolder resolver="sha256b16_directory" path="storage::webhare_testsuite/tmp/foldersha_dir/" />
      <tryfile path="storage::webhare_testsuite/tmp/file.shtml" />
      <tryfile path="mod::[modulename]/web/resources/tests/static.html" />
    </webrule>

    <usereditpolicy name="usereditpolicy" title="webhare_testsuite test user edit policy"
                    usereditedmanagedtask="usereditedtask" />

  </backend>

  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="rights_tree" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="name" maxlength="256" nullable="0"/>
      <d:integer name="parent" references=".rights_tree" ondelete="cascade"/>
    </d:table>

    <d:table name="consilio_index" primarykey="id">
      <d:integer name="id" autonumberstart="1"/>
      <d:varchar name="groupid" maxlength="1024"/>
      <d:varchar name="objectid" maxlength="1024"/>
      <d:varchar name="text" maxlength="1024"/>
      <d:datetime name="adate"/>
      <d:datetime name="grouprequiredindexdate"/> <!-- ignored when default -->
      <d:datetime name="objectrequiredindexdate"/> <!-- ignored when default -->
      <d:datetime name="indexdate"/>
      <d:integer name="spiderfrom" references=".consilio_index" ondelete="cascade"/>
      <d:varchar name="extradata" maxlength="4096" />
    </d:table>

    <d:obsoletetable name="hosted_blobs" />

    <d:table name="exporttest" primarykey="id">
      <d:integer name="id"/>
      <d:varchar name="text" maxlength="4096"/>
    </d:table>

  </databaseschema>


  <logging>
    <log name="test" filename="betatest" rotates="4" mseconds="true"/>
  </logging>

  <moduleregistry>
    <node name="tests">
      <string name="ingenicomode" />
      <string name="response" />
      <string name="alttestsitehost" />
      <string name="hashedpassword" />
      <string name="secondhareinterface" />
      <record name="addressverification" />
      <datetime name="lastaftercompile" />
      <datetime name="tempfailretryat" />
      <boolean name="taskthrownow" />
    </node>
    <node name="apis">
      <obsoletekey name="google_oauth_clientid" />
      <obsoletekey name="google_oauth_clientsecret" />
      <record name="twitter_testclient" />
      <record name="twitter_testauth" />
    </node>
  </moduleregistry>

  <publisher>
    <siteprofile path="data/webhare_testsuite.siteprl.xml"/>
    <siteprofile path="tests/consilio/data/consiliotests.siteprl.xml"/>
    <virtualfs name="beta_tests" objectname="lib/myvirtualfs.whlib#BetaFS">
      <accesscheck>
        <requireright right="system:sysop"/>
      </accesscheck>
    </virtualfs>
    <virtualfs name="beta_tests2" objectname="lib/myvirtualfs.whlib#BetaModularFS">
      <accesscheck>
        <requireright right="system:sysop"/>
      </accesscheck>
    </virtualfs>
    <worklisttype name="filteredlist" filterscreen="tests/publisher/tollium/data/worklistfilter.xml#FilteredListPanel" />
    <webdesign hidden="true" name="basetest" title="WH testsuite: selftest 'basetest'" siteprofile="webdesigns/basetest/basetest.siteprl.xml">
      <assetpack entrypoint="webdesigns/basetest/js/basetest" supportedlanguages="en nl ps" compatibility="es2016" />
    </webdesign>
    <webdesign hidden="true" name="pwatest" title="WH testsuite: pwatest" siteprofile="webdesigns/pwatest/pwatest.siteprl.xml">
      <assetpack entrypoint="webdesigns/pwatest/pwatest.es" supportedlanguages="en" compatibility="es2016" /> <!-- FIXME aftercompiletask="webharedev_pwa:rebuildpages" ?? -->
    </webdesign>
    <webdesign hidden="true" name="alttest" title="WH testsuite: selftest 'attest'" siteprofile="webdesigns/basetest/alttest.siteprl.xml">
    </webdesign>
    <webdesign name="neverused_compiletest"
               hidden="true"
               siteprofile="webdesigns/basetest/neverused_compiletest.siteprl.xml"
               title="WH testsuite: never used siteprl" />

    <addtoassetpack assetpack="webhare_testsuite:basetest" entrypoint="webdesigns/basetest/js/addtopack" />
    <addtowebdesign webdesign="webhare_testsuite:basetest" siteprofile="webdesigns/basetest/siteprofiles/addtobasetest.siteprl.xml" />
    <webfeature hidden="true" name="testfeature" title="WH testsuite: Test feature" siteprofile="webfeatures/testfeature.siteprl.xml"/>
    <webfeature hidden="true" name="insecure_interface" title="WH testsuite: Unprotected WebHare backend" siteprofile="webfeatures/insecure_interface.siteprl.xml"/>
    <webfeature hidden="true" name="siteprl_datastorage" title="WH testsuite: siteprl_datastorage" siteprofile="webfeatures/siteprl_datastorage.siteprl.xml"/>
    <webfeature hidden="true" name="siteprl_datastorage2" title="WH testsuite: siteprl_datastorage2" siteprofile="webfeatures/siteprl_datastorage2.siteprl.xml"/>
    <webfeature hidden="true" name="conversionstest" title="WH testsuite: conversionstest" siteprofile="webfeatures/conversionstest.siteprl.xml"/>
    <webfeature hidden="true" name="actions" title="WH testsuite: actions" siteprofile="webfeatures/actions.siteprl.xml"/>
    <webfeature hidden="true" name="versioned" title="WH testsuite: versioned" siteprofile="webfeatures/versioned.siteprl.xml"/>
    <webfeature name="unusedfeature"
                hidden="true"
                siteprofile="webfeatures/neverused_feature.siteprl.xml"
                title="WH testsuite: never used feature" />

    <customnode name="test" namespace="urn:xyz" />
    <customnode name="blub" namespace="http://www.webhare.net/xmlns/webhare_testsuite/blub" />
    <webdesignplugin name="test" namespace="http://www.webhare.net/xmlns/webhare_testsuite" objectname="mod::webhare_testsuite/lib/internal/testplugin.whlib#TestPlugin" hooksfeatures="preparemail" />

    <filemgrextension>
      <accesscheck>
        <requireright right="system:sysop"/>
      </accesscheck>
      <addaction tid="module.testaction" screen="feedback.frompublisher" addtomenu="actions" />
    </filemgrextension>

    <indexfield name="contenttypefield" namespace="http://www.webhare.net/xmlns/webhare_testsuite/publisher/publishersearchtest" member="testfield" />
    <indexfield name="libraryfield" fieldfunc="lib/publisher/publishersearch.whlib#gettestfield" />
    <indexfield name="arrayfield" namespace="http://www.webhare.net/xmlns/webhare_testsuite/publisher/publishersearchtest" member="testarray">
      <arrayfield member="arrayfield" />
      <arrayfield name="date_otherfield" member="otherfield" />
      <arrayfield name="libraryfield" fieldfunc="lib/publisher/publishersearch.whlib#getarrayfield" />
    </indexfield>

    <formcomponents namespace="http://www.webhare.net/xmlns/webhare_testsuite/testformcomponents" xmlschema="tests/publisher/forms/data/testformcomponents.xsd"/>

    <registerslot name="testsite" tid="module.testsite.title" descriptiontid="module.testsite.description" initialvalue="site::webhare_testsuite.testsite" type="site" />
    <registerslot name="testslot" title="Test Slot" description="Test Description" initialvalue="whfs::/webhare-tests/webhare_testsuite.testfolder/testslot" type="folder" fallback="whfs::/webhare-tests/webhare_testsuite.testfolder/testslot-fallback"/>

    <searchcontentprovider name="testprovider" objectname="lib/publisher/publishersearch.whlib#testprovider" version="1.0.0" />
    <shorturls domain="test2.bea.gl" urllisthook="tests/publisher/shorturl/shorturltests.whlib#HookURLList" urlpropsextension="tests/publisher/shorturl/shorturltests.xml#ExtendURLProps" />
  </publisher>

  <consilio>
    <!-- modern syntax -->
    <catalog tag="testsitecatalog" ongetsources="lib/consilio/sources.whlib#GetTestSiteCatalogSources" priority="9" fieldgroups="pagelistfields">
      <customsource tag="loremindex" contentobject="lib/consilio/loremindex.whlib#IndexLibrary"  />
      <customsource tag="dbindex" contentobject="lib/consilio/dbindex.whlib#DBContent"  />
    </catalog>

    <fieldgroup tag="pagelistfields">
      <text name="myfield1" />
      <integer name="fieldgroup_integer" />
      <integer64 name="fieldgroup_integer64" />
      <float name="fieldgroup_float" />
      <boolean name="fieldgroup_boolean" />
      <datetime name="fieldgroup_datetime" />
    </fieldgroup>

    <!-- legacy syntax -->
    <catalog tag="testindex" fieldgroups="testindexfields" lang="nl" managed="false" />
    <catalog tag="testindex_suffixed" fieldgroups="testindexfields" lang="nl" managed="false" suffixed="true" />

    <fieldgroup tag="testindexfields">
      <datetime name="@timestamp" />
      <text name="title" />
      <keyword name="keyword" />
      <text name="body">
        <keyword name="body_keyword" ignore_above="256" />
      </text>
      <integer name="int_field" />
      <integer64 name="int64_field" />
      <float name="float_field" />
      <datetime name="date_field" />
      <boolean name="bool_field" />
      <record name="unspecified_record" />
      <record name="record_field" strict="false">
        <text name="record_text_field" />
        <integer name="dn_*" />
      </record>
      <ipaddress name="ip_field" />
      <latlng name="latlng_field" />
      <addfieldgroup ref="testgroup" />
    </fieldgroup>
    <fieldgroup tag="testgroup">
      <integer name="group_int_field" />
      <record name="group_record_field" strict="false">
        <text name="group_record_text_field" />
        <keyword name="ds_*" />
        <addfieldgroup ref="webhare_testsuite:testsubgroup" />
      </record>
    </fieldgroup>
    <fieldgroup tag="testsubgroup">
      <datetime name="when" />
      <latlng name="where" />
      <boolean name="db_*" />
    </fieldgroup>

    <catalog tag="module_reference" managed="false" fieldgroups="consilio:test_reference_group" />

    <fieldgroup tag="test_reference_group">
      <text name="testsuite" />
    </fieldgroup>

    <catalog tag="circular_module_reference" managed="false" fieldgroups="consilio:circular_test_reference_group" />
    <fieldgroup tag="circular_test_reference_group">
      <addfieldgroup ref="consilio:circular_test_reference_group" />
    </fieldgroup>

    <catalog tag="duplicate_fieldnames" managed="false" fieldgroups="fields_1 fields_2" />
    <fieldgroup tag="fields_1">
      <text name="textfield" />
    </fieldgroup>
    <fieldgroup tag="fields_2">
      <text name="textfield" />
    </fieldgroup>

    <catalog tag="circular_index_direct" managed="false" fieldgroups="circular" />
    <fieldgroup tag="circular">
      <addfieldgroup ref="circular" />
    </fieldgroup>

    <catalog tag="circular_index_indirect" managed="false" fieldgroups="circular_1" />
    <fieldgroup tag="circular_1">
      <record name="record_1">
        <addfieldgroup ref="circular_2" />
      </record>
    </fieldgroup>
    <fieldgroup tag="circular_2">
      <record name="record_2">
        <addfieldgroup ref="circular_1" />
      </record>
    </fieldgroup>

    <fieldgroup tag="nosuchfieldyet">
      <record name="no">
        <record name="such">
          <record name="field">
            <integer name="yet"/>
          </record>
        </record>
      </record>
    </fieldgroup>

    <fieldgroup tag="unspecifiedwildcards">
      <record name="unspecified_record" strict="false" />
    </fieldgroup>

    <fieldgroup tag="storeonly">
      <keyword name="indexed" ignore_above="16" />
      <keyword name="stored" ignore_above="16" storeonly="true" />
    </fieldgroup>

    <fieldgroup tag="extrafield">
      <text name="extrafield" />
    </fieldgroup>

    <addtowhfsindex privatefolder="addtowhfsindex/aftersites" priority="aftersites" />
    <addtowhfsindex privatefolder="addtowhfsindex/beforerepository" priority="beforerepository" />
    <addtowhfsindex privatefolder="addtowhfsindex/beforesites" priority="beforesites" />
    <addtowhfsindex privatefolder="addtowhfsindex/anywhere" />
  </consilio>

  <hooking>
    <target name="siteprofilehook" />
  </hooking>

</module>
