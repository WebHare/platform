<?wh

/** @topic file-formats/archives
    @public
*/

LOADLIB "wh::files.whlib";
LOADLIB "wh::internal/interface.whlib" EXPORT CreateZlibCompressor, CloseZlibCompressor, OpenBlobAsDecompressingStream, CloseZlibDecompressor;

/** Compress a blob using zlib deflate
    @param infile Data to compress
    @param format Compression format
      - GZIP: Add gzip heaaders to compressed file
      - ZLIBRAW, ZIP: compress the file, do not add headers
    @param Compression level (1-9)
    @return Compressed data
*/
PUBLIC BLOB FUNCTION MakeZlibCompressedFile(BLOB infile, STRING format, INTEGER compressionlevel)
{
  INTEGER outfile := CreateStream();
  INTEGER compressor := CreateZlibCompressor(outfile, format, compressionlevel);
  SendBlobTo(compressor, infile);
  CloseZlibCompressor(compressor);
  RETURN MakeBlobFromStream(outfile);
}

/** Decompress a blob that was compressed with zlib deflate
    @param infile Data to decompress
    @param format Compression format
      - ZLIB: With zlib header
      - GZIP: With gzip headers
      - ZLIBRAW Zlib raw data, decode whole blob
      - ZLIBRAW:<length>: Zlib raw data, decode max length bytes
    @return Decompressed data
*/
PUBLIC BLOB FUNCTION MakeZlibDecompressedFile(BLOB infile, STRING format)
{
  INTEGER outfile := CreateStream();
  INTEGER decompressor := OpenBlobAsDecompressingStream(infile, format);
  INTEGER64 todo := LENGTH64(infile);
  WHILE(TRUE)
  {
    STRING block := ReadFrom(decompressor,16384);
    IF(block="")
      BREAK;
    PrintTo(outfile,block);
    todo := todo - LENGTH(block);
  }
  CloseZlibDecompressor(decompressor);
  RETURN MakeBlobFromStream(outfile);
}
