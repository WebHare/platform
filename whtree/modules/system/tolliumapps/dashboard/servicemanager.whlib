<?wh
LOADLIB "mod::system/lib/screenbase.whlib";

LOADLIB "mod::system/lib/services.whlib";
LOADLIB "mod::system/lib/internal/services/apprunner.whlib";

/////////////////////////////////////////////////////////////////////
//
// Service Manager (AppRunner controller)
//
PUBLIC STATIC OBJECTTYPE ServiceManager EXTEND DashboardPanelBase
<
  UPDATE PUBLIC INTEGER FUNCTION GetSuggestedRefreshFrequency()
  {
    RETURN 0;
  }
  /** @short This monitor has been activated, start refreshing */
  UPDATE PUBLIC MACRO EnableRefresh()
  {
    ^listener->enabled := TRUE;
  }
  /** @short This monitor has been deactivated, stop refreshing */
  UPDATE PUBLIC MACRO DisableRefresh()
  {
    ^listener->enabled := FALSE;
  }

  UPDATE MACRO OnMessage(RECORD msg)
  {
    IF (CellExists(msg, "service"))
      ^applit->value := msg.service;
  }

  MACRO OnAppRunnerRefreshEvent(RECORD ARRAY events)
  {
    this->RefreshDashboardPanel();
  }

  UPDATE PUBLIC MACRO RefreshDashboardPanel()
  {
    TRY
    {
      ^applist->rows :=
            SELECT rowkey := name
                 , icon :=      NOT enabled
                                    ? 3 // not enabled
                                    : running
                                          ? runatsoftreset
                                                ? 4 // neutral (task running)
                                                : 1 // checked (running now)
                                          : runatsoftreset
                                                ? lasterror IN [ "Terminated", "" ]
                                                      ? 1 // checked, should not be running
                                                      : 2
                                                : 2 // terminated
                 , type :=      runatsoftreset
                                    ? this->GetTid(".ondemand")
                                    : this->GetTid(".persistent")
                 , status :=    running
                                    ? this->GetTid(".running")
                                    : lasterror IN [ "", "Terminated" ] AND runatsoftreset
                                          ? this->GetTid(".inactive")
                                          : this->GetTid(".notrunning")
                 , since
                 , lasterror    := lasterror = "Terminated" AND runatsoftreset ? "" : lasterror
                 , regkey
                 , canedit :=   regkey != ""
                 , enabled
              FROM ListRunningServices()
          ORDER BY name;

      ^applist->empty := ""; //this is currently not happening in practice, so no need to provide a "there are no processes configured" text
    }
    CATCH(OBJECT e)
    {
      ^applist->empty := this->GetTid(".apprunnerdown");
      ^applist->rows := DEFAULT RECORD ARRAY;
    }
  }

  MACRO DoRestart()
  {
    STRING appname := ^applist->value;
    TRY
    {
      OBJECT link := WaitForPromise(OpenWebHareService("system:apprunner"));
      WaitForPromise(link->Restart(appname));
      link->CloseService();
    }
    CATCH(OBJECT e)
    {
      this->RunSimpleScreen("error", this->GetTid(".restartfailed", appname));
    }
  }
  MACRO SetEnabled(STRING appname, BOOLEAN doenable)
  {
    TRY
    {
      OBJECT link := WaitForPromise(OpenWebHareService("system:apprunner"));
      RECORD response := WaitForPromise(link->SetEnabled(appname, doenable));
      link->CloseService();
    }
    CATCH(OBJECT e)
    {
    }
  }

  MACRO DoEnable()
  {
    this->SetEnabled(^applist->value, TRUE);
  }

  MACRO DoDisable()
  {
    this->SetEnabled(^applist->value, FALSE);
  }
>;
