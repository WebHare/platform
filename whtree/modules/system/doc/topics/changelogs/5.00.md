# 5.0 - Current master

PLEASE NOTE! YOU NEED TO UPGRADE TO 4.35 BEFORE UPGRADING TO 5.0

## Incompatibilities and deprecations
- The `dbserver` (whdb, WebHareDB) has been removed
- `system.fs_instances.id`, `system.fs_settings.id` and `wrd.entity_settings.id` and any referring columns are now `INTEGER64`s
- Deprecations/removals that a dev:rewrite will fix for you:
  - Support for the `lib=` attribute a `<tolliumcomponent>` has been removed. Merge it into the `objecttype=`
- Support for manually configured scheduler tasks has been removed. You should use `<task>`s in moduledefinitions.
- `<authenticationsettings requireauthorization=false>` has been removed. It wasn't properly parsed from the XML anyway
  and is only acting as the inverse of the `managementmode` property.
- Support for `<undoextendproperties>` has been removed. It has already been broken for a while.
- You can no longer manage WRD schema metadata through the legacy objectapi.whlib
- Support for the Tollium `rowselect` and `border` attributes has been removed in both XML and HareScript (this does not
  affect the newer `borders` attribute that replaced `border` in WebHare 4.03)
- Support for the WebHare dev-agent (formerly Connect-helper) has been completely removed. You can use `wh dev:mount` now
  to mount a remote WebHare server using WebDav once you've setup a peering connection. "Open in editor" now requires an
  editor supporting LSP (Language Server Protocol)
- NPM v7 restored automatic installation of per dependencies, even if not explicitly selected. We now explicitly disable
  that again for modules.
- Support for `beforeversion=` and `requireversion=` applicability checks have been removed - use `webhareversion=` with
  semver-based checks (available since 4.27)
- `TestThrows` has been removed
- Support for `role` and `grant` in the moduledefinition `<databaseschema>` has been removed. They were never supported by our
  PostgreSQL integration and only used with the legacy WHDB (dbserver) database.
- All public functions in `mod::consilio/lib/catalog.whlib`, `mod::consilio/lib/queries.whlib` and `mod::consilio/lib/queuemgmt.whlib`
  have now been deprecated, use the equivalent functions in `mod::consilio/lib/api.whlib` instead.
- The search libraries now support more field types. All fields will be returned in the type that they are specified in the
  mapping/empty search record, so manual conversion of search result fields shouldn't be necessary anymore. Please note that
  legacy Consilio indices don't support `MONEY`/`MONEY ARRAY`, `FLOAT`/`FLOAT ARRAY`, `BOOLEAN`/`BOOLEAN ARRAY` or `DATETIME
  ARRAY` queries or relative `INTEGER`/`INTEGER64` queries (matchtypes `<`, `<=`, `>` and `>=`) and only legacy Consilio
  indices require `DATETIME` fields to be prefixed with `date_`.
- Custom fields that are indexed using `<meta name="consilio-[name]" value="[value]" />` must be specified in the catalog
  definition before they can be indexed by Opensearch. Support for INTEGER less/greater than queries for Consilio is dropped,
  as it didn't work as intended anyway.
- User queries in Opensearch are parsed in Opensearch itself instead of within HareScript, using a `simple_query_string` query.
  This query format this query type uses is basically the same as HareScript's QueryParser uses, so the results should be the
  same. For more complex user queries, the results might differ a bit, so please use the `CQ*` functions to construct a search
  query instead of constructing a query string programmatically.
- For Opensearch catalogs, the `thesaurusid` setting is deprecated in favor of a simple `synonyms` settings which determines
  if the synonyms list of the searched catalog should be used or not.
- The `analyzer`, `search_analyzer` and `search_quote_analyzer` content source field settings are deprecated. For language-
  specific analysis functions, set the catalog language using `<catalog lang="...">` or `UpdateCatalog([ lang := "..." ])`.
  Please note that changing a catalog's language requires the catalog to be rebuilt completely (to reindex all documents
  using the new language's analysis functionality)!
- Support for `editfragment` and `editscreen` widget editors have been removed. `wh dev:rewrite` should be able to help rewrite
  any remaining uses. (The alternative `editextension=` is available since 4.27)
- Users now need to be explicitly granted the system:webdav right to be able to use WebDav URLs. Most users will never need it

## Things that are nice to know
- `<windowopenaction>` now has a `link=` parameter which you can use if the link is hardcoded anyway (no need for a callback)
- The 'Send results by email' form handler will set the Reply-To to the recipient address if not otherwise set
- Dashboard panels can now have individual access checks.
- %TestThrowsLike and %TestRejectedLike now match their exceptions case-insensitively
- The new language construct `FOREVERY [ AWAIT ] (variable YIELD FROM iterator)` has been added, to quickly get
  the values returned by an iterator
- Adds `http://www.webhare.net/xmlns/publisher/widgets/wittyblock` and `http://www.webhare.net/xmlns/publisher/widgets/wittyinline`
  widgets to allow users to directly insert witty objects into RTDs. (Use with care!)
- You can set the mask parameter of `TestThrowsLike` to `REPORT` to get a print of the exception.
  - Replacing all `TestThrows(` calls with `TestThrowsLike("REPORT", ` is a quick way to get a list of all exceptions in a
    test so you can then simply copy them into the test code.
- WRD has a new type, WHFSLINK, which stores links to files in WHFS (useful you don't want WHFSINTEXTLINKs ability to store external links too)
- Frontend support for the Tollium GetExclusiveAccess screen has been added
- `wh sql` now has a `-r` (raw) option to simply print the results
- You can use %IsProductionOrAsIf to guard a workflows/dialog which you need to be able to simulate during development
- Adds a "contains widget" search filter to the Publisher search

## Things you should do
- Use the functions from `mod::consilio/lib/api.whlib` instead of those from `mod::consilio/lib/catalog.whlib`,
  `mod::consilio/lib/queries.whlib` and `mod::consilio/lib/queuemgmt.whlib`
- All indexed fields are returned in the type specified in the mapping/empty search record, so any code that does conversion
  of field types in search results should be removed if the expected type is not `STRING`.
- Remove analyzer settings of content source fields and replace language-specific settings with setting the `lang` attribute
  of the `<catalog>` node.
