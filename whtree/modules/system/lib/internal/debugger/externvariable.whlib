<?wh

LOADLIB "wh::crypto.whlib";
LOADLIB "wh::datetime.whlib";
LOADLIB "wh::float.whlib";
LOADLIB "wh::money.whlib";


PUBLIC STATIC OBJECTTYPE ExternVariable
< OBJECT inspector;
  STRING lastrowkey;
  OBJECT ARRAY elts;
  STRING pvt_encoding;

  PUBLIC STRING name;
  PUBLIC STRING sortkey;
  PUBLIC RECORD result;
  PUBLIC PROPERTY encoding(pvt_encoding, SetEncoding);

  MACRO NEW(OBJECT inspector, STRING name, STRING sortkey)
  {
    this->inspector := inspector;
    this->name := name;
    this->sortkey := sortkey;
  }

  MACRO SetEncoding(STRING newencoding)
  {
    this->pvt_encoding := newencoding;
    this->inspector->RenderTree(this->lastrowkey);
  }

  PUBLIC MACRO GetData(RECORD options)
  {
    IF (NOT ObjectExists(this->inspector))
      THROW NEW Exception("Cannot get data without an inspector");

    RECORD request :=
        [ id := this->result.id
        , vm := this->inspector->vm
        ];

    IF (CellExists(options, "GETALL") AND options.getall)
    {
      IF (CellExists(this->result, "LENGTH"))
        INSERT CELL max := this->result.length INTO request;
    }

    OBJECT req := this->inspector->job->GetVariables([ request ]);
    req->Then(PTR this->HandleGetResult);
  }

  MACRO HandleGetResult(RECORD data)
  {
    this->result := data.variables[0];
    this->HandleValue(data.variables[0], TRUE);
    this->inspector->RenderTree(this->lastrowkey);
  }

  PUBLIC MACRO HandleValue(RECORD value, BOOLEAN keeptree)
  {
    this->result := value;
    IF (NOT keeptree)
      RETURN;

    IF (this->result.type IN [ TypeID(RECORD), TypeID(OBJECT), TypeID(WEAKOBJECT) ])
    {
      FOR (INTEGER i := 0; i < this->result.max; i := i + 1)
      {
        OBJECT elt;
        IF (i < LENGTH(this->elts))
          elt := this->elts[i];

        IF (NOT ObjectExists(elt))
          elt := NEW ExternVariable(this->inspector, "[" || i || "]", Right("0000000" || i, 8));

        RECORD result;
        IF (i >= this->result.min)
        {
          result := this->result.value[INTEGER(i - this->result.min)];
          IF (RecordExists(result)) // Not always for object members!
          {
            elt->name := result.name;
            elt->sortkey := result.name;
            elt->HandleValue(result.value, TRUE);
          }
          ELSE
            elt->HandleValue([ type := -3 ], TRUE);
        }

        IF (LENGTH(this->elts) <= i)
          INSERT elt INTO this->elts AT END;
        ELSE
          this->elts[i] := elt;
      }
    }

    IF (this->result.type >= 128)
    {
      FOR (INTEGER i := 0; i < this->result.max; i := i + 1)
      {
        OBJECT elt;
        IF (i < LENGTH(this->elts))
          elt := this->elts[i];

        IF (NOT ObjectExists(elt))
          elt := NEW ExternVariable(this->inspector, "[" || i || "]", Right("0000000" || i, 8));

        RECORD result;
        IF (i >= this->result.min)
        {
          result := this->result.value[INTEGER(i - this->result.min)];
          elt->HandleValue(result, TRUE);
        }

        IF (LENGTH(this->elts) <= i)
          INSERT elt INTO this->elts AT END;
        ELSE
          this->elts[i] := elt;
      }
    }
  }

  PUBLIC RECORD FUNCTION Render(STRING rowkey)
  {
    RECORD retval :=
        [ row :=
              [ rowkey :=   rowkey
              , name :=     this->name
              , sortkey :=  this->sortkey
              , value :=    "(retrieving)"
              , expanded := FALSE
              , subnodes := DEFAULT RECORD ARRAY
              , obj :=      this
              , canretrievefull := FALSE
              , cantoggleencoding := FALSE
              , canshowtext := FALSE
              , candownload := FALSE
              ]
        ];

    this->lastrowkey := rowkey;

    IF (NOT RecordExists(this->result))
      RETURN retval;

    SWITCH (this->result.type)
    {
      CASE -3
      {
        retval.row.value := "<object context>";
      }
      CASE -2
      {
        retval.row.value := "<requesting>";
      }
      CASE -1
      {
        retval.row.value := "<invalid request>";
      }
      CASE 0
      {
        retval.row.value := "<optimized away>";
      }
      CASE TypeID(BOOLEAN)
      {
        retval.row.value := this->result.value ? "TRUE" : "FALSE";
      }
      CASE TypeID(INTEGER), TypeID(INTEGER64)
      {
        retval.row.value := ToString(this->result.value);
      }
      CASE TypeID(STRING)
      {
        STRING encoded;
        IF (this->pvt_encoding = "base16")
          retval.row.value := "B16:" || EncodeBase16(this->result.value) || (this->result.max != this->result.length ? "..." : "");
        ELSE
          retval.row.value := '"' || EncodeJava(this->result.value) || (this->result.max != this->result.length ? "..." : "") || '"';
        retval.row.cantoggleencoding := TRUE;
        IF (this->result.length = this->result.max)
          retval.row.canshowtext := TRUE;
        ELSE
          retval.row.canretrievefull := TRUE;
      }
      CASE TypeID(MONEY)
      {
        retval.row.value := FormatMoney(this->result.value, 1, ".", "", FALSE);
      }
      CASE TypeID(FLOAT)
      {
        retval.row.value := FormatFloat(this->result.value, 20);
      }
      CASE TypeID(BLOB)
      {
        IF (this->result.length = 0)
          retval.row.value := "DEFAULT BLOB";
        ELSE IF (this->result.length != this->result.max)
        {
          retval.row.canretrievefull := TRUE;
          retval.row.value := "BLOB (length: " || this->result.length || " bytes)";
        }
        ELSE
        {
          STRING sha1hash := GetHashForString(this->result.value, "SHA-1");
          IF (this->result.max != this->result.length)
            retval.row.value := "BLOB (length: " || this->result.length || " bytes, got " || this->result.max || " bytes";
          ELSE
            retval.row.value := "BLOB (length: " || this->result.length || " bytes, SHA1: " || EncodeUFS(sha1hash) || " / " || EncodeBase16(sha1hash) || ")";
          retval.row.candownload := TRUE;
          retval.row.canshowtext := TRUE;
        }
      }
      CASE TypeID(DATETIME)
      {
        retval.row.value := this->result.value = MAX_DATETIME
            ? "MAX_DATETIME"
            : FormatISO8601DateTime(this->result.value, "", "", "", TRUE) ?? (this->result.value = DEFAULT DATETIME
                ? "DEFAULT DATETIME"
                : GetDayCount(this->result.value) || "T" || FormatDateTime("%H:%M:%S.%Q", this->result.value));
      }
      CASE TypeID(RECORD)
      {
        IF (NOT this->result.exists)
          retval.row.value := "DEFAULT RECORD";
        ELSE IF (this->result.length = 0)
          retval.row.value := "EMPTY RECORD";
        ELSE
        {
          IF (this->result.length != this->result.max)
          {
            retval.row.value := "RECORD (" || this->result.length || " cells, " || this->result.max || " shown)";
            retval.row.canretrievefull := TRUE;
          }
          ELSE
            retval.row.value := "RECORD (" || this->result.length || " cells)";
        }

        FOREVERY (OBJECT o FROM this->elts)
          INSERT o->Render(rowkey || "\t" || EncodeJava(o->name)).row INTO retval.row.subnodes AT END;
      }
      CASE TypeID(OBJECT), TypeID(WEAKOBJECT)
      {
        STRING name := GetTypeName(this->result.type);
        IF (NOT this->result.exists)
          retval.row.value := "DEFAULT " || name;
        ELSE
        {
          name := name || " #" || this->result.objectid || " (" || Detokenize(this->result.objecttypes, ", ") || ")";
          IF (this->result.length != this->result.max)
          {
            retval.row.value := name || " (" || this->result.length || " cells, " || this->result.max || " shown)";
            retval.row.canretrievefull := TRUE;
          }
          ELSE
            retval.row.value := name || " (" || this->result.length || " cells)";
        }

        FOREVERY (OBJECT o FROM this->elts)
          INSERT o->Render(rowkey || "\t" || EncodeJava(o->name)).row INTO retval.row.subnodes AT END;
      }

      DEFAULT
      {
        retval.row.value := GetTypeName(this->result.type);

        IF (this->result.type >= 128)
        {
          IF (this->result.length != this->result.max)
          {
            retval.row.value := retval.row.value || " (" || this->result.length || " items, " || this->result.max || " shown)";
            retval.row.canretrievefull := TRUE;
          }
          ELSE
            retval.row.value := retval.row.value || " (" || this->result.length || " items)";

          FOREVERY (OBJECT o FROM this->elts)
            INSERT o->Render(rowkey || "\t[" || #o || "]").row INTO retval.row.subnodes AT END;
        }
      }
    }
    RETURN retval;
  }
>;

