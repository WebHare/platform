<?wh
LOADLIB "mod::tollium/lib/internal/gettid.whlib";

PUBLIC RECORD ARRAY captured_tids;

MACRO OnTid(STRING resourcename, RECORD tiddata)
{
  tiddata := CELL [ resourcename, ...tiddata ];
  INSERT tiddata INTO captured_tids AT END;
}

PUBLIC RECORD FUNCTION RunAndExtractTids(STRING resourcename, FUNCTION PTR tocall)
{
  RECORD ARRAY save_captured_tids := captured_tids;
  MACRO PTR save_capture := onparsedtid;
  TRY
  {
    captured_tids := RECORD[];
    onparsedtid := PTR OnTid(resourcename, #1);

    VARIANT result := tocall();
    RETURN [ tids := captured_tids
           , returnvalue := result
           ];
  }
  FINALLY
  {
    captured_tids := save_captured_tids;
    onparsedtid := save_capture;
  }
}
