<?wh

LOADLIB "wh::files.whlib";
LOADLIB "wh::internet/urls.whlib";
LOADLIB "wh::util/algorithms.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/webserver/configure.whlib";

// Update the public configuration data

RECORD FUNCTION GeneratePublicConfig()
{
  STRING ARRAY interfaces := GetSortedSet(SELECT AS STRING ARRAY UnpackURL(baseurl).origin FROM ListWebservers() WHERE interface);
  RETURN CELL[ interfaces ];
}

PUBLIC MACRO UpdatePublicConfig()
{
  RECORD currentconfig := GeneratePublicConfig();

  //ensure our storage dir exists
  STRING targetdir := MergePath(GetModuleStorageRoot("system"),"js");
  CreateDiskDirectoryRecursive(targetdir,TRUE);

  STRING publicconfigfile := MergePath(targetdir, "publicconfig.json");
  STRING expectedcontent := EncodeJSON(currentconfig);
  IF(BlobToString(GetDiskResource(publicconfigfile, [allowmissing := TRUE])) != expectedcontent)
    StoreDiskFile(publicconfigfile, StringToBlob(expectedcontent), [ overwrite := TRUE ]);

  //we expect disk watching to pick this up where needed
}
