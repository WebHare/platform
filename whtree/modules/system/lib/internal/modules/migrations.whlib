<?wh
//Migrations and runonce

LOADLIB "mod::system/lib/internal/resources.whlib";

CONSTANT STRING ARRAY whens :=
        [ "afterschemacreation"
        , "aftertablesbeforerights"
        , "aftertablecreation"
        , "afterregistryupdate"
        , "poststart"
        ];

RECORD ARRAY FUNCTION ParseModuleDefRunonceModuleDef(OBJECT doc)
{
  INTEGER last_runonce_whentype;
  RECORD ARRAY scripts;

  FOREVERY(OBJECT runonce FROM doc->xml->ListElements("http://www.webhare.net/xmlns/system/moduledefinition","runonce"))
  {
    STRING when := runonce->GetAttribute("when") ?? "aftertablecreation";

    // Check ordering
    INTEGER when_type := SearchElement(whens, when);
    IF (when_type = -1)
    {
      doc->AddError(runonce, "Unknown runonce script ordering, got '" || when || "'");
    }
    ELSE IF (last_runonce_whentype > when_type)
    {
      doc->AddError(runonce, "Illegal runonce script ordering, found '" || whens[when_type] || "' after a '" || whens[last_runonce_whentype] || "'");
      last_runonce_whentype := -1;
    }
    ELSE IF (last_runonce_whentype != -1)
      last_runonce_whentype := when_type;

    IF(runonce->HasAttribute("at"))
      doc->AddError(runonce, "Support for at=install or at=upgrade has been removed in WebHare 4.19");

    INSERT
      [ tag    := doc->GetModuleName() || ":" || runonce->GetAttribute("tag")
      , script := doc->GetVerifyPath(runonce, "script", MakeAbsoluteResourcePath(doc->respath,"scripts/"), [ warnversion := 42300 ])
      , when   := when
      ] INTO scripts AT END;
   }

   RETURN scripts;
}

PUBLIC RECORD ARRAY FUNCTION ParseModuleDefRunonce(OBJECT doc)
{
  RETURN ParseModuleDefRunonceModuleDef(doc);
}
