<?wh
LOADLIB "wh::util/algorithms.whlib";
LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/internal/rightsmgmt.whlib";
LOADLIB "mod::system/lib/internal/backend/users.whlib";

RECORD FUNCTION GetAuthObjectById(RECORD ARRAY allobjs, INTEGER authobjectid)
{
  RECORD authobjectpos := RecordLowerBound(allobjs, [ id := authobjectid ], ["ID"]);
  IF(NOT authobjectpos.found)
    RETURN DEFAULT RECORD;
  RETURN allobjs[authobjectpos.position];
}

RECORD FUNCTION GetGrantee(RECORD ARRAY allusers, RECORD ARRAY allroles, RECORD ARRAY allobjs, INTEGER authobjectid)
{
  RECORD authobject := GetAuthObjectById(allobjs, authobjectid);
  IF(NOT RecordExists(authobject))
    RETURN DEFAULT RECORD;

  RECORD userobjpos := RecordLowerBound(allusers, [ guid := authobject.guid ], [ "GUID" ]);
  IF(userobjpos.found)
  {
    RECORD userrec := allusers[userobjpos.position];
    RETURN CELL[ login := authobject.name
               , userrec.active
               , userrec.fullname
               , userrec.email
               , authobject.unitid
               , authobject.unitname
               ];
  }

  RECORD roleobjpos := RecordLowerBound(allroles, [ wrd_guid := authobject.guid ], [ "WRD_GUID" ]);
  IF(roleobjpos.found)
  {
    RECORD rolerec := allroles[roleobjpos.position];
    RETURN CELL[ login := rolerec.wrd_title
               , active := TRUE
               , fullname := ""
               , email := ""
               , authobject.unitid
               , authobject.unitname
               ];
  }

  RETURN DEFAULT RECORD;
}

STRING FUNCTION GetGrantor(RECORD ARRAY allobjs, RECORD grant, RECORD grantordata)
{
  RECORD grantorrec;
  IF(grant.grantor = grant.grantee) //self grant!
    RETURN ""; //dont report a user with these, we want them to stand out

  IF(grant.grantor != 0 AND grant.grantor != grant.grantee)
  {
    grantorrec := GetAuthObjectById(allobjs, grant.grantor);
    IF(RecordExists(grantorrec))
      RETURN grantorrec.name ?? grantorrec.guid;
  }

  //TODO present data from grantordata, but need testcases
  RETURN "#" || grant.grantor;
}

PUBLIC RECORD ARRAY FUNCTION EnrichWithGrantorAndGrantee(OBJECT userapi, RECORD ARRAY rightslist)
{
  RECORD ARRAY allusers :=
      SELECT *
           , active :=    whuser_disable_type = ""
           , DELETE whuser_disable_type
        FROM userapi->accounttype->RunQuery(
                  [ outputcolumns :=
                        [ id :=         "WRD_ID"
                        , fullname :=   "WRD_TITLE"
                        , login :=      userapi->wrdschema->accountlogintag
                        , email :=      userapi->wrdschema->accountemailtag
                        , guid  :=      "WRD_GUID"
                        , whuser_disable_type := "WHUSER_DISABLE_TYPE"
                        ]
                  ]) AS row
    ORDER BY guid;

  RECORD ARRAY allroles :=
      SELECT *
           , active :=    TRUE
        FROM userapi->wrdschema->^whuser_role->RunQuery(
            [ outputcolumns := CELL[ "WRD_GUID", "WRD_TITLE" ]
            ])
    ORDER BY wrd_guid;

  RECORD ARRAY allobjs := SELECT authobjects.id
                               , authobjects.name
                               , authobjects.guid
                               , unitid := units.id
                               , unitname := units.name
                            FROM system.authobjects, system.authobjects as units
                           WHERE units.id = authobjects.parent
                        ORDER BY authobjects.id;

  RECORD ARRAY finallist;
  FOREVERY(RECORD grant FROM rightslist)
  {
    RECORD granteerec := GetGrantee(allusers, allroles, allobjs, grant.grantee);
    IF(NOT RecordExists(granteerec))
      CONTINUE;

    STRING grantor := GetGrantor(allobjs, grant, grant.grantordata);

    INSERT CELL[...grant, ...granteerec, grantor ] INTO finallist AT END;
  }

  RETURN finallist;
}

//NOTE: userapi should now only be enabled for schemas depending on usermgmt
PUBLIC RECORD ARRAY FUNCTION ListRightsAndRolesForExport(OBJECT userapi)
{
  RECORD ARRAY allroleobjs := SELECT authobjects.id
                                   , authobjects.name
                                   , authobjects.guid
                                   , unitid := units.id
                                   , unitname := units.name
                                FROM system.authobjects, system.authobjects as units
                               WHERE units.id = authobjects.parent
                                     AND authobjects.type = 3 //user role
                            ORDER BY authobjects.id;

  RECORD ARRAY allrights := GetListOfRights();
  GetPrimary()->BeginWork();
  OBJECT user := EnsureCreatedMagicSysop("<overrideuser>");
  GetPrimary()->CommitWork();

  RECORD ARRAY allrows;

  //Gather the rights
  FOREVERY(RECORD r FROM allrights)
  {
    RECORD ARRAY grants := GetDirectGrantsForRight(r.rightname);
    FOREVERY(RECORD grant FROM grants)
    {
      STRING objecttypename;
      INTEGER objectid;
      STRING ARRAY objectpath;

      IF(NOT r.isglobal)
      {
        RECORD pathrec := user->GetObjectPath(r.objecttypename, grant."object");
        IF (NOT RecordExists(pathrec) OR NOT pathrec.visible)
          CONTINUE;

        objecttypename := r.objecttypename;
        objectid := grant."object";
        objectpath := SELECT AS STRING ARRAY name FROM pathrec.path WHERE id != 0;
      }

      INSERT CELL[ ...grant
                 , type := "GRANT"
                 , r.rightname
                 , objecttypename
                 , objectid
                 , objectpath
                 ] INTO allrows AT END;
    }
  }

  //Gather the role grants
  RECORD ARRAY rolegrants := SELECT * FROM system.rolegrants;
  rolegrants := userapi->EnrichRoles("role", rolegrants, [ celltype := "authobjectid" ]); //enrich to kick out roles that don't exist in our userapi view
  rolegrants := SELECT *, grantordata := grantordata != "" ? DecodeHSON(grantordata) : DEFAULT RECORD FROM rolegrants;

  FOREVERY(RECORD grant FROM rolegrants)
  {
    RECORD roleinfo := GetAuthObjectById(allroleobjs, grant.role);
    IF(NOT RecordExists(roleinfo))
      CONTINUE;

    INSERT CELL[ ...grant
               , type := "ROLEGRANT"
               , rightname := ""
               , withgrantoption := FALSE
               , objecttypename := "role"
               , objectid := roleinfo.id
               //FIXME show full role path
               , objectpath := STRING[roleinfo.name]
               ] INTO allrows AT END;
  }

  allrows := EnrichWithGrantorAndGrantee(userapi, allrows);

  RETURN allrows;
}
