<?wh
/** Consilio Search Service
*/

LOADLIB "wh::adhoccache.whlib";
LOADLIB "wh::datetime.whlib";
LOADLIB "wh::ipc.whlib";
LOADLIB "wh::util/langspecific.whlib";

LOADLIB "mod::consilio/lib/search.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/logging.whlib";
LOADLIB "mod::system/lib/remoting/server.whlib";

RECORD FUNCTION GetCacheableSuggestSettings()
{
  RECORD settings :=
      [ maxconcurrent :=  ReadRegistryKey("consilio.suggest.maxconcurrent")
      , maxwait :=        ReadRegistryKey("consilio.suggest.maxwait")
      ];

  settings := ValidateOptions(
      [ maxconcurrent :=    10
      , maxwait :=          200
      ], settings);

  RETURN
      [ value :=        settings
      , eventmasks :=   [ "system:registry.consilio.suggest" ]
      ];
}

STRING FUNCTION GetSuggestSearchWord(STRING query)
{
  STRING searchword;
  OBJECT tokens := NEW TokenStream(query);
  WHILE (TRUE)
  {
    RECORD token := tokens->GetNextToken();
    IF (NOT RecordExists(token))
      BREAK;
    IF (token.type = TokenTypeWord)
      searchword := token.normalizedtext;
  }
  tokens->Close();
  RETURN searchword;
}

/** Get search suggestions for given input
*/
PUBLIC RECORD FUNCTION RPC_Suggest(RECORD source, STRING query, RECORD options)
{
  RECORD settings := GetAdhocCached([ type := "suggestsettings" ], PTR GetCacheableSuggestSettings);

  IF (NOT RecordExists(source) OR NOT CellExists(source, "type"))
    THROW NEW RPCInvalidArgsException("No valid source specified");

  IF (LENGTH(GetSuggestSearchWord(query)) < 3)
    RETURN [ "values" := RECORD[], tooshort := TRUE ];

  OBJECT lock;
  TRY
  {
    // Limit suggest calls to a certain number at a time, with a max wait time in the queue
    lock := OpenLocalLockManager()->TryLockLocalSemaphore("consilio:suggest", settings.maxconcurrent, AddTimeToDate(settings.maxwait, GetCurrentDateTime()));
    IF (NOT ObjectExists(lock))
    {
      LogDebug("consilio:rpc.suggest", "Timeout for suggest query, too long in wait queue", CELL[ source, query, options ]);
      RETURN [ "values" := RECORD[], timeout := TRUE ];
    }

    OBJECT suggest;
    SWITCH (source.type)
    {
      CASE "catalog"
      {
        // Open a catalog suggest object
        IF (NOT CellExists(source, "catalog"))
          THROW NEW Exception("No catalog");
        suggest := OpenSuggestObject(source.catalog);
      }

      DEFAULT
      {
        THROW NEW Exception("Unknown source type '" || source.type || "'");
      }
    }

    // Retrieve the suggest results
    IF (CellExists(options, "doccount"))
      suggest->document_count := options.doccount;
    IF (CellExists(options, "restricturl") AND options.restricturl != "")
      suggest->restrict_url := options.restricturl;
    IF (CellExists(options, "and_search"))
      suggest->and_search := options.and_search;
    INTEGER maxresults := CellExists(options, "count") ? options.count : 0;
    RECORD ARRAY suggestions := SELECT value := text
                                     , subtitle := suggest->document_count != "" ? ToString(results.count) : ""
                                  FROM suggest->GetSuggestions(query, maxresults) AS results;
    RETURN [ "values" := suggestions, timeout := FALSE ];
  }
  CATCH (OBJECT e)
  {
    THROW NEW RPCInvalidArgsException("Error while searching: " || e->what);
  }
  FINALLY
  {
    IF (ObjectExists(lock))
      lock->Close();
  }
}
