<?wh

RECORD FUNCTION CQNothing()
{
  RETURN [ _type := "nothing"
         , boost := 1f
         ];
}

PUBLIC RECORD FUNCTION __CQMatch(STRING field, STRING matchtype, VARIANT value, RECORD options)
{
  IF (options.__opensearch)
  {
    SWITCH (TypeID(value))
    {
      CASE TypeID(STRING ARRAY)
         , TypeID(INTEGER ARRAY)
         , TypeID(INTEGER64 ARRAY)
         , TypeID(MONEY ARRAY)
         , TypeID(FLOAT ARRAY)
         , TypeID(DATETIME ARRAY)
         , TypeID(BOOLEAN ARRAY)
      {
        IF (matchtype NOT IN [ "IN", "CONTAINS" ])
          THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
      }
      CASE TypeID(STRING)
         , TypeID(INTEGER)
         , TypeID(INTEGER64)
         , TypeID(MONEY)
         , TypeID(FLOAT)
         , TypeID(DATETIME)
      {
        IF (matchtype NOT IN [ "CONTAINS", "<", "<=", "=", ">=", ">" ])
          THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
        IF (matchtype = "CONTAINS" AND TypeID(value) != TypeID(STRING))
          matchtype := "="; // Match the literal query value within an indexed array
      }
      CASE TypeID(BOOLEAN)
      {
        IF (matchtype NOT IN [ "=" ])
          THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
      }
      DEFAULT
      {
        THROW NEW Exception(`Invalid value type '${GetTypeName(TypeID(value))}' for match query`);
      }
    }

    IF (IsTypeIDArray(TypeID(value)))
    {
      IF (Length(value) = 0)
        RETURN CQNothing();
      RETURN [ _type := "boolean"
             , subqueries :=
                 (SELECT query :=
                           CELL[ _type := matchtype = "IN" ? "literal" : "term"
                               , field
                               , term
                               , boost := 1f
                               ]
                       , required := (matchtype = "CONTAINS")
                       , prohibited := FALSE
                    FROM ToRecordArray(value, "term"))
             , boost := 1f
             ];
    }
    ELSE IF (matchtype IN [ "<", "<=", ">=", ">" ])
    {
      RETURN
          CELL[ _type := "range"
              , field
              , matchtype
              , term := value
              , boost := 1f
              ];
    }

    RETURN
        CELL[ _type := matchtype = "=" ? "literal" : "term"
            , field
            , term := value
            , boost := 1f
            ];
  }

  STRING ARRAY searchvalue;
  IF (TypeID(value) IN [ TypeID(INTEGER), TypeID(INTEGER64) ])
  {
    IF (matchtype NOT IN [ "CONTAINS", "=" ])
      THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
    searchvalue := [ ToString(value) ];
  }
  ELSE IF (TypeID(value) = TypeID(STRING))
  {
    IF (matchtype NOT IN [ "CONTAINS", "<", "<=", "=", ">=", ">" ])
      THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
    searchvalue := STRING[ value ];
  }
  ELSE IF (TypeID(value) IN [ TypeID(INTEGER ARRAY), TypeID(INTEGER64 ARRAY) ])
  {
    IF (matchtype NOT IN [ "IN", "CONTAINS" ])
      THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
    searchvalue := SELECT AS STRING ARRAY ToString(t) FROM ToRecordArray(value, "t");
    IF (Length(searchvalue) = 1)
      matchtype := "=";
  }
  ELSE IF (TypeID(value) = TypeID(STRING ARRAY))
  {
    IF (matchtype NOT IN [ "IN", "CONTAINS" ])
      THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);
    searchvalue := value;
    IF (Length(searchvalue) = 1)
      matchtype := "=";
  }
  ELSE IF (TypeID(value) = TypeID(DATETIME))
  {
    IF (matchtype NOT IN [ "<", "<=", "=", ">=", ">" ])
      THROW NEW Exception(`Invalid match type '${matchtype}' for ${GetTypeName(TypeID(value))} match query`);

    IF (NOT options.datetimesupport)
    {
      // Rewrite field name: 'field' to 'date_field', 'array.field@module' to 'array.date_field@module'
      IF (field LIKE "*.*@*")
      {
        IF (field NOT LIKE "*.date_*@*")
        {
          INTEGER dot := SearchSubstring(field, ".") + 1;
          field := `${Left(field, dot)}date_${Substring(field, dot)}`;
        }
      }
      ELSE IF (field NOT LIKE "date_*")
        field := `date_${field}`;
    }

    RETURN
        CELL[ _type := "date"
            , field
            , matchtype
            , term := value
            , boost := 1f
            ];
  }
  ELSE
    THROW NEW Exception(`Invalid value type '${GetTypeName(TypeID(value))}' for match query`);

  IF (Length(searchvalue) > 1)
  {
    RETURN [ _type := "boolean"
           , subqueries :=
               (SELECT query :=
                         CELL[ _type := "term"
                             , field
                             , term
                             , boost := 1f
                             ]
                     , required := (matchtype = "CONTAINS")
                     , prohibited := FALSE
                  FROM ToRecordArray(searchvalue, "term"))
           , boost := 1f
           ];
  }
  ELSE IF(Length(searchvalue) = 0)
  {
    RETURN CQNothing();
  }
  ELSE IF (matchtype IN [ "<", "<=", ">=", ">" ])
  {
    RETURN
        CELL[ _type := "range"
            , field
            , matchtype
            , term := searchvalue[0]
            , boost := 1f
            ];
  }

  RETURN
      CELL[ _type := matchtype = "=" ? "literal" : "term"
          , field
          , term := searchvalue[0]
          , boost := 1f
          ];
}
