<?wh

LOADLIB "wh::datetime.whlib";
LOADLIB "wh::ipc.whlib";
LOADLIB "wh::os.whlib";
LOADLIB "wh::xml/xsd.whlib";

LOADLIB "mod::consilio/lib/api.whlib";
LOADLIB "mod::consilio/lib/database.whlib";
LOADLIB "mod::consilio/lib/contentproviders/contentprovider.whlib";
LOADLIB "mod::consilio/lib/internal/support.whlib";

LOADLIB "mod::publisher/lib/publisher.whlib";
LOADLIB "mod::publisher/lib/siteapi.whlib";
LOADLIB "mod::publisher/lib/siteprofiles.whlib";
LOADLIB "mod::publisher/lib/internal/siteprofiles/cache.whlib";
LOADLIB "mod::publisher/lib/internal/siteprofiles/reader.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/logging.whlib";
LOADLIB "mod::system/lib/resources.whlib";
LOADLIB "mod::system/lib/services.whlib";
LOADLIB "mod::system/lib/tasks.whlib";
LOADLIB "mod::system/lib/whfs.whlib";
LOADLIB "mod::system/lib/internal/webhareconstants.whlib";

RECORD ARRAY FUNCTION GetRequiredCatalogs()
{
  //Figure out which catalogs to create..
  RECORD ARRAY wantcatalogs;
  FOREVERY(RECORD catalognode FROM GetCustomModuleSettings("http://www.webhare.net/xmlns/system/moduledefinition", "catalog"))
  {
    STRING tag := ToLowercase(`${catalognode.module}:${catalognode.node->GetAttribute("tag")}`);
    INTEGER priority := ParseXSInt(catalognode.node->Getattribute("priority"));

    RECORD catalog := CELL[ tag
                          , priority
                          , definedby := "<catalog> " || catalognode.resource || ":" || catalognode.node->linenum
                          , contentsources := RECORD[]
                          , managed := catalognode.node->HasAttribute("managed") ? ParseXSBoolean(catalognode.node->GetAttribute("managed")) : TRUE
                          ];

    STRING ongetsources := MakeAbsoluteResourcePath(catalognode.resource, catalognode.node->GetAttribute("ongetsources"));
    IF(ongetsources != "")
      catalog.contentsources := EnforceStructure([[ definedby := "<catalog ongetsources> " || ongetsources
                                                  , fsobject := 0
                                                  , contentobject := ""
                                                  , tag := ""
                                                 ]], MakeFunctionPtr(ongetsources, TYPEID(RECORD ARRAY), INTEGER[])());

    FOREVERY(OBJECT customsource FROM catalognode.node->ListElements(catalognode.node->namespaceuri, "customsource"))
    {
      INSERT [[ definedby :=  "<customsource> " || catalognode.resource || ":" || customsource->linenum
              , fsobject := 0
              , contentobject := MakeAbsoluteResourcePath(catalognode.resource, customsource->GetAttribute("contentobject"))
              , tag := `${catalognode.module}:${customsource->GetAttribute("tag")}`
              ]
             ] INTO catalog.contentsources AT END;
    }

    INSERT catalog INTO wantcatalogs AT END;
  }

  RECORD siteprofs := GetCachedSiteProfiles();
  FOREVERY (RECORD addtocatalog FROM siteprofs.addtocatalogs)
  {
    INTEGER matchcatalog := (SELECT AS INTEGER #wantcatalogs + 1 FROM wantcatalogs WHERE wantcatalogs.tag = addtocatalog.catalog)-1;
    IF(matchcatalog = -1)
    {
      //TODO make sure the error goes somewhere recorded/validateable/reportable
      PrintTo(2,`<addtocatalog> on ${addtocatalog.siteprofile}:${addtocatalog.line} refers to undefined catalog '${addtocatalog.catalog}'\n`);
      CONTINUE;
    }

    INSERT CELL definedby := "<addtocatalog> " || addtocatalog.siteprofile || ":" || addtocatalog.line INTO addtocatalog;
    FOREVERY(INTEGER siteid FROM GetSiteSettingIDs(addtocatalog))
    {
      OBJECT site := OpenSite(siteid);
      IF(NOT ObjectExists(site))
        CONTINUE; //race, just deleted ?

      OBJECT target := site->OpenByPath(addtocatalog.folder, [ allowinitialslash := TRUE ]);
      IF(NOT ObjectExists(target) OR NOT target->isfolder)
      {
        PrintTo(2,`<addtocatalog> on ${addtocatalog.siteprofile}:${addtocatalog.line} refers to nonexisting folder '${addtocatalog.folder}' in site '${site->name}'\n`);
        CONTINUE;
      }
      INSERT CELL[ ...addtocatalog
                 , fsobject := target->id
                 , contentobject := ""
                 , tag := ""
                 ] INTO wantcatalogs[matchcatalog].contentsources AT END;
    }
  }

  RETURN wantcatalogs;
}

MACRO UpdateManagedCatalog(OBJECT catalog, RECORD want)
{
  RECORD ARRAY currentsources := catalog->ListContentSources();
  FOREVERY(RECORD source FROM want.contentsources)
  {
    INTEGER matchpos := (SELECT AS INTEGER #currentsources + 1
                           FROM currentsources
                          WHERE contentprovider = (source.contentobject != "" ? "consilio:custom" : "publisher:webhare")
                                AND fsobject = source.fsobject
                                AND ToUppercase(tag) = ToUppercase(source.tag)) - 1;

    IF(matchpos >= 0)
    {
      STRING expect_library, expect_contentobject;
      IF(source.contentobject != "")
      {
        expect_library := Tokenize(source.contentobject,'#')[0];
        expect_contentobject := Tokenize(source.contentobject,'#')[1];
      }

      IF(currentsources[matchpos].definedby != source.definedby
         OR currentsources[matchpos].contentobject != source.contentobject)
      {
        catalog->OpenContentSourceById(currentsources[matchpos].id)->UpdateContentSource(CELL[ source.definedby
                                                                                             , settings := CELL[library := expect_library, contentobject := expect_contentobject]
                                                                                             , tag := source.tag
                                                                                             ]);
      }

      IF(currentsources[matchpos].isorphan)
        catalog->OpenContentSourceById(currentsources[matchpos].id)->ReactivateContentSource();

      DELETE FROM currentsources AT matchpos; //remove from cleanup list
      CONTINUE;
    }

    TRY
    {
      IF(source.contentobject = "")
        catalog->AddPublisherContentSource(source.fsobject, CELL[ source.definedby ]);
      ELSE
        catalog->AddCustomContentSource(source.tag, source.contentobject, CELL[ source.definedby ]);
    }
    CATCH(OBJECT e)
    {
      LogHarescriptException(e);
      PrintTo(2,`Failed to add catalog from ${source.definedby}: ${e->what}\n`);
      CONTINUE;
    }
  }

  //mark unreferred catalogs as orphan
  FOREVERY(RECORD makeorphansource FROM SELECT * FROM currentsources WHERE NOT isorphan)
    catalog->OpenContentSourceById(makeorphansource.id)->MarkAsOrphan();
}

MACRO UpdateModuleCatalogs(RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions(
      [ reportmissing := FALSE
      ], options);

  OBJECT trans := GetPrimary();
  IF (NOT trans->ColumnExists("consilio", "indexmanagers", "id"))
    RETURN; //consilio is not initialized yet!

  RECORD ARRAY wantcatalogs := GetRequiredCatalogs();

  INTEGER builtin_indexmanager := GetDefaultIndexManager();
  IF(builtin_indexmanager = 0)
    DELETE FROM wantcatalogs WHERE managed;  //don't create managed catalogs until index storage is ready

  trans->BeginWork();
  FOREVERY(RECORD want FROM wantcatalogs)
  {
    OBJECT catalog := OpenConsilioCatalog(want.tag) ?? CreateConsilioCatalog(want.tag, CELL[ want.managed ]);
    IF(catalog->ismanaged != want.managed)
    {
      PrintTo(2, `Catalog '${want.tag} is incorrectly ${catalog->ismanaged ? "" : "not "}managed, it probably needs to be recreated\n`);
      CONTINUE;
    }

    IF(catalog->definedby != want.definedby)
      catalog->UpdateCatalog( CELL[ want.definedby ]);

    IF(want.managed)
      UpdateManagedCatalog(catalog, want);

  }
  trans->CommitWork();
}

MACRO UpdateModuleIndices(RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions(
      [ modules := STRING[]
      , reportmissing := FALSE
      ], options);

  OBJECT trans := GetPrimary();
  IF (NOT trans->ColumnExists("consilio", "indexmanagers", "id"))
    RETURN; //consilio is not initialized yet!

  trans->BeginWork();
  DELETE FROM consilio.indices WHERE type = whconstant_consilio_catalogtype_fieldgroup; //clear any 4.25 created fieldgroups

  //gather requested indices
  RECORD ARRAY allindices;
  FOREVERY (STRING mod FROM GetInstalledModuleNames())
  {
    IF (Length(options.modules) > 0 AND mod NOT IN options.modules)
      CONTINUE;

    OBJECT xmldoc := GetModuleDefinitionXML(mod);
    FOREVERY(OBJECT consilionode FROM xmldoc->documentelement->ListChildren("http://www.webhare.net/xmlns/system/moduledefinition", "consilio"))
      FOREVERY(OBJECT indexnode FROM consilionode->ListChildren("http://www.webhare.net/xmlns/system/moduledefinition", "index"))
      {
        STRING indexname := mod || ":" || indexnode->GetAttribute("tag");
        INTEGER setpriority := ParseXSInt(indexnode->Getattribute("priority"));

        // Update or create the index
        RECORD indexrec := SELECT * FROM consilio.indices WHERE ToUppercase(name) = ToUppercase(VAR indexname);
        IF (RecordExists(indexrec))
        {
          IF (indexrec.type != whconstant_consilio_catalogtype_moduleindex)
          {
            PrintTo(2,`There already is an index named '${indexname}', which is not a module index\n`);
            SetConsoleExitCode(1);
            CONTINUE;
          }
          /* Nothing to update (yet?)
          UPDATE consilio.indices
             SET
           WHERE id = indexrec.id;
          GetPrimary()->BroadCastOnCommit("consilio:indiceschanged", DEFAULT RECORD);*/
        }
        ELSE
        {
          OBJECT newindex := CreateConsilioCatalog(indexname, [ priority := setpriority, managed := FALSE ]);
          indexrec := CELL[ newindex->id, name := indexname ];
        }
        INSERT CELL[ indexrec.id, indexrec.name ] INTO allindices AT END;
      }
  }

  trans->CommitWork();
}

PUBLIC MACRO FixConsilioIndices(RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions(
      [ reportmissing := FALSE
      ], options);

  OBJECT lock := OpenLockManager()->LockMutex("consilio:updateindices");
  TRY
  {
    UpdateModuleCatalogs(CELL[options.reportmissing]);
    UpdateModuleIndices(CELL[options.reportmissing]);
  }
  FINALLY
  {
    lock->Release();
  }

  // Broadcast indexfields event to reset cached module index fields (publisher search)
  BroadcastEvent("consilio:indexfields", DEFAULT RECORD);//TODO is this still needed? but UpdateConsilioIndices, now removed, broadcasted it
}
