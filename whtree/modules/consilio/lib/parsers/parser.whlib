<?wh
/** @private Parser list. (may be replaced with tika at some point) */

//ADDME moduledefinition registration? perhaps an object to base upon is a nicer api than functions though

PUBLIC RECORD ARRAY consilio_parsers :=
[ [ mimetypes := [ "text/plain" ]
  , lib := "mod::consilio/lib/parsers/parser_txt.whlib"
  , func := "ParsePlainTextDoc"
  ]
, [ mimetypes := [ "text/html" ]
  , lib := "mod::consilio/lib/parsers/parser_html.whlib"
  , func := "ParseHTMLPage"
  ]
, [ mimetypes := [ "application/pdf" ]
  , lib := "mod::consilio/lib/parsers/parser_pdf.whlib"
  , func := "ParsePDFDoc"
  ]
, [ mimetypes := [ "application/msword", "application/vnd.openxmlformats-officedocument.wordprocessingml.document" ]
  , lib := "mod::consilio/lib/parsers/parser_msword.whlib"
  , func := "ParseMSWordDoc"
  ]
, [ mimetypes := [ "application/vnd.ms-excel", "application/excel" ]
  , lib := "mod::consilio/lib/parsers/parser_excel.whlib"
  , func := "ParseExcelFile"
  ]
, [ mimetypes := [ "application/vnd.ms-powerpoint" ]
  , lib := "mod::consilio/lib/parsers/parser_powerpoint.whlib"
  , func := "ParsePowerPointFile"
  ]
, [ mimetypes := [ "application/vnd.openxmlformats-officedocument.presentationml.presentation" ]
  , lib := "mod::consilio/lib/parsers/parser_pptx.whlib"
  , func := "ParsePPTX"
  ]
];

PUBLIC RECORD FUNCTION ParsePage(BLOB data, STRING mimetype, RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions(
      [ contentlinksonly := FALSE
      ], options);

  mimetype := ToLowercase(mimetype);
  RECORD parser := SELECT * FROM consilio_parsers WHERE mimetype IN mimetypes;
  IF (NOT RecordExists(parser))
    RETURN DEFAULT RECORD;

  RECORD parsed_page;
  TRY
  {
    parsed_page := MakeFunctionPtr(parser.lib, parser.func, TypeID(RECORD), [TypeID(BLOB), TypeID(BOOLEAN)])(data, options.contentlinksonly);
  }
  CATCH (OBJECT e) {}
  IF (NOT RecordExists(parsed_page))
  {
    TRY
    {
      parsed_page := MakeFunctionPtr(parser.lib, parser.func, TypeID(RECORD), [TypeID(BLOB)])(data);
    }
    CATCH (OBJECT e) {}
  }
  IF (NOT RecordExists(parsed_page))
    THROW NEW Exception(`${parser.lib}#${parser.func}`);
  RETURN parsed_page;
}
