<?wh
/** @private Parser list. (may be replaced with tika at some point) */
LOADLIB "wh::internal/any.whlib";
//ADDME moduledefinition registration? perhaps an object to base upon is a nicer api than functions though

RECORD ARRAY consilio_parsers :=
[ [ mimetypes := [ "text/plain" ]
  , func := "mod::consilio/lib/parsers/parser_txt.whlib#ParsePlainTextDoc"
  ]
, [ mimetypes := [ "text/html" ]
  , func := "mod::consilio/lib/parsers/parser_html.whlib#ParseHTMLPage"
  ]
, [ mimetypes := [ "*" ]
  , func := "mod::consilio/lib/parsers/tika.whlib#ParseTikaPage"
  ]
];

PUBLIC RECORD FUNCTION ParsePage(BLOB data, STRING mimetype, RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions(
      [ contentlinksonly := FALSE
      ], options);

  mimetype := ToLowercase(mimetype);
  RECORD parser := SELECT * FROM consilio_parsers WHERE __MatchesAnyMask(mimetype,mimetypes);
  IF (NOT RecordExists(parser))
    RETURN DEFAULT RECORD;

  RETURN MakeFunctionPtr(parser.func, TypeID(RECORD), [TypeID(BLOB), TypeID(BOOLEAN)] )(data, options.contentlinksonly);
}
