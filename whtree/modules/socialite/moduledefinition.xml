<module xmlns="http://www.webhare.net/xmlns/system/moduledefinition">

  <meta configscreen="screens/sysmgmt.xml#googleapikeys">
    <!--
    1.2 - recaptcha, sharepage, embedvideoproviders, misc
    1.3 - YouTube V3 and lots of small LinkedIn, Recaptcha, Twitter and other misc updates
    1.4 - Slack API, Google Maps, GPX (SPC), Pinterest network, ES6 API
    1.5 - Slack API fixes, Analytics API V3 support, GTM debug lib, Twitter fallback, SEO Tab, YouTube duration fix
    1.6 - Vimeo V3 API
    -->
    <description>Social network API and manager</description>
    <packaging>
      <dependency module="publisher" />
      <dependency module="tollium" />
    </packaging>
    <validation options="nowarnings">
      <format masks="*.ts *.tsx" />
    </validation>
  </meta>

  <servicemanager>
    <task runat="*/5   * * * *" script="scripts/tasks/update_embedded.whscr" tag="update_embedded" description="Update embedded scripts" />
  </servicemanager>

  <services>
    <webservice name="recaptcha"
                library="lib/internal/recaptcha-rpc.whlib"
                prefix="RPC_"
                primarytrans="none"
                transports="jsonrpc">
      <accesscheck />
    </webservice>
  </services>

  <portal>
    <application name="config"
                 group="system:setup"
                 icon="tollium:applications/socialite"
                 screen="/screens/config.xml#main"
                 tid="config.apptitle">
      <accesscheck>
        <requireright right="fullaccess" />
      </accesscheck>
    </application>
  </portal>

  <backend>
    <webrule path="allroots:/.socialite/" match="initial" handlebydir="web/global/" priority="after" />

    <!-- embed scripts. cache for 10 minutes, together with the 5 minutes refresh rate this should sort of simulate GTM's 15 minute cache -->
    <webrule path="allroots:/.se/"
             match="initial"
             cachecontrol="public, max-age=600"
             priority="after"
             redirecttodir="var:se/" />
  </backend>

  <rights>
    <objecttype name="accounts"
                describer="lib/internal/support.whlib#accountsdescriber"
                table=".accounts"
                tid="rights.accounts" />

    <right name="fullaccess" descriptiontid="rights.fullaccess-descr" objecttype="accounts" tid="rights.fullaccess">
      <impliedby right="system:sysop" />
    </right>
  </rights>

  <tollium>
    <!-- Entry point for our component parser -->
    <components namespace="http://www.webhare.net/xmlns/socialite/components" xmlschema="components.xsd" />
  </tollium>

  <!-- schema kort
       accounts bestaan uit
           keys (keys definieren applicaties)
  -->
  <databaseschema xmlns:d="http://www.webhare.net/xmlns/whdb/databaseschema">
    <d:table name="accounts" primarykey="id">
      <d:integer name="id" autonumberstart="1" />
      <d:varchar name="title" maxlength="256" nullable="0" />
      <d:varchar name="tag" maxlength="256" nullable="0" />
    </d:table>

    <d:table name="applications" parentlinkcolumn="account" primarykey="id">
      <d:integer name="id" autonumberstart="1" />
      <d:integer name="account" nullable="0" ondelete="cascade" references=".accounts" />
      <d:varchar name="title" maxlength="256" nullable="0" />
      <d:varchar name="tag" maxlength="256" />
      <d:varchar name="type" maxlength="16" nullable="0" />
      <d:varchar name="remarks" maxlength="4096" />
      <d:boolean name="logrpc" />
    </d:table>

    <d:table name="applicationkeys" parentlinkcolumn="application" primarykey="id">
      <d:integer name="id" autonumberstart="1" />
      <d:integer name="application" nullable="0" ondelete="cascade" references=".applications" />
      <d:varchar name="tag" maxlength="256" nullable="0" />
      <d:varchar name="value" maxlength="4096" />
    </d:table>

    <d:obsoletetable name="sessions" parentlinkcolumn="application" primarykey="id" />

    <d:obsoletetable name="feeds" />

    <d:obsoletetable name="feedentries" />

    <!-- TODO generalize this a bit, there are more things that need API keys that are bound to local urls. we should probably move it to a webhare configuration wrdschema -->
    <d:table name="google_apikeys" primarykey="id">
      <d:integer name="id" autonumberstart="1" />
      <d:integer name="keytype" />  <!-- 0 = maps, 1 = recaptcha -->
      <d:integer name="scopetype" />  <!-- 0 = any scope. 1 = use in clients (javascript), 2 = use in servers -->
      <d:varchar name="domain" maxlength="1024" nullable="0" />
      <d:varchar name="apikey" maxlength="512" nullable="0" />
      <d:varchar name="privatekey" maxlength="512" />
      <d:datetime name="creationdate" />
      <d:varchar name="comment" maxlength="512" />
      <d:index name="domainskeys" columns="keytype scopetype domain(32)" unique="1" uppercase="1" />
    </d:table>
  </databaseschema>

  <publisher>
    <siteprofile path="data/socialite.siteprl.xml" />

    <webdesignplugin name="analytics"
                     namespace="http://www.webhare.net/xmlns/socialite"
                     objectname="lib/internal/webdesignplugin.whlib#analyticsplugin" />
    <webdesignplugin name="googleanalytics"
                     namespace="http://www.webhare.net/xmlns/socialite"
                     objectname="mod::socialite/lib/internal/webdesignplugin.whlib#SocialiteGoogleAnalyticsPluginWrapper" />
    <webdesignplugin name="gtm"
                     namespace="http://www.webhare.net/xmlns/socialite"
                     objectname="mod::socialite/lib/internal/webdesignplugin.whlib#SocialiteGTMWrapper" />
    <webdesignplugin name="opengraph"
                     namespace="http://www.webhare.net/xmlns/socialite"
                     objectname="lib/internal/webdesignplugin.whlib#opengraphplugin" />
    <webdesignplugin name="seotab"
                     hooksfeatures="objectprops"
                     namespace="http://www.webhare.net/xmlns/socialite"
                     objectname="lib/internal/plugins/seotab.whlib#seotabplugin" />

    <formcomponents namespace="http://www.webhare.net/xmlns/socialite/forms" xmlschema="data/forms/formdef.xsd" />

    <embedvideodetector functionname="lib/internal/embedvideo/support.whlib#guessfromcode" />

    <embedvideoprovider name="youtube"
                        objectname="lib/internal/embedvideo/youtube.whlib#YoutubeProvider"
                        tid="embedvideo.network.youtube" />
    <embedvideoprovider name="vimeo"
                        objectname="lib/internal/embedvideo/vimeo.whlib#VimeoProvider"
                        tid="embedvideo.network.vimeo" />
  </publisher>

  <moduleregistry>
    <obsoletenode name="localoverrides" />

    <node name="embedscripts">
      <string name="tagmanagers" />
    </node>
    <node name="maps">
      <string name="defaultprovider" initialval="leaflet" />
    </node>
  </moduleregistry>

</module>
