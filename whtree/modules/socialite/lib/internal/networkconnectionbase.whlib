<?wh
LOADLIB "mod::socialite/lib/internal/support.whlib";
LOADLIB "wh::crypto.whlib";

INTEGER current_token_version := 1;

PUBLIC OBJECTTYPE NetworkConnectionBase
< // ---------------------------------------------------------------------------
  //
  // Variables
  //

  RECORD ARRAY pvt_permissionmap;

  RECORD accesstok;

  PUBLIC STRING consumer;
  PUBLIC STRING secret; //application secret

  PUBLIC INTEGER appid; //used for secure tokens

  // ---------------------------------------------------------------------------
  //
  // Public properties
  //

  PUBLIC PROPERTY accesstoken(GetAccessToken, SetAccessToken);

  PUBLIC PROPERTY permissionmap(pvt_permissionmap, -);

  // ---------------------------------------------------------------------------
  //
  // Constructor
  //

  MACRO NEW(RECORD ARRAY permissionmap)
  {
    this->pvt_permissionmap := permissionmap;
  }


  // ---------------------------------------------------------------------------
  //
  // Getters & setters
  //

  STRING FUNCTION GetAccessToken()
  {
    RECORD toreturn := this->accesstok;
    IF (NOT RecordExists(toreturn))
      RETURN "";

    INSERT CELL v := current_token_version INTO toreturn;
    RETURN EncodeJSON(toreturn);
  }

  MACRO SetAccessToken(STRING newaccesstoken)
  {
    //Note that accestoken integrates both the oauth token and extra metadata for validation, so we can't move this to oauth whlib currently...
    RECORD decode;
    IF (newaccesstoken != "")
    {
      decode := DecodeJSON(newaccesstoken);
      IF (NOT RecordExists(decode))
        THROW NEW SocialiteException("EXPIRED", "The access token is corrupted");
      IF(decode.v != current_token_version)
        THROW NEW SocialiteException("EXPIRED", "This access token is no longer supported");

      DELETE CELL v FROM decode;
    }
    this->accesstok := decode;
    this->ExtUpdatedAccessToken();
  }

  PUBLIC STRING FUNCTION GetSecureAccessToken()
  {
    STRING header := EncodePacket("version:C,appid:L", [version := 1, appid := this->appid ]);
    STRING basehandle := this->accesstoken;
    STRING signedhandle := basehandle || GetSHA1Hash(basehandle|| this->secret);
    STRING encryptedhandle := Encrypt("bf-ecb", this->secret, signedhandle);

    IF (basehandle = "")
      RETURN "";

    RETURN MyEncodeURLBin64(header || encryptedhandle);
  }

  PUBLIC BOOLEAN FUNCTION SetSecureEncryptedHandle(STRING encryptedhandle)
  {
    STRING signedhandle := Decrypt("bf-ecb", this->secret, encryptedhandle);
    STRING basehandle := Left(signedhandle, Length(signedhandle)-20);

    IF(Right(signedhandle,20) != GetSHA1Hash(basehandle || this->secret))
      RETURN FALSE;

    this->accesstoken := basehandle;
    RETURN TRUE;
  }

  // ---------------------------------------------------------------------------
  //
  // ExtXXX
  //

  MACRO ExtUpdatedAccessToken()
  {
  }

  // ---------------------------------------------------------------------------
  //
  // Public API
  //

  /** Returns the redirect page for oauth apps
      @param serverurl Host url
      @return URL that will be redirected to after authentication
  */
  PUBLIC STRING FUNCTION GetCallbackURL(STRING serverurl)
  {
    THROW NEW Exception("This connection does not support callback url based login");
  }

  PUBLIC MACRO Close()
  {
  }
>;
