<?wh
LOADLIB "wh::files.whlib";
LOADLIB "wh::xml/dom.whlib";
LOADLIB "wh::ipc.whlib";
LOADLIB "mod::tollium/lib/screenbase.whlib";
LOADLIB "mod::socialite/lib/database.whlib";
LOADLIB "mod::socialite/lib/api.whlib";
LOADLIB "mod::socialite/lib/commondialogs.whlib";
LOADLIB "mod::socialite/lib/internal/support.whlib";


PUBLIC STATIC OBJECTTYPE Main EXTEND TolliumScreenBase
<
  MACRO Init(RECORD data)
  {
    this->Refresh();
  }

  MACRO Refresh()
  {
    ^apps->rows := this->GetAccounts();
  }

  RECORD ARRAY FUNCTION GetAccounts()
  {
    RECORD ARRAY accounts := SELECT * FROM socialite.accounts;

    RETURN
      SELECT isaccount := TRUE
           , isapp := FALSE
           , title
           , rowkey := "account_" || id
           , accountid := id
           , id
           , tag
           , expanded := FALSE
           , subnodes := this->GetApplications(id)
        FROM accounts
    ORDER BY ToUpperCase(title), id;
  }

  RECORD ARRAY FUNCTION GetApplications(INTEGER accountid)
  {
    RECORD ARRAY applications := SELECT * FROM socialite.applications WHERE account = accountid;

    RETURN
      SELECT isaccount := FALSE
           , isapp := TRUE
           , title
           , rowkey := "application_" || id
           , accountid := accountid
           , id
           , tag
           , expanded := TRUE
           , subnodes := DEFAULT RECORD ARRAY
        FROM applications;
  }

  MACRO DoAddAccount()
  {
    OBJECT accountdialog := this->LoadScreen(".account");
    accountdialog->RunModal();
    this->Refresh();
  }

  MACRO DoAddApplication()
  {
    OBJECT accountdialog := this->LoadScreen(".application", [ account := ^apps->selection.id, id := 0 ]);
    accountdialog->RunModal();
    this->Refresh();
  }

  MACRO DoEditAccount()
  {
    OBJECT accountdialog := this->LoadScreen(".account", [id := ^apps->selection.id]);
    accountdialog->RunModal();
    this->Refresh();
  }

  MACRO DoEditApplication()
  {
    OBJECT accountdialog := this->LoadScreen(".application", [ account := 0, id := ^apps->selection.id ]);
    accountdialog->RunModal();
    this->Refresh();
  }

  MACRO DoDeleteAccount()
  {
    IF (this->RunSimpleScreen("confirm", this->GetTid(".delete_confirmation")) = "yes")
    {
      OBJECT work := this->BeginWork();
      DELETE FROM socialite.accounts WHERE id = ^apps->selection.id;
      work->Finish();
    }

    this->Refresh();
  }

  MACRO DoDeleteApplication()
  {
    IF (this->RunSimpleScreen("confirm", this->GetTid(".delete_confirmation")) = "yes")
    {
      OBJECT work := this->BeginWork();
      DELETE FROM socialite.applications WHERE id = ^apps->selection.id;
      work->Finish();
      BroadcastEvent("socialite:applications", DEFAULT RECORD);
    }

    this->Refresh();
  }

  MACRO DoExit()
  {
    this->tolliumresult := "ok";
  }
>;

PUBLIC OBJECTTYPE Account EXTEND TolliumScreenBase
<
  INTEGER accountid;

  MACRO Init(RECORD data)
  {
    IF (RecordExists(data))
    {
      this->accountid := data.id;

      RECORD accountrec := SELECT * FROM socialite.accounts WHERE accounts.id = data.id;
      this->title->value := accountrec.title;
      this->tag->value := accountrec.tag;
    }
  }

  BOOLEAN FUNCTION Submit()
  {
    OBJECT work := this->BeginWork();

    IF (this->accountid = 0)
      INSERT INTO socialite.accounts(title, tag) VALUES (this->title->value, this->tag->value);
    ELSE
      UPDATE socialite.accounts SET title := this->title->value, tag := this->tag->value WHERE id = this->accountid;

    RETURN work->Finish();
  }
>;

PUBLIC OBJECTTYPE Application EXTEND TolliumScreenBase
<
  INTEGER accountid;
  INTEGER applicationid;
  STRING ARRAY networksetup;

  MACRO Init(RECORD data)
  {
    this->accountid := data.account;
    this->applicationid := data.id;
    this->applicationtype->options := SELECT rowkey := tag, title FROM socialnetworks ORDER BY ToUpperCase(title), tag;

    RECORD applicationrec;
    IF (this->applicationid != 0)
      applicationrec := SELECT * FROM socialite.applications WHERE applications.id = data.id;

    IF(RecordExists(applicationrec))
    {
      this->title->value := applicationrec.title;
      this->tag->value := applicationrec.tag;
      this->applicationtype->value := applicationrec.type;
      this->remarks->value := applicationrec.remarks;
      this->logrpc->value := applicationrec.logrpc;
    }

    this->ChangeType();

    IF(RecordExists(applicationrec))
    {
      IF("PUBKEY" IN this->networksetup)
        this->publickey->value := this->GetKey("publickey");
      IF("PVTKEY" IN this->networksetup)
        this->privatekey->value := this->GetKey("privatekey");
      IF("CALLBACKHOST" IN this->networksetup)
        this->authenticationcallbackhost->value := this->GetKey("authcallbackhosturl");
      IF("EMULATORURL" IN this->networksetup)
        this->emulationurl->value := this->GetKey("emulationurl");
      IF("DEVELOPERKEY" IN this->networksetup)
        this->developerkey->value := this->GetKey("developerkey");
      this->jsredirecturl->value := this->GetKey("jsredirecturl");

      this->applicationtype->enabled := FALSE;
    }
  }

  MACRO ChangeType()
  {
    RECORD networkinfo := SELECT * FROM socialnetworks WHERE tag = this->applicationtype->value;
    IF (NOT RecordExists(networkinfo)) // unknown network, probably one we supported in the past, but which isn't supported anymore
      RETURN;

    this->networksetup := networkinfo.setup;

    this->publickey->visible := "PUBKEY" IN this->networksetup;
    this->privatekey->visible := "PVTKEY" IN this->networksetup;

    this->emulationurl->visible := "EMULATORURL" IN this->networksetup;
    this->emulationurl->required := "EMULATORURL" IN this->networksetup;
    this->authenticationcallbackhost->visible := "CALLBACKHOST" IN this->networksetup;
    this->developerkey->visible := "DEVELOPERKEY" IN this->networksetup;
    this->developerkey->required := "DEVELOPERKEY" IN this->networksetup;
  }

  STRING FUNCTION GetKey(STRING lookup_tag)
  {
    RETURN
      SELECT AS STRING value FROM socialite.applicationkeys WHERE tag = lookup_tag AND COLUMN application = this->applicationid;
  }

  MACRO SetKey(STRING lookup_tag, STRING new_value)
  {
    RECORD old_entry := SELECT * FROM socialite.applicationkeys WHERE tag = lookup_tag AND COLUMN application = this->applicationid;

    IF (RecordExists(old_entry))
    {
      UPDATE socialite.applicationkeys SET value := new_value WHERE id = old_entry.id;
    }
    ELSE
    {
      INSERT INTO socialite.applicationkeys(application, tag, value) VALUES(this->applicationid, lookup_tag, new_value);
    }
  }

  BOOLEAN FUNCTION Submit()
  {
    OBJECT work := this->BeginWork();
    IF(work->HasFailed())
      RETURN work->Finish();

    IF (this->applicationid = 0)
    {
      this->applicationid := MakeAutonumber(socialite.applications, "id");
      INSERT INTO socialite.applications(id, account, title, tag, type, remarks, logrpc)
             VALUES (this->applicationid, this->accountid, this->title->value, this->tag->value, this->applicationtype->value, this->remarks->value, this->logrpc->value);
    }
    ELSE
    {
      UPDATE socialite.applications
         SET title := this->title->value
           , tag := this->tag->value
           , remarks := this->remarks->value
           , logrpc := this->logrpc->value
       WHERE id = this->applicationid;
    }

    IF("PUBKEY" IN this->networksetup)
      this->SetKey("publickey", this->publickey->value);
    IF("PVTKEY" IN this->networksetup)
      this->SetKey("privatekey", this->privatekey->value);
    IF("CALLBACKHOST" IN this->networksetup)
      this->SetKey("authcallbackhosturl", this->authenticationcallbackhost->value);
    IF("EMULATORURL" IN this->networksetup)
      this->SetKey("emulationurl", this->emulationurl->value);
    IF("DEVELOPERKEY" IN this->networksetup)
      this->SetKey("developerkey", this->developerkey->value);
    this->SetKey("jsredirecturl", this->jsredirecturl->value);

    BOOLEAN result := work->Finish();
    BroadcastEvent("socialite:applications", DEFAULT RECORD);
    RETURN result;
  }
>;
