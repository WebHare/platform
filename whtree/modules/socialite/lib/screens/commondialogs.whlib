<?wh
LOADLIB "wh::util/geo.whlib";
LOADLIB "mod::tollium/lib/screenbase.whlib";

LOADLIB "mod::socialite/lib/google/maps-v3.whlib";



PUBLIC OBJECTTYPE Location EXTEND TolliumScreenBase
< // ---------------------------------------------------------------------------
  //
  // Variables
  //

  OBJECT geocoder;
  RECORD pvt_value;

  STRING iconname;


  // ---------------------------------------------------------------------------
  //
  // Properties
  //

  PUBLIC PROPERTY center(GetCenter, SetCenter);
  PUBLIC PROPERTY zoom(GetZoom, SetZoom);
  PUBLIC PROPERTY value(GetValue, SetValue);
  PUBLIC BOOLEAN autozoom;


  // ---------------------------------------------------------------------------
  //
  // Constructor & tollium admin stuff
  //

  MACRO NEW()
  {
    this->autozoom := TRUE;
  }

  MACRO Init(RECORD data)
  {
    this->geocoder := NEW GGeocoder([ requesturl := this->tolliumcontroller->baseurl ]);
    this->geocoder->baselanguagecode := this->tolliumuser->language;

    IF (RecordExists(data))
    {
      IF (CellExists(data, "icon") AND TypeID(data.icon) = TypeID(RECORD))
        this->map->icons := [ RECORD(data.icon) ];
      this->autozoom := CellExists(data, "autozoom") AND TypeID(data.autozoom) = TypeId(BOOLEAN) AND data.autozoom;
    }
    this->iconname := Length(this->map->icons) > 0 ? this->map->icons[0].name : "";
  }

  PUBLIC MACRO SetInitialSearch(STRING initialdata)
  {
    //initial searches may not trigger a popup
    IF(this->TrySearchFor(initialdata, [ silentlyfail := TRUE ]))
      this->query->value := initialdata;
  }


  // ---------------------------------------------------------------------------
  //
  // Helper functions
  //

  MACRO UpdateValue(RECORD coordinates, BOOLEAN center, OBJECT viewport DEFAULTSTO DEFAULT OBJECT)
  {
    this->pvt_value := coordinates;
    IF (RecordExists(this->pvt_value))
    {
      this->map->overlays := [ [ type := "marker"
                               , icon := this->iconname
                               , lat := this->pvt_value.lat
                               , lng := this->pvt_value.lng
                               , moveable := TRUE
                               , selectable := FALSE
                               ]
                             ];
      IF (center)
      {
        this->map->center := this->pvt_value;
        IF (this->autozoom AND ObjectExists(viewport))
          this->map->SetViewport(viewport->ToRecord());
      }
    }
    ELSE
    {
      DELETE FROM this->map->overlays;
    }
  }


  // ---------------------------------------------------------------------------
  //
  // Callbacks
  //

  BOOLEAN FUNCTION TrySearchFor(STRING query, RECORD options DEFAULTSTO DEFAULT RECORD)
  {
    options := ValidateOptions( [ silentlyfail := FALSE ], options);

    // If the user entered a valid latlng coordinate, don't search but use that directly
    RECORD latlng := StringToLatLng(Substitute(query, " ", ""));
    IF (RecordExists(latlng))
    {
      this->UpdateValue(latlng, TRUE);
      RETURN TRUE;
    }

    RECORD reply := this->geocoder->GetLocations(query);
    IF (NOT RecordExists(reply) OR reply.status != "OK")
    {
      IF(NOT options.silentlyfail)
      {
        IF(RecordExists(reply) AND reply.status IN ["REQUEST_DENIED","OVER_QUERY_LIMIT","OVER_DAILY_LIMIT"])
          this->RunSimpleScreen("error", GetTid("socialite:commondialogs.messageboxes.queryfailed", reply.status, reply.error_message));
        ELSE
          this->RunSimpleScreen("error", GetTid("socialite:commondialogs.messageboxes.noresults"));
      }
      RETURN FALSE;
    }

    this->results->options := SELECT rowkey := #results + 1
                                   , title := formatted_address
                                   , point := geometry.location
                                   , viewport := geometry.viewport
                                   , tolliumselected := #results = 0
                                FROM reply.results;
    //Print("Results:\n" || AnyToString(this->results->options, "tree"));
    this->OnResultSelect();
    RETURN TRUE;
  }

  MACRO DoSearch()
  {
    IF (^query->value != "")
      this->TrySearchFor(^query->value);
  }

  MACRO OnResultSelect()
  {
    IF (RecordExists(this->results->selection))
      this->UpdateValue(this->results->selection.point->ToRecord(), TRUE, this->results->selection.viewport);
    ELSE
      this->map->overlays := DEFAULT RECORD ARRAY;
  }

  MACRO OnClick(RECORD pos)
  {
    this->UpdateValue(pos, FALSE);
  }

  MACRO OnMoveOverlay(RECORD overlay, RECORD pos)
  {
    this->UpdateValue(pos, FALSE);
  }


  // ---------------------------------------------------------------------------
  //
  // Property getters/setters
  //

  RECORD FUNCTION GetCenter()
  {
    RETURN this->map->center;
  }
  MACRO SetCenter(RECORD coordinates)
  {
    this->map->center := coordinates;
  }

  RECORD FUNCTION GetZoom()
  {
    RETURN this->map->zoom;
  }
  MACRO SetZoom(INTEGER zoom)
  {
    this->map->zoom := zoom;
  }

  RECORD FUNCTION GetValue()
  {
    RETURN this->pvt_value;
  }
  MACRO SetValue(RECORD coordinates)
  {
    this->UpdateValue(coordinates, TRUE);
  }
>;
