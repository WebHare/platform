<?wh
LOADLIB "wh::files.whlib";
LOADLIB "mod::system/lib/internal/webhareconstants.whlib";

PUBLIC MACRO PTR onparsedtid;
PUBLIC STRING tidlang := "en";

PUBLIC BOOLEAN FUNCTION IsAbsoluteTid(STRING tid)
{
  RETURN tid LIKE "*:*" OR tid LIKE "~*";
}

PUBLIC STRING FUNCTION ParseXMLGid(STRING defaultmodule, STRING currentgid, OBJECT el, STRING ns, STRING cellname)
{
  IF(NOT el->HasAttributeNS(ns, cellname))
    RETURN currentgid;

  STRING gid := el->GetAttributeNS(ns, cellname);
  IF(Left(gid,1)=".")
    RETURN currentgid || gid;
  IF(gid != "" AND gid NOT LIKE "*:*")
    RETURN defaultmodule || ":" || gid;
  RETURN gid;
}

PUBLIC RECORD FUNCTION GetXMLTidFromName(STRING defaultmodule, STRING currentgid, OBJECT el)
{
  FOREVERY(STRING attr FROM ["cellname", "name"])
    IF(el->HasAttribute(attr))
    {
      STRING name := ToLowercase(el->GetAttribute(attr));
      name := Substring(name,  SearchLastSubstring(name,'.')+1);
      IF(currentgid LIKE "*:*")
        RETURN CELL[ attr, tid := currentgid || "." || name ];

      IF(defaultmodule = "")
        THROW NEW Exception(`ParseXMLTidPtr requires a set module for automatic ${attr}-based titles if the gid doesn't specify one`);
      RETURN CELL[ attr, tid := defaultmodule || ":" || currentgid || "." || name ];
    }

  RETURN DEFAULT RECORD;
}

PUBLIC STRING FUNCTION ParseXMLTidDirectly(STRING resourcename, OBJECT el, STRING tid, STRING attrnametid)
{
  IF(resourcename != "" AND resourcename NOT LIKE "*::*") //no exceptions, noone externally should use this
    THROW NEW Exception("ParseXMLTidDirectly call with invalid resource name");
  IF(onparsedtid != DEFAULT MACRO PTR)
    onparsedtid(CELL[ resourcename, tid, line := el->linenum, col := 0, attrname := attrnametid ]);
  RETURN tid;
}

/** @topic localization/gettid
    @public
    @loadlib mod::tollium/lib/gettid.whlib
    @short Parse a title/tid combination, considering any groupid, default module and name/cellname rules. Returns an empty string if unset, ':' prefixed string for untranslated texts, and otherwise a module:tid combination
*/
PUBLIC STRING FUNCTION ParseXMLTidPtr(STRING resourcename, STRING currentgid, OBJECT el, STRING attrname)
{
  RETURN ParseXMLTidPtrNS(resourcename, currentgid, el, "", attrname);
}

PUBLIC STRING FUNCTION ParseXMLTidPtrNS(STRING resourcename, STRING currentgid, OBJECT el, STRING ns, STRING attrname)
{
  /* validate resourcename, as we used to accept modulename for now we'll tolerate it for old code, but only if targetted at
     an external module (eg embedded blexdev_formsapi). this check can probably go away post 4.29 */
  IF(resourcename != "" AND resourcename NOT LIKE "*::*" AND resourcename IN (whconstant_builtinmodules CONCAT ["webhare_testsuite"]))
    THROW NEW Exception("ParseXMLTidPtr call with invalid resource name");

  STRING attrnametid := attrname LIKE "*title" ? Left(attrname, Length(attrname) - 5) || "tid" : attrname || "tid";
  IF(el->HasAttributeNS(ns, attrnametid))
  {
    STRING tid := el->GetAttributeNS(ns, attrnametid);
    IF(Left(tid,1)='.')
      tid := currentgid || tid;
    IF(NOT IsAbsoluteTid(tid))
    {
      IF(resourcename = "")
        THROW NEW Exception("ParseXMLTidPtr requires a set module if the tid/gid doesn't specify one");
      tid := __GetModuleNameFromResourcePath(resourcename) || ":" || tid;
    }

    IF(onparsedtid != DEFAULT MACRO PTR)
      onparsedtid(CELL[ resourcename, tid, line := el->linenum, col := 0, attrname := attrnametid ]);

    RETURN tid;
  }

  IF(el->HasAttributeNS(ns, attrname))
    RETURN ":" || el->GetAttributeNS(ns, attrname);

  IF(currentgid != "" AND attrname LIKE "*title")
  {
    RECORD trygidfromname := GetXMLTidFromName(__GetModuleNameFromResourcePath(resourcename), currentgid, el);
    IF(RecordExists(trygidfromname))
    {
      IF(onparsedtid != DEFAULT MACRO PTR AND trygidfromname.tid!="")
        onparsedtid(CELL[ resourcename, tid := trygidfromname.tid, line := el->linenum, col := 0, attrname := trygidfromname.attr ]);

      RETURN trygidfromname.tid;
    }
  }

  RETURN "";
}

PUBLIC STRING FUNCTION DetermineNodeGid(STRING resourcename, OBJECT node) // FIXME: add tests
{
  WHILE (ObjectExists(node) AND node->nodetype = 1)
  {
    STRING localgid := node->GetAttribute("gid");
    IF (localgid = "")
    {
      node := node->parentnode;
      CONTINUE;
    }

    IF (localgid LIKE "*:*")
      RETURN localgid;

    STRING parentgid := DetermineNodeGid(resourcename, node->parentnode);
    IF (localgid LIKE ".*")
      RETURN parentgid || localgid;

    RETURN __GetModuleNameFromResourcePath(resourcename) || ':' || localgid;
  }
  RETURN "";
}
