<?wh

LOADLIB "wh::datetime.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::float.whlib";
LOADLIB "wh::witty.whlib";

LOADLIB "mod::publisher/lib/internal/feedback/feedbacksupport.whlib";
LOADLIB "mod::tollium/lib/screenbase.whlib";

LOADLIB "mod::system/lib/resources.whlib";

LOADLIB "mod::wrd/lib/api.whlib";


CONSTANT FLOAT maxscreenshotsize := 640;

PUBLIC STATIC OBJECTTYPE Main EXTEND TolliumScreenBase
< //----------------------------------------------------------------------------
  //
  // Initialization
  //

  MACRO NEW()
  {
    this->contexts->wrdschema := OpenWRDSchema("publisher:feedback");
  }

  MACRO Init(RECORD data)
  {
    ^scope->options :=
        SELECT rowkey := wrd_tag
             , title := ToLowercase(wrd_tag)
          FROM this->contexts->wrdschema->^scope->RunQuery([ outputcolumns := [ "wrd_id", "wrd_tag" ]])
         WHERE this->tolliumuser->HasRightOn("publisher:managefeedbackscope", wrd_id)
         ORDER BY wrd_tag;
    IF (Length(^scope->options) <= 1)
      ^scope->visible := FALSE;
  }


  //----------------------------------------------------------------------------
  //
  // Action handlers
  //

  MACRO DoView()
  {
    IF (^feedback->selection.version != 1)
      this->RunSimpleScreen("warning", this->GetTid(".messages.unsupportedversion"));
    ELSE
      this->RunScreen("#feedback", ^feedback->selection);
  }

  MACRO DoDelete()
  {
    IF (this->RunSimpleScreen("confirm", this->GetTid(".messages.confirmdeletefeedback")) = "yes")
    {
      OBJECT work := this->BeginWork();
      this->contexts->wrdschema->^feedback->UpdateEntity(^feedback->selection.wrd_id, [ wrd_limitdate := GetCurrentDateTime() ]);
      work->Finish();
    }
  }

  MACRO DoExit()
  {
    this->tolliumresult := "close";
  }


  //----------------------------------------------------------------------------
  //
  // Callbacks
  //
  RECORD ARRAY FUNCTION MapFeedbackRows(RECORD ARRAY rows)
  {
    rows := SELECT TEMPORARY reportinfo := EnforceStructure([ realname := "", login := "", emailaddress := "" ], userdata)
                 , *
                 , reportedby     := reportinfo.realname ?? reportinfo.login
                 , reportedbylink := reportinfo.emailaddress != "" ? "mailto:" || reportinfo.emailaddress : ""
              FROM rows;

    RETURN rows;
  }

  MACRO OnSelectScope()
  {
    INTEGER scopeid := this->contexts->wrdschema->^scope->Search("wrd_tag", ^scope->value);
    ^feedback->listfilters := [ [ field := "wrd_leftentity", value := scopeid ] ];
  }
>;

PUBLIC STATIC OBJECTTYPE Feedback EXTEND TolliumScreenBase
< //----------------------------------------------------------------------------
  //
  // Variables
  //

  RECORD data;


  //----------------------------------------------------------------------------
  //
  // Initialization
  //

  MACRO Init(RECORD data)
  {
    this->data := data;
    RECORD feedback := this->contexts->wrdschema->^feedback->GetEntityFields(this->data.rowkey, ["EXTRADATA","SIZE"] CONCAT ^data->GetComposedCellnames());
    ^data->value := feedback;

    // The 'extrafields' cell contains field definitions to show extra data
    IF (CellExists(feedback.extradata, "extrafields") AND TypeID(feedback.extradata.extrafields) = TypeID(RECORD ARRAY))
    {
      // The 'there is no extra data available' text doesn't have to be displayed
      ^noextradata->DeleteComponent();

      FOREVERY (RECORD extra FROM feedback.extradata.extrafields)
      {
        extra := EnforceStructure(
            [ field := ""
            , type := ""
            , title := ""
            , tid := ""
            , optiongid := ""
            ], extra);
        IF (NOT CellExists(feedback.extradata, extra.field))
          CONTINUE;

        OBJECT comp;
        SWITCH (extra.type)
        {
          CASE "string" {
            comp := this->CreateTolliumComponent("text");
            comp->value := GetCell(feedback.extradata, extra.field);
          }
          CASE "integer" {
            comp := this->CreateTolliumComponent("text");
            comp->value := ToString(GetCell(feedback.extradata, extra.field));
          }
          CASE "tid" {
            comp := this->CreateTolliumComponent("text");
            STRING tid := GetCell(feedback.extradata, extra.field);

            // Try to resolve the tid if this is not an absolute tid reference
            IF (tid NOT LIKE "*:*")
            {
              IF (extra.optiongid != "")
                tid := extra.optiongid || "." || tid;
              ELSE
                tid := extra.tid || "-" || tid;
            }
            IF (tid LIKE "*:*")
              comp->value := GetTid(tid);
            ELSE
              comp->value := tid;
          }
        }

        IF (ObjectExists(comp))
        {
          comp->title := extra.tid = "" ? extra.title : GetTid(extra.tid);
          IF (comp->componenttype = "text")
            comp->selectable := TRUE;
          this->frame->bodynode->InsertComponentAfter(comp, DEFAULT OBJECT, TRUE);
        }
      }
    }

    // Load the stored screenshot into the container iframe
    ^screenshot->value := GetScreenshotWitty()->RunComponentToString("container", CELL
        [ width := INTEGER(Ceil(feedback.size.width))
        , height := INTEGER(Ceil(feedback.size.height))
        , url := GetFeedbackScreenshotURL(this->data.rowkey)
        , scaled := ^scaled->value
        ]);
  }


  //----------------------------------------------------------------------------
  //
  // Callbacks
  //

  MACRO OnScaleIframe()
  {
    ^screenshot->PostMessage([ type := "scaled", scaled := ^scaled->value ], "*");
  }
>;
