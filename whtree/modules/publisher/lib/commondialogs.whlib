<?wh
/** @short All dialogs that are used in the publisher module
    @private Interesting dialogs should be moved to dialogs.whlib AND use a Run... instead of Make... workflow
*/
LOADLIB "wh::files.whlib";

LOADLIB "mod::publisher/lib/internal/siteprofiles/reader.whlib";
LOADLIB "mod::publisher/lib/internal/files.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/logging.whlib";
LOADLIB "mod::system/lib/whfs.whlib";



STRING FUNCTION GetDropFullpathFolder(STRING infullpath) //removes last component, strips dupe slashes
{
  RETURN MergePath("", GetDirectoryFromPath(infullpath));
}

OBJECT FUNCTION EnsureDeepFolder(OBJECT base, STRING path)
{
  IF(path="")
    RETURN base;
  FOREVERY(STRING tok FROM Tokenize(path,'/'))
    base := base->EnsureFolder([name:=tok]);
  RETURN base;
}

PUBLIC INTEGER ARRAY FUNCTION DoFilemanagerUpload(OBJECT tolliumscreen, INTEGER basefolderid, RECORD ARRAY files, RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions([ createdownloadableversions := FALSE ], options);

  files := SELECT *, destfolder := CellExists(files,"fullpath") ? GetDropFullpathFolder(files.fullpath) : "" FROM files;
  IF(RecordExists(SELECT FROM files WHERE Length(destfolder)>300 OR Length(Tokenize(destfolder,'/'))>7)) //this is too odd...
    RETURN DEFAULT INTEGER ARRAY;

  //when dropping folders, remove metadata and fork files
  DELETE FROM files WHERE destfolder != "" AND (files.filename LIKE "._*" OR ToUppercase(files.filename) IN ["THUMBS.DB",".DS_STORE"]);

  OBJECT work := tolliumscreen->BeginUnvalidatedWork();
  OBJECT basedestfolder := basefolderid = 0 ? OpenWHFSRootObject() : OpenWHFSObject(basefolderid);
  IF(NOT ObjectExists(basedestfolder))
  {
    work->Cancel();
    RETURN DEFAULT INTEGER ARRAY;
  }

  INTEGER ARRAY rootuploads;
  RECORD ARRAY perfolder := SELECT files := GroupedValues(files)
                                 , destfolder := ANY(destfolder)
                              FROM files
                          GROUP BY ToUppercase(COLUMN destfolder);

  FOREVERY(RECORD uploadgroup FROM perfolder)
  {
    OBJECT uploadtofolder;
    TRY
    {

       uploadtofolder := EnsureDeepFolder(basedestfolder, uploadgroup.destfolder);
    }
    CATCH(OBJECT e)
    {
      LogHarescriptException(e);
      work->Cancel();
      RETURN DEFAULT INTEGER ARRAY;
    }

    OBJECT parenttester := GetApplyTesterForObject(uploadtofolder->id);
    RECORD uploadsettings;
    IF(ObjectExists(parenttester))
      uploadsettings := parenttester->GetFolderSettings();

    BOOLEAN safename := NOT tolliumscreen->contexts->user->GetRegistryKey("publisher.prefs.nouploadrename",FALSE);

    FOREVERY(RECORD file FROM uploadgroup.files)
    {
      RECORD filemeta := [ name := ""
                         , data := file.data
                         , publish := TRUE //default for direct publisher uploads, will be blocked by filetype where needed
                         ];

      IF(RecordExists(uploadsettings) AND uploadsettings.ordering = "orderable")
        INSERT CELL ordering := (SELECT AS INTEGER Max(ordering) + 1 FROM system.fs_objects WHERE parent = uploadtofolder->id) INTO filemeta;
      IF(ObjectExists(parenttester))
        INSERT CELL type := parenttester->GetUploadFileTypeMapping(file.filename, file.mimetype) INTO filemeta;

      filemeta.name := uploadtofolder->GenerateUniqueName(file.filename, [ safename := safename ]);

      OBJECT res := uploadtofolder->CreateFile(filemeta); //ADDME: Allow 'publish:=true' to be set and createfile do the 'thinking' worwk
      IF(ObjectExists(res))
      {
        IF(res->type = 4 AND options.createdownloadableversions)
          res->UpdateMetadata([type := OpenWHFSType("http://www.webhare.net/xmlns/publisher/msworddownload")->id]);

        RunAddFileHooks(res->id);

        INTEGER addid := uploadtofolder = basedestfolder ? res->id : uploadtofolder->id;
        IF(addid NOT IN rootuploads)
          INSERT addid INTO rootuploads AT END;
      }

      //when a file is the first upload in a folder and an acceptabel index, it should become one
      IF(Length(uploadgroup.files) = 1
        AND res->isacceptableindex
        AND Length(SELECT FROM system.fs_objects WHERE parent = uploadtofolder->id AND NOT isfolder) = 1)
      {
        uploadtofolder->UpdateMetadata([indexdoc := res->id]);
      }
    }
  }

  IF(NOT work->Finish())
    RETURN DEFAULT INTEGER ARRAY;

  RETURN rootuploads;
}

PUBLIC BOOLEAN FUNCTION DoFilemanagerReplace(OBJECT tolliumscreen, INTEGER filetoreplace, RECORD uploadedfile)
{
  OBJECT file := OpenWHFSObject(filetoreplace);
  IF(NOT ObjectExists(file) OR file->isfolder)
    RETURN FALSE;

  // Check content types - they should be the same. If not, add a warning.
  RECORD original_filetype := ScanBlob(file->data, file->name);
  RECORD new_filetype := ScanBlob(uploadedfile.data, uploadedfile.filename);
  IF (ToUpperCase(original_filetype.mimetype) != ToUpperCase(new_filetype.mimetype)
      AND tolliumscreen->RunMessageBox("publisher:commondialogs.replace_file_with_other_type") != "yes")
  {
    RETURN FALSE;
  }

  OBJECT parenttester := GetApplyTesterForObject(file->parent);
  OBJECT work := tolliumscreen->BeginUnvalidatedWork();
  file->UpdateData(uploadedfile.data);
  RETURN work->Finish();
}

PUBLIC OBJECT FUNCTION CreateSiteSelectDialog(OBJECT parent)
{
  RETURN parent->LoadScreen("publisher:commondialogs.selectsitedialog", DEFAULT RECORD);
}
