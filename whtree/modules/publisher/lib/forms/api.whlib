<?wh
/** @short APIs for managing form files
    @topic forms/api
*/

LOADLIB "mod::publisher/lib/siteprofiles.whlib";
LOADLIB "mod::publisher/lib/internal/forms/opener.whlib" EXPORT OpenForm;
LOADLIB "mod::publisher/lib/internal/forms/formdef.whlib" EXPORT CreateNewFormdefinitionsFile, OpenWHFSFormDefinitionsFile;
LOADLIB "mod::publisher/lib/internal/forms/parser.whlib";
LOADLIB "mod::publisher/lib/internal/forms/results.whlib";
LOADLIB "mod::publisher/lib/forms/base.whlib";

LOADLIB "mod::system/lib/configure.whlib";
LOADLIB "mod::system/lib/logging.whlib";
LOADLIB "mod::system/lib/resources.whlib";
LOADLIB "mod::system/lib/services.whlib";
LOADLIB "mod::system/lib/whfs.whlib";


/** @short Open a formdefinition WHFS file
    @param formfile File to open
    @return(object %FormDefinitionsFile) An opened formdefinition
*/
PUBLIC OBJECT FUNCTION OpenFormFileDefinition(OBJECT formfile, RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions([ formname := "webtoolform" ], options);
  RETURN OpenWHFSFormDefinitionsFile(formfile)->OpenFormDefinition(options.formname);
}

/** @short Open the result storage of a formdefinition WHFS file
    @param formfile File to open
    @cell(string) options.formname The name of the form to open the results for, defaults to `webtoolform` for webtool forms
    @cell(boolean) options.initcustomform If this is a custom form, initialize the custom form object. Make sure this doesn't
        run code that can only run within a request context!
    @return(object %WHFSForm) Form results, or DEFAULT OBJECT if the file does not contain a valid webtool form
*/
PUBLIC OBJECT FUNCTION OpenFormFileResults(OBJECT formfile, RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions(
      [ formname := "webtoolform"
      , initcustomform := FALSE
      ], options);

  STRING formdefname;
  STRING formname := options.formname;
  IF (options.formname LIKE "*#*")
  {
    formdefname := Tokenize(formname, "#")[0];
    formname := Substring(formname, Length(formdefname) + 1);
  }

    // First try opening the form file directly
  OBJECT formdef := OpenFormFileDefinition(formfile, [ formname := options.formname ]);

  // Check if there are formdefinitions applied to the file
  IF (NOT ObjectExists(formdef))
  {
    OBJECT applytester := GetApplyTesterForObject(formfile->id);
    RECORD formdefs := applytester->GetFormDefinitionFile(formdefname);
    IF (RecordExists(formdefs))
    {
      // We have a form definitions file resource path
      TRY
      {
        // Open the form definitions file by resource path
        BLOB formdefxml := GetWebHareResource(formdefs.path);
        OBJECT formdeffile := CreateNewFormdefinitionsFile();
        formdeffile->ImportFromRecord([ formtext := formdefxml ], [ resourcename := formdefs.path ]);
        formdef := formdeffile->OpenFormDefinition(formname);
      }
      CATCH (OBJECT e)
      {
        LogHareScriptException(e);
      }
    }
  }
  IF(NOT ObjectExists(formdef))
    RETURN DEFAULT OBJECT;

  RETURN OpenWebtoolFormResultsForFormdef(formfile, /*formdef->ListFields(), */options.formname, formdef, CELL[ options.initcustomform ]);
}

PUBLIC OBJECT FUNCTION __DoOpenWebtoolForm(OBJECT formobject, OBJECT webcontext, OBJECT applytester, BOOLEAN selfhosted, INTEGER targetid)
{
  OBJECT formdefs := OpenWHFSFormDefinitionsFile(formobject);
  OBJECT mainform := formdefs->OpenFormDefinition("webtoolform");
  IF(NOT ObjectExists(mainform))
    RETURN DEFAULT OBJECT;

  INTEGER webtoolformid := formobject->id;
  OBJECT openasdraft := OpenWHFSDraft(webtoolformid);
  IF(ObjectExists(openasdraft))
    webtoolformid := openasdraft->source;

  RECORD parseresult := ParseFormDef(mainform->node, "webtoolform", "", "", formdefs, [/* externalformname := formname
                                                                                      , */webtoolformid := webtoolformid
                                                                                      ]);
  IF(parseresult.objectname = "")
    parseresult.objectname := "mod::publisher/lib/internal/forms/webtool.whlib#WebtoolFormBase";

  OBJECT form := OpenFormByDef(parseresult, CELL[ webcontext, applytester ]);
//ABORT(targetid);
  IF(NOT selfhosted OR (GetDtapStage() = "development" AND formobject->whfspath NOT IN __webhare_ci_routingexceptions)) // in the future we should ALWAYS take the __formwidget path
    form->__form.externalformname := "__formwidget:" || EncryptForThisServer("publisher:formwidget", [ target := targetid ]);

  RETURN form;
}

/** @short Open a webtool form directly
    @param formid File id to open
    @return Opened form */
PUBLIC OBJECT FUNCTION OpenWebtoolForm(INTEGER formid, RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions([ applytester := DEFAULT OBJECT
                             , webcontext := DEFAULT OBJECT
                             ], options);

  IF(NOT ObjectExists(options.applytester))
    IF(ObjectExists(options.webcontext))
      options.applytester := options.webcontext->applytester;
    ELSE
      options.applytester := GetApplyTesterForObject(formid);

  IF(options.webcontext = DEFAULT OBJECT)
    options.webcontext := __GetWebContextForApplyTester(options.applytester, formid);

  OBJECT form := __DoOpenWebtoolForm(OpenWHFSObject(formid), options.webcontext, options.applytester, TRUE, formid);
  IF(NOT ObjectExists(form))
    THROW NEW Exception(`Cannot open form for fsobject #${formid}`);

  RETURN form;
}
