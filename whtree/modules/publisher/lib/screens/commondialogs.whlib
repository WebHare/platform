<?wh

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::tollium/lib/screenbase.whlib";
LOADLIB "mod::tollium/lib/internal/support.whlib";


PUBLIC OBJECTTYPE SelectSiteDialog EXTEND TolliumScreenBase
< // ---------------------------------------------------------------------------
  //
  // Variables
  //

  OBJECT selecthelper;

  // ---------------------------------------------------------------------------
  //
  // Public properties
  //

  /// Id of currently selected site
  PUBLIC PROPERTY value(this->sites->value, this->sites->value);

  // ---------------------------------------------------------------------------
  //
  // Init
  //

  MACRO Init(RECORD data)
  {
    this->selecthelper := NEW ListFilterSelectionHelper(this->sites, PTR this->RefreshList);
    this->selecthelper->RefreshList();
  }

  // ---------------------------------------------------------------------------
  //
  // Events
  //

  MACRO GotFilterChange()
  {
    this->selecthelper->RefreshList();
  }

  // ---------------------------------------------------------------------------
  //
  // List fill
  //

  MACRO RefreshList()
  {
    STRING filter := Substitute(ToUppercase("*" || Substitute(this->filter->value, " ", "*") || "*"), "**", "*");

    RECORD ARRAY sites :=
        SELECT fs_objects.id
             , fs_objects.name
          FROM system.fs_objects
             , system.sites
         WHERE fs_objects.id = sites.id
           AND ToUppercase(fs_objects.name) LIKE ToUppercase(filter);

    INTEGER ARRAY visible_ids := this->tolliumuser->HasRightOnMultiple("system:fs_browse", SELECT AS INTEGER ARRAY id FROM sites);
    this->sites->rows :=
        SELECT rowkey :=  id
             , *
          FROM sites
         WHERE id IN visible_ids;
  }
>;

