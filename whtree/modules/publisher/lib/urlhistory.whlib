<?wh
/* public urlhistory APIs */

LOADLIB "mod::publisher/lib/internal/urlhistory.whlib" EXPORT AddURLHistoryEntry;
LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/webserver.whlib";

/** Redirect if a history URL is available. This function is intended for custom 404 pages */
PUBLIC MACRO TryRedirectUsingURLHistory(RECORD options DEFAULTSTO DEFAULT RECORD)
{
  options := ValidateOptions( [ passthrough := DEFAULT STRING ARRAY ], options); //FIXME obsolete passthrough, remove from UT first

  OBJECT trans;
  TRY
  {
    IF(NOT HavePrimaryTransaction())
      trans := OpenPrimary();

    STRING requrl := GetRequestURL();
    RECORD dest := GetURLHistoryRedirect(requrl, FALSE, FALSE);
    IF(NOT RecordExists(dest))
    {
      //If normal url failed, see if its worthwhile to use the client's URL. This may happen for non-virtualhosted requests
      STRING clientrequrl := GetClientRequestURL();
      IF(clientrequrl != requrl)
      {
        //TODO normalize host/server part ourselves instead of relying on client
        dest := GetURLHistoryRedirect(clientrequrl, FALSE, FALSE);
      }
    }
    IF(RecordExists(dest) AND dest.desturl != "")
      Redirect(dest.desturl, 301);
 }
  FINALLY
  {
    IF(ObjectExists(trans))
      trans->Close();
  }

}
