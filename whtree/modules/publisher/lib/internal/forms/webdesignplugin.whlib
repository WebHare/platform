<?wh

LOADLIB "wh::files.whlib";
LOADLIB "wh::xml/xsd.whlib";

LOADLIB "mod::system/lib/configure.whlib";

LOADLIB "mod::publisher/lib/webdesign.whlib";
LOADLIB "mod::publisher/lib/internal/forms/rendering.whlib";
LOADLIB "mod::publisher/lib/internal/forms/support.whlib";

LOADLIB "mod::wrd/lib/internal/addressfields.whlib";

PUBLIC OBJECTTYPE FormIntegrationPlugin EXTEND WebDesignPluginBase
<
  PUBLIC STRING spamchecklib;
  PUBLIC STRING spamcheckopts;
  PUBLIC STRING buttonpath;

  PUBLIC PROPERTY manualwebpackembed(pvt_manualwebpackembed, SetManualwebpackEmbed);
  PUBLIC PROPERTY usecaptcha(this->__config.usecaptcha, -);
  PUBLIC PROPERTY allowsubmittype(this->__config.allowsubmittype, -);
  PUBLIC PROPERTY countrylist(this->__config.countrylist, -);
  PUBLIC PROPERTY addressoptions(this->__config.addressoptions, -);
  PUBLIC PROPERTY enablepagetitles(this->__config.enablepagetitles, -);
  PUBLIC PROPERTY enableinfotexts(this->__config.enableinfotexts, -);
  PUBLIC PROPERTY infotextrtdtype(this->__config.infotextrtdtype, -);
  PUBLIC PROPERTY mailrtdtype(this->__config.mailrtdtype, -);
  PUBLIC PROPERTY webtoolformhooks(this->__config.webtoolformhooks, -);
  PUBLIC PROPERTY config(this->__config,-);

  OBJECT webcontext;
  BOOLEAN didintegrate;
  BOOLEAN pvt_manualwebpackembed;
  BOOLEAN __haswebpack;  //FIXME drop in wh6.0
  RECORD __config;

  MACRO NEW()
  {
    IF(IsModuleInstalled("webpack"))
    {
      this->__haswebpack := TRUE;
      ExtendObject(this, "mod::webpack/lib/internal/formsplugin.whlib", "WebpackFormsPlugin");
    }
  }

  UPDATE PUBLIC MACRO ConfigureYamlPlugin(OBJECT webcontext, RECORD ARRAY props) {
    this->webcontext := webcontext;
    this->__config := CombineFormPluginConfiguration(props);

    IF(this->__haswebpack)
      this->__ConfigureWebpack(webcontext);
  }

  //initialize the plugin during runtime, using the provided nodes
  UPDATE PUBLIC MACRO PrepareForRendering(OBJECT webcontext)
  {
    IF(this->__haswebpack)
      this->__PrepareWebpack();
  }

  PUBLIC RECORD ARRAY FUNCTION GetContentNav()
  {
    //ADDME: Share this link generation code with webpack.whlib?
    RETURN SELECT title
                , link := "#" || GetSafeFileName(title || "-wh" || instanceid)
                , tagname := "div" // Make it compatible with webcontextBase::GetContentNav
             FROM this->items
            WHERE title != "";
  }

  MACRO SetManualwebpackEmbed(BOOLEAN manualwebpackembed)
  {
    IF (this->didintegrate)
      THROW NEW Exception("Manual embed cannot be set after the page has been rendered");
    this->pvt_manualwebpackembed := manualwebpackembed;
  }

  PUBLIC OBJECT FUNCTION GetFormRenderer()
  {
    RETURN NEW FormRenderingBase(this->webcontext);
  }
>;
