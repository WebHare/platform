<?wh
LOADLIB "mod::system/lib/internal/webhareconstants.whlib";

PUBLIC RECORD FUNCTION CombinePartialNodes(RECORD ARRAY nodes)
{
  nodes := SELECT * FROM nodes WHERE RecordExists(nodes); //custom plugins currently wind up with 1 [DEFAULT RECORD] here

  RECORD retval;
  STRING ARRAY setfields;
  FOREVERY(RECORD upd FROM nodes)
  {
    IF(#upd=0)
    {
      setfields := upd.__attributes;
      retval := upd;
      CONTINUE;
    }
    //later nodes, only update the values that were actually set
    FOREVERY(STRING attr FROM upd.__attributes)
      IF(CellExists(upd, attr))
      {
        IF(attr NOT IN setfields)
          INSERT attr INTO setfields AT END;
        retval := CellUpdate(retval, attr, GetCell(upd, attr));
      }
  }
  DELETE CELL __attributes FROM retval;
  INSERT CELL __setfields := setfields INTO retval;

  INSERT CELL setattributes := retval.__setfields INTO retval;
  DELETE CELL __setfields, __location FROM retval;
  RETURN retval;
}


PUBLIC INTEGER FUNCTION GetFSMemberTypeID(STRING membertypename)
{
  RETURN SearchElement(whconstant_whfstype_membertypes, ToLowercase(membertypename));
}
PUBLIC STRING FUNCTION GetFSMemberTypeName(INTEGER membertypeid)
{
  IF(membertypeid >=0 AND membertypeid < Length(whconstant_whfstype_membertypes))
    RETURN whconstant_whfstype_membertypes[membertypeid];
  ELSE
    RETURN "";
}

/* basic types */
PUBLIC RECORD FUNCTION GetBaseFiletypeRecord()
{
  RETURN [ extensions := DEFAULT STRING ARRAY
         , blobiscontent := FALSE
         , pagelistprovider := ""
         , requirescontent := FALSE
         , generatepreview := FALSE
         , previewlibrary := ""
         , previewobjectname := ""
         , searchcontentprovider := ""
         , indexversion := ""
         , isacceptableindex := FALSE
         , needstemplate := FALSE
         , ispublishable := FALSE
         , ispublishedassubdir := FALSE
         , capturesubpaths := FALSE
         ];
}

PUBLIC RECORD FUNCTION GetBaseFolderTypeRecord()
{
  RETURN [ indexfile := ""
         , protectindexfile := FALSE
         , ishidden := FALSE
         ];
}

PUBLIC RECORD FUNCTION MakePluginRecord(STRING objectname)
{
  RETURN [ objectname := objectname
         , name := ""
         , namespace := ""
         , hooksplugins := DEFAULT RECORD ARRAY
         , hooksfeatures := DEFAULT STRING ARRAY
         ];
}

PUBLIC RECORD FUNCTION InstantiatePlugin(RECORD plugin)
{
  INSERT CELL combine := TRUE
            , wittyname := ""
            , data := DEFAULT RECORD
         INTO plugin;
  RETURN plugin;
}

PUBLIC RECORD FUNCTION MakeBasicTypeInfo(STRING type)
{
  RETURN [ id := 0
         , namespace := ""
         , type := type
         , siteprofile :=        ""
         , line := 0
         , title := ""
         , tolliumicon := ""
         , groupmemberships := DEFAULT RECORD ARRAY
         , isembeddedobjecttype := type = "widgettype"
         , isrtdtype := type = "rtdtype"
         , wittycomponent := ""
         , previewcomponent := ""
         , filetype := DEFAULT RECORD
         , foldertype := DEFAULT RECORD
         , orphan := FALSE
         , cloneoncopy := TRUE
         , isdevelopertype := FALSE //TODO can we deprecate this and just have 'ishidden' and allowfiletype/allowfoldertype deal with this?
         , dynamicexecution := DEFAULT RECORD
         ];
}

PUBLIC RECORD FUNCTION MakeBaseSiteprofileXMLStructure()
{
  RETURN MakeMergedRecord(MakeBasicTypeInfo("rtdtype"),
         [ structure := DEFAULT RECORD
         , cssfiles := DEFAULT RECORD ARRAY
         , internallinkroots := DEFAULT INTEGER ARRAY
         , css := ""
         , htmlclass := ""
         , bodyclass := ""
         , allowedobjects := DEFAULT RECORD ARRAY
         , allownewwindowlinks := FALSE
         , ignoresiteprofilewidgets := FALSE
         , applytester := DEFAULT OBJECT
         , linkhandlers := DEFAULT RECORD
         , margins := ""
         , tag_b := "b"
         , tag_i := "i"
         ]);
}
