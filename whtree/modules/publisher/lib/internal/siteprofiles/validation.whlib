<?wh
LOADLIB "mod::publisher/lib/internal/siteprofiles/parser.whlib";
LOADLIB "mod::system/lib/resources.whlib";
LOADLIB "mod::system/lib/internal/resources.whlib";
LOADLIB "mod::system/lib/internal/webhareconstants.whlib";
LOADLIB "mod::tollium/lib/internal/validation.whlib";

PUBLIC STATIC OBJECTTYPE SiteprofValidator EXTEND ScreensFileValidator
<
  MACRO EnsureNoFSInstance(OBJECT extension)
  {
    FOREVERY(OBJECT node FROM extension->ListElements("*","*"))
      IF(node->GetAttribute("composition") = "fsinstance")
      {
        this->AddWarning(node, `This node refers to composition="fsinstance", are you sure you didn't mean composition="contentdata" ?`);
        BREAK; //one warning of this type per extension is enough
      }
  }

  UPDATE PUBLIC MACRO ValidateDocument()
  {
    ScreensFileValidator::ValidateDocument();
    IF(this->respath LIKE "mod*")
    {
      FOREVERY(OBJECT node FROM this->xml->GetElementsByTagNameNS("http://www.webhare.net/xmlns/system/moduledefinition","services")->GetCurrentElements())
        this->AddError(node, "Module siteprofiles should not contain service definitions - move your services to the module");
    }

    FOREVERY(OBJECT widgettype FROM this->xml->ListElements("http://www.webhare.net/xmlns/publisher/siteprofile","widgettype"))
    {
      OBJECT extension := this->VerifyScreenReferenceExistence(widgettype->linenum, widgettype->GetAttribute("editextension"), "tabsextension");
      //extra sanity check, composition name=fsinstance is always a mistake?
      IF(ObjectExists(extension))
        this->EnsureNoFSInstance(extension);
    }

    RECORD parseres := ParseSiteProfile(this->respath, "", [ xmldoc := this->xml ]); //ADDME forwards XSD?
    this->errors := this->errors CONCAT SELECT code := 0, col, line, message, resourcename FROM parseres.value.errors;
    this->warnings := this->warnings CONCAT SELECT code := 0, col, line, message, resourcename FROM parseres.value.warnings;
    IF(this->syntaxlevel_2020)
    {
      FOREVERY(OBJECT propertyeditor FROM this->xml->ListElements("http://www.webhare.net/xmlns/publisher/siteprofile","propertyeditor"))
        this->AddError(propertyeditor, "<propertyeditor>s should be replaced by tabsextensions");
      FOREVERY(OBJECT embeddedobjecttype FROM this->xml->ListElements("http://www.webhare.net/xmlns/publisher/siteprofile","embeddedobjecttype"))
        this->AddError(embeddedobjecttype, "<embeddedobjecttype>s should be replaced by widgettypes");
    }
  }
>;
