<?wh

LOADLIB "wh::datetime.whlib";

LOADLIB "mod::publisher/lib/siteprofiles.whlib";
LOADLIB "mod::publisher/lib/webtools/forum.whlib";

LOADLIB "mod::system/lib/database.whlib";
LOADLIB "mod::system/lib/services.whlib";

PUBLIC OBJECT FUNCTION OpenForumByToken(STRING forumtoken)
{
  RECORD forumdata := DecryptForThisServer("publisher:commentsplugin", forumtoken);
  OBJECT forumobj := OpenForum(forumdata.id, [ verifycreationdate := forumdata.cd ]);
  RETURN forumobj;
}

PUBLIC RECORD FUNCTION RPC_GetCommentsState(STRING forumtoken, STRING urlpath)
{
  OpenPrimary();
  OBJECT forumobj := OpenForumByToken(forumtoken);
  STRING languagecode := GetSiteLanguage(forumobj->id);

  INTEGER numentries := 0;
  RECORD ARRAY entries;
  DATETIME closedate;

  //FIXME configurable datetime format, timezone
  //and immediate get the requested entries
  entries := forumobj->GetMessagesByPage(0, "");
  entries := SELECT name := postername
                  , postdate := FormatDatetime("%d %B %Y %H:%M", UTCToLocal(creationdate, "CET"), languagecode)
                  , postisodate := FormatISO8601Datetime(creationdate)
                  , message := EncodeHTML(content) //FIXME should probably follow contenttype
                FROM entries;

  BOOLEAN isopen := forumobj->closedate = DEFAULT DATETIME OR GetCurrentDatetime() < forumobj->closedate;

  RETURN [ success := TRUE
         , numentries := numentries
         , entries := entries
         , closed := NOT isopen
         ];
}
