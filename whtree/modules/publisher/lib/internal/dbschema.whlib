<?wh
/** @private This library offers the internal table definitions implementing the publisher
*/

LOADLIB "mod::system/lib/database.whlib";


/** @schemadef publisher
*/
PUBLIC SCHEMA
  < TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "file" NULL := 0
    , DATETIME "when"
    , INTEGER "event"
    , INTEGER "folder" NULL := 0
    , INTEGER "modifiedby" NULL := 0
    ; KEY id
    > schedule

  , TABLE
    < INTEGER id NULL := 0
    , INTEGER fsobject NULL := 0
    , DATETIME creationdate
    , STRING url
    , STRING urlhash __ATTRIBUTES__(BINARY)
    ; KEY id
    > urlhistory

  , TABLE
    < INTEGER "id" NULL := 0
    , STRING "hash"
    , DATETIME "created"
    , DATETIME "lastuse"
    , INTEGER "designfolder" NULL := 0
    , STRING datahash
    ; KEY id
    > compileddesigns


    ///////////////////////////////////////////////////////////////
    //
    //  BLIT

  , TABLE
    < INTEGER "id" NULL := 0
    , DATETIME "modificationdate"
    , STRING "hash"
    , STRING "contenttype"
    ; KEY id
    > blithashcache

  , TABLE
    < INTEGER "id" NULL := 0
    , STRING "hash"
    , INTEGER "hashhash"
    , BLOB "data"
    , DATETIME "expires"
    ; KEY id
    > blitrepocache


    ///////////////////////////////////////////////////////////////
    //
    //  Webtools / Polls

  , TABLE
    < INTEGER  "id" NULL := 0
    , INTEGER  "poll_fsobject" NULL := 0
    , STRING   "guid"
    , INTEGER  "votes"
    , BOOLEAN  "hide"  // not meant to publish and not available to cast votes on
    , STRING   "title"
    ; KEY id
    > polloptions

  , TABLE
    < INTEGER  "id" NULL := 0
    , INTEGER  "poll_fsobject" NULL := 0
    , STRING   "ipaddress"
    , STRING   "useragent"
  //, STRING   "userguid"
    , DATETIME "when"
    ; KEY id
    > pollvoters

  , TABLE
    < INTEGER  "id" NULL := 0
    , INTEGER  "voter" NULL := 0
    , INTEGER  "option" NULL := 0
    ; KEY id
    > pollvotes


    ///////////////////////////////////////////////////////////////
    //
    //  Webtools / Forms

  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "status"
    , INTEGER "form_fsobject" NULL := 0
    , STRING "form_name"
    , STRING "guid"
    , INTEGER "replacedby" NULL := 0
    , STRING "url"
    , STRING "languagecode"
    , DATETIME "when"
    , DATETIME "modified"
    , DATETIME "expiration"
    , DATETIME "deletion"
    , STRING "ipaddress"
    , STRING "useragent"
    , STRING "ipcountrycode"
    , STRING "results"
    , BLOB "blobresults"
    , STRING "idfield"
    , STRING "wrdguid" __ATTRIBUTES__(BINARY)
    ; KEY id
    > formresults

  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "formresult" NULL := 0
    , STRING "question"
    , STRING "metadata"
    , BLOB "file"
    ; KEY id
    > formattachments

  , TABLE
    < INTEGER "id" NULL := 0
    , BLOB "blobdata"
    , STRING "data"
    , INTEGER "formresult" NULL := 0
    , STRING "tag"
    ; KEY "id"
    > "formresultskvstore"

  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "postertype" NULL := 0
    , STRING "uuid"
    ; KEY id
    > forums
  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "forum" NULL := 0
    , INTEGER "parent" NULL := 0
    , STRING "title"
    , STRING "description"
    , INTEGER "numtopics"
    , STRING "tag"
    , DATETIME "creationdate"
    , INTEGER "ordering"
    , BOOLEAN "newtopics"
    ; KEY id
    > subforums
  , TABLE
    < INTEGER "id" NULL := 0
    , DATETIME "creationdate"
    , INTEGER "subforum" NULL := 0
    , STRING "topic"
    , INTEGER "firstposting" NULL := 0
    , INTEGER "lastposting" NULL := 0
    , INTEGER "ordering"
    , INTEGER "numentries"
    , BOOLEAN "sticky"
    , STRING "tag"
    , BOOLEAN "locked"
    , INTEGER "linkedfileid" NULL := 0
    , DATETIME "closedate"
    ; KEY id
    > forumtopics
  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "topic" NULL := 0
    , INTEGER "inreplyto" NULL := 0
    , DATETIME "creationdate"
    , DATETIME "modificationdate"
    , INTEGER "postingtype"
    , STRING "content"
    , STRING subject
    , BOOLEAN "attachments"
    , STRING "postersource"
    , STRING "postername"
    , STRING "posteremail"
    , STRING "posteruid"
    , BOOLEAN "deleted"
    ; KEY id
    > forumpostings
  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "posting" NULL := 0
    , BLOB "data"
    , BLOB "displayversion"
    , STRING "mimetype"
    , STRING "displaymimetype"
    , STRING "filename"
    , STRING "description"
    , INTEGER "ordering"
    , INTEGER "type"
    ; KEY id
    > forumattachments


    ///////////////////////////////////////////////////////////////
    //
    //  Work lists

  , TABLE
    < INTEGER "id" NULL := 0
    , STRING "name"
    , STRING "tag"
    , INTEGER "owner" NULL := 0
    , DATETIME "creationdate"
    ; KEY id
    > worklists

  , TABLE
    < INTEGER "id" NULL := 0
    , INTEGER "listid" NULL := 0
    , INTEGER "objectid" NULL := 0
    , DATETIME "creationdate"
    , STRING "comments"
    , DATETIME "resolveddate"
    , INTEGER "resolvedby" NULL := 0
    ; KEY id
    > worklistitems

  > publisher;

/** @short Bind the publisher and system module tables
    @long This function binsd both publisher and system tables to the specified transaction, to ensure backwards compatibility with other WebHares which expect binding the publisher to bind the system tables
    @param transaction ID of the transaction to which the tables should be bound
*/
MACRO BindPublisherTables(INTEGER transaction)
{
  publisher := BindTransactionToSchema(transaction, "publisher");
}

SetupPrimaryTransactionBinder(PTR BindPublisherTables);
