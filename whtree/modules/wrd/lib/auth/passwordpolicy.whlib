<?wh

/** @short WRD authentication
    @topic wrdauth/api
*/

LOADLIB "wh::adhoccache.whlib";
LOADLIB "wh::crypto.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::internet/webbrowser.whlib";

LOADLIB "mod::tollium/lib/gettid.whlib";


OBJECT pwnedbrowser;

/** Queries the haveibeenpwned (HIBP) service for the breach count of a password
    @param pwd Password to query
    @return Cachable record
    @cell return.value Breach count
    @cell return.ttl Cache ttl
*/
RECORD FUNCTION GetCacheablePwnCount(STRING pwd)
{
  IF(NOT Objectexists(pwnedbrowser))
  {
    pwnedbrowser := NEW WebBrowser;
    pwnedbrowser->timeout := 3000; //3 secs is more than enough
  }

  STRING pwdhash := ToUppercase(EncodeBase16(GetSHA1Hash(pwd)));

  INTEGER numbreaches := -1;
  IF(pwnedbrowser->GotoWebPage(`https://api.pwnedpasswords.com/range/${Left(pwdhash,5)}`))
  {
    STRING data := BlobToString(pwnedbrowser->content);
    INTEGER hashpos := SearchSubstring(data, Substring(pwdhash,5));
    IF(hashpos = -1)
    {
      numbreaches := 0;
    }
    ELSE
    {
      INTEGER countstart := hashpos + 36; //35 remaining chars plus :
      INTEGER countend := SearchSubstring(data, '\n', countstart);
      numbreaches := ToInteger(Substring(data, countstart, countend - countstart - 1), -1);
    }
  }
  RETURN [ value := numbreaches
         , ttl := 30*60*1000
         ];
}

/** Queries the haveibeenpwned (HIBP) service for the breach count of a password
    @param pwd Password to query
    @return Breach count (cached for up to 30 minutes)
*/
PUBLIC INTEGER FUNCTION GetPasswordBreachCount(STRING pwd)
{
  RETURN GetAdhocCached(CELL[pwd], PTR GetCacheablePwnCount(pwd));
}
