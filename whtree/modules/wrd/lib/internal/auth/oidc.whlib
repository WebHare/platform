<?wh

LOADLIB "wh::adhoccache.whlib";
LOADLIB "wh::files.whlib";
LOADLIB "wh::internet/webbrowser.whlib";

LOADLIB "mod::system/lib/logging.whlib";
LOADLIB "mod::system/lib/webapi/oauth2.whlib";


RECORD FUNCTION GetOpenIDConnectMetadata(STRING metadataurl)
{
  //TODO On any data failure, log info to RPClog
  OBJECT browser := NEW WebBrowser;
  LogRPCForWebbrowser("wrd:auth-oidc", "", browser);
  IF(NOT browser->GotoWebPage(metadataurl))
    THROW NEW Exception(`Metadata unavailable from ` || metadataurl);

  RECORD metadata := DecodeJSONBlob(browser->content);
  IF(NOT RecordExists(metadata))
    THROW NEW Exception(`Metadata could not be parsed`);

  IF(NOT browser->GotoWebPage(metadata.jwks_uri))
    THROW NEW Exception(`JWKS keys unavailable`);

  RETURN[ value := [ authorizeurl := metadata.authorization_endpoint
                   , authtokenurl := metadata.token_endpoint
                   , issuer := metadata.issuer
                   , keys := BlobToString(browser->content)  //the jwks_uri content
                   ]
        , ttl := 15 * 60 * 1000
        , eventmasks := ["system:internal.clearopenidcaches"]
        ];
}

PUBLIC RECORD FUNCTION GetOIDCMetadata(STRING metadataurl)
{
  RETURN GetAdhocCached(CELL[ metadataurl ], PTR GetOpenIDConnectMetadata(metadataurl));
}

PUBLIC OBJECT FUNCTION GetOIDCOauth2Connection(RECORD spinfo)
{
  RECORD metadata := GetOIDCMetadata(spinfo.metadataurl);
  OBJECT oauth2 := NEW Oauth2Connection(
      CELL[ spinfo.clientid
          , spinfo.clientsecret
          , metadata.authorizeurl
          , metadata.authtokenurl
          , rpclogsource := "wrd:auth-oidc"
          ]);
  RETURN oauth2;
}

PUBLIC RECORD FUNCTION GuessOpenIdIcon(STRING metadataurl) {
  IF(metadataurl LIKE "https://login.microsoftonline.com/*")
    RETURN [ frontend := "/.wh/ea/p/providers/microsoft.24x24.c.svg"
           , tollium := "tollium:misc/microsoft"
           ];
  IF(metadataurl LIKE "https://accounts.google.com/*")
    RETURN [ frontend := "/.wh/ea/p/providers/google.24x24.c.svg"
           , tollium := "tollium:misc/google"
           ];

  RETURN [ frontend := "/.wh/ea/p/providers/idp.24x24.c.svg"
         , tollium := "tollium:misc/loginservice"
         ];
}
