<schemadefinition xmlns="http://www.webhare.net/xmlns/wrd/schemadefinition">

  <migration tag="wrd:migratesettings"
             at="update"
             revision="4"
             stage="afterEntities"
             updatefunction="mod::wrd/lib/internal/metadata/migrations.whlib#MigrateSettings" />

  <object tag="wrd_relation" title="Relation" />

  <object tag="wrd_person" haspersonaldata="true" parent="wrd_relation" title="Person" />

  <object tag="wrd_organization" parent="wrd_relation" title="Organization">
    <attributes>
      <free tag="wrd_orgname" title="Organization name" />
    </attributes>
  </object>

  <object tag="wrd_settings" title="Schema settings">
    <attributes>
      <array tag="migrations">
        <free tag="tag" required="true" />
        <datetime tag="finished" description="When the migration completed" required="true" />
        <record tag="result" description="Result returned by the migration script" />
        <integer tag="revision" description="Update revision. Script is rerun if last update had a lower number than us" />
      </array>
      <array tag="syncpoints" unsafetocopy="true">
        <!-- syncpoints peers are installation specific -->
        <free tag="peer" required="true" />
        <free tag="remotewrdschema" required="true" />
      </array>
      <free tag="domain_secret" description="Shared secret for WRDAuth tokens" unsafetocopy="true" />
      <free tag="password_validation_checks" description="Global checks" />
      <json tag="login_settings"
            description="Login configuration (see wrdauth_defaultconfiguration)"
            typedeclaration="@webhare/auth/src/support#WRDAuthLoginSettings" />
      <free tag="password_totp_issuer" description="The issuer to use in TOTP urls" />
      <array tag="authpages_texts" description="Overwritten texts for authpages">
        <enum tag="language" allowedvalues="en nl" />
        <enum tag="tag"
              allowedvalues="login-intro
                             login-services-intro
                             login-services-webhare
                             totp-intro
                             forgotpassword-intro
                             forgotpassword-done
                             resetpassword-intro
                             setpassword-intro
                             linkexpired-intro
                             emailchange-intro
                             emailchange-done
                             passwordchange-intro
                             passwordchange-done
                             completeaccount-intro
                             completeaccount-totp-intro
                             completeaccount-totp-done"
              gid="tolliumapps.auth.settings.authtexts" />
        <richdocument tag="text" />
      </array>
      <free tag="issuer" description="JWT issuer" unsafetocopy="true" />  <!-- attempting to sync an existing issuer will only generate confusing tokens. it's better to maintain this per server -->
      <array tag="signing_keys" description="JWT keys" unsafetocopy="true">
        <!-- mark as unsafe... syncing keys should be an explicit action -->
        <datetime tag="available_since" required="true" />
        <free tag="key_id" required="true" />
        <json tag="private_key" required="true" typedeclaration="node:crypto#JsonWebKey" />
      </array>
      <json tag="address_verification" description="Address verification provider" unsafetocopy="true" />
    </attributes>
    <values matchattribute="wrd_tag" overwriteattributes="wrd_guid wrd_limitdate">
      <value>
        <field tag="wrd_guid">wrd:0700400000004000A00000BEA61EF00D</field>
        <field tag="wrd_tag">WRD_SETTINGS</field>
        <field tag="wrd_limitdate">MAX_DATETIME</field>
      </value>
    </values>
  </object>

</schemadefinition>
