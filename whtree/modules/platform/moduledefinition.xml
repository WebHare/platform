<module xmlns="http://www.webhare.net/xmlns/system/moduledefinition">

  <meta>
    <description>WebHare platform core functionality</description>
    <validation options="nowarnings">
      <format excludemasks="generated/*" masks="*.ts *.tsx" />
    </validation>
  </meta>

  <backend>
    <!--
    All WebHare assets that usually do not require authentication (ie they are well-known, only content-addressable or do their own authentication)
    must be moved to `/.wh/` so we have a single path to exclude from login checks.

    All embeddedable assets (eg image cache) should move to /.wh/ea/ - this will help when designing rate limits and error handling (ie: users should
    rarely if ever land on a /.wh/ea, requesting 10 real pages in a second is highly suspect, 10 embedded assets in a second isn't)

    Keep in mind that embedded assets aren't necessarily static or immutable.

    Modules that add similar embeddable assets should do so under /.wh/ea/mod/<modulename>/

    All under `/.wh/dev/` will be assigned to the standard 'dev' module (mod::dev/web/wh-dev/)
     `/.wh/common/` is a common location for tools such as Publisher feedback pages. It is managed by the 'platform' module

    Add-on modules that want to add content under /.wh/ should use /.wh/mod/<modulename>/

    - `/.wh/common/`: implements various builtin pages
    - `/.wh/ea/p/`: Static assets part of the core WebHare 'platform' module (ie used for shadowcss assets)
    - `/.wh/ea/uc/`: The new location for the unified cache (Files and Images)
    - `/.wh/ea/ap/`: The new location for asset packs
    -->
    <webrule path="allroots:/.wh/common/" match="initial" handlebydir="web/wh-common/" priority="after" />

    <!-- Assetpack caching.. cache everything (with hashed names) for 24 hours *except* ap.css/mjs etc... those should only be cached for 15 minutes as their names cannot change -->
    <webrule path="allroots:/.wh/ea/ap/" match="initial" cachecontrol="public, max-age=31536000, immutable" priority="after">
      <addheader header="Access-Control-Allow-Origin" value="*" />  <!-- TODO should we permit only locally known hosts? -->
      <tryfolder path="whdata::generated/platform/ap/" />
    </webrule>
    <webrule path="allroots:/.wh/ea/ap/*/ap.*" match="wildcards" cachecontrol="public, max-age=900" priority="after">
      <addheader header="Service-Worker-Allowed" value="/" />
    </webrule>
    <webrule path="allroots:/.wh/ea/p/" match="initial" handlebydir="web/wh-assets/" priority="after" />
    <webrule path="allroots:/.wh/ea/uc/" match="initial" cachecontrol="public, max-age=31536000, immutable" priority="after">
      <tryfolder path="whdata::caches/platform/uc/" resolver="sha256b16_directory" tag="platform:unifiedcache" />
      <tryfile path="scripts/routers/unifiedcache.shtml" />
    </webrule>
    <webrule path="allroots:/.wh/openid/" match="initial" router="/js/auth/openid.ts#openIdRouter" />
  </backend>

  <development>
    <debugflag name="wrq" description="Show webrequests (formerly `__webbrowser_debugall := TRUE`)" />
    <debugflag name="evt" description="Event broadcasts" />
    <debugflag name="ahc" description="Ad-hoc Cache requests and stores" />
    <debugflag name="apr" description="Make a function CPU profile for HareScript code" />
    <debugflag name="cov" description="Make a coverage profile" />
    <debugflag name="que" description="Log task/queue actions" />
    <debugflag name="ipc" description="Log backend/internal IPC traffic" />
    <debugflag name="hmr" description="Log hot module reloading actions" />
    <debugflag name="asprod"
               description="As production - used to trigger some production-only dialogs/workflows (%IsProductionOrAsIf will evaluate to TRUE)" />
    <debugflag name="handles" description="Record stack traces when handles are created (currently only outputobjects)" />
    <debugflag name="startup" description="Log startup processes and timing" />
    <debugflag name="traceadhoccache" description="Record stack traces when new items are inserted in the adhoc cache" />
    <debugflag name="pg-auto_explain"
               description="Activate the PostgreSQL auto_explain module on new transactions and log its output to the debug log (for JS: no support)" />
    <debugflag name="pg-logcommands"
               description="Log all SQL queries sent to the PostgreSQL database to the debug log (for JS: to console)" />
    <debugflag name="pg-logsocket" description="Log all raw PGL socket commands (JS only)" />
    <debugflag name="pg-noerrordelay"
               description="Immediately report errors on insert queries (normally these are detected when the next SQL query is executed) (for JS: no support)" />
    <debugflag name="whfsplan" description="Print WHFS copy/move planning and mapping actions" />
    <debugflag name="runner" description="Debug the node runner plugin" />
    <debugflag name="conloc" description="Prefix console output with file and line number" />
    <debugflag name="etr" description="Enable full error tracing for ALL webserver clients" />
    <debugflag name="openapi" description="Log openAPI request data to the debug log" />
    <debugflag name="async" description="Activate various async tools (enforce awaits, track openWork calls)" />
    <debugflag name="jsprofile" description="Generate some profiling data for JavaScript ran by node" />
    <debugflag name="retainers" description="Add stacktraces to common retaining JS objects (Timeout, Promise)" />
  </development>

  <wrdschemas>
    <!-- TODO need 'abstract' schema. -->
    <schema tag="basewrdschema" autocreate="false" definitionfile="mod::wrd/data/wrdschemas/base.wrdschema.xml" title="Base WRD schema definition" />
  </wrdschemas>

  <moduleregistry>
    <node name="cache">
      <string name="defaultimageformat" />
      <integer name="keepucdays" description="Keep unified cache items for at least this many days" initialval="7" />
    </node>
  </moduleregistry>

</module>
