<module xmlns="http://www.webhare.net/xmlns/system/moduledefinition">

  <meta>
    <description>WebHare platform core functionality</description>
    <validation options="nowarnings">
      <format excludemasks="generated/*" masks="*.ts *.tsx" />
    </validation>
  </meta>

  <servicemanager>
    <task runat="13  1 * * *" runtz="maintenance" script="scripts/tasks/executemaintenance.ts" tag="executemaintenance" />
    <task runat="15  * * * *" runtz="maintenance" script="scripts/tasks/updatepxllog.ts" tag="updatepxllog" />

    <runonce script="migrations/5.9/scripts/fix-snakecase-settings.ts" tag="fix_snakecase_settings_5_9" when="poststart" />
    <runonce script="migrations/5.9/scripts/migrate-seosettings.whscr" tag="migrate_seosettings_5_9" when="poststart" />
  </servicemanager>

  <backend>
    <!--
    All WebHare assets that usually do not require authentication (ie they are well-known, only content-addressable or do their own authentication)
    must be moved to `/.wh/` so we have a single path to exclude from login checks.

    All embeddedable assets (eg image cache) should move to /.wh/ea/ - this will help when designing rate limits and error handling (ie: users should
    rarely if ever land on a /.wh/ea, requesting 10 real pages in a second is highly suspect, 10 embedded assets in a second isn't)

    Keep in mind that embedded assets aren't necessarily static or immutable.

    Modules that add similar embeddable assets should do so under /.wh/ea/mod/<modulename>/

    All under `/.wh/devkit/` will be assigned to the standard 'devkit' module (mod::devkit/web/wh-dev/)
    `/.wh/dev/` is reserved for the legacy `dev` module
    `/.wh/common/` is a common location for tools such as Publisher feedback pages. It is managed by the 'platform' module

    Add-on modules that want to add content under /.wh/ should use /.wh/mod/<modulename>/

    - `/.wh/common/`: implements various builtin pages
    - `/.wh/ea/p/`: Static assets part of the core WebHare 'platform' module (ie used for shadowcss assets)
    - `/.wh/ea/uc/`: The new location for the unified cache (Files and Images)
    - `/.wh/ea/ap/`: The new location for asset packs (see also getAssetPackBase)
    -->
    <webrule path="allroots:/.wh/auth/" match="initial" router="/js/auth/authpages.ts#authRouter" />
    <webrule path="allroots:/.wh/common/" match="initial" handlebydir="web/wh-common/" priority="after" />

    <!-- Assetpack caching.. cache everything (with hashed names) for 24 hours *except* ap.css/mjs etc... those should only be cached for 15 minutes as their names cannot change -->
    <webrule path="allroots:/.wh/ea/ap/" match="initial" cachecontrol="public, max-age=31536000, immutable" priority="after">
      <addheader header="Access-Control-Allow-Origin" value="*" />  <!-- TODO should we permit only locally known hosts? -->
      <tryfolder path="mod::platform/generated/ap/" />
      <tryfolder path="whdata::generated/platform/ap/" />
    </webrule>
    <webrule path="allroots:/.wh/ea/ap/*/ap.*" match="wildcards" cachecontrol="public, max-age=900" priority="after">
      <addheader header="Service-Worker-Allowed" value="/" />
      <!-- Avoids limiting service workers connection ability (for them the CSP of the mjs file is considered) -->
      <csp policy="" />
    </webrule>

    <!-- configuration, limited cachability. used to inform sites about active interface webservers (TODO and perhaps public keys for password encryption in the future?) -->
    <webrule path="allroots:/.wh/ea/config/"
             match="initial"
             cachecontrol="public, max-age=15"
             handlebydir="whdata::config/public/"
             priority="after" />

    <!-- shared static assets. always put in a topical subfolder -->
    <webrule path="allroots:/.wh/ea/p/" match="initial" handlebydir="web/wh-assets/" priority="after" />
    <webrule path="allroots:/.wh/ea/uc/" match="initial" cachecontrol="public, max-age=31536000, immutable" priority="after">
      <tryfolder path="whdata::caches/platform/uc/" resolver="sha256b16_directory" tag="platform:unifiedcache" />
      <tryfile path="scripts/routers/unifiedcache.shtml" />
    </webrule>

    <!-- Formerly /.px/ - move under /.wh/ as you don't want it access controlled, and under /ea/ because this shouldn't count towards anyrate limits -->
    <webrule path="allroots:/.wh/ea/pxl/" match="initial" handlebyscript="mod::consilio/web/resources/pxl.txt">
      <addheader header="Access-Control-Allow-Origin" value="*" />
      <addheader header="Access-Control-Max-Age" value="86400" />
    </webrule>
    <webrule path="allroots:/.wh/openid/" match="initial" router="/js/auth/openid.ts#openIdRouter" />
    <webrule path="allroots:/.wh/rpc/" match="initial" router="/js/services/rpc-router.ts#RPCRouter" />
  </backend>

  <development>
    <debugflag name="wrq" description="Show webrequests (formerly `__webbrowser_debugall := TRUE`)" />
    <debugflag name="evt" description="Event broadcasts" />
    <debugflag name="ahc" description="Ad-hoc Cache requests and stores" />
    <debugflag name="apr" description="Make a function CPU profile for HareScript code" />
    <debugflag name="cov" description="Make a coverage profile" />
    <debugflag name="que" description="Log task/queue actions" />
    <debugflag name="ipc" description="Log backend/internal IPC traffic" />
    <debugflag name="hmr" description="Log hot module reloading actions" />
    <debugflag name="asprod"
               description="As production - used to trigger some production-only dialogs/workflows (%IsProductionOrAsIf will evaluate to TRUE)" />
    <debugflag name="handles" description="Record stack traces when handles are created (currently only outputobjects)" />
    <debugflag name="startup" description="Log startup processes and timing" />
    <debugflag name="traceadhoccache" description="Record stack traces when new items are inserted in the adhoc cache" />
    <debugflag name="db-readonly" description="Mark database as readonly" />
    <debugflag name="pg-auto_explain"
               description="Activate the PostgreSQL auto_explain module on new transactions and log its output to the debug log (for JS: no support)" />
    <debugflag name="pg-logcommands"
               description="Log all SQL queries sent to the PostgreSQL database to the debug log (for JS: to console)" />
    <debugflag name="pg-logsocket" description="Log all raw PGL socket commands (JS only)" />
    <debugflag name="pg-logstacktraces" description="Log PGL stack traces (currently HS only)" />
    <debugflag name="pg-noerrordelay"
               description="Immediately report errors on insert queries (normally these are detected when the next SQL query is executed) (for JS: no support)" />
    <debugflag name="whfsplan" description="Print WHFS copy/move planning and mapping actions" />
    <debugflag name="runner" description="Debug the node runner plugin" />
    <debugflag name="conloc" description="Prefix console output with file and line number" />
    <debugflag name="etr" description="Enable full error tracing for ALL webserver clients" />
    <debugflag name="openapi" description="Log openAPI request data to the debug log" />
    <debugflag name="async" description="Activate various async tools (enforce awaits, track openWork calls)" />
    <debugflag name="jsprofile" description="Generate some profiling data for JavaScript ran by node" />
    <debugflag name="retainers" description="Add stacktraces to common retaining JS objects (Timeout, Promise)" />
    <debugflag name="assetpacks" description="Log assetpack actions" />
    <debugflag name="vmlifecycle" description="Log the lifecycle of WASM VM's" />
    <debugflag name="runpermission"
               description="Log the runpermission handling of HareScript code called from JavaScript in WASM mode" />
    <debugflag name="calljs" description="Log the calljs calls to the debug log" />
    <debugflag name="test-showbrowser" description="Show browser when running tests" />
    <debugflag name="test-keepopen" description="Keep browser open when running tests" />
  </development>

  <moduleregistry>
    <node name="cache">
      <string name="defaultimageformat" />
      <integer name="keepucdays" description="Keep unified cache items for at least this many days" initialval="7" />
    </node>
  </moduleregistry>

  <consilio>
    <!-- Set up a fieldgroup in case someone wants to build a custom pxl-like catalog -->
    <fieldgroup tag="pxlfields">
      <datetime name="@timestamp" comment="UTC timestamp of the hit" />
      <keyword name="event" comment="Pxl event, the value of the `pe` query variable" ignore_above="256" />
      <keyword name="userid" comment="User identifier, the value of the `pi` query variable" ignore_above="256" />
      <keyword name="sessionid" comment="User session id, the value of the `ps` query variable" ignore_above="256" />
      <keyword name="pageid" comment="Page session id, the value of the `pp` query variable" ignore_above="256" />
      <keyword name="objref" comment="WHFS object reference" ignore_above="256" />
      <integer64 name="counter" comment="Event counter for this page session, the value of the `pc` query variable" />
      <keyword name="location"
               comment="The current url (location) of the page, the value of the `bl` query variable"
               ignore_above="1000" />
      <keyword name="referrer" comment="The referrer, if known, the value of the `br` query variable" ignore_above="1000" />
      <record name="user_agent">
        <keyword name="os"
                 comment="The user agent platform (one of `android`, `ios`, `linux`, `mac`, `webos` or `windows`), based on the value of the `bt` query variable"
                 ignore_above="16" />
        <keyword name="name"
                 comment="The user agent browser name (one of `chrome`, `edge`, `firefox`, `ie`, `opera` or `safari`), based on the value of the `bt` query variable"
                 ignore_above="16" />
        <integer name="major" comment="The user agent version, based on the value of the `bt` query variable" />
        <keyword name="device"
                 comment="Device type (one of `desktop`, `mobile` or `tablet`), the value of the `bd` query variable"
                 ignore_above="16" />
      </record>
      <record name="screen">
        <integer name="width" comment="Screen width, based on the value of the `bs` query variable" />
        <integer name="height" comment="Screen height, based on the value of the `bs` query variable" />
        <float name="pixelratio" comment="Device pixel ratio, the value of the `bp` query variable" />
      </record>
      <ipaddress name="remoteip" comment="Anonymized client IP address" />
      <record name="geoip">
        <keyword name="country"
                 comment="Client physical location two-letter country code, based on the client IP address"
                 ignore_above="2" />
        <latlng name="location" comment="Client physical location, based on the client IP address" />
        <keyword name="region"
                 comment="Client physical location region name, based on the client IP address"
                 ignore_above="256" />
        <keyword name="city" comment="Client physical location city name, based on the client IP address" ignore_above="256" />
      </record>
    </fieldgroup>
    <catalog tag="pxl" fieldgroups="pxlfields" managed="false" suffixed="true" />  <!-- This catalog is further extended by addPxlFieldMappings. this should become a Generic Feature once the format moves to YML -->
  </consilio>

  <rights>
    <right name="api" descriptiontid="module.rights.api-description" isrootright="true" tid="module.rights.api">
      <impliedby right="system:sysop" />
    </right>
  </rights>

  <documentation>
    <embedded rooturlkey="system.services.webhare.docroot" subpath="platform" />
  </documentation>

</module>
