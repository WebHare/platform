---
# yaml-language-server: $schema=http://json-schema.org/draft-07/schema#
# To update derived the TypeScript interfaces: wh update-generated-files --only=schema
"$schema": http://json-schema.org/draft-07/schema#
title: Module definition
description: A module definition tells WebHare which features and integrations are offered by this module
type: object
additionalProperties: false
properties:
  backendHooks:
    $ref: "#/definitions/BackendHooks"
  connect:
    description: "Extends WRD Schemas for Connect"
    $ref: "#/definitions/Connect"
  managedServices:
    description: Additional services
    $ref: "#/definitions/ManagedServices"
  backendServices:
    description: Additional services
    $ref: "#/definitions/BackendServices"
  assetPacks:
    description: JavaScript/asset bundles
    $ref: "#/definitions/AssetPacks"
  webFeatures:
    description: "Web features (apply additional siteprofiles)"
    $ref: "#/definitions/WebFeatures"
  selfChecks:
    description: Setup automatisch selfchecks
    $ref: "#/definitions/SelfChecks"
patternProperties:
  "^x-[a-zA-Z0-9][-a-zA-Z0-9]*$": # allow custom properties afer x- (but no x-- and no funny chars)
    type: object
    tsType: unknown

definitions:
  # managedServices are additional services to have the servicemanager start
  ManagedServices:
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z_][-a-z0-9_]*$": # Service name
        type: object
        additionalProperties: false
        properties:
          script:
            description: "Script which implements the service (must have whscr, js or ts extesion)"
            type: string
          run:
            description: "Whether to always run the service or only ondemand"
            type: string
            enum: # "once" is not exposed, you should use tasks instead
              - always
              - on-demand
          arguments:
            description: "Command line arguments for script"
            type: array
            items:
              type: string
          engine:
            description: "HareScript engine to use"
            type: string
            enum:
              - native
              - wasm
        required:
          - script
          - run

  # backendHooks are a generic way to extend the WebHare backend (user interface)
  # NOTE In WH5.3 this was an object but we want to enforce unique names per hook so we can do things like 'before/after' (ordering) in hte future
  BackendHooks:
    description: WebHare backend (user interface) integrations
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z_][-a-z0-9_]*$": # Service name
        type: object
        additionalProperties: false
        required:
          - screen
        properties:
          screen:
            type: string
          when:
            $ref: "#/definitions/ContextFilter"
          tabsExtension:
            type: string
          addActions:
            type: array
            items:
              type: object
              additionalProperties: false
              required:
                - category
                - title
                - onexecute
              properties:
                title:
                  type: string
                  description: "Title for the action"
                category:
                  type: string
                  description: "Action category (possible values defined by the screen)"
                onexecute:
                  type: string
                  description: "Function to invoke"

  BackendServices:
    description: backendServices implement the actual services for openBackendService
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z_][-a-z0-9_]*$": # Service name
        type: object
        additionalProperties: false
        properties:
          clientFactory:
            description: "Function to create a client for this service. Must satisfy ServiceClientFactoryFunction"
            type: string
          controllerFactory:
            description: "Function to create a controller for this service which will create the clients. Must satisfy ServiceControllerFactoryFunction"
            type: string

  Connect:
    type: object
    additionalProperties: false
    properties:
      schemas:
        type: object
        additionalProperties: false
        patternProperties:
          "^[a-z_][-a-z0-9_]+:[a-z_][-a-z0-9_]+$": # WRD schema name. require a fully qualifiedname to simplify our matching in SetupBackendScreenHooks.hookssubkey
            type: object
            additionalProperties: false
            properties:
              tagset:
                type: string
                description: Tagset for task labels
              backendHooks:
                description: "Connect schema specific backend hooks. Deprecated, will be moved into backendHooks"
                $ref: "#/definitions/BackendHooks"

  # Filter where backend hooks are applied
  ContextFilter:
    type: object
    additionalProperties: false
    properties:
      wrdSchema:
        type: string
        # TODO? support masks in the future, but how to properly combine that with support for optionally module-scoped schemas?
        description: "WRD schema to apply the hook to"

  # assetPacks configure the JS bundler
  AssetPacks:
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z_][-a-z0-9_]*$": # Assetpack name
        type: object
        additionalProperties: false
        properties:
          entryPoint:
            description: "Initial script for the asset pack"
            type: string
          supportedLanguages:
            description: "Languages to compile into the asset pack"
            type: array
            items:
              # We don't suport the full range of language codes yet - this is what we tested with
              type: string
              desription: "ISO-639 language codes, eg 'en-US' or 'nl'"
              pattern: "[a-z]{2}(-[A-Z]{2})?"
          compatibility:
            description: "The compatibility settings for generated code. es2016-es2021 or esnext. See also https://esbuild.github.io/content-types/#javascript"
            type: string
          webharePolyfills:
            description: "Whether to include WebHare polyfills (defaults to true)"
            type: boolean
          module:
            description: "Output an ES module. This setting no longer applies to WH5.5 and up which will always generate and expect modules"
            type: boolean
          afterCompileTask:
            description: "Task to run after compiling the asset pack"
            type: string

        required:
          - entryPoint

  SelfChecks:
    description: Add checks to run as part of the automatic checks
    type: array
    items:
      type: object
      additionalProperties: false
      properties:
        checker:
          description: Path to function to execute. Must satify CheckFunction
          type: string
      required:
        - checker

  WebFeatures:
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z_][-a-z0-9_]*$": # Webfeature name
        type: object
        additionalProperties: false
        properties:
          siteProfile:
            type: string
            description: "Site profile to apply"
          title:
            type: string
          hidden:
            type: boolean
          webDesignMasks:
            type: array
            items:
              type: string
            description: "Limit webdesigns to which this feature can apply"
