---
# yaml-language-server: $schema=https://json-schema.org/draft/2019-09/schema
# (To update derived the TypeScript interfaces: wh apply config)
# TODO we leave some parts open now to allow for custom elements... but we should be able to compile to a complete schema allowing only supported elements
"$schema": https://json-schema.org/draft/2019-09/schema
title: Site profile
type: object
additionalProperties: false
properties:
  gid:
    type: string
  typeGroup:
    type: string
    pattern: "^[a-z][0-9a-z_.]+[0-9a-z]$" # require alpha and proper identifiers, no ending with dots. TODO permit one-char groups? shouldn't hurt anywhere, just makes the regex more complex
    description: Place all types in this file in this group. This creates a sublevel for the types without encoding into the group into automatic gids.
  types:
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z][0-9a-z_.]+[0-9a-z]$":
        $ref: "#/$defs/Type"
        type: object
  deleteTypes:
    description: "WHFS types that are obsolete and safe to delete."
    type: array
    items:
      type: string
  rtdTypes:
    type: object
    additionalProperties:
      $ref: "#/$defs/RTDType"
  apply:
    type: array
    items:
      $ref: "#/$defs/Apply"
  widgetGroups:
    type: object
    additionalProperties:
      type: object
      additionalProperties: false
      properties:
        namespace:
          type: string
        tid:
          type: string
        title:
          type: string
        icon:
          type: string
  siteSettings:
    type: array
    items:
      $ref: "#/$defs/SiteSetting"
  applySiteProfiles: # A list of siteprofiles to apply (by path) when this siteprofile is applied
    type: array
    items: #TODO alternative syntax with ifWebHare
      type: string

$defs:
  Type: # a WHFS type (contenttype, filetype, foldertype, widget)
    type: object
    unevaluatedProperties: false
    allOf:
      - $ref: "#/$defs/BaseType"
      - oneOf:
          - $ref: "#/$defs/DataFileType"
          - $ref: "#/$defs/InstanceType"
          - $ref: "#/$defs/UploadType"
          - $ref: "#/$defs/PageType"
          - $ref: "#/$defs/WidgetType"
          - $ref: "#/$defs/FolderType"

  BaseType:
    type: object
    properties:
      namespace:
        type: string
        description: "The namespace assigned to the type. If not set, it will be `<module>:[<typegroup>.]<type>"
      group:
        type: string
        description: The namespace of the group assigned to the type.
      icon:
        type: string
      gid:
        type: string
      title:
        type: string
      tid:
        type: string
      comment:
        type: string
        description: A developer's comment on this type. Not shown to unprivileged WebHare users.
      searchContentProvider: # this affects about all meta types except plain whfsType so we'll put it at BaseType level
        type: string
      members:
        $ref: "#/$defs/TypeMembers"
      deleteMembers:
        description: Members that are obsolete and safe to delete.
        type: array
        items:
          type: string
      metaType:
        description: Enables this type as a potential WHFS object, eg a file, folder or widget.
        oneOf:
          - const: instance
            description: A plain instance used to extend existing objects with additional properties. This is the default
          - const: dataFile
            description: A dataFile combines properties into a single file but cannot be downloaded or published.
          - const: upload
            description: A filetype that has 'raw' content that can be uploaded and downloaded, eg a PDF, Word Document or HTML file
          - const: page
            description: "A filetype whose content/properties are fully managed in Webare and is usually managed in a workflow (ie: draft/publish)"
          - const: blockWidget
            description: A top-level RTD widget
          - const: inlineWidget
            description: An inline RTD widget (can be embedded into paragraphs)
          - const: folder
            description: A folder stores other folders and files.

  DataFileType:
    type: object
    required:
      - metaType
    properties:
      metaType:
        const: dataFile
      apply:
        $ref: "#/$defs/ApplyRule"

  InstanceType: # InstanceType is also implicitly selected without a metaType: as it's the only to not require it. Do *not* add other required: properties here or you'll implicitly require whfsType
    type: object
    properties:
      metaType:
        const: instance
      clone:
        type: string
        description: "Configure the type's behavior when duplicated. Defaults to 'onCopy'"
        enum:
          - onCopy
          - onArchive
          - never
      workflow:
        type: boolean
        description: "Obsolete, will be removed"

  UploadType:
    type: object
    required:
      - metaType
    properties:
      metaType:
        const: upload
      requiresContent:
        type: boolean
        description: "If set, files of this type must have content (a blob) to be valid and cannot be created as an empty file in a 'New file' dialog"
      extension:
        type: string
        description: "If set, files of this type must have this extension"
        pattern: "^\\..+$"
      isAcceptableIndex:
        type: boolean
        description: "If set, files of this type are acceptable as index files in folders. For uploaded files this defaults to false and should only be enabled for HTML files"
      useWebDesign:
        type: boolean
        description: "Publish inside webdesign (former 'needstemplate'). Defaults to false for upload types but eg. HTML needs this"
      isPublishable:
        type: boolean
        description: "Whether this uploadable type can be published. Defaults to true"
      browserPreview:
        type: string
        description: "If set, this URL is used to preview files of this type in the Publisher's preview browser"
      apply:
        $ref: "#/$defs/ApplyRule"

  PageType:
    type: object
    required:
      - metaType
      - workflow # Not sure what the safe default is
    properties:
      metaType:
        const: page
      workflow:
        type: boolean
        description: If set, new files of this type are not immediately published after creation but are expected to go throufh Draft/Publish workflow
      captureSubPaths:
        type: boolean
        description: "If set, pages of this type capture all paths below their output url"
      isAcceptableIndex:
        type: boolean
        description: "If set, files of this type are acceptable as index files in folders. For pages this defaults to true"
      isPublishedAsSubdir:
        type: boolean
        description: "If set, pages of this type are published in a subdirectory named after the page (eg /about/index.html). Defaults to true. May be removed in the future" #removal will depend on who still requires it unset.
      useWebDesign:
        type: boolean
        description: "Publish inside webdesign (former 'needstemplate'). Defaults to true for page types"
      pageListProvider:
        type: string
      apply:
        $ref: "#/$defs/ApplyRule"
      dynamicExecution:
        $ref: "#/$defs/DynamicExecution"

  WidgetType:
    type: object
    required:
      - metaType
    properties:
      metaType:
        type: string
        enum:
          - blockWidget
          - inlineWidget
      editor:
        $ref: "#/$defs/WidgetEditor"
      renderer:
        type: string
      requireMergeFieldsContext:
        type: boolean
      previewComponent:
        type: string
      wittyComponent:
        type: string
      apply: # Note that widgets can have apply rules but these only affect widgets in the WHFS (Publisher), not RTD embedded widgets
        $ref: "#/$defs/ApplyRule"

  WidgetEditor:
    type: object
    oneOf:
      - type: object
        additionalProperties: false
        required:
          - tabsExtension
        properties:
          tabsExtension:
            type: string
      - type: object
        additionalProperties: false
        required:
          - function
        properties:
          function:
            type: string

  FolderType:
    type: object
    required:
      - metaType
    properties:
      metaType:
        const: folder
      apply:
        $ref: "#/$defs/ApplyRule"
      dynamicExecution:
        $ref: "#/$defs/DynamicExecution"

  TypeMembers:
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-z][a-zA-Z0-9]*$": # Explicitly not permitting underscores, expecting camelcase
        $ref: "#/$defs/TypeMember"
        type: object

  TypeMember:
    type: object
    additionalProperties: false
    required:
      - "type"
    properties:
      type:
        type: string
        enum:
          - string
          - integer
          - instant
          - plainDate
          - file
          - boolean
          - float
          - money
          - whfsRef
          - array
          - whfsRefArray
          - stringArray
          - richTextDocument
          - composedDocument
          - intExtLink
          - instance
          - url
          - hson
          - record
          - json
          # LEGACY values - drop soon (should be few users pre WH5.9)
          - whfsref
          - whfsrefarray
          - stringarray
          - richdocument
          - intextlink
          - datetime
          - date
      gid:
        type: string
      tid:
        type: string
      title:
        type: string
      comment:
        type: string
        description: "A developer's comment on this member. Not shown to unprivileged WebHare users."
      members: # TODO limit to arrays only
        $ref: "#/$defs/TypeMembers"
      deleteMembers:
        description: Members that are obsolete and safe to delete.
        type: array
        items:
          type: string
      constraints:
        $ref: "#/$defs/ValueConstraints"
      component:
        $ref: "#/$defs/Component"
      line:
        $ref: "#/$defs/ComponentLine"
      lines:
        $ref: "#/$defs/ComponentLines"
      layout:
        $ref: "#/$defs/FieldLayout"

  FieldLayout:
    type: string
    description: "Force fields to be presented as a block or separate section"
    enum:
      - section
      - block

  ValueConstraints: # TODO we need to share this with Tollium components
    type: object
    description: Record constraints for a Tollium component value
    additionalProperties: false
    properties:
      valueType:
        description: Type of value used
        type: string
        enum:
          - string
          - integer
          - float
          - money
          - boolean
          - dateTime
          - date
          - file
          - whfsRef
          - array
          - richTextDocument
      itemType:
        description: Type of value used in an array
        type: string
        enum:
          - string
          - integer
          - float
          - money
          - boolean
          - dateTime
          - file
          - whfsRef
      validation:
        description: Validation checks to apply on the input
        type: array
        items:
          type: string
          enum:
            - "email"
            - "email-maysendfrom"
            - "email-maysendto"
            - "emails"
            - "emails-maysendto"
            - "url"
            - "url-plus-relative"
            - "http-url"
            - "secure-url"
            - "insecure-url"
            - "hostname"
            - "whfsname"
            - "rfc3986"
      minValue:
        description: Minimum value
        type: integer #TODO float?
      maxValue:
        description: Maximum value
        type: integer #TODO float?
      maxBytes:
        description: Maximum data length in (UTF-8) bytes
        type: integer
      maxLength:
        description: Maximum data length in UTF-16 'code units' (ie JavaScript String.length)
        type: integer
      required:
        description: Require a value to be set
        type: boolean
      precision:
        description: Date/time precision
        type: string
        enum:
          - hour
          - minute
          - second
          - millisecond
      accept:
        description: For file values, a list of accepted MIME types. Set to 'bitmap' to support all editable bitmap types (jpeg, png, webp, avif) and WebHare can show an image-edit component
        type: array
        items:
          oneOf:
            - type: string
              pattern: "^[a-z0-9]+/[a-z0-9.+-]+$"
            - enum:
                - "bitmap" # A special value meaning any supported editable bitmap image (eg jpeg, png, webp, avif - but not gif or svg, and currently not heic)
                - "*/*"
                - "image/*"

  DynamicExecution:
    type: object
    additionalProperties: false
    description: Configuration for dynamic execution of macros or webpage objects to generate content
    properties:
      startMacro:
        type: string
      webPageObjectName:
        type: string
      routerFunction:
        type: string
      cacheTtl:
        type: integer
      cacheGetParameters:
        type: array
        items:
          type: string
      cacheIgnoreGetParameters:
        type: array
        items:
          type: string
      cacheCookies:
        type: array
        items:
          type: string
      cacheIgnoreCookies:
        type: array
        items:
          type: string

  AllowDenyTypeList:
    type: array
    items:
      type: object
      unevaluatedProperties: false
      oneOf:
        - type: object
          required: [allow]
          properties:
            allow:
              $ref: "#/$defs/MatchType"
        - type: object
          required: [deny]
          properties:
            deny:
              $ref: "#/$defs/MatchType"

  Apply:
    type: object
    unevaluatedProperties: false
    allOf:
      - type: object
        required:
          - to
        properties:
          to:
            $ref: "#/$defs/ApplyTo"
          priority:
            type: integer
            description: Higher priority rules are applied later and thus override lower priority rules. Defaults to 0
          comment:
            type: string
            description: "A developer's comment on this apply rule. Not shown to unprivileged WebHare users."
      - $ref: "#/$defs/ApplyRule"

  ApplyRule:
    type: object
    properties:
      baseProps:
        $ref: "#/$defs/ApplyBaseProps"
      bodyRenderer:
        $ref: "#/$defs/ApplyBodyRenderer"
      editProps: # TODO now that we're converting XML to YML we've had to add tabsExtension= to editProps, and this is potentially doing a completely different thing from extending the RTD Editor. requireRight is especially 'off' as what does it mean to not have rights to a field but still have it go through editdocument workflow?
        # We might have to properly split this between 'Properties dialog extensions' (where requireright and tabsextension makes sense) and 'Edditor app metadata' (the new versioned stuff)
        $ref: "#/$defs/ApplyEditProps"
      folderIndex:
        $ref: "#/$defs/ApplyFolderIndex"
      userData:
        $ref: "#/$defs/ApplyUserData"
      usePublishTemplate:
        type: string
      setObjectEditor:
        $ref: "#/$defs/ApplySetObjectEditor"
      forms:
        $ref: "#/$defs/ApplyForms"
      captcha:
        $ref: "#/$defs/ApplyCaptcha"
      fileTypes:
        $ref: "#/$defs/ApplyTypes"
      folderTypes:
        $ref: "#/$defs/ApplyTypes"
      rtdDoc: # TODO naming? its <rtddoc in XML but if i'm correct this is specifically about configuring the 'richdocument' object editor - just like editProps is a generic object editor ocnfiguration
        $ref: "#/$defs/ApplyRTDDoc"
      republish:
        $ref: "#/$defs/ApplyToRepublish"
      folderSettings:
        $ref: "#/$defs/ApplyFolderSettings"
      scheduleTimedTasks:
        $ref: "#/$defs/ApplyScheduleTimedTasks"
      scheduleManagedTasks:
        $ref: "#/$defs/ApplyScheduleManagedTasks"
      intercept:
        $ref: "#/$defs/ApplyIntercept"
      webDesign:
        $ref: "#/$defs/ApplyWebdesign"
      siteLanguage:
        $ref: "#/$defs/ApplySiteLanguage"
      debugSettings: # customnode http://www.webhare.net/xmlns/publisher/siteprofile#debugsettings
        $ref: "#/$defs/ApplyDebugSettings"
      mailTemplates:
        $ref: "#/$defs/ApplyMailTemplates"
      setWidget:
        $ref: "#/$defs/ApplySetWidget"
    patternProperties:
      "[a-z][a-zA-Z0-9_]+:[a-zA-Z0-9_]+$": # Custom properties prefixed with a site name are simply parsed and passed through
        tsType: unknown # prevent broken schema, see also https://github.com/bcherny/json-schema-to-typescript/issues/671
        oneOf: #depending on the customNode configuration this may be a single object or an array of objects
          - type: object
          - type: array
            items:
              type: object

  MatchType: #used for more limited wildcards in cases where we don't want moduleprefixing to introduce ambiguity
    type: string
    description: Match a type. The typename may end in a wildcard. Non URLs are prefixed with the module name if not specified
    pattern: "^[^?*]*\\*?$" # A wildcard, if any, may only appear at the end
    examples: ["module:type.name.*", "group.type"]

  MatchOrRegExp:
    oneOf:
      - type: string
        description: Match the value directly or using wildcards '?' and/or '*'.
      - type: object
        description: Match using a regular expression
        additionalProperties: false
        required:
          - regex
        properties:
          regex:
            type: string

  ApplyTo:
    oneOf:
      - type: object
        additionalProperties: false
        required: ["and"]
        properties:
          and:
            type: array
            items:
              $ref: "#/$defs/ApplyTo"
      - type: object
        additionalProperties: false
        required: ["or"]
        properties:
          or:
            type: array
            items:
              $ref: "#/$defs/ApplyTo"
      - type: object
        additionalProperties: false
        required: ["not"]
        properties:
          not:
            $ref: "#/$defs/ApplyTo"
      - type: object
        additionalProperties: false
        properties:
          is: # matches the isFile/isFolder/isIndex but as part of a rule (TODO because its very hard to map to=any/file/folder otherwise. however are the separate enums 'isFile/isFolder/isIndex' actually worth it?
            type: string
            enum:
              - "file"
              - "folder"
              - "index"
          type: # should map to scopedType and be resolved
            description: Match type
            "$ref": "#/$defs/MatchType"
          site: # TODO share with sitefilter concept somehow
            description: Match site name
            $ref: "#/$defs/MatchOrRegExp"
          siteType:
            description: Match the site root folder's type of this object
            "$ref": "#/$defs/MatchType"
          sitePath:
            description: Match sitePath (path from the start of the site)
            $ref: "#/$defs/MatchOrRegExp"
          whfsPath:
            description: Match whfsPath (path from the root of the WebHare filesystem)
            $ref: "#/$defs/MatchOrRegExp"
          withinType:
            description: Match any of the parent folders (up to the site root) against the requested type
            "$ref": "#/$defs/MatchType"
          parentPath:
            $ref: "#/$defs/MatchOrRegExp"
            description: RegExp to match parent object's sitepath against (case-insensitive)
          parentType:
            $ref: "#/$defs/MatchOrRegExp"
          testSetting:
            $ref: "#/$defs/ApplyToTestSetting"
          hasWebDesign:
            type: boolean #NOTE no support for 'false' (requiring no design) as fileneedstemplate doesn't
            description: "If set, validate whether the object's type is published inside a webdesign"
          webFeature:
            type: string
            description: "Matches if the containing site has enabled the specific webfeature"
            pattern: "^[a-z][a-z0-9_.]:[a-z0-9]$"
      - type: string # TODO considering removing all but 'all'
        enum:
          - "all"
          - "isFile"
          - "isFolder"
          - "isIndex"

  ApplyToTestSetting:
    type: object
    additionalProperties: false
    required: [target, type, member, value]
    properties:
      target:
        oneOf:
          - const: "self"
          - const: "root"
      type:
        type: string
      member:
        type: string
      value: {}

  ApplyBaseProps: # TODO camelcase the properties here? but we may really need to reconsider whether such detailed baseprops are the way to go in the future
    description: Either an array of flags (to fully reset baseproperties) or a bag of mostly boolean properties to mutate base properties
    oneOf:
      - type: array
        items:
          type: string
          enum:
            - description
            - keywords
            - isUnlisted
            - requireTitle
            - seoTitle
            # old name:
            - seotitle
      - type: object
        properties:
          title:
            type: boolean
            description: Deprecated. Ignored since WH5.9, will be removed
          seoTitle:
            type: boolean
            description: Enable the SEO title field
          description:
            type: boolean
          keywords:
            type: boolean
          seoTab:
            description: Enable the SEO tab (noindex, nofollow, canonical)
            oneOf:
            - type: boolean
            - type: object
              additionalProperties: false
              required: ["requireRight"]
              properties:
                requireRight:
                  type: string

          # TODO: nodindex/nofollownoarchive don't seem to be properties that control the UI but primarily affect the generated value
          noIndex:
            type: boolean
            description: If true for a file, enforces the 'noindex' robot setting
          noFollow:
            type: boolean
            description: If true for a file, enforces the 'nofollow' robot setting
          noArchive:
            type: boolean
            description: If true for a file, enforces the 'noarchive' robot setting
          striprtdextension:
            type: boolean
            description: Deprecated. Ignored since WH5.9, will be removed
          # New WH5.9 props. Not currently available through siteprofiles.
          isUnlisted:
            type: boolean
            description: Enable the isUnlisted field
          requireTitle:
            type: boolean
            description: Require a title on all objects

          # old baseprop names
          seotitle:
            type: boolean
          noindex:
            type: boolean
          nofollow:
            type: boolean
          noarchive:
            type: boolean
          seotab:
            type: boolean

  ApplyEditProps:
    description: Set up an editor for these metadata fields
    type: array
    items:
      type: object
      additionalProperties: false
      required: [type]
      properties:
        type:
          description: The type of the metadata field
          type: string
        requireRight:
          type: string
          description: Require this right to edit this field
        tabsExtension:
          type: string
          description: The tabs extension to use for this field instead of the layout here
        workflow:
          type: boolean
          description: Allow this type to be managed
        layout:
          oneOf:
            - description: All defined fields on a single tab
              const: all
            - description: A single tab with with the specified fields
              type: array
              items:
                type: string
            - description: Explicitly set up tabs with their fields
              type: object
              additionalProperties: false
              required: [tabs]
              properties:
                tabs:
                  type: array
                  items:
                    type: object
                    additionalProperties: false
                    required: [layout]
                    properties:
                      title:
                        type: string
                      tid:
                        type: string
                      layout:
                        type: array
                        items:
                          type: string

        override:
          type: object
          additionalProperties:
            $ref: "#/$defs/ApplyEditMember"

  ApplyEditMember:
    type: object
    additionalProperties: false
    properties:
      component:
        $ref: "#/$defs/Component"
      line:
        $ref: "#/$defs/ComponentLine"
      lines:
        $ref: "#/$defs/ComponentLines"
      title:
        type: string
      constraints:
        $ref: "#/$defs/ValueConstraints"
      props:
        type: object
      layout:
        $ref: "#/$defs/FieldLayout"

  ApplyBodyRenderer:
    type: object
    additionalProperties: false
    properties:
      objectName:
        type: string
      renderer:
        type: string

  ApplyUserData:
    type: object
    additionalProperties:
      type: string # TODO A future version of YAML may open up this type (eg allow all JS primitves) but for HS compatibility we'll limit this to strings for now

  ApplyFolderIndex:
    oneOf:
      - type: string
        description: "'none' explicitly disables an earler configured folderindex"
        const: none
      - type: object
        unevaluatedProperties: false
        oneOf:
          - type: object
            required:
              - copy
            properties:
              copy:
                type: string
              pin:
                type: boolean
          - type: object
            required:
              - contentLink
            properties:
              contentLink:
                type: string
              pin:
                type: boolean
          - type: object
            required:
              - newFileType
            properties:
              newFileType:
                type: string
              newFileName:
                type: string
              pin:
                type: boolean

  ApplySetObjectEditor: #TODO reconsider if separateapp & screen versions is really what we want, but some options are likely to be forced/obsoleted as they conflict with workflow?
    type: object
    additionalProperties: false
    properties:
      separateApp:
        type: boolean
      screen:
        type: string
      name:
        type: string

  ApplyRTDDoc:
    type: object
    additionalProperties: false
    properties:
      rtdType: # FIXME look into camelcasing consistency of the various rtdType/RTDType etc stuff
        type: string
      htmlClass:
        type: string
      bodyClass:
        type: string
      margins:
        type: string
        enum:
          - none
          - compact
          - wide

  ApplyTypes: # allow/deny file/folder type - or only if a template is used
    type: array
    items:
      type: object
      unevaluatedProperties: false
      oneOf:
        - type: object
          required: [allowType]
          properties:
            allowType:
              "$ref": "#/$defs/MatchType"
        - type: object
          required: [allowTemplate]
          properties:
            allowTemplate:
              "$ref": "#/$defs/MatchType"
        - type: object
          required: [denyType]
          properties:
            denyType:
              "$ref": "#/$defs/MatchType"

  ApplyForms:
    type: object
    additionalProperties: false
    properties:
      components:
        description: "Components to allow/deny"
        $ref: "#/$defs/AllowDenyTypeList"
      handlers:
        description: "Handlers to allow/deny"
        $ref: "#/$defs/AllowDenyTypeList"
      rtdTypes:
        description: "RTD Types to allow/deny"
        $ref: "#/$defs/AllowDenyTypeList"
      captcha:
        description: Enable captcha checks by default for webtool forms
        type: boolean
      matchSubmitType:
        description: Allow to match conditions based on submit type (new, change, cancel)
        type: boolean
      pageTitles:
        description: Enable page titles by default for webtool forms
        type: boolean
      infoTexts:
        description: Enable info texts by default for webtool forms
        type: boolean
      infoTextRtdType:
        description: RTD type to use for info texts (if not set, falls back to the rtdDoc)
        type: string
      mailRtdType:
        description: Default RTD type to use for mails
        type: string
      autoCompleteUsername:
        description: Enable username autocomplete and set its title. Set to '*' to use the default title
        type: string
      pageHooks:
        description: Supply hooks to the webtool form page (would otherwise be done by a %WebtoolFormPage)
        type: string
      addressOptions: # split off as we might need to reuse these settings elsewhere, and it cleans up a bit
        description: Enable addresses by default for webtool forms
        type: object
        additionalProperties: false
        properties:
          countryList:
            description: A list of two-letter country codes and "-" (a divider in the country select option list). WORLD to add all countries not explicitly mentioned
            type: array
            items:
              type: string
              pattern: "^[A-Z]{2}$|^-$|^WORLD$"
          deriveFromZip:
            description: Special zip/postal code handling, currently NL addresses only. Places the zip and house nr first and either suggests or forces an address based on the zip code
            type: string
            enum:
            - suggest
            - force
          validationRegistryKey:
            type: string
            description: Registry key to get address verification settings from. Takes precedence over any wrdschema
          validationWrdSchema:
            type: string
            description: Schema to get verification settings from

  ApplyToRepublish:
    type: array
    items:
      type: object
      additionalProperties: false
      description: Instruct WebHare to republish files when the applied to item changed
      properties:
        folder:
          type: string
        siteMask:
          type: string
        mask:
          type: string
        recursive:
          type: boolean
        indexOnly:
          type: boolean
        onChange:
          type: string
          description: "- metadata: Republish only if metadata changed"
          const: metadata
        scope:
          type: string
          description: "- references: Interpret the republish instruction from the point of view of any references to this file (internal links, content links and contenttype whfsrefs)"
          const: references

  ApplyCaptcha:
    type: object
    additionalProperties: false
    properties:
      skipFunction:
        type: string

  ApplyFolderSettings:
    type: object
    additionalProperties: false
    properties:
      filterScreen:
        type: string
      ordering:
        description: "Configure ordering for this folder
          - none: There is no ordering, the website ordering option should be unavailable
          - fixed: A website ordering is available, but cannot be modified through the publisher drag/drop
          - orderable: Ordering can be changed through the website
          "
        type: string
        enum:
          - none
          - fixed
          - orderable
      contentsListHandler:
        type: string

  ApplyScheduleTimedTasks:
    type: array
    items:
      type: object
      additionalProperties: false
      required: [task]
      properties:
        task:
          type: string
        delay:
          type: integer

  ApplyScheduleManagedTasks:
    type: array
    items:
      type: object
      additionalProperties: false
      required: [task]
      properties:
        task:
          type: string

  ApplyIntercept:
    type: object
    additionalProperties: false
    patternProperties:
      "^[a-zA-Z0-9_]+$":
        type: object
        additionalProperties: false
        required: [target, interceptFunction]
        properties:
          target:
            type: string
          runAfter:
            type: array
            items:
              type: string
          runBefore:
            type: array
            items:
              type: string
          interceptFunction:
            type: string

  ApplyWebdesign:
    type: object
    additionalProperties: false
    properties:
      objectName:
        type: string
      siteResponseFactory:
        type: string
      pageBuilder:
        type: string
        description: JS Page render function. Receives a PageRenderRequest and returns a WebResponse
      witty:
        type: string
      assetPack:
        type: string
      wittyEncoding:
        type: string
      designFolder:
        type: string
      maxContentWidth:
        type: string
      supportsErrors:
        type: boolean
      supportsAccessDenied:
        type: boolean
      contentNavStops:
        type: array
        items:
          type: string

  ApplySiteLanguage:
    type: string

  ApplyDebugSettings:
    type: array
    items:
      type: object
      additionalProperties: false
      required: [groupTitle]
      properties:
        groupTitle:
          description: Debug settings option group title
          type: string
        userWarning:
          description: A warning shown to users when they open the debug settings
          type: string
        flags:
          description: The debug option tags (often three-letter debug flag for builtin flags)
          type: object
          additionalProperties: false
          patternProperties:
            "^[a-z][a-z0-9_-]+$":
              type: object
              additionalProperties: false
              required: [title]
              properties:
                title:
                  description: The title of the debug option shown to the user
                  type: string
                requireRight:
                  description: Require a specific right to set this option. Defaults to system:sysop. Rights that require a target are checked against the fsobject for which the settings are opened
                  type: string

  ApplyPollSettings:
    type: object
    additionalProperties: false
    properties:
      revoteAfter:
        description: "ISO8601 period (eg P1D) after which voting is allowed again. (this check is cookie based so it can be circumvented by any user which clears his cookies)"
        type: string

  ApplyMailTemplates:
    type: array
    items:
      type: object
      additionalProperties: false
      properties:
        path:
          type: string
        title:
          type: string
        tid:
          type: string
        ordering:
          type: integer
        sources:
          $ref: "#/$defs/Sources"

  ApplySetWidget:
    type: object
    description: Override widget configuration
    additionalProperties:
      type: object
      additionalProperties: false
      properties:
        editor:
          $ref: "#/$defs/WidgetEditor"
        renderer:
          type: string
        previewComponent:
          type: string
        wittyComponent:
          type: string

  Sources:
    type: array
    items:
      type: object
      required: [path]
      properties:
        path:
          type: string
          description:
            The path can either be an absolute path like "site::path/to/folder" or "whfs::/path/to/folder" or a path relative to
            either the current site profile or the target object, based on the 'relativeto' setting. If the relative path starts
            with a slash ('/'), it is resolved to the the root of the site or module that contains the site profile or the site
            containing the target object.
        relativeTo:
          oneOf:
            - const: siteProfile
            - const: targetObject

  SiteSetting:
    type: object
    additionalProperties: false
    properties:
      # Site filters
      site:
        description: Match site name
        $ref: "#/$defs/MatchOrRegExp"
      webRoot:
        description: Match published site's root URL'
        $ref: "#/$defs/MatchOrRegExp"
      webRules:
        type: array
        items:
          $ref: "#/$defs/WebRule"
      addToCatalogs:
        type: array
        items:
          $ref: "#/$defs/AddToCatalog"

  AddToCatalog:
    type: object
    additionalProperties: false
    required: [catalog]
    properties:
      catalog:
        type: string
        description: Target catalog name
      folder:
        type: string
        description: Optional subfolder of the site to add
      folderType:
        type: string
        description: Limit to folders of this type

  WebRule:
    type: object
    additionalProperties: false
    required: [path]
    properties:
      path:
        type: string
        description: The path to match, starting with a slash. May include wildcards '*' and '?'
      priority:
        oneOf:
          - const: before
          - const: after
      methods:
        const: "*"
      cacheControl:
        type: string
        description: The Cache-Control header to use for succesful requests
      contentSecurityPolicy:
        type: string
        description: The Content-Security-Policy header to use. Should include `frame-ancestors 'self' [webhare]` to prevent clickjacking but still allow the Publisher Preview
      headers:
        type: object
        additionalProperties:
          type: string
      router:
        type: string

  Component:
    type: object
    not: # forbid 'line' or 'lines' as a component
      required:
        - line
      properties:
        line:
          $ref: "#/$defs/ComponentLine"

  ComponentLine:
    type: array
    items:
      $ref: "#/$defs/Component" # TODO We should also permit line: but

  ComponentLines:
    type: array
    items:
      oneOf:
        - type: object
          required: [line]
          properties:
            line:
              $ref: "#/$defs/ComponentLine"
        - $ref: "#/$defs/Component"

  RTDType:
    type: object
    additionalProperties: false
    properties:
      comment:
        type: string
        description: "A developer's comment on this type. Not shown to unprivileged WebHare users."
      htmlClass:
        type: string
      bodyClass:
        type: string
      b:
        type: string
        enum:
          - "strong"
          - "b"
      i:
        type: string
        enum:
          - "em"
          - "i"
      widgets:
        type: array
        items:
          type: object
          required:
            - type
          additionalProperties: false
          properties:
            type:
              $ref: "#/$defs/MatchType"
            inherit:
              type: boolean
      allowNewWindowLinks:
        type: boolean
      ignoreSiteProfileWidgets:
        type: boolean
      contentAreaWidth:
        type: string
      linkHandlers:
        type: array
        items:
          type: string
      blockStyles:
        type: object
        additionalProperties: false
        patternProperties:
          "^[a-z][-a-z0-9]*$":
            type: object
            additionalProperties: false
            properties:
              title:
                type: string
              containerTag:
                type: string
                enum:
                  [
                    p,
                    div,
                    h1,
                    h2,
                    h3,
                    h4,
                    h5,
                    h6,
                    pre,
                    address,
                    blockquote,
                    section,
                    nav,
                    article,
                    aside,
                    header,
                    footer,
                    ol,
                    ul,
                    code,
                  ]

              textStyles:
                type: array
                items:
                  type: string
                  enum: [i, u, b, a-href, img, sub, sup, strike]

              importFrom:
                type: array
                items:
                  type: string

              nextBlockStyle:
                type: string

      tableStyles:
        type: object
        additionalProperties: false
        patternProperties:
          "^[a-z0-9]+$":
            type: object
            additionalProperties: false
            properties:
              title:
                type: string
              defaultBlockStyle:
                type: string
              allowStyles:
                type: array
                items:
                  type: string

      cellStyles:
        type: object
        additionalProperties: false
        patternProperties:
          "^[a-z0-9]+$":
            type: object
            additionalProperties: false
            properties:
              title:
                type: string

      css:
        type: array
        items:
          type: string

      defaultBlockStyle:
        type: string
