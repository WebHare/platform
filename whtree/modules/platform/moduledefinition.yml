managedServices:
  apprunner:
    script: mod::system/scripts/internal/apprunner.whscr
    run: always
  tollium-wasm-runner:
    script: mod::tollium/scripts/internal/applicationstarter.whscr
    run: on-demand
    engine: wasm
  nodeservices: # Implements JS-based <backendservice>s
    script: js/nodeservices/nodeservices.ts
    run: always
  unifiedcache: # Temporarily split off due to memory usage
    script: js/nodeservices/imgcache.ts
    run: always
    # When stress-testing/debugging, lower restartInterval to 1sec in imgcache.ts and enable these below:
    # minRunTime: 1
    # maxThrottleMsecs: 5

backendServices:
  openapiservice:
    clientFactory: "mod::system/js/internal/openapi/openapiservice.ts#getServiceInstance"
  jsrouterservice:
    clientFactory: "mod::system/js/internal/webserver/jsrouterservice.ts#getJSRouter"
  fetchpool:
    clientFactory: "mod::system/js/internal/fetchpool/fetchpool.ts#getFetcher"
  jsonapicaller:
    clientFactory: "mod::system/js/internal/jsonrpccaller.ts#getJSONApiCaller"
  assetpacks:
    controllerFactory: js/assetpacks/control.ts#createAssetPackManager
  configuration:
    controllerFactory: js/configure/configservice.ts#createConfigManager
    coreService: true
  calljs:
    clientFactory: "js/nodeservices/calljs.ts#getCallJSService"

openApiServices:
  api:
    spec: openapi/api/api.yml

selfChecks:
  - checker: js/checks/servicechecks.ts#checkMissingServices
  - checker: js/checks/platformchecks.ts#checkPlatform
  - checker: js/assetpacks/checks.ts#checkAssetPacks

assetPacks:
  pwaserviceworker:
    entryPoint: webfeatures/pwaserviceworker/pwaserviceworker
    supportedLanguages: [en]
    whPolyfills: false
  tollium:
    entryPoint: mod::tollium/webdesigns/webinterface/webinterface
    supportedLanguages: [en, nl]
    whPolyfills: false #tollium shouldn't be recompiled by webserver list changes
  authormode:
    entryPoint: mod::publisher/webdesigns/authormode/authormode.tsx
    supportedLanguages: [en, nl]
    whPolyfills: false #we shouldn't polyfill with this assetpack, we're loaded side-by-side to an existing one
  testsuite:
    entryPoint: mod::system/web/systemroot/jstests/testsuite.tsx
    supportedLanguages: [en]
    whPolyfills: false #actually no platform assetpacks should every be recompiled by webservices list changes

siteProfiles:
  - path: data/siteprofiles/types.siteprl.yml
  - path: data/siteprofiles/internal-types.siteprl.yml
  - path: data/siteprofiles/globalrules.siteprl.yml
  - path: mod::consilio/data/consilio.siteprl.xml
  - path: mod::consilio/webfeatures/sitecontent/sitecontent.siteprl.xml
  - path: mod::publisher/data/siteprofiles/abtest.siteprl.xml
  - path: mod::publisher/data/siteprofiles/pwa.siteprl.xml
  - path: mod::publisher/data/siteprofiles/shorturl.siteprl.xml
  - path: mod::publisher/data/embeddedobjects.siteprl.xml
  - path: mod::publisher/data/siteprofiles/contentlibraries.siteprl.xml
  - path: mod::publisher/data/siteprofiles/webtools.siteprl.xml
  - path: mod::publisher/widgets/widgets.siteprl.xml
  - path: mod::tollium/data/tollium.siteprl.xml
  - path: mod::wrd/data/wrd.siteprl.xml

webFeatures:
  identityprovider:
    siteProfile: webfeatures/identityprovider/identityprovider.siteprl.xml

moduleFileTypes:
  - tsType: ModuleDefinition
    schema: data/schemas/moduledefinition.schema.yml
    resourceMask: ^mod::[^/]+/moduledefinition\.yml$
  - tsType: SiteProfile
    schema: data/schemas/siteprofile.schema.yml
    resourceMask: siteprl\.yml$
    contentValidator: mod::publisher/lib/internal/siteprofiles/parser.ts#validateSiteProfile

pxlEvents:
  # Form events need to correspond with FormAnalyticsEventData in @webhare/forms/src/types.ts
  form_started: # 'started' is currently the most minimal event, so we'll use it as the base for others
    fields:
      formmeta_id: keyword
      formmeta_session: keyword
      formmeta_pagenum: integer
      formmeta_pagetitle: keyword
      formmeta_time: integer
      formmeta_objref: keyword
      formmeta_waittime: integer
  form_failed:
    includeFields: form_started
    fields:
      formmeta_errorfields: keyword
      formmeta_errorsource: keyword
  form_exception:
    includeFields: form_started
    fields:
      formmeta_exception: keyword
      formmeta_errorsource: keyword
  form_slow:
    includeFields: form_started
    fields:
      formmeta_waitfor: keyword
  form_nextpage:
    includeFields: form_started
    fields:
      formmeta_targetpagenum: integer
      formmeta_targetpagetitle: keyword
  form_previouspage:
    includeFields: form_nextpage
  form_submitted:
    includeFields: form_started
  form_abandoned:
    includeFields: form_started
    fields:
      formmeta_pagenum: integer
      formmeta_lastfocused: keyword

wrdSchemas:
  basewrdschema:
    abstract: true
    schema: mod::wrd/data/wrdschemas/base.wrdschema.xml

rpcServices:
  authservice:
    api: js/auth/authservice.ts#authService
  frontendtests:
    api: js/devsupport/frontend-test-service.ts#testService
    filter: js/devsupport/frontend-test-service.ts#filterTestService
