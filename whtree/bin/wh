#!/bin/bash
source ${BASH_SOURCE%/*}/../lib/wh-functions.sh

REQUIRENPMVERSION="7.13.0"
export WHBUILD_PLATFORM="`uname | tr A-Z a-z`"
export PGUSER="root" #postgres user, must be locked for compatibility between dev and prod
export HOMEBREW_NO_AUTO_UPDATE=1 # We don't want to responsible for brew/trigger updates.

while [[ $1 =~ ^-.* ]]; do
  if [ "$1" == "-v" -o "$1" == "--verbose" ]; then
    export WH_VERBOSE=1
    shift
  elif [ "$1" == "-f" -o "$1" == "--force" ]; then
    FORCE=1
    shift
  elif [ "$1" == "-i" -o "$1" == "--ignore-running" ]; then
    IGNORERUNNING=1
    shift
  elif [ "$1" == "--setup-env" ]; then
    SETUPENV=1
    shift
  else
    die "Illegal option $1"
  fi
done

# If used as command in 'docker run', initialize the environment
if [ "$$" = "1" -a -n "$WEBHARE_IN_DOCKER" ]; then
  SETUPENV=1
fi

# We must have $WEBHARE_DIR, pointing to the 'whtree'.
if [ -z "$WEBHARE_DIR" ]; then
  if [ -n "$WEBHARE_CHECKEDOUT_TO" ]; then
    export WEBHARE_DIR="$WEBHARE_CHECKEDOUT_TO/whtree"
  else
    export WEBHARE_DIR=`cd ${BASH_SOURCE%/*}/..; pwd`
  fi

  [ "$WH_VERBOSE" == "1" ] && echo "WebHare installation dir: $WEBHARE_DIR"
fi

# Try to set WEBHARE_CHECKEDOUT_TO from WEBHARE_DIR where possible
if [ -z "$WEBHARE_CHECKEDOUT_TO" ]; then
  if [ -f "$WEBHARE_DIR/../base_makefile" ]; then
    export WEBHARE_CHECKEDOUT_TO="`cd ${WEBHARE_DIR}/..; pwd`"
  fi
fi

# If you haven't set WEBHARE_DATAROOT... read .webhare-envsettings if possible. wh console should set it.
if [ -z "$WEBHARE_DATAROOT" ] && [ -f "$WEBHARE_DIR/.webhare-envsettings.sh" ]; then
  source $WEBHARE_DIR/.webhare-envsettings.sh
fi

# If we haven't found WEBHARE_DATAROOT that way, discover it
if [ -z "$WEBHARE_DATAROOT" ] ; then
  WEBHARE_DATAROOT="$WEBHARE_DIR/whdata"
  __WEBHARE_DATAROOT_AUTOSET=1
fi

# Discover which database we'll be using
if [ "$WEBHARE_INITIALDB" == "postgres" -o "$WEBHARE_INITIALDB" == "postgresql" -o "$(uname).$(uname -m)" == "Darwin.arm64" ]; then  #support postgres as alias
  WEBHARE_INITIALDB=postgresql
elif [ "$WEBHARE_INITIALDB" == "dbserver" -o "$WEBHARE_INITIALDB" == "" ]; then
  WEBHARE_INITIALDB=dbserver
else
  die "Invalid WEBHARE_INITIALDB setting: $WEBHARE_INITIALDB"
fi

if [ -f $WEBHARE_DATAROOT/postgresql/db/postgresql.conf ] || ( [ ! -f $WEBHARE_DATAROOT/dbase/translog.whdb -a "$WEBHARE_INITIALDB" == "postgresql" ] ); then
  export __WEBHARE_DBASE="postgresql" # __ var because external users should not set it! they should set WEBHARE_INITIALDB
  if [ -z "$WEBHARE_DBASENAME" ]; then
    export WEBHARE_DBASENAME="webhare" # embedded database is always named WH
  fi
else
  export __WEBHARE_DBASE="dbserver"
  export WEBHARE_DBASENAME=""
fi

# Source settings.sh from the dataroot for non-docker installations
if [ -z "$WEBHARE_IN_DOCKER" -a -f "$WEBHARE_DATAROOT"/settings.sh ]; then
  . "$WEBHARE_DATAROOT"/settings.sh
fi


# If you haven't set WEBHARE_BASEPORT, assume it to be 13679
if [ -z "$WEBHARE_BASEPORT" ]; then
  WEBHARE_BASEPORT=13679
fi

# If you haven't set WEBHARE_TEMP, assume it to be $WEBHARE_DATAROOT/tmp
if [ -z "$WEBHARE_TEMP" ]; then
  WEBHARE_TEMP="$WEBHARE_DATAROOT/tmp"
fi

[ "$WH_VERBOSE" == "1" ] && echo "WebHare data directory:   $WEBHARE_DATAROOT"
[ "$WH_VERBOSE" == "1" ] && echo "WebHare base port number: $WEBHARE_BASEPORT"

if [ -n "$WHBUILD_DEBUG" ]; then
  WHBUILD_DIPREFIX=debug-
else
  WHBUILD_DIPREFIX=release-
fi

if [ -n "$WEBHARE_CHECKEDOUT_TO" ]; then
  if [ -z "$WEBHARE_BUILDDIR" ]; then
    WEBHARE_BUILDDIR="`cd $WEBHARE_CHECKEDOUT_TO; DIRNAME="${PWD##*/}" ; cd ..; echo $PWD/whbuild/${WHBUILD_DIPREFIX}${DIRNAME}`"
  fi
  WEBHARE_BUILDHOLDERS="`cd $WEBHARE_CHECKEDOUT_TO; cd ..; echo $PWD/whbuild`"
fi

export WEBHARE_CHECKEDOUT_TO
export WEBHARE_BUILDDIR
export WEBHARE_DIR
export WEBHARE_BASEPORT
export WEBHARE_DATAROOT

# Ensures npm stable ordering - https://github.com/npm/npm/issues/17048
# Minimum debian/ubuntu install ships only with C.UTF-8, not en_US.UTF-8
export LANG="C"
export LC_ALL="C"

if [ ! -d "$WEBHARE_DIR" ]; then
  die "Cannot find WebHare installation"
fi

deprecation_sleep()
{
  for P in 1 2 3 4 5 ; do
    echo -n "."
    sleep 1
  done
  echo ""
}

vercomp () {
  # https://stackoverflow.com/questions/4023830/how-compare-two-strings-in-dot-separated-version-format-in-bash
  if [[ $1 == $2 ]]
  then
      return 0
  fi
  local IFS=.
  local i ver1=($1) ver2=($2)
  # fill empty fields in ver1 with zeros
  for ((i=${#ver1[@]}; i<${#ver2[@]}; i++))
  do
      ver1[i]=0
  done
  for ((i=0; i<${#ver1[@]}; i++))
  do
      if [[ -z ${ver2[i]} ]]
      then
          # fill empty fields in ver2 with zeros
          ver2[i]=0
      fi
      if ((10#${ver1[i]} > 10#${ver2[i]}))
      then
          return 1
      fi
      if ((10#${ver1[i]} < 10#${ver2[i]}))
      then
          return 2
      fi
  done
  return 0
}

whcompile()
{
  loadenvsettings
  $WEBHARE_DIR/bin/whcompile "$@"
}

exec_whcompile()
{
  loadenvsettings
  exec $WEBHARE_DIR/bin/whcompile "$@"
}

wh()
{
  $WEBHARE_DIR/bin/wh "$@"
}

exec_wh()
{
  $WEBHARE_DIR/bin/wh "$@"
}

check_webhare_running()
{
  if [ "$IGNORERUNNING" == "1" ]; then
    return
  fi

  if ! is_webhare_running ; then
    die "WebHare does not seem to be running"
  fi
}

check_webhare_not_running()
{
  if [ "$IGNORERUNNING" == "1" ]; then
    return
  fi

  if is_webhare_running ; then
    die "WebHare is already running"
  fi
}

setup_buildsystem()
{
  if [ -n "$WEBHARE_IN_DOCKER" -a -z "$WHBUILD_ALLOW" ]; then
    # Prevent you from accidentally breaking a running WebHare installation - did you think you were running this locally?
    die "If WEBHARE_IN_DOCKER is set you must set WHBUILD_ALLOW to be able to 'wh make'"
  fi

  if [ -z "$WEBHARE_BUILDDIR" ]; then
    die "Haven't determined the WebHare builddir - your checkout looks too different from what I'm used to"
  fi
  mkdir -p $WEBHARE_BUILDDIR

  if [ "$WHBUILD_PLATFORM" == "darwin" ]; then   # Set up darwin. Make sure homebrew and packages are available
    if ! which brew >/dev/null 2>&1 ; then
      echo "On macOS we rely on Homebrew (http://brew.sh) and some additional packages being installed. Please install it"
      exit 1
    fi

    if [ -z "$NOBREW" ]; then
      # Only update homebrew if webhare.rb changed or last check was a day ago
      TODAY="`date +%Y%m%d`"
      if [ "$WEBHARE_CHECKEDOUT_TO/addons/darwin/webhare.rb" -nt "$WEBHARE_CHECKEDOUT_TO/.checkoutstate/last-brew-install" ] ||
         [ "$TODAY" != "`cat $WEBHARE_CHECKEDOUT_TO/.checkoutstate/last-brew-install`" ]; then
        mkdir -p $WEBHARE_CHECKEDOUT_TO/.checkoutstate
        echo -n "Brew: "
        if ! brew install --only-dependencies --formula $WEBHARE_CHECKEDOUT_TO/addons/darwin/webhare.rb ; then exit ; fi
        echo "$TODAY" > $WEBHARE_CHECKEDOUT_TO/.checkoutstate/last-brew-install
      fi
    fi

    if ! which node >/dev/null 2>&1 ; then
      echo "'node' still not available, please install it ('brew link node' or 'brew link node@<version>'?)"
      exit 1
    fi

  elif [ "$WHBUILD_PLATFORM" == "linux" ] && [ -f /etc/redhat-release ] && ! grep CentOS /etc/redhat-release ; then
    REQUIREPACKAGES="openssl-devel pixman-devel git freetype-devel GeoIP-devel libtiff-devel giflib-devel libjpeg-turbo-devel libpng-devel libtiff-devel pixman-devel openssl-devel unixODBC-devel libicu-devel libxml2-devel valgrind-devel libgit2-devel libmaxminddb-devel libpq-devel"
    if ! which ccache > /dev/null 2>&1 ; then
      REQUIREPACKAGES="$REQUIREPACKAGES ccache"
    fi
    MISSINGPACKAGES=
    for P in $REQUIREPACKAGES; do
      ASSUME=0
      for Q in $WEBHARE_ASSUMEPACKAGES ; do
        if [ "$P" == "$Q" ]; then
          ASSUME=1
        fi
      done
      if [ "$ASSUME" == "1" ]; then
        continue
      fi
      if ! rpm -q $P >/dev/null ; then
        MISSINGPACKAGES="$MISSINGPACKAGES $P"
      fi
    done

    if [ -n "$MISSINGPACKAGES" ]; then
      echo ""
      echo "We need to install the following packages:"
      echo "$MISSINGPACKAGES"
      echo ""
      if [ "$WEBHARE_IN_DOCKER" == "1" ]; then
        die "WEBHARE_IN_DOCKER set, aborting build. You probably want to update your Dockerfile"
      fi
      if [ "$FORCE" != "1" ]; then
        echo "If you want me to install them, type YES"
        echo ""
        read answer
        if [ "$answer" != "YES" ]; then
          die "Then I fear you're on your own"
        fi
      fi

      sudo dnf install -y $MISSINGPACKAGES
    fi
  fi

  vercomp "`npm -v`" "$REQUIRENPMVERSION"
  if [ "$?" == "2" ]; then
    echo "You have npm $(npm -v), we desire $REQUIRENPMVERSION or higher"
    echo "You may need to update nodejs or manually install npm (eg npm install -g npm)"
    exit 1
  fi

  export SRCDIR=$WEBHARE_CHECKEDOUT_TO
  export WHBUILD_PLATFORM

  if [ -z "$WEBHARE_IN_DOCKER" ]; then # Not a docker build, configure for local building
    # don't set relative paths, not all tools can handle relative paths
    export CCACHE_DIR=$WEBHARE_BUILDHOLDERS/ccache

    mkdir -p $CCACHE_DIR

    # Colors are nice
    export GCC_COLORS=1

    # We also want pdf-box. Homebrew/Fedora don't ship it so we'll just manually download it
    PDFBOX_BASEDIR="$WEBHARE_CHECKEDOUT_TO/whtree/modules/system/data/engines/"
    PDFBOX_VERSION="2.0.21"
    PDFBOX_DOWNLOADPATH="$PDFBOX_BASEDIR/pdfbox-app-$PDFBOX_VERSION.jar"
    PDFBOX_FINALPATH="$PDFBOX_BASEDIR/pdfbox-app.jar"

    if [ ! -f "$PDFBOX_DOWNLOADPATH" -o ! -f "$PDFBOX_FINALPATH" ]; then
      mkdir -p "$PDFBOX_BASEDIR"
      if ! curl https://build.webhare.dev/whbuild/pdfbox-app-$PDFBOX_VERSION.jar > "$PDFBOX_DOWNLOADPATH.tmp" ; then
        die PDFBOX download failed
      fi
      mv "$PDFBOX_DOWNLOADPATH.tmp" "$PDFBOX_DOWNLOADPATH"
    fi

    # Make sure pdf-box points to our desired vesrion
    ln -f "$PDFBOX_DOWNLOADPATH" "$PDFBOX_FINALPATH"
  fi
}

setup_webhare_envsettings()
{
  if [ -f $WEBHARE_DIR/modules/system/whres/buildinfo ]; then
    export WEBHARE_VERSION=$( source $WEBHARE_DIR/modules/system/whres/buildinfo ; echo -n "$version" )
    export WEBHARE_DISPLAYBUILDINFO=$(
      source $WEBHARE_DIR/modules/system/whres/buildinfo
      echo -n "branch $branch, commit ${committag:0:10}"
    )
  else
    getbaseversioninfo
    if [ -z "$WEBHARE_VERSION" ]; then
      die Cannot determine WebHare version
    fi
    export WEBHARE_VERSION="${WEBHARE_VERSION}-dev"
    export WEBHARE_DISPLAYBUILDINFO=$(
      cd $WEBHARE_DIR
      GIT_HEAD_SHA1=$(git rev-parse HEAD)
      GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
      GIT_ORIGIN_URL=$(git config --get remote.origin.url)
      echo "developer's build: branch $GIT_ORIGIN_URL:$GIT_BRANCH, commit ${GIT_HEAD_SHA1:0:10}"
    )
  fi

  > $WEBHARE_DATAROOT/.webhare-envsettings.sh

  cat << HERE > $WEBHARE_DATAROOT/.webhare-envsettings.sh
export PGUSER="root"
export WEBHARE_DIR="$WEBHARE_DIR"
export WEBHARE_DATAROOT="$WEBHARE_DATAROOT"
export WEBHARE_BASEPORT="$WEBHARE_BASEPORT"
export WEBHARE_DISPLAYBUILDINFO="$WEBHARE_DISPLAYBUILDINFO"
export WEBHARE_ISRESTORED="$WEBHARE_ISRESTORED"
export WEBHARE_TEMP="$WEBHARE_TEMP"
export __WEBHARE_DBASE="$__WEBHARE_DBASE"
export WEBHARE_DBASENAME="$WEBHARE_DBASENAME"
export WEBHARE_DBASE_READONLY="$WEBHARE_DBASE_READONLY"
export WEBHARE_VERSION="$WEBHARE_VERSION"
HERE

  if [ "$1" != "" ]; then
    if [ -z "$WEBHARE_DEBUGSESSION" ]; then
      WEBHARE_DEBUGSESSION=default
    fi
    cat << HERE >> $WEBHARE_DATAROOT/.webhare-envsettings.sh
export WEBHARE_DEBUG="$1"
export WEBHARE_DEBUGSESSION="$WEBHARE_DEBUGSESSION"
HERE
  fi

  # Are we the 'primary' installation for a WEBHARE_DIR ?
  if [ -z "$WEBHARE_NOINSTALLATIONINFO" -a -z "$WEBHARE_IN_DOCKER" ]; then
    cp $WEBHARE_DATAROOT/.webhare-envsettings.sh $WEBHARE_DIR/.webhare-envsettings.sh
  fi

  # Load the current settings
  source $WEBHARE_DATAROOT/.webhare-envsettings.sh
}

right_pad()
{
  PAD="                                       "
  if [ "${#1}" -gt "${#PAD}" ]; then
    PAD=""
  else
    PAD="${PAD:${#1}}"
  fi
  echo "$1$PAD"
}

show_commandfile_help() # instr filename
{
  local COMMAND SHORT
  COMMAND=$(grep -ie "^\(#\|///\?\) *command: " $2)
  SHORT=$(grep -ie "^\(#\|///\?\) *short: " $2)

  COMMAND=${COMMAND#*: }
  SHORT=${SHORT#*: }
  if [ -z "$SHORT" ]; then
    return
  fi

  if [ -z "$COMMAND" ]; then
    COMMAND="$1"
  fi
  echo "$(right_pad "$COMMAND") $SHORT"
}

list_commands()
{
  grep -oe "^[a-z]*" ${BASH_SOURCE%/*}/../modules/system/doc/wh.txt
  SCRIPTDIRS="$WEBHARE_DIR/modules/system/scripts/whcommands/"

  for SCRIPTDIR in $SCRIPTDIRS; do
    for SCRIPTPATH in '%s\n' "${SCRIPTDIR}"*.whscr "${SCRIPTDIR}"*.sh; do
      if [ -f $SCRIPTPATH ]; then
        FILENAME="${SCRIPTPATH##*/}"
        INSTR="${FILENAME%.*}"
        echo "$INSTR"
      fi
    done
  done
  if [ -x "$WEBHARE_DIR/bin/runscript" ]; then
    loadshellconfig
    for MODULE in $WEBHARE_CFG_MODULES; do
      if [ "$MODULE" != "system" ]; then
        getmoduledir MODULEDIR $MODULE
        SCRIPTDIR="${MODULEDIR}scripts/whcommands/"
        for SCRIPTPATH in "${SCRIPTDIR}"*.whscr "${SCRIPTDIR}"*.sh; do
          if [ -f $SCRIPTPATH ]; then
            FILENAME="${SCRIPTPATH##*/}"
            INSTR="$MODULE:${FILENAME%.*}"
            echo "$INSTR"
          fi
        done
      fi
    done
  fi
}

run_help()
{
  local SCRIPTDIRS SCRIPTDIR SCRIPTPATH FILENAME INSTR
  cat ${BASH_SOURCE%/*}/../modules/system/doc/wh.txt

  SCRIPTDIRS="$WEBHARE_DIR/modules/system/scripts/whcommands/"

  for SCRIPTDIR in $SCRIPTDIRS; do
    for SCRIPTPATH in '%s\n' "${SCRIPTDIR}"*.whscr "${SCRIPTDIR}"*.sh; do
      if [ -f $SCRIPTPATH ]; then
        FILENAME="${SCRIPTPATH##*/}"
        INSTR="${FILENAME%.*}"
        show_commandfile_help "$INSTR" "$SCRIPTPATH"
      fi
    done
  done

  INSTR=help
  if [ -x "$WEBHARE_DIR/bin/runscript" ]; then
    loadshellconfig
    for MODULE in $WEBHARE_CFG_MODULES; do
      if [ "$MODULE" != "system" ]; then
        getmoduledir MODULEDIR $MODULE
        SCRIPTDIR="${MODULEDIR}scripts/whcommands/"
        for SCRIPTPATH in "${SCRIPTDIR}"*.whscr "${SCRIPTDIR}"*.sh; do
          if [ -f $SCRIPTPATH ]; then
            FILENAME="${SCRIPTPATH##*/}"
            INSTR="$MODULE:${FILENAME%.*}"
            show_commandfile_help "$INSTR" "$SCRIPTPATH"
          fi
        done
      fi
    done
  else
    echo "Not querying modules for commands or help, because runscript isn't built yet"
  fi
}

getscripttorun()
{
  VARNAME=$1
  while shift; do
    if [ "$1" == "--whdebug" ]; then
      shift
    elif [ "${1:0:1}" != "-" ]; then
      break;
    fi
  done
  eval $VARNAME=\$1
}

setup_for_console()
{
  mkdir -p "$WEBHARE_DATAROOT"/tmp >/dev/null 2>&1
  WEBHARE_DATAROOT="`cd $WEBHARE_DATAROOT; pwd`" #Ensure we have a full path
}

if [ -n "$SETUPENV" ]; then
  check_webhare_not_running
  setup_for_console

  getwhparameters
  setup_webhare_envsettings
fi

INSTR="${1:-help}"
shift
OPTIONS=("$@")

# Find the 'dev' module, and if present, load its hooks. Not sure if we should trust random modules to install hooks.. especially as we may run under different UIDs ?
# WEBHARE_WH_HOOK is an external hook which may replace implementations in wh.
for EXT in "$WEBHARE_WH_HOOK" \
           "$WEBHARE_DATAROOT/installedmodules/dev/scripts/wh-hook.sh" \
           "$WEBHARE_DATAROOT/installedmodules/webhare/dev/scripts/wh-hook.sh" ; do
  if [ -n "$EXT" ] && [ -f "$EXT" ]; then
    # shellcheck source=/dev/null
    source "$EXT"
  fi
done

case $INSTR in
  "exec")
    setup_for_console
    getwhparameters

    PROCESS="$1"
    shift

    if [ -x "$WEBHARE_DIR/bin/${PROCESS}.sh" ]; then #so 'wh exec dbserver' launches the proper database and we can use the .sh extension for syntax highlighting
      PROCESS="$WEBHARE_DIR/bin/${PROCESS}.sh"
    elif [ -x "$WEBHARE_DIR/bin/$PROCESS" ]; then
      PROCESS="$WEBHARE_DIR/bin/$PROCESS"
    else
      echo "No such subbinary '$PROCESS'"
    fi

    exec $PROCESS "$@"
    exit 255
    ;;

  "execbuilt")
    setup_for_console
    getwhparameters
    setup_buildsystem

    PROCESS="$1"
    shift

    if [ ! -x "$PROCESS" -a -x "$WEBHARE_BUILDDIR/bin/$PROCESS" ]; then #resolve to bin path ?
      PROCESS="$WEBHARE_BUILDDIR/bin/$PROCESS"
    fi

    exec $PROCESS "--moduledir" "$WEBHARE_BUILDDIR/lib" "$@"
    exit 255
    ;;

  "console")
    DEBUGTAGS=
    if [ "$1" == "--profile" ]; then
      DEBUGTAGS=apr
      shift;
    elif [ "$1" == "--coverage" ]; then
      DEBUGTAGS=cov
      shift;
    fi

    check_webhare_not_running
    setup_for_console

    getwhparameters
    setup_webhare_envsettings "$DEBUGTAGS"
    echo "WebHare version: $WEBHARE_VERSION"

    if [ "$DEBUGTAGS" == "" ]; then
      # no processing needed, just exec
      exec $WEBHARE_DIR/bin/webhare "$@" console
      exit 255
    fi

    TOSHOWFILE=
    if [ "$DEBUGTAGS" == "cov" ]; then
      runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr" --deleteprofiles

      echo "Coverage data will be stored in ${WEBHARE_DATAROOT}ephemeral/profiles/$WEBHARE_DEBUGSESSION"
      echo
    fi

    echo "Starting console mode"
    cd "$WEBHARE_DATAROOT"/tmp
    $WEBHARE_DIR/bin/webhare "$@" console

    if [ "$DEBUGTAGS" == "cov" ]; then
      echo
      echo "Processing coverage data in ${WEBHARE_DATAROOT}ephemeral/profiles/$WEBHARE_DEBUGSESSION"
      runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr"
      echo "Results are available in ${WEBHARE_DATAROOT}ephemeral/profiles/${WEBHARE_DEBUGSESSION}/index.html"
      TOSHOWFILE="${WEBHARE_DATAROOT}ephemeral/profiles/${WEBHARE_DEBUGSESSION}/index.html"
    fi

    setup_webhare_envsettings # Reset to defaults

    if [ -n "$TOSHOWFILE" ]; then
      [ "$WHBUILD_PLATFORM" == "darwin" ] && open "$TOSHOWFILE"
      [ "$WHBUILD_PLATFORM" == "linux" ] && xdg-open "$TOSHOWFILE"
    fi

    exit 0
    ;;

  "reset-coverage")
    runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr" --deleteprofiles
    ;;

  "calculate-coverage")
    loadenvsettings
    exec_runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr"
    ;;

  "cachereset")
    check_webhare_running
    CLEARPERSISTENT=
    while [ "$#" -ne 0 ]; do
      if [ "$1" == "-p" ]; then
        CLEARPERSISTENT=-p
      else
        die "Unknown option $1"
      fi
      shift
    done
    exec_runscript mod::system/scripts/whcommands/softreset.whscr -c $CLEARPERSISTENT
    ;;

  "run")
    getscripttorun SCRIPT "$@"
    if [ -z "$SCRIPT" ]; then
      die "Specify the script to run"
    fi

    if [ "${SCRIPT: -3}" == ".es" -o "${SCRIPT: -3}" == ".js" ]; then
      setup_node
      BASE_DIR=$WEBHARE_DIR/node_modules
      while (true); do
        if [ "$1" == "--debug" ]; then
          NODEOPTIONS=--debug
          shift
        elif [ "$1" == "--inspect" ]; then
          NODEOPTIONS=--inspect
          shift
        elif [ "$1" == "--whdebug" ]; then
          shift
          shift
        else
          break
        fi
      done
      exec node $NODEOPTIONS "$@"
      die Failed to invoke node for $1
    else
      if [ "$1" == "--whdebug" ]; then
        shift
        export WEBHARE_DEBUG="$1"
        shift
      elif [[ $1 =~ ^--whdebug=(.*) ]]; then
        export WEBHARE_DEBUG="${BASH_REMATCH[1]}"
        shift
      elif [ "$1" == "--profile" ]; then
        export WEBHARE_DEBUG=apr
        shift
      elif [ "$1" == "--coverage" ]; then
        export WEBHARE_DEBUG=cov
        shift
      elif [ "$1" == "--debugbrk" ]; then
        export WEBHARE_DEBUG=brk
        shift
      fi
      exec_runscript --workerthreads 4 "$@"
    fi
    ;;

  "republish")
    check_webhare_running
    runscript --workerthreads 4 mod::publisher/scripts/internal/publishing.whscr --measure "$@"
    ;;

  "reindex")
    check_webhare_running
    runscript --workerthreads 4 mod::publisher/scripts/tools/reindex_publisher.whscr "$@"
    ;;

  "help")
    run_help
    ;;

  "terminate")
    check_webhare_running
    kill `pgrep -f $WEBHARE_DIR/bin`
    ;;

  "kill")
    check_webhare_running
    kill -9 `pgrep -f $WEBHARE_DIR/bin`
    ;;

  "activity")
    getlog LOGFILE access
    cut -d' ' -f4 -- "$LOGFILE" | cut -d':' -f2,3 | sort | uniq -c
    ;;

  "dumplog")
    getlog LOGFILE $1
    if [ -n "$LOGFILE" ]; then
      cat $LOGFILE
    else
      echo "Could not find log '$1'"
    fi
    ;;

  "dirs")
    if [ ! -z "$WEBHARE_CHECKEDOUT_TO" ]; then
      echo "git checkout:  $WEBHARE_CHECKEDOUT_TO"
    fi
    getwhparameters
    echo "Installation:  $WEBHARE_DIR"
    echo "Log files:     $LOGFILEPATH"
    echo "Rescue port:   http://127.0.0.1:$(($WEBHARE_BASEPORT + 9))/" # whwebserverconfig_rescueportoffset
    echo ""
    echo "Data root:     $WEBHARE_DATAROOT"
    echo "Database data: $STORAGEPATH"
    echo "Database recs: $RECORDSTORAGEPATH"
    echo "Database idx:  $INDEXSTORAGEPATH"
    echo ""
    set|grep ^WEBHARE_
    ;;

  "noderun")
    setup_node
    noderun $@
    ;;

  "mocharun")
    setup_node
    EXTRA_WATCH=
    COVERAGE=
    if [[ " $@ " = *" --watch "* ]] || [[ " $@ " = *" -w "* ]]; then
      EXTRA_WATCH="--watch-extensions es,js"
    fi
    if [ "$1" == "--debug" ]; then
      NODEOPTIONS="$NODEOPTIONS --debug"
      shift
    fi
    if [ "$1" == "--coverage" ]; then
      COVERAGE=1
      shift
    fi

    BASE_DIR=$WEBHARE_DIR/node_modules
    if [ -n "$COVERAGE" ]; then
      if [ -n "$EXTRA_WATCH" ]; then
        die "Coverage testing and watching are mutally exclusive"
      fi

      if ! which nyc >/dev/null 2>&1 ; then
        die "Install 'nyc' to run coverage tests (npm i -g nyc)"
      fi

      # Run nyc in /tmp, it creates a lot of directories. Resolve all files first
      MOCHAPARAMS=
      while [ "$#" -ne 0 ]; do
        if [[ $1 == -* ]]; then
          die "Unknown option $1"
        fi
        if [[ $1 == /* ]]; then
          MOCHAPARAMS="$MOCHAPARAMS $1"
        else
          MOCHAPARAMS="$MOCHAPARAMS $PWD/$1"
        fi
        shift
      done

      # prepare environment for nyc
      mkdir -p /tmp/nyc
      ln -fs $WEBHARE_DIR/modules/webhare_testsuite/data/.nycrc /tmp/nyc/.nycrc

      # and run it
      cd $WEBHARE_DIR
      echo "nyc --report-dir /tmp/coverage node $NODEOPTIONS $BASE_DIR/.bin/_mocha $MOCHAPARAMS"
      exec nyc --extension .es --report-dir /tmp/coverage node $NODEOPTIONS $BASE_DIR/.bin/_mocha $MOCHAPARAMS
    elif [ "${1: -3}" == ".es" ] || [ "${2: -3}" == ".es" ]; then
      if [ -n "$WEBHARE_BABELCACHE" ]; then
        export BABEL_CACHE_PATH="$WEBHARE_BABELCACHE/babel-cache.json"
      else
        export BABEL_CACHE_PATH=$WEBHARE_DATAROOT/ephemeral/babelcache/babel-node
      fi
      exec node $NODEOPTIONS $BASE_DIR/@babel/node/lib/_babel-node \
        --plugins $WEBHARE_DIR/node_modules/@babel/plugin-transform-modules-commonjs \
        --ignore ignore_nothing --extensions ".es" \
        $BASE_DIR/.bin/_mocha $EXTRA_WATCH "$@"
    fi
    exit 1
    ;;

  "getrootdir")
    echo ${WEBHARE_CHECKEDOUT_TO:-WEBHARE_DIR}
    ;;

  "getdatadir")
    getwhparameters
    echo $WEBHARE_DATAROOT
    ;;

  "getmoduledir")
    getmoduledir MODULEDIR "$1"
    echo $MODULEDIR
    ;;

  "getmodulelist")
    loadshellconfig
    echo $WEBHARE_CFG_MODULES
    ;;

  "compile")
    exec_whcompile "$@"
    ;;

  "setupmyshell")
    cat << HERE
wh() { $WEBHARE_DIR/bin/wh "\$@"; } ;
whcd() {
  local DEST;
  DEST="\`wh run mod::system/scripts/internal/cli/getdir.whscr \"\$@\"\`";
  [ -n "\$DEST" ] && cd "\$DEST";
} ;
export -f wh ;
export -f whcd ;
source $WEBHARE_DIR/lib/wh-bashautocomplete.sh
HERE
    ;;

  "runtest")
    setup_node
    runscript --workerthreads 10 --onlyshippedfonts mod::system/scripts/internal/tests/runtest.whscr "$@"
    EXITCODE=$?
    if [ "$EXITCODE" != "0" ]; then
      echo "Test failed with exit code $EXITCODE"
      exit $EXITCODE
    fi
    exit 0
    ;;

  "make")
    if [[ "${OPTIONS[@]}" =~ install ]]; then
      check_webhare_not_running
    fi
    setup_buildsystem
    estimate_buildj
    cd $WEBHARE_BUILDDIR
    if ! make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile "${OPTIONS[@]}" ; then
      [ -z "$WEBHARE_IN_DOCKER" ] && cat $WEBHARE_CHECKEDOUT_TO/addons/makefailed.txt
      exit 1
    fi
    exit 0
    ;;

  "fixbuild")
    check_webhare_not_running
    setup_buildsystem
    estimate_buildj
    cd $WEBHARE_BUILDDIR

    # Cannot build a target for this in the makefile, we want to serialise these steps
    for P in clean-icu-provider clean-libs postuninstall install; do
      make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile $P "${OPTIONS[@]}"
    done
    exit
    ;;

  "builddocker")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/builddocker.sh "$@"
    ;;

  "testdocker")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/testdocker.sh "$@"
    ;;

  "deploydocker")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/deploydocker.sh "$@"
    ;;

  "testmodule")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/testdocker.sh -m "$@"
    ;;

  "isrunning")
    is_webhare_running && exit 0 || exit 1
    ;;

  "freshdbconsole")
    check_webhare_not_running
    setup_for_console

    eval `$WEBHARE_DIR/bin/webhare printparameters`

    ALLOWFRESHFILE="$WEBHARE_DATAROOT/etc/allow-fresh-db"
    if [ ! -f "$ALLOWFRESHFILE" ]; then
      die "freshdbconsole WIPES YOUR DATABASE on startup. To prove this is what you wish, please create a file named '$ALLOWFRESHFILE'"
    fi

    rm -rf -- "$WEBHARE_DATAROOT"/postgresql
    rm -rf -- "$WEBHARE_DATAROOT"/dbase/index* "$WEBHARE_DATAROOT"/dbase/db-*.* "$WEBHARE_DATAROOT"/dbase/translog.* "$WEBHARE_DATAROOT"/dbase/blob*
    rm -rf -- "$WEBHARE_DATAROOT"/log "$WEBHARE_DATAROOT"/system.cache "$WEBHARE_DATAROOT"/publisher.pb "$WEBHARE_DATAROOT"/publisher.pd "$WEBHARE_DATAROOT"/system.last-shrinkwrap-var
    rm -rf -- "$WEBHARE_DATAROOT"/index -- "$WEBHARE_DATAROOT"/elasticsearch
    if [ -x "$WEBHARE_DATAROOT/etc/fresh-db-setup.sh" ]; then
      "$WEBHARE_DATAROOT/etc/fresh-db-setup.sh" &
    fi
    exec $WEBHARE_DIR/bin/wh "$@" console
    exit 255
    ;;

  "installsocketbinder")
    git clone https://github.com/WebHare/socket_binder.git /tmp/installsocketbinder.$$
    cd /tmp/installsocketbinder.$$
    make
    if [ "$WHBUILD_PLATFORM" == "darwin" ]; then
      sudo make install-darwin
    else
      sudo make install
      echo "Make install ran, now do whatever it takes to start socketbinder on this platform"
    fi
    exit 0
    ;;

  "mic")
    setup_buildsystem
    eval `$WEBHARE_DIR/bin/webhare printparameters`
    check_webhare_not_running
    estimate_buildj
    cd $WEBHARE_BUILDDIR
    if ! make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile install ; then
      [ -z "$WEBHARE_IN_DOCKER" ] && cat $WEBHARE_CHECKEDOUT_TO/addons/makefailed.txt
       exit 1
    fi

    getwhparameters

    exec $WEBHARE_DIR/bin/wh "$@" console
    exit 255
    ;;

  "hstest")
    if [ -z "$1" ]; then
      die "Specify the test to run"
    fi
    setup_buildsystem
    estimate_buildj
    cd $WEBHARE_BUILDDIR
    exec make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile HSTEST=$1 harescript-test
    exit 255
    ;;

  "eslint")
    getwhparameters
    CHECKDIR=
    TORUN=".bin/eslint"
    args=()
    if [ "$1" == "--watch" ]; then
      TORUN=".bin/esw -w --color -f simple"
      shift;
    elif [ "$1" == "--fix" ]; then
      # remove the cache directives
      args=( --fix )
      shift;
    fi
    if [ $# -eq 0 ]; then
      args+=("$WEBHARE_CHECKEDOUT_TO/whtree/modules/")
    else
      args+=( "$@" )
    fi
    "$WEBHARE_DIR/node_modules/"$TORUN --cache --cache-location "$WEBHARE_DATAROOT/ephemeral/eslintcache/cache" -c "$WEBHARE_DIR/modules/system/data/validation/eslintrc.json" --ext .js,.es --ignore-pattern "**/node_modules/**" --ignore-pattern "**/bower_components/**" "${args[@]}"
    exit $?
    ;;

  "__listcommands")
    list_commands | sort -u
    exit 0
    ;;

  "up" | "st" | "status" | "umic")
    echo "The command '$INSTR' is now provided by the 'dev' module, please install it first"
    exit 255
    ;;

  *)
    if [[ $INSTR =~ .*:.* ]]; then
      TARGETMODULE=${INSTR%:*}
      SUBCOMMAND=${INSTR##*:}
      getmoduledir MODULEDIR $TARGETMODULE

      if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.sh" ]; then
        exec /bin/bash "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.sh" "${OPTIONS[@]}"
      fi
      if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.whscr" ]; then
        exec_runscript --workerthreads 4 "mod::$TARGETMODULE/scripts/whcommands/$SUBCOMMAND.whscr" "${OPTIONS[@]}"
      fi
      if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.js" ]; then
        setup_node
        exec node "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.js" "${OPTIONS[@]}"
      fi

      die "Don't know how to process command '$SUBCOMMAND' for module $TARGETMODULE"
    else #Command not in the form 'xxx:yyy'
      if [ -f "$WEBHARE_DIR/modules/system/scripts/whcommands/$INSTR.sh" ]; then
        exec /bin/bash "$WEBHARE_DIR/modules/system/scripts/whcommands/$INSTR.sh" "${OPTIONS[@]}"
      fi
      if [ -f "$WEBHARE_DIR/modules/system/scripts/whcommands/$INSTR.whscr" ]; then
        exec_runscript --workerthreads 4 "mod::system/scripts/whcommands/$INSTR.whscr" "${OPTIONS[@]}"
      fi
    fi

    die "Command '$INSTR' not understood - use 'wh help' for a list of instructions"
    ;;
esac
