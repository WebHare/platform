#!/bin/bash
source ${BASH_SOURCE%/*}/../lib/wh-functions.sh

REQUIRENPMVERSION="7.13.0"
export WHBUILD_PLATFORM="`uname | tr A-Z a-z`"
export PGUSER="root" #postgres user, must be locked for compatibility between dev and prod
export HOMEBREW_NO_AUTO_UPDATE=1 # We don't want to responsible for brew/trigger updates.

while [[ $1 =~ ^-.* ]]; do
  if [ "$1" == "-v" -o "$1" == "--verbose" ]; then
    export WH_VERBOSE=1
    shift
  elif [ "$1" == "-f" -o "$1" == "--force" ]; then
    FORCE=1
    shift
  elif [ "$1" == "-i" -o "$1" == "--ignore-running" ]; then
    IGNORERUNNING=1
    shift
  elif [ "$1" == "--setup-env" ]; then
    SETUPENV=1
    shift
  else
    die "Illegal option $1"
  fi
done

[ -f /opt/wh/whtree/etc/is-webhare-in-docker ] && export WEBHARE_IN_DOCKER=1

# If used as command in 'docker run', initialize the environment
if [ "$$" = "1" -a -n "$WEBHARE_IN_DOCKER" ]; then
  SETUPENV=1
fi

# We must have $WEBHARE_DIR, pointing to the 'whtree'.
if [ -z "$WEBHARE_DIR" ]; then
  if [ -n "$WEBHARE_CHECKEDOUT_TO" ]; then
    export WEBHARE_DIR="${WEBHARE_CHECKEDOUT_TO%/}/whtree"
  else
    export WEBHARE_DIR=`cd ${BASH_SOURCE%/*}/..; pwd`
  fi

  [ "$WH_VERBOSE" == "1" ] && echo "WebHare installation dir: $WEBHARE_DIR"
fi

# Try to set WEBHARE_CHECKEDOUT_TO from WEBHARE_DIR where possible
if [ -z "$WEBHARE_CHECKEDOUT_TO" ]; then
  if [ -f "$WEBHARE_DIR/../base_makefile" ]; then
    export WEBHARE_CHECKEDOUT_TO="`cd ${WEBHARE_DIR}/..; pwd`"
  fi
fi

# If we haven't found WEBHARE_DATAROOT that way, discover it
if [ -z "$WEBHARE_DATAROOT" ] ; then
  WEBHARE_DATAROOT="$WEBHARE_DIR/whdata"
  INFERRED_DATAROOT=1
fi

if [ -f $WEBHARE_DATAROOT/dbase/translog.whdb ]; then
  echo "The dbserver is no longer suppported by WebHare 5.0 and up. Downgrade and convert first!"
  exit 1
fi

export WEBHARE_DBASENAME="webhare" # embedded database is always named WH

# If you haven't set WEBHARE_BASEPORT, assume it to be 13679
if [ -z "$WEBHARE_BASEPORT" ]; then
  WEBHARE_BASEPORT=13679
fi

# If you haven't set WEBHARE_TEMP, assume it to be $WEBHARE_DATAROOT/tmp
if [ -z "$WEBHARE_TEMP" ]; then
  WEBHARE_TEMP="$WEBHARE_DATAROOT/tmp"
fi

[ "$WH_VERBOSE" == "1" ] && echo "WebHare data directory:   $WEBHARE_DATAROOT"
[ "$WH_VERBOSE" == "1" ] && echo "WebHare base port number: $WEBHARE_BASEPORT"

if [ -n "$WHBUILD_DEBUG" ]; then
  WHBUILD_DIPREFIX=debug-
else
  WHBUILD_DIPREFIX=release-
fi

if [ -n "$WEBHARE_CHECKEDOUT_TO" ]; then
  if [ -z "$WEBHARE_BUILDDIR" ]; then
    WEBHARE_BUILDDIR="`cd $WEBHARE_CHECKEDOUT_TO; DIRNAME="${PWD##*/}" ; cd ..; echo $PWD/whbuild/${WHBUILD_DIPREFIX}${DIRNAME}`"
  fi
  WEBHARE_BUILDHOLDERS="`cd $WEBHARE_CHECKEDOUT_TO; cd ..; echo $PWD/whbuild`"

  if [ -z "$WHBUILD_DOWNLOADCACHE" ]; then
    WHBUILD_DOWNLOADCACHE="$WEBHARE_BUILDDIR/downloadcache"
  fi
fi

export WEBHARE_CHECKEDOUT_TO
export WEBHARE_BUILDDIR
export WEBHARE_DIR
export WEBHARE_BASEPORT
export WEBHARE_DATAROOT
export WHBUILD_DOWNLOADCACHE
export WEBHARE_TEMP

# Ensures npm stable ordering - https://github.com/npm/npm/issues/17048
# Minimum debian/ubuntu install ships only with C.UTF-8, not en_US.UTF-8
export LANG="C"
export LC_ALL="C"

if [ ! -d "$WEBHARE_DIR" ]; then
  die "Cannot find WebHare installation"
fi

deprecation_sleep()
{
  for P in 1 2 3 4 5 ; do
    echo -n "."
    sleep 1
  done
  echo ""
}

exec_whcompile()
{
  getwhparameters
  exec $WEBHARE_DIR/bin/whcompile "$@"
}

wh()
{
  $WEBHARE_DIR/bin/wh "$@"
}

exec_wh()
{
  $WEBHARE_DIR/bin/wh "$@"
}

check_webhare_running()
{
  if [ "$IGNORERUNNING" == "1" ]; then
    return
  fi

  if ! is_webhare_running ; then
    die "WebHare does not seem to be running"
  fi
}

check_webhare_not_running()
{
  if [ "$IGNORERUNNING" == "1" ]; then
    return
  fi

  if is_webhare_running ; then
    die "WebHare is already running"
  fi
}

setup_buildsystem()
{
  if [ -n "$WEBHARE_IN_DOCKER" -a -z "$WHBUILD_ALLOW" ]; then
    # Prevent you from accidentally breaking a running WebHare installation - did you think you were running this locally?
    die "If WEBHARE_IN_DOCKER is set you must set WHBUILD_ALLOW to be able to 'wh make'"
  fi

  if [ -z "$WEBHARE_BUILDDIR" ]; then
    die "Haven't determined the WebHare builddir - your checkout looks too different from what I'm used to"
  fi
  mkdir -p $WEBHARE_BUILDDIR

  if [ "$WHBUILD_PLATFORM" == "darwin" ]; then   # Set up darwin. Make sure homebrew and packages are available
    if ! which brew >/dev/null 2>&1 ; then
      echo "On macOS we rely on Homebrew (http://brew.sh) and some additional packages being installed. Please install it"
      exit 1
    fi

    if [ -z "$NOBREW" ]; then
      # Only update homebrew if webhare.rb changed or last check was a day ago
      TODAY="`date +%Y%m%d`"
      if [ "$WEBHARE_CHECKEDOUT_TO/addons/darwin/webhare.rb" -nt "$WEBHARE_CHECKEDOUT_TO/.checkoutstate/last-brew-install" ] ||
         [ "$TODAY" != "`cat $WEBHARE_CHECKEDOUT_TO/.checkoutstate/last-brew-install`" ]; then
        mkdir -p $WEBHARE_CHECKEDOUT_TO/.checkoutstate
        echo -n "Brew: "
        if ! brew install --only-dependencies --formula $WEBHARE_CHECKEDOUT_TO/addons/darwin/webhare.rb ; then exit ; fi
        echo "$TODAY" > $WEBHARE_CHECKEDOUT_TO/.checkoutstate/last-brew-install
      fi
    fi

    if ! which node >/dev/null 2>&1 ; then
      echo "'node' still not available, please install it ('brew link node' or 'brew link node@<version>'?)"
      exit 1
    fi

  elif [ "$WHBUILD_PLATFORM" == "linux" ] && [ -f /etc/redhat-release ] && ! grep CentOS /etc/redhat-release ; then
    REQUIREPACKAGES="openssl-devel pixman-devel git freetype-devel GeoIP-devel libtiff-devel giflib-devel libjpeg-turbo-devel libpng-devel libtiff-devel pixman-devel openssl-devel unixODBC-devel libicu-devel libxml2-devel valgrind-devel libgit2-devel libmaxminddb-devel libpq-devel"
    if ! which ccache > /dev/null 2>&1 ; then
      REQUIREPACKAGES="$REQUIREPACKAGES ccache"
    fi
    MISSINGPACKAGES=
    for P in $REQUIREPACKAGES; do
      ASSUME=0
      for Q in $WEBHARE_ASSUMEPACKAGES ; do
        if [ "$P" == "$Q" ]; then
          ASSUME=1
        fi
      done
      if [ "$ASSUME" == "1" ]; then
        continue
      fi
      if ! rpm -q $P >/dev/null ; then
        MISSINGPACKAGES="$MISSINGPACKAGES $P"
      fi
    done

    if [ -n "$MISSINGPACKAGES" ]; then
      echo ""
      echo "We need to install the following packages:"
      echo "$MISSINGPACKAGES"
      echo ""
      if [ "$WEBHARE_IN_DOCKER" == "1" ]; then
        die "WEBHARE_IN_DOCKER set, aborting build. You probably want to update your Dockerfile"
      fi
      if [ "$FORCE" != "1" ]; then
        echo "If you want me to install them, type YES"
        echo ""
        read answer
        if [ "$answer" != "YES" ]; then
          die "Then I fear you're on your own"
        fi
      fi

      sudo dnf install -y $MISSINGPACKAGES
    fi
  fi

  vercomp "`npm -v`" "$REQUIRENPMVERSION"
  if [ "$?" == "2" ]; then
    echo "You have npm $(npm -v), we desire $REQUIRENPMVERSION or higher"
    echo "You may need to update nodejs or manually install npm (eg npm install -g npm)"
    exit 1
  fi

  export SRCDIR=$WEBHARE_CHECKEDOUT_TO
  export WHBUILD_PLATFORM

  if [ -z "$WEBHARE_IN_DOCKER" ]; then # Not a docker build, configure for local building
    # don't set relative paths, not all tools can handle relative paths
    export CCACHE_DIR=$WEBHARE_BUILDHOLDERS/ccache

    mkdir -p $CCACHE_DIR

    # Colors are nice
    export GCC_COLORS=1

    # Additional dependencies
    if ! /bin/bash $WEBHARE_CHECKEDOUT_TO/addons/docker-build/setup-pdfbox.sh ; then
      echo "setup-pdfbox failed"
    fi
    if ! /bin/bash $WEBHARE_CHECKEDOUT_TO/addons/docker-build/setup-tika.sh ; then
      echo "setup-tika failed"
    fi
  fi
}

setup_webhare_envsettings()
{
  export WEBHARE_VERSION=$( source $WEBHARE_DIR/modules/system/whres/buildinfo ; echo -n "$version" )
  WEBHARE_DISPLAYBUILDINFO="$( source $WEBHARE_DIR/modules/system/whres/buildinfo ; echo -n "branch $branch, commit ${committag:0:10}")"

  ORIGIN=$( source $WEBHARE_DIR/modules/system/whres/buildinfo ; echo -n "$origin" )
  if [ -n "$ORIGIN" ]; then
    WEBHARE_DISPLAYBUILDINFO="$WEBHARE_DISPLAYBUILDINFO, source build, origin $ORIGIN"
  fi
  export WEBHARE_DISPLAYBUILDINFO

  # Export all WEBHARE_ vars to .webhare-envsettings.sh for scripts that need to restablish the whole `wh console` environment
  # But don't export WEBHARE_DEBUG= ... as WebHare will cross-process communicate that anyway
  set | grep -E '^WEBHARE_' | grep -v '^WEBHARE_DEBUG=' | sed -e 's/^/export /' > $WEBHARE_DATAROOT/.webhare-envsettings.sh
}

list_commands()
{
  grep -oe "^[a-z]*" ${BASH_SOURCE%/*}/../modules/system/doc/wh.txt
  SCRIPTDIRS="$WEBHARE_DIR/modules/system/scripts/whcommands/"

  for SCRIPTDIR in $SCRIPTDIRS; do
    for SCRIPTPATH in '%s\n' "${SCRIPTDIR}"*.whscr "${SCRIPTDIR}"*.sh; do
      if [ -f $SCRIPTPATH ]; then
        FILENAME="${SCRIPTPATH##*/}"
        INSTR="${FILENAME%.*}"
        echo "$INSTR"
      fi
    done
  done
  if [ -x "$WEBHARE_DIR/bin/runscript" ]; then
    loadshellconfig
    for MODULE in $WEBHARE_CFG_MODULES; do
      if [ "$MODULE" != "system" ]; then
        getmoduledir MODULEDIR $MODULE
        SCRIPTDIR="${MODULEDIR}scripts/whcommands/"
        for SCRIPTPATH in "${SCRIPTDIR}"*.whscr "${SCRIPTDIR}"*.sh; do
          if [ -f $SCRIPTPATH ]; then
            FILENAME="${SCRIPTPATH##*/}"
            INSTR="$MODULE:${FILENAME%.*}"
            echo "$INSTR"
          fi
        done
      fi
    done
  fi
}

getscripttorun()
{
  VARNAME=$1
  while shift; do
    if [ "$1" == "--whdebug" ]; then
      shift
    elif [ "${1:0:1}" != "-" ]; then
      break;
    fi
  done
  eval $VARNAME=\$1
}

setup_for_console() #setup_for_console is invoked when we're starting a major subprocess (console or exec)
{
  if [ -n "$INFERRED_DATAROOT" ]; then
    echo "WEBHARE_DATAROOT is not set and inferring WEBHARE_DATAROOT has been deprecated" 2>&1
    echo "Make sure WEBHARE_DATAROOT is set and exported or use 'runkit' to manage your WebHare intallation(s)" 2>&1
    sleep 3
  fi

  mkdir -p "$WEBHARE_DATAROOT"/home "$WEBHARE_DATAROOT"/tmp >/dev/null 2>&1
  WEBHARE_DATAROOT="`cd $WEBHARE_DATAROOT; pwd`" #Ensure we have a full path

  # WH 5.0 - move the unified cache (image cache) into the right place. To avoid races we *have* to do this before we start WebHare - it should normally be done in a sec...
  if [ -d "$WEBHARE_DATAROOT"/ephemeral/system.uc2 ]; then
    # If a conflicting dir exists, you upgraded WebHare while it was running. Removing it, images will get recreated
    rm -rf -- "$WEBHARE_DATAROOT"/storage/system/output/uc >/dev/null 2>&1
    mkdir -p -- "$WEBHARE_DATAROOT"/storage/system/output
    if ! mv "$WEBHARE_DATAROOT"/ephemeral/system.uc2 "$WEBHARE_DATAROOT"/storage/system/output/uc ; then
      # If this failed.. cross disk partition? we'll delete it in the background and have it regenerated.
      rm -rf -- "$WEBHARE_DATAROOT"/ephemeral/system.uc2 > /dev/null 2>&1 &
    fi
  fi

  # When running from source, rebuild buildinfo
  if [ -z "$WEBHARE_IN_DOCKER" ]; then
    getbaseversioninfo
    if [ -z "$WEBHARE_VERSION" ]; then
      die Cannot determine WebHare version
    fi

    cat > "$WEBHARE_DIR/modules/system/whres/buildinfo.tmp" << HERE
committag="$(git -C "$WEBHARE_DIR" rev-parse HEAD)"
version="${WEBHARE_VERSION}-dev"
branch="$(git -C "$WEBHARE_DIR" rev-parse --abbrev-ref HEAD)"
origin=$(git -C "$WEBHARE_DIR" config --get remote.origin.url)
HERE
    mv $WEBHARE_DIR/modules/system/whres/buildinfo.tmp $WEBHARE_DIR/modules/system/whres/buildinfo
  fi

  # always replace webhare-config/tsconfig.json at startup
  setup_node --force
}

INSTR="${1:-help}"
shift
OPTIONS=("$@")

# Find the 'dev' module, and if present, load its hooks. Not sure if we should trust random modules to install hooks.. especially as we may run under different UIDs ?
# WEBHARE_WH_HOOK is an external hook which may replace implementations in wh.
for EXT in "$WEBHARE_WH_HOOK" \
           "$WEBHARE_DATAROOT/installedmodules/dev/scripts/wh-hook.sh" \
           "$WEBHARE_DATAROOT/installedmodules/webhare/dev/scripts/wh-hook.sh" ; do
  if [ -n "$EXT" ] && [ -f "$EXT" ]; then
    # shellcheck source=/dev/null
    source "$EXT"
  fi
done

case $INSTR in
  "exec")
    setup_for_console
    getwhparameters
    setup_node

    PROCESS="$1"
    shift

    if [ -x "$WEBHARE_DIR/bin/${PROCESS}.sh" ]; then #so 'wh exec postgres' launches the proper database and we can use the .sh extension for syntax highlighting
      PROCESS="$WEBHARE_DIR/bin/${PROCESS}.sh"
    elif [ -x "$WEBHARE_DIR/bin/$PROCESS" ]; then
      PROCESS="$WEBHARE_DIR/bin/$PROCESS"
    else
      echo "No such subbinary '$PROCESS'"
    fi

    exec $PROCESS "$@"
    exit 255
    ;;

  "execbuilt")
    setup_for_console
    getwhparameters
    setup_buildsystem
    setup_node

    DBGARGS=();
    if [ "$1" == "--dbg" ]; then
      shift
      [ "$WHBUILD_PLATFORM" == "darwin" ] && DBGARGS+=("lldb" "--")
      [ "$WHBUILD_PLATFORM" == "linux" ] && DBGARGS+=("gdb" "--args")
    fi

    PROCESS="$1"
    shift

    if [ ! -x "$PROCESS" -a -x "$WEBHARE_BUILDDIR/bin/$PROCESS" ]; then #resolve to bin path ?
      PROCESS="$WEBHARE_BUILDDIR/bin/$PROCESS"
    fi
    exec "${DBGARGS[@]}" $PROCESS "--moduledir" "$WEBHARE_BUILDDIR/lib" "$@"
    exit 255
    ;;

  "console")
    DEBUGTAGS=
    if [ "$1" == "--profile" ]; then
      DEBUGTAGS=apr
      shift;
    elif [ "$1" == "--coverage" ]; then
      DEBUGTAGS=cov
      shift;
    fi

    [ -n "$DEBUGTAGS" ] && WEBHARE_DEBUG="$WEBHARE_DEBUG,$DEBUGTAGS"

    check_webhare_not_running
    setup_for_console
    setup_node

    getwhparameters
    setup_webhare_envsettings
    PREVIOUSVERSION=""
    if [ -f "$WEBHARE_DATAROOT/webhare.version" ]; then
      PREVIOUSVERSION="$(jq -r .version < "$WEBHARE_DATAROOT/webhare.version" 2>/dev/null)"
    fi
    if [ -n "$PREVIOUSVERSION" ] && ! verify_webhare_version "$PREVIOUSVERSION" "$WEBHARE_VERSION" ; then
      echo "Aborting - if you want to ignore this version check failure, delete $WEBHARE_DATAROOT/webhare.version at your own risk!"
      exit 1
    fi

    # Show version and restore information
    echo -n "WebHare version: $WEBHARE_VERSION"
    if [ "$WEBHARE_ISRESTORED" == "1" ]; then
      echo " (restored)"
    elif [ -n "$WEBHARE_ISRESTORED" ]; then
      echo " ($WEBHARE_ISRESTORED)"
    else
      echo ""
    fi

    TOSHOWFILE=
    if [ "$DEBUGTAGS" == "cov" ]; then
      runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr" --deleteprofiles

      echo "Coverage data will be stored in ${WEBHARE_DATAROOT}ephemeral/profiles/default"
      echo
    fi

    # envvar WEBHARE_DEBUG should be treated as an 'initial' value so we move it
    if [ -n "$WEBHARE_DEBUG" ]; then
      export __WEBHARE_DEBUG_INITIALSETTING="$WEBHARE_DEBUG"
      WEBHARE_DEBUG=""
    fi

    # reset current directory, make sure we're not on a mountpunt (and would dump any coredumps over the network)
    cd /tmp/

    if [ "$DEBUGTAGS" == "" ]; then # no processing needed, just exec
      exec $WEBHARE_DIR/bin/webhare "$@" console
      exit 255
    fi

    $WEBHARE_DIR/bin/webhare "$@" console

    if [ "$DEBUGTAGS" == "cov" ]; then
      echo
      echo "Processing coverage data in ${WEBHARE_DATAROOT}ephemeral/profiles/default"
      runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr"
      echo "Results are available in ${WEBHARE_DATAROOT}ephemeral/profiles/default/index.html"
      TOSHOWFILE="${WEBHARE_DATAROOT}ephemeral/profiles/default/index.html"
    fi

    if [ -n "$TOSHOWFILE" ]; then
      [ "$WHBUILD_PLATFORM" == "darwin" ] && open "$TOSHOWFILE"
      [ "$WHBUILD_PLATFORM" == "linux" ] && xdg-open "$TOSHOWFILE"
    fi

    exit 0
    ;;

  "reset-coverage")
    exec_runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr" --deleteprofiles
    ;;

  "calculate-coverage")
    exec_runscript --workerthreads 4 "mod::system/scripts/debug/analyze_coverage.whscr"
    ;;

  "cachereset")
    check_webhare_running
    CLEARPERSISTENT=
    while [ "$#" -ne 0 ]; do
      if [ "$1" == "-p" ]; then
        CLEARPERSISTENT=-p
      else
        die "Unknown option $1"
      fi
      shift
    done
    exec_runscript mod::system/scripts/whcommands/softreset.whscr -c $CLEARPERSISTENT
    ;;

  "run")
    getscripttorun SCRIPT "$@"
    if [ -z "$SCRIPT" ]; then
      die "Specify the script to run"
    fi

    setup_node
    if [ "${SCRIPT: -3}" == ".es" -o "${SCRIPT: -3}" == ".js" -o "${SCRIPT: -3}" == ".ts" -o "${SCRIPT: -4}" == ".tsx" ]; then
      BASE_DIR=$WEBHARE_DIR/node_modules
      export NODE_OPTIONS=
      SKIPVALIDATE=--swc
      while (true); do
        if [ "$1" == "--debug" ]; then
          NODE_OPTIONS=--debug
          shift
        elif [ "$1" == "--inspect" ]; then
          NODE_OPTIONS=--inspect
          shift
        elif [ "$1" == "--whdebug" ]; then
          shift
          shift
        elif [ "$1" == "--validate" ]; then
          SKIPVALIDATE=
          shift
        else
          break
        fi
      done
      CMDLINE=("$BASE_DIR/.bin/ts-node" $SKIPVALIDATE "$@")
      exec "${CMDLINE[@]}"
      die Failed to invoke ts-node for $1
    else
      if [ "$1" == "--whdebug" ]; then
        shift
        export WEBHARE_DEBUG="$1"
        shift
      elif [[ $1 =~ ^--whdebug=(.*) ]]; then
        export WEBHARE_DEBUG="${BASH_REMATCH[1]}"
        shift
      elif [ "$1" == "--profile" ]; then
        export WEBHARE_DEBUG=apr
        shift
      elif [ "$1" == "--coverage" ]; then
        export WEBHARE_DEBUG=cov
        shift
      elif [ "$1" == "--debugbrk" ]; then
        export WEBHARE_DEBUG=brk
        shift
      fi
      exec_runscript --workerthreads 4 "$@"
    fi
    ;;

  "republish")
    check_webhare_running
    runscript --workerthreads 4 mod::publisher/scripts/internal/publishing.whscr --measure "$@"
    ;;

  "terminate")
    check_webhare_running
    kill `pgrep -f $WEBHARE_DIR/bin`
    ;;

  "kill")
    check_webhare_running
    kill -9 `pgrep -f $WEBHARE_DIR/bin`
    ;;

  "activity")
    getlog LOGFILE access
    cut -d' ' -f4 -- "$LOGFILE" | cut -d':' -f2,3 | sort | uniq -c
    ;;

  "dumplog")
    getlog LOGFILE $1
    if [ -n "$LOGFILE" ]; then
      cat $LOGFILE
    else
      echo "Could not find log '$1'"
    fi
    ;;

  "dirs")
    if [ ! -z "$WEBHARE_CHECKEDOUT_TO" ]; then
      echo "git checkout:  $WEBHARE_CHECKEDOUT_TO"
    fi
    setup_for_console
    getwhparameters
    setup_webhare_envsettings
    echo "Installation:  $WEBHARE_DIR"
    echo "Log files:     $LOGFILEPATH"
    echo "Rescue port:   http://127.0.0.1:${WEBHARE_BASEPORT}/"
    echo ""
    echo "Data root:     $WEBHARE_DATAROOT"
    echo "Database data: $WEBHARE_DATABASEPATH"
    echo ""
    set|grep ^WEBHARE_
    ;;

  "getrootdir")
    echo ${WEBHARE_CHECKEDOUT_TO:-WEBHARE_DIR}
    ;;

  "getdatadir")
    getwhparameters
    echo $WEBHARE_DATAROOT
    ;;

  "getmoduledir")
    getmoduledir MODULEDIR "$1"
    echo $MODULEDIR
    ;;

  "getmodulelist")
    loadshellconfig
    echo $WEBHARE_CFG_MODULES
    ;;

  "getinstalledmodulelist")
    loadshellconfig
    echo $WEBHARE_CFG_INSTALLEDMODULES
    ;;

  "compile")
    exec_whcompile "$@"
    ;;

  "setupmyshell")
    cat << HERE
wh() { $WEBHARE_DIR/bin/wh "\$@"; } ;
whcd() {
  local DEST;
  DEST="\`wh run mod::system/scripts/internal/cli/getdir.whscr \"\$@\"\`";
  [ -n "\$DEST" ] && cd "\$DEST";
} ;
export -f wh ;
export -f whcd ;
source $WEBHARE_DIR/lib/wh-bashautocomplete.sh
HERE
    ;;

  "runtest")
    setup_node
    runscript --workerthreads 10 --onlyshippedfonts mod::system/scripts/internal/tests/runtest.whscr "$@"
    EXITCODE=$?
    if [ "$EXITCODE" != "0" ]; then
      echo "Test failed with exit code $EXITCODE"
      exit $EXITCODE
    fi
    exit 0
    ;;

  "make")
    if [[ "${OPTIONS[@]}" =~ install ]]; then
      check_webhare_not_running
    fi
    setup_buildsystem
    estimate_buildj
    cd $WEBHARE_BUILDDIR
    if ! make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile "${OPTIONS[@]}" ; then
      [ -z "$WEBHARE_IN_DOCKER" ] && cat $WEBHARE_CHECKEDOUT_TO/addons/makefailed.txt
      exit 1
    fi
    exit 0
    ;;

  "fixbuild")
    check_webhare_not_running
    setup_buildsystem
    estimate_buildj
    cd $WEBHARE_BUILDDIR

    # Cannot build a target for this in the makefile, we want to serialise these steps
    for P in clean-icu-provider clean-libs postuninstall install; do
      make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile $P "${OPTIONS[@]}"
    done
    exit
    ;;

  "builddocker")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/builddocker.sh "$@"
    ;;

  "testdocker")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/testdocker.sh "$@"
    ;;

  "deploydocker")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/deploydocker.sh "$@"
    ;;

  "testmodule")
    exec $WEBHARE_CHECKEDOUT_TO/addons/docker-build/testdocker.sh -m "$@"
    ;;

  "isrunning")
    is_webhare_running && exit 0 || exit 1
    ;;

  "installsocketbinder")
    git clone https://github.com/WebHare/socket_binder.git /tmp/installsocketbinder.$$
    cd /tmp/installsocketbinder.$$
    make
    if [ "$WHBUILD_PLATFORM" == "darwin" ]; then
      sudo make install-darwin
    else
      sudo make install
      echo "Make install ran, now do whatever it takes to start socketbinder on this platform"
    fi
    exit 0
    ;;

  "mic")
    setup_buildsystem
    eval `$WEBHARE_DIR/bin/webhare printparameters`
    check_webhare_not_running
    estimate_buildj
    cd $WEBHARE_BUILDDIR
    if ! make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile install ; then
      [ -z "$WEBHARE_IN_DOCKER" ] && cat $WEBHARE_CHECKEDOUT_TO/addons/makefailed.txt
       exit 1
    fi

    getwhparameters

    exec $WEBHARE_DIR/bin/wh "$@" console
    exit 255
    ;;

  "hstest")
    if [ -z "$1" ]; then
      die "Specify the test to run"
    fi
    setup_buildsystem
    estimate_buildj
    cd $WEBHARE_BUILDDIR
    exec make -rj$WHBUILD_NUMPROC -f $WEBHARE_CHECKEDOUT_TO/base_makefile HSTEST=$1 harescript-test
    exit 255
    ;;

  "__listcommands")
    list_commands | sort -u
    exit 0
    ;;

  "up" | "st" | "status" | "umic")
    echo "The command '$INSTR' is now provided by the 'dev' module, please install it first"
    exit 255
    ;;

  "__autocomplete_wh")
    autocomplete_init_compwords

    if [ "$COMP_CWORD" == "1" ]; then
      # Return list of commands (line separated)
      IFS=$'\n' read -d '' -r -a COMPREPLY <<< "$(wh __listcommands)"
    fi

    autocomplete_print_compreply
    ;;

  "__autocomplete_whcd")
    autocomplete_init_compwords

    if [ "$COMP_CWORD" == "1" ]; then
      CUR="${COMP_WORDS[1]}"
      MODULEPREFIX=${CUR%%/*}

      if [ "$MODULEPREFIX" == "$CUR" ]; then
        # no slash, return module list (space separated) and append a slash
        read -r -a COMPREPLY <<< "$(wh getmodulelist)"
        COMPREPLY=("${COMPREPLY[@]/%//}")
      else
        # Calculate the path within the module
        SUBPATH=${CUR#"$MODULEPREFIX/"}

        # cd to the module root and complete the subpath there. Add the module prefix and append a slash
        pushd "$(wh getmoduledir "$MODULEPREFIX")" > /dev/null || return
        # Parse list of directories (line separated)
        IFS=$'\n' read -d '' -r -a COMPREPLY <<< "$(compgen -d -P "$MODULEPREFIX/" -S / -- "${SUBPATH}")"
        popd > /dev/null || return
      fi
    fi

    autocomplete_print_compreply
    ;;

  *)
    if [[ $INSTR =~ .*:.* ]]; then
      TARGETMODULE="${INSTR%:*}"
      SUBCOMMAND="${INSTR##*:}"
    else
      TARGETMODULE=system
      SUBCOMMAND="$INSTR"
    fi

    getmoduledir MODULEDIR $TARGETMODULE

    if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.sh" ]; then
      exec /bin/bash "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.sh" "${OPTIONS[@]}"
    fi
    if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.whscr" ]; then
      exec_runscript --workerthreads 4 "mod::$TARGETMODULE/scripts/whcommands/$SUBCOMMAND.whscr" "${OPTIONS[@]}"
    fi
    if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.ts" ] ; then
      setup_node
      exec "$WEBHARE_DIR/node_modules/.bin/ts-node" --swc "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.ts" "${OPTIONS[@]}"
    fi
    if [ -f "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.js" ]; then
      setup_node
      exec "$WEBHARE_DIR/node_modules/.bin/ts-node" --swc "$MODULEDIR/scripts/whcommands/$SUBCOMMAND.js" "${OPTIONS[@]}"
    fi

    die "Command '$INSTR' not understood - use 'wh help' for a list of instructions"
    ;;
esac
