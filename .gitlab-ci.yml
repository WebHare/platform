# https://docs.gitlab.com/ce/ci/yaml/
# https://docs.gitlab.com/ee/ci/docker/using_docker_build.html

# Note:
#    GitLab has dind runners, which will be able to run wh builddocker
#    WebHarebv has shell executors.. which just ignore the images.. which seems to work just as well

image: docker:19.03.1-dind

services:
  - docker:dind

stages:
  - build
  - test
  - deploy

# if apk is present,
default:
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - ( which apk && apk add bash curl git ) || true    # execute on alpine only
  after_script:
    - docker logout $CI_REGISTRY
    - docker logout


builddocker:
  stage: build
  except:
    - schedules
  script:
    - whtree/bin/wh builddocker
  artifacts:
    paths:
      - build/
    expire_in: 1 week
    when: always
  interruptible: true

builddocker-scheduled:
  stage: build
  only:
    - schedules
  script:
    - whtree/bin/wh builddocker --no-cache
  artifacts:
    paths:
      - build/
    expire_in: 1 week
    when: always
  interruptible: true

testbaselibs:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external baselibs
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testmodules:
  stage: test
  script:
    - whtree/bin/wh testdocker --tag=-external checkmodules
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testversioning:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external publisher-versioning
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testpublisher:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external,-forms publisher
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testpublisher-forms:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=forms publisher
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testsystem:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external system
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testwebdesign:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external publisher-webdesign
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testdatabase:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external wh.database
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testtollium:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external tollium
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testtollium-components:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external tollium-components
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testconsilio:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external consilio
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testelasticsearch:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - TESTFW_SETUP_ELASTICSEARCH=1 whtree/bin/wh testdocker --tag=-external consilio
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testcore:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external --generatexmltests wh.hscore
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testwebserver:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external wh.webserver
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testsocialite:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external socialite
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testwrd:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external wrd
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testjscomponents:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --tag=-external wh.jscomponents
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testexternal:
  stage: test
  except:
    - /^docs\/.*$/
  allow_failure: true
  script:
    - whtree/bin/wh testdocker --tag=external
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testsftp:
  stage: test
  except:
    - /^docs\/.*$/
  allow_failure: true
  script:
    - whtree/bin/wh testdocker --tag=-external wh.sftp
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

testtwohares:
  stage: test
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --twohares --testscript $PWD/whtree/modules/webhare_testsuite/scripts/whcommands/twoharetests.sh
  artifacts:
    paths:
      - artifacts
    when: on_failure
    expire_in: 1 week
  interruptible: true

calculatecoverage:
  stage: test
  when: manual
  except:
    - /^docs\/.*$/
  script:
    - whtree/bin/wh testdocker --coverage --generatexmltests
  artifacts:
    paths:
      - artifacts
      - coverage.tar.gz
    when: always
    expire_in: 1 week
  interruptible: true

deploydocker:
  stage: deploy
  except:
    - schedules
    - /^docs\/.*$/
  script:
    - whtree/bin/wh deploydocker
  interruptible: true

updatetestscripts:
  stage: deploy
  only:
    refs:
      - master
    variables:
      - $WHBUILD_BUILDBOTPASSWORD
  except:
    - schedules
    - /^docs\/.*$/
  script:
    - addons/deploy_testscripts.sh

