################################################
#
# This makefile is executed by `wh` on source code checkouts but by
# `/opt/wh/builder/make.sh install` on container builds. These routes differ
# in which set of environment variables they define, but on Darwin you can always
# assume we're invoked by `wh` and have the full set.
#

################################################
#
# Check whether 'make' itself is recent enough:
#
NEED_MAKE_VERSION=4.3
ifneq ($(firstword $(sort $(MAKE_VERSION) $(NEED_MAKE_VERSION))),$(NEED_MAKE_VERSION))
  $(error This makefile requires version $(NEED_MAKE_VERSION), you have $(MAKE_VERSION)))
endif

#MAKEFLAGS+=--warn-undefined-variables # too much noise with 4.3
#MAKEFLAGS+=--output-sync=target # finalize-webhare step takes frustratingly long with this

################################################
#
# Extensions & paths

SRCDIR ?= .
PREFIX ?= $(SRCDIR)/whtree
WEBHARE_PLATFORM := $(shell uname | tr A-Z a-z)

export WHBUILD_SRCDIR=$(abspath $(SRCDIR))
export WHBUILD_PREFIX=$(abspath $(PREFIX))
export WHBUILD_BUILDDIR:=$(abspath $(shell pwd))

ifeq ($(DEBUGMAKE),1)
	HIDE=
else
	HIDE=@
endif

# Setup vendored libxml2 compilation. We add the builddir includes for generated config.h and xmlversion.h
CPPFLAGS += -I$(WHBUILD_BUILDDIR)/vendor-native/libxml2 -I$(WHBUILD_BUILDDIR)/vendor-native/libxml2/include -I$(SRCDIR)/vendor/libxml2/include/
CPPFLAGS_WASM += -I$(WHBUILD_BUILDDIR)/vendor-wasm/libxml2 -I$(WHBUILD_BUILDDIR)/vendor-wasm/libxml2/include -I$(SRCDIR)/vendor/libxml2/include/

ifeq ($(WEBHARE_PLATFORM),darwin)
	BUILDSYSTEM ?= llvm
	BREWPREFIX ?= $(shell brew --prefix)
	BREWPREFIX := $(BREWPREFIX)
	# brew has multiple independent postgresql@version packages. Get the newest one
	POSTGRESQLPACKAGE ?= $(shell brew list | grep "^postgresql@" | sort -r --human-numeric-sort | head -n 1)
	POSTGRESQLPACKAGE := $(POSTGRESQLPACKAGE)
	# Convert BREWPREFIX and POSTGRESQLPACKAGE to a static value, so the shell command will be evaluated only once.
	BREWPREFIX := $(BREWPREFIX)
	POSTGRESQLPACKAGE := $(POSTGRESQLPACKAGE)

	# The pkgconfig dirs of postgresql@13, postgresql@14 and postgresql@17 differ. Include all patterns
	PKGCONFIGPATHS = $(BREWPREFIX)/opt/openssl/lib/pkgconfig:$(BREWPREFIX)/opt/icu4c/lib/pkgconfig/:$(BREWPREFIX)/opt/$(POSTGRESQLPACKAGE)/lib/pkgconfig/:$(BREWPREFIX)/opt/$(POSTGRESQLPACKAGE)/lib/$(POSTGRESQLPACKAGE)/pkgconfig/:$(BREWPREFIX)/opt/$(POSTGRESQLPACKAGE)/lib/postgresql/pkgconfig/
	CPPFLAGS += -I$(BREWPREFIX)/include -I$(BREWPREFIX)/include/pixman-1
	GLOBALLDFLAGS += -L$(BREWPREFIX)/lib

else
	BUILDSYSTEM ?= gcc
	PKGCONFIGPATHS = /usr/lib/x86_64-linux-gnu/pkgconfig/:/usr/local/ssl/lib/pkgconfig/:/usr/local/lib/pkgconfig:/usr/local/lib64/pkgconfig/:/usr/lib64/pkgconfig/
	# Set LD_LIBRARY_PATH for tests
	LD_LIBRARY_PATH := $(WHBUILD_BUILDDIR)/lib:/usr/local/lib:/usr/local/lib64:/usr/local/ssl/lib/:$(LD_LIBRARY_PATH)
	GLOBALLDFLAGS += -L/usr/local/lib64
endif

PKGCONFIG = PKG_CONFIG_PATH=$(PKG_CONFIG_PATH):$(PKGCONFIGPATHS) pkg-config

ifeq ($(WEBHARE_PLATFORM),darwin)
	DLL_SUFFIX=.dylib
	DLL_SUFFIXPATTERN=*.dylib
else
	DLL_SUFFIX=.so
	DLL_SUFFIXPATTERN=.so*
endif

vpath %.cpp $(SRCDIR)
vpath %.c $(SRCDIR)
vpath %.h $(SRCDIR)
vpath %.S $(SRCDIR)
vpath %.pc $(PKGCONFIGPATHS)

export WEBHARE_PLATFORM
export PREFIX
export DLL_SUFFIX
export LD_LIBRARY_PATH

################################################
#
# Compiler/linker configuration
#

PKGCONFIG_PACKAGES = openssl freetype2 pixman-1 icu-i18n libpq
PKGCONFIGCFLAGS := $(shell $(PKGCONFIG) --cflags $(PKGCONFIG_PACKAGES))
PKGCONFIGLDFLAGS := $(shell $(PKGCONFIG) --libs $(PKGCONFIG_PACKAGES))

CPPFLAGS += -I$(SRCDIR)
CPPFLAGS_WASM += -I$(SRCDIR)

# AWS SDK disables exceptions via pkgconfig cflags, put in extra -fexceptions to re-enable
CXXFLAGS += $(PKGCONFIGCFLAGS) -fexceptions -g -Wall -Wextra -W -Werror -Wno-unused-result -Wno-long-long -fno-strict-aliasing -pthread -fPIC -pedantic -fvisibility=hidden -Wno-switch
# lots of #ifdefs make unused function checking a bit pointless for now
CXXFLAGS_WASM += -g -Wall -Wextra -W -Werror -Wno-unused-result -Wno-long-long -fno-strict-aliasing -pedantic -fvisibility=hidden -Wno-unused-function -Wno-deprecated-declarations

ifneq ($(DISABLE_PCH),1)
	CXXFLAGS+=-Igch-native/
	CXXFLAGS_WASM+=-Igch-wasm/
endif


GLOBALLDFLAGS += $(PKGCONFIGLDFLAGS)
ifeq ($(WEBHARE_PLATFORM),linux)
  CPPFLAGS += -I/opt/libjpeg-turbo/include
  GLOBALLDFLAGS += -L/opt/libjpeg-turbo/lib64/
  ifeq ($(WHBUILD_LTO),1)
    CPPFLAGS += -flto=jobserver
    GLOBALLDFLAGS += -flto=jobserver
  endif
endif

ifeq ($(WHBUILD_WASMLTO),1)
  CPPFLAGS_WASM += -flto
  WHLDFLAGS_WASM += -flto
endif

GLOBALLDFLAGS += -Llib

ifeq ($(BUILDSYSTEM),gcc)
  CXXFLAGS+=-std=c++17 -Wno-deprecated-declarations
else
	CXXFLAGS+=-std=c++17 -Wno-deprecated-declarations
	ifeq ($(WEBHARE_PLATFORM),darwin)
		CXXFLAGS+=-stdlib=libc++ -Wno-nan-infinity-disabled
		GLOBALLDFLAGS+=-stdlib=libc++
	else
		CXXFLAGS+=-Wno-unknown-attributes
	endif
endif

ifeq ($(WHBUILD_DEBUG),1)
	CPPFLAGS += -DWHBUILD_DEBUG -fno-omit-frame-pointer
	CPPFLAGS_WASM += -DWHBUILD_DEBUG -fno-omit-frame-pointer
	CXXFLAGS += -O0
	CXXFLAGS_WASM += -O0
	WHLDFLAGS_WASM += -g -gsource-map
else
	CXXFLAGS += -DNDEBUG -O3
	CXXFLAGS_WASM += -DNDEBUG -O3
	ifeq ($(BUILDSYSTEM),gcc)
		CXXFLAGS += -fno-implement-inlines -ffast-math -finline-functions
	else
		ifeq ($(BUILDSYSTEM),llvm)
		  ifneq ($(WEBHARE_PLATFORM),linux)
		    # -ffast-math gives compilation errors on Fedora 18
		    CXXFLAGS += -ffast-math
		  endif
		endif
	endif
endif

ifeq ($(WHBUILD_PROFILE),1)
	CXXFLAGS += -fno-omit-frame-pointer
	# --profiling: Use reasonable defaults when emitting JavaScript to make the build readable but still useful for profiling.
	CXXFLAGS_WASM += --profiling
	WHLDFLAGS_WASM += --profiling
else
  # --profiling-funcs: Preserve function names in profiling, but otherwise minify whitespace and names as we normally do in optimized builds. This is useful if you want to look at profiler results based on function names, but do not intend to read the emitted code
	WHLDFLAGS_WASM += --profiling-funcs
endif

ifeq ($(BUILDSYSTEM),llvm)
	ifeq ($(WEBHARE_PLATFORM),darwin)
		# Warnings coming from boost headers
		CXXFLAGS += -Wno-unknown-warning-option -Wno-unused-parameter -Wno-parentheses-equality -Wno-char-subscripts -Wno-unused-function -Wno-deprecated-register -Wno-unused-local-typedef -Wno-keyword-macro
		# For webhare (too many false positives)
		CXXFLAGS += -Wno-unused-private-field
	else
		# Warnings coming from boost headers
		CXXFLAGS += -Wno-unknown-warning-option -Wno-unused-parameter -Wno-parentheses-equality -Wno-char-subscripts -Wno-unused-function
		# For webhare (too many false positives)
		CXXFLAGS += -Wno-unused-private-field
	endif
else
	# Warnings coming from boost headers
	CXXFLAGS += -Wno-unused-function
endif

GLOBALLDFLAGS += -rdynamic

#webhare/blex/datetime.h:176:32: error: unknown warning group '-Wmissing-attributes', ignored [-Werror,-Wunknown-warning-option]
#webhare/blex/tests/teststring.cpp:517:102: error: array subscript is of type 'char' [-Werror,-Wchar-subscripts]
#ES_ASM seems to need -Wno-gnu-zero-variadic-macro-arguments
CXXFLAGS_WASM += -Wno-unknown-warning-option -Wno-char-subscripts -fwasm-exceptions -Wno-gnu-zero-variadic-macro-arguments
WHLDFLAGS_WASM += -fwasm-exceptions -sNODERAWFS=1 -O3 -lembind

ifeq ($(WEBHARE_PLATFORM),darwin)
	# Use current MacOS version, no need for binaries to be portable between machines
	MACOSVERSION := $(shell sw_vers | grep ProductVersion: | tr -d '\t' | cut -d: -f2 | cut -d "." -f 1-2)
	CXXFLAGS += -mmacosx-version-min=$(MACOSVERSION)
	GLOBALLDFLAGS += -mmacosx-version-min=$(MACOSVERSION)
else
	GLOBALLDFLAGS += -pthread
endif

ifneq ($(SANITIZE),)
	CXXFLAGS += -fsanitize=$(SANITIZE)
	GLOBALLDFLAGS += -fsanitize=$(SANITIZE)
endif

BLEX_SSL_LIBS=ssl crypto

ICU_LIBS = icui18n icudata icuuc
DRAWLIB_BASE_LIBS=freetype png tiff gif pixman-1
DRAWLIB_STATIC_LIBS=

DRAWLIB_BASE_LIBS+=jpeg

EMCC?=emcc
EMSCRIPTEN_VERSION_FILE := $(SRCDIR)/vendor/wh-current-emscripten-version

ifeq ($(BUILDSYSTEM),gcc)
	ifeq ($(CXX),clang++)
		# Allow override - CXX is always set to system C++ compiler
		CXX=g++
	endif
	CXX?=g++
	CC?=gcc
	LD_APP?=g++
else ifeq ($(BUILDSYSTEM),llvm)
	ifeq ($(CXX),g++)
		# Allow override - CXX is always set to system C++ compiler
		CXX=clang++
	endif
	CXX?=clang++
	CC?=clang
	LD_APP?=clang++
else
  $(error Unsupported build system $(BUILDSYSTEM))
endif

ifeq ($(WHBUILD_NOCCACHE),)
	export CCACHE_DIR:=${WHBUILD_CCACHE_DIR}
	CC:=ccache ${CC}
	CXX:=ccache ${CXX}
	EMCC:=ccache ${EMCC}
endif

WHLDFLAGS+=$(GLOBALLDFLAGS)

WASM_EXPORTED_RUNTIME_METHODS = stringToUTF8,lengthBytesUTF8,stringToNewUTF8,UTF8ToString,getValue,setValue,ENV,addFunction,removeFunction,Emval,HEAP8,HEAP16,HEAP32,HEAPU8,HEAPU16,HEAPU32,HEAPF32,HEAPF64,HEAP64,HEAPU64

WHLDFLAGS_IMPORTABLE += -s MODULARIZE=1
WHLDFLAGS_IMPORTABLE += -s EXPORT_NAME="createModule"
WHLDFLAGS_IMPORTABLE += -s EXPORTED_RUNTIME_METHODS=$(WASM_EXPORTED_RUNTIME_METHODS)
WHLDFLAGS_IMPORTABLE += -s EXPORTED_FUNCTIONS=_malloc,_free

WHLDFLAGS_EXECUTABLE += -s EXPORTED_RUNTIME_METHODS=$(WASM_EXPORTED_RUNTIME_METHODS)

# Get all normal lines from wasm-suspending-functions.txt, seperated by commas
JSPI_EXPORTS := $(shell cat $(SRCDIR)/harescript/vm/wasm-suspending-functions.txt | grep -oe "^[^ \#]\+" | tr '\n' ','  | sed "s/,$$//" )

WHLDFLAGS_WASM += -s ALLOW_MEMORY_GROWTH=1
WHLDFLAGS_WASM += -s IMPORTED_MEMORY
WHLDFLAGS_WASM += -s STACK_SIZE=8MB
WHLDFLAGS_WASM += -s INITIAL_MEMORY=16MB
WHLDFLAGS_WASM += -s JSPI
WHLDFLAGS_WASM += -s JSPI_EXPORTS=$(JSPI_EXPORTS)
WHLDFLAGS_WASM += -s ALLOW_TABLE_GROWTH
WHLDFLAGS_WASM += -s WASM_BIGINT
WHLDFLAGS_WASM += --pre-js $(SRCDIR)/harescript/vm/wasm-pre.js

CPPFLAGS_WASM += -s USE_ZLIB=1
WHLDFLAGS_WASM += -s USE_ZLIB=1

ifeq ($(WEBHARE_PLATFORM),darwin)
	WHLDFLAGS += -Wl,-rpath '-Wl,@loader_path/../lib'
else
	WHLDFLAGS += -Wl,-rpath '-Wl,/usr/local/lib' -Wl,-rpath '-Wl,/usr/local/lib64'   -Wl,-rpath '-Wl,$$ORIGIN/../lib'
	CPPFLAGS += -DUSE_VALGRIND=1 # not supported on darwin
endif

CPPFLAGS += -DHAVE_LIBGIT=1
harescript_HsMod_git_AddLibs = git2

CompileCNative = $(HIDE)echo "- CompileCNative $1 -> $2" && $(CC) $(CPPFLAGS) -o$2 -c $1
CompileCWasm   = $(HIDE)echo "- CompileCWasm $1 -> $2"   && $(EMCC) $(CPPFLAGS_WASM) -o$2 -c $1

CompileCPPNative = $(HIDE)echo "- CompileCPPNative $1 -> $2" && $(CXX) $(CPPFLAGS) $(CXXFLAGS) -o$2 -c $1
CompileCPPWasm = $(HIDE)echo "- CompileCPPWasm $1 -> $2" && $(EMCC) $(CPPFLAGS_WASM) $(CXXFLAGS_WASM) -o$2 -c $1

GenerateDepsNative = $(HIDE)echo "- GenerateDepsNative $1 -> $2" && $(CXX) $(CPPFLAGS) $(CXXFLAGS) -M -MP -MT "$2 $(subst .native-d,.native-obj,$2)" $3 -o $2 -c $1
GenerateDepsWasm   = $(HIDE)echo "- GenerateDepsWasm $1 -> $2" && $(EMCC) $(CPPFLAGS_WASM) $(CXXFLAGS_WASM) -M -MP -MT "$2 $(subst .wasm-d,.wasm-obj,$2)" $3 -o $2 $1

GeneratePCHDepsNative = $(HIDE)echo "- GeneratePCHDepsNative $1 -> $2" && $(CXX) $(CPPFLAGS) $(CXXFLAGS) -x c++-header -M -MP -MT "$2 $(subst .native-d,.gch,$2)" $3 -o $2 -c $1
GeneratePCHDepsWasm = $(HIDE)echo "- GeneratePCHDepsWasm $1 -> $2" && $(EMCC) $(CPPFLAGS_WASM) $(CXXFLAGS_WASM) -x c++-header -M -MP -MT "$2 $(subst .wasm-d,.gch,$2)" $3 -o $2 $1

GeneratePCHNative = $(HIDE)echo "- GeneratePCHNative $2" && $(CXX) $(CPPFLAGS) $(CXXFLAGS) -x c++-header $4 -o$3 -c $2
GeneratePCHWasm = $(HIDE)echo "- GeneratePCHWasm $2" && $(EMCC) $(CPPFLAGS_WASM) $(CXXFLAGS_WASM) -x c++-header $4 -o$3 -c $2

# We'll keep the fix-emcc-output.js infrastructure around now fix-emcc-output.js
LinkWASMImportable  = $(HIDE)echo "- LinkWASMImportable $2" && $(EMCC) $(WHLDFLAGS_WASM) $(WHLDFLAGS_IMPORTABLE) -o $2 $1 && node $(SRCDIR)/harescript/vm/fix-emcc-output.js $2
LinkWASMExecutable  = $(HIDE)echo "- LinkWASMExecutable $2" && $(EMCC) $(WHLDFLAGS_WASM) $(WHLDFLAGS_EXECUTABLE) -o $2 $1 && node $(SRCDIR)/harescript/vm/fix-emcc-output.js $2

ifeq ($(WEBHARE_PLATFORM),darwin)
 	LinkShared       = $(HIDE)echo "- LinkSharedNative $2" && $(LD_APP) $(WHLDFLAGS) -shared -Wl,-install_name -Wl,@rpath/$(notdir $2) -o $2 $1 $(addprefix -l,$3)
 	LinkModule       = $(HIDE)echo "- LinkModuleNative $2" && $(LD_APP) $(WHLDFLAGS) -shared -Wl,-install_name -Wl,@rpath/$(notdir $2) -o $2 $1 $(addprefix -l,$3)
 	LinkExecutable   = $(HIDE)echo "- LinkExecutableNative $2" && $(LD_APP) $(WHLDFLAGS) -o $2 $1 $(addprefix -l,$3)
else
	LinkShared       = +$(HIDE)echo "- LinkSharedNative $2" && $(LD_APP) $(WHLDFLAGS) -shared -o $2 $1 $(addprefix -l,$3)
	LinkModule       = +$(HIDE)echo "- LinkModuleNative $2" && $(LD_APP) $(WHLDFLAGS) -shared -o $2 $1 $(addprefix -l,$3)
	LinkExecutable   = +$(HIDE)echo "- LinkExecutableNative $2" && $(LD_APP) $(WHLDFLAGS) -o $2 $1 $(addprefix -l,$3)
endif


FullPath=$(if $(filter /%,$(1)),$(1),$(abspath $(WHBUILD_BUILDDIR)/$(1)))

################################################
#
# Other useful internal variables

HSENGINE_SUBPROJECTS=blex harescript
WHAP_SUBPROJECTS=blex harescript ap
HSENGINE_SUBPROJECTS+=drawlib parsers
WHAP_SUBPROJECTS+=drawlib parsers

SUBPROJECTS=$(sort $(HSENGINE_SUBPROJECTS) $(WHAP_SUBPROJECTS))
GetSrcFiles=$(subst $(SRCDIR)/,,$(wildcard $(SRCDIR)/$1))
Src2ObjFiles=$(addprefix ,$(subst .cpp,.native-obj,$1))
GetObjFiles=$(call Src2ObjFiles,$(call GetSrcFiles,$1))

ALLBUILDDIRS=$(ALLOBJDIRS) bin lib vendor/libxml2

ifneq ($(DISABLE_PCH),1)
  ALLBUILDDIRS += $(ALLPCHDIRS)
endif

# Create all directories
ALLDIRS=$(ALLBUILDDIRS) $(ALLINSTALLDIRS) $(PREFIX)/bin $(PREFIX)/lib

#################################################
##
## File listings
##

## Configuration


# BLEX - Configuration
LIBBLEX_LIBXML2_NAMES=tree xmlstring HTMLparser xmlmemory xmlschemas xpath globals pattern xmlschemastypes xmlregexp parser valid xmlunicode parserInternals SAX2 xmlreader uri encoding error relaxng xmlIO xmlsave threads hash dict entities buf HTMLtree list chvalid debugXML c14n schematron

LIBBLEX_SHARED_SOURCENAMES=api bitmanip context crc crypt_blowfish crypto crypto_sha1 datetime decimalfloat docfile getopt lexer logfile mime notificationevents path podvector socket stem_UTF_8_danish stem_UTF_8_english stem_UTF_8_french stem_UTF_8_german stem_UTF_8_italian stem_UTF_8_kraaijpohlmann stem_UTF_8_portuguese stem_UTF_8_spanish stemmer stream stringmanip testing threads tokenstream unicode utilities utils xml zstream
LIBBLEX_NATIVE_ADDSOURCENAMES=binarylogfile btree_blocks btree_filesystem complexfs dispat dispat_impl mmapfile
LIBBLEX_WASM_ADDSOURCENAMES=

LIBBLEX_SHARED_TESTNAMES=blextest testbitmanip testcontext testcrypto testdocfile testgetopt testio testmime testnet testpath teststring testtypes testutils
LIBBLEX_NATIVE_ADDTESTNAMES=test_btree_blocks test_btree_filesystem testdynamic test_index_stress testbinarylogfile testcomplexfs testthreads indexdumping
LIBBLEX_WASM_ADDTESTNAMES=

# HARESCRIPT - Configuartion
LIBHSVM_SHARED_SOURCENAMES=baselibs bl_blobs bl_docgen bl_json bl_libdumper bl_mime bl_os bl_regex bl_strings bl_tcpip bl_tokenstream bl_types bufferedpipes errors filesystem groupdata hs_lexer hsvm_blobinterface hsvm_columnnamemapper hsvm_constants hsvm_context hsvm_dllinterface hsvm_environment hsvm_events hsvm_externals hsvm_functioncalltree hsvm_idmapstorage hsvm_librarywrapper hsvm_loopbackdbprovider hsvm_marshalling hsvm_recorddbprovider hsvm_sqlinterface hsvm_sqllib hsvm_sqlqueries hsvm_stackmachine hsvm_varmemory mangling outputobject sharedpool witty xml_cssengine xml_domobjects xml_provider
LIBHSVM_NATIVE_ADDSOURCENAMES=bl_crypto hsvm_processmgr hsvm_debugger icu_provider ipc hsvm_pgsqlprovider
LIBHSVM_WASM_ADDSOURCENAMES=wasm-harescript wasm-tools

## Expansions. Old defines may also use these..
## libxml2 parts we need (we now embed this directly to simplify emscripten builds)
LIBBLEX_LIBXML2_SRCFILES = $(addsuffix .c,$(addprefix vendor/libxml2/,$(LIBBLEX_LIBXML2_NAMES)))

LIBBLEX_LIBXML2_NATIVE_OBJS = $(LIBBLEX_LIBXML2_SRCFILES:.c=.native-obj)
LIBBLEX_LIBXML2_WASM_OBJS = $(LIBBLEX_LIBXML2_SRCFILES:.c=.wasm-obj)

LIBBLEX_NATIVE_SOURCENAMES=$(LIBBLEX_SHARED_SOURCENAMES) $(LIBBLEX_NATIVE_ADDSOURCENAMES)
LIBBLEX_NATIVE_TESTNAMES=$(LIBBLEX_SHARED_TESTNAMES) $(LIBBLEX_NATIVE_ADDTESTNAMES)
LIBHSVM_NATIVE_SOURCENAMES=$(LIBHSVM_SHARED_SOURCENAMES) $(LIBHSVM_NATIVE_ADDSOURCENAMES)

LIBBLEX_WASM_SOURCENAMES=$(LIBBLEX_SHARED_SOURCENAMES) $(LIBBLEX_WASM_ADDSOURCENAMES)
LIBBLEX_WASM_TESTNAMES=$(LIBBLEX_SHARED_TESTNAMES) $(LIBBLEX_WASM_ADDTESTNAMES)
LIBHSVM_WASM_SOURCENAMES=$(LIBHSVM_SHARED_SOURCENAMES) $(LIBHSVM_WASM_ADDSOURCENAMES)

LIBBLEX_NATIVE_SOURCEOBJS=$(LIBBLEX_LIBXML2_NATIVE_OBJS) $(addsuffix .native-obj,$(addprefix blex/,$(LIBBLEX_NATIVE_SOURCENAMES)))
LIBBLEX_NATIVE_TESTOBJS=$(addsuffix .native-obj,$(addprefix blex/tests/,$(LIBBLEX_NATIVE_TESTNAMES)))
LIBHSVM_NATIVE_SOURCEOBJS=$(addsuffix .native-obj,$(addprefix harescript/vm/,$(LIBHSVM_NATIVE_SOURCENAMES)))

LIBBLEX_WASM_SOURCEOBJS=$(LIBBLEX_LIBXML2_WASM_OBJS) $(addsuffix .wasm-obj,$(addprefix blex/,$(LIBBLEX_WASM_SOURCENAMES)))
LIBBLEX_WASM_TESTOBJS=$(addsuffix .wasm-obj,$(addprefix blex/tests/,$(LIBBLEX_WASM_TESTNAMES)))
# TODO wh_filesystem here is a bit of a hack...
LIBHSVM_WASM_SOURCEOBJS=$(LIBBLEX_WASM_SOURCEOBJS) $(addsuffix .wasm-obj,$(addprefix harescript/vm/,$(LIBHSVM_WASM_SOURCENAMES))) ap/libwebhare/wh_filesystem.wasm-obj

#NATIVE_ALL_OBJS=  #todo and not a deeply recursive wildcard!
NATIVE_ALL_OBJS_DEPFILES=$(subst .native-obj,.native-d,$(ALLOBJS))

WASM_ALL_OBJS=$(LIBHSVM_WASM_SOURCEOBJS) $(LIBBLEX_WASM_TESTOBJS)
# TODO do we want to set up dep files for libxml2 ? it requires some wrangling with the implicit rules and them having .c extensions
WASM_ALL_OBJS_DEPFILES=$(subst .wasm-obj,.wasm-d,$(filter-out $(LIBBLEX_LIBXML2_WASM_OBJS),$(WASM_ALL_OBJS)))

# BLEX - rest..



blex_DEPLOYABLES_HSENGINE=lib/libblex_base$(DLL_SUFFIX)
blex_DEPLOYABLES_WHAP=$(blex_DEPLOYABLES_HSENGINE)
blex_DEPLOYABLES=$(blex_DEPLOYABLES_WHAP)

BLEX_BASE_LIBS=z dl $(ICU_LIBS) $(BLEX_SSL_LIBS)
BLEX_HSVM_LIBS=$(ICU_LIBS) pq

ifeq ($(WEBHARE_PLATFORM),darwin)
  BLEX_BASE_LIBS+=iconv
endif

BLEX_LIBS=blex_base $(BLEX_BASE_LIBS)

LIBBLEX_FILES=$(addsuffix .cpp,$(addprefix blex/,$(LIBBLEX_SOURCEFILES)))

blex_SRCDIRS=tests tools

PCH_HEADERS_SHARED+=blex/blexlib.h

ifeq ($(BLEXTEST),)
	BLEXTESTS=$(addprefix blex/tests/,$(addsuffix .cpp,$(LIBBLEX_TESTFILES)))
	RUNTEST=runtest
else
	BLEXTESTS=blex/tests/test$(BLEXTEST).cpp
	RUNTEST=runtest-$(BLEXTEST)
endif

BLEXTEST_FILES=blex/tests/blextest.cpp $(BLEXTESTS)
blex_CPPFILES=$(LIBBLEX_FILES) $(BLEXTEST_FILES)
blex_OBJFILES=$(call Src2ObjFiles, $(blex_CPPFILES))

# HARESCRIPT

HS_SUBPROJECTS = compiler vm
HS_HS_MODULES = selfcompile

LIBHSCOMPILER_OBJS = $(addprefix ,$(LIBHSCOMPILER_FILES:.cpp=.native-obj))
LIBHSVM_OBJS = $(addprefix ,$(LIBHSVM_FILES:.cpp=.native-obj))
HARESCRIPTVMTEST_OBJS = $(addprefix ,$(HARESCRIPTVMTEST_FILES:.cpp=.native-obj))

DRAWLIB_OBJS = $(addprefix ,$(DRAWLIB_FILES:.cpp=.native-obj))
DRAWLIBTEST_OBJS = $(addprefix ,$(DRAWLIBTEST_FILES:.cpp=.native-obj))
DRAWLIBHSINTERFACE_OBJS = $(addprefix ,$(DRAWLIBHSINTERFACE_FILES:.cpp=.native-obj))

HS_LIBS=blex_hscompiler blex_hsvm $(BLEX_LIBS)

PCH_HEADERS_SHARED+=harescript/vm/allincludes.h

PCH_HEADERS_NATIVE+=harescript/compiler/allincludes.h

HS_DEPLOYABLES_PREP=\
	$(addprefix lib/hsm_wh_,$(addsuffix $(DLL_SUFFIX),$(HS_HS_MODULES)))

harescript_SRCDIRS=compiler modules $(addprefix modules/,$(HS_HS_MODULES)) tests vm vmtest utils

harescript_DEPLOYABLES_BASE=lib/libblex_hsvm$(DLL_SUFFIX) lib/libblex_hscompiler$(DLL_SUFFIX) $(HS_DEPLOYABLES_PREP)

harescript_DEPLOYABLES_WHAP_EXTRAS=bin/libdumper

harescript_DEPLOYABLES_HSENGINE=$(harescript_DEPLOYABLES_BASE)
harescript_DEPLOYABLES_WHAP=$(harescript_DEPLOYABLES_BASE) $(harescript_DEPLOYABLES_WHAP_EXTRAS)
harescript_DEPLOYABLES=$(harescript_DEPLOYABLES_BASE) $(harescript_DEPLOYABLES_WHAP_EXTRAS)

LIBHSVM_FILES = $(call GetSrcFiles,harescript/vm/*.cpp)
LIBHSCOMPILER_FILES = $(call GetSrcFiles,harescript/compiler/*.cpp)
HARESCRIPTVMTEST_FILES = $(call GetSrcFiles,harescript/vmtest/*.cpp)

harescript_CPPFILES = $(LIBHSVM_FILES) $(LIBHSCOMPILER_FILES) $(HARESCRIPTVMTEST_FILES)
# (the list of harescript_CPPFILES is expanded later)

# DRAWLIB
drawlib_DEPLOYABLES_HSENGINE = lib/libblex_draw$(DLL_SUFFIX) lib/hsm_whmod_graphics$(DLL_SUFFIX)
drawlib_DEPLOYABLES_WHAP = $(drawlib_DEPLOYABLES_HSENGINE)
drawlib_DEPLOYABLES = $(drawlib_DEPLOYABLES_HSENGINE)
DRAWLIB_FILES = $(call GetSrcFiles,drawlib/drawlibv2/*.cpp)

ifeq ($(DRAWLIBTEST),)
	DRAWLIBTEST_FILES = $(call GetSrcFiles,drawlib/drawlibv2_test/*.cpp)
	RUNDRAWLIBTEST=drawlibv2_test
else
	DRAWLIBTEST_FILES = drawlib/drawlibv2_test/$(DRAWLIBTEST).cpp drawlib/drawlibv2_test/helperfuncs.cpp drawlib/drawlibv2_test/drawlibv2.cpp
	RUNDRAWLIBTEST=drawlibv2_test-$(DRAWLIBTEST)
endif

DRAWLIBHSINTERFACE_FILES = $(call GetSrcFiles,drawlib/harescript/*.cpp)

PCH_HEADERS_NATIVE+=drawlib/drawlibv2/allincludes.h

DRAWLIB_LIBS = blex_draw pixman-1

drawlib_CPPFILES = $(DRAWLIB_FILES) $(DRAWLIBTEST_FILES) $(DRAWLIBHSINTERFACE_FILES)
drawlib_SRCDIRS = drawlibv2 harescript $(RUNDRAWLIBTEST)

# PARSERS
PARSERS_baselib = lib/libblex_parser_base$(DLL_SUFFIX)
PARSERS_escherlib = lib/libblex_parser_office_escher$(DLL_SUFFIX)
PARSERS_MODULES = $(filter-out .svn,$(notdir $(wildcard $(SRCDIR)/parsers/modules/*)))
parsers_SRCDIRS = base office_escher modules $(addprefix modules/,$(PARSERS_MODULES))
parsers_DEPLOYABLES_HSENGINE = \
	$(PARSERS_baselib) \
	$(PARSERS_escherlib) \
	$(addprefix lib/hsm_,$(addsuffix $(DLL_SUFFIX),$(PARSERS_MODULES)))

parsers_DEPLOYABLES_WHAP = $(parsers_DEPLOYABLES_HSENGINE)
parsers_DEPLOYABLES = $(parsers_DEPLOYABLES_WHAP)

# AP
AP_DEPLOYABLES_SERVERS = webserver whmanager
AP_DEPLOYABLES_UTILS = runscript whcompile
ap_DEPLOYABLES_WHAP = \
	$(AP_libwebhare) \
	lib/hsm_system_geoip$(DLL_SUFFIX) \
	$(addprefix bin/,$(addsuffix ,$(AP_DEPLOYABLES_SERVERS) $(AP_DEPLOYABLES_UTILS) ))

ap_DEPLOYABLES = $(ap_DEPLOYABLES_WHAP)
AP_libwebhare = lib/libblex_webhare$(DLL_SUFFIX)

PCH_HEADERS_NATIVE+=ap/libwebhare/allincludes.h

ap_SRCDIRS = addons addons/system_geoip libwebhare utils webserver whmanager

# WASM
wasm_SRCDIRS = .

wasm_DEPLOYABLES_WHAP = lib/harescript.js lib/harescript.wasm lib/harescript-interface.ts

# Global stuff
# forevery project, take project_SRCDIRS, create $(SRCDIR)/project/$(SUBDIR) entries
ALLSRCDIRS=$(SRCDIR)/blex $(foreach sub,$(SUBPROJECTS),$(addprefix $(SRCDIR)/$(sub)/,$($(sub)_SRCDIRS)))
ALLOBJDIRS=$(addprefix ,$(subst $(SRCDIR)/,,$(ALLSRCDIRS)))
ALLCPPSRCS_IN=$(foreach sub,$(ALLSRCDIRS),$(wildcard $(sub)/*.cpp))

# We need to blacklist some files from the Deps generation as the above code is a bit too gready when matching wildcards and some files crash the Dep process
DEPS_BLACKLIST=harescript/vm/wasm-harescript harescript/vm/libpq_wasm_emul
DEPS_FULLPATHS=$(addsuffix .cpp,$(addprefix $(SRCDIR)/,$(DEPS_BLACKLIST)))
ALLCPPSRCS_IN:=$(filter-out $(DEPS_FULLPATHS),$(ALLCPPSRCS_IN))

ALLOBJS:=$(addprefix ,$(subst .cpp,.native-obj,$(subst $(SRCDIR)/,,$(ALLCPPSRCS_IN))))
HSENGINE_DEPLOYABLES = $(foreach sub,$(HSENGINE_SUBPROJECTS),$($(sub)_DEPLOYABLES_HSENGINE))
WHAP_DEPLOYABLES = $(foreach sub,$(WHAP_SUBPROJECTS),$($(sub)_DEPLOYABLES_WHAP)) $(wasm_DEPLOYABLES_WHAP)

ALL_DEPLOYABLES = $(sort $(HSENGINE_DEPLOYABLES) $(WHAP_DEPLOYABLES))
ALL_DEPLOYABLES_SETUP = $(foreach sub,$(SUBPROJECTS),$($(sub)_DEPLOYABLES_SETUP))

#################################################
##
## File listing post processing
##

# Build up the output lists



#################################################
##
## Precompiled header processing
##

ifneq ($(DISABLE_PCH),1)
ALLPCHDIRS+=$(addprefix gch-wasm/,$(foreach hdr,$(PCH_HEADERS_SHARED) $(PCH_HEADERS_WASM),$(dir $(hdr))))
ALLPCHDIRS+=$(addprefix gch-native/,$(foreach hdr,$(PCH_HEADERS_SHARED) $(PCH_HEADERS_NATIVE),$(dir $(hdr))))
ALLPCHS_NATIVE=$(addsuffix .gch,$(addprefix gch-native/,$(PCH_HEADERS_SHARED) $(PCH_HEADERS_NATIVE)))
ALLPCHS_WASM=$(addsuffix .gch,$(addprefix gch-wasm/,$(PCH_HEADERS_SHARED) $(PCH_HEADERS_WASM)))

ALLPCHS_NATIVE_DEPFILES=$(subst .gch,.native-d,$(ALLPCHS_NATIVE))
ALLPCHS_WASM_DEPFILES=$(subst .gch,.wasm-d,$(ALLPCHS_WASM))

endif


#################################################
##
## Build it all. This *MUST* be the first target in the makefile to make it the default for 'wh make'
##
# GLOBAL
all: $(ALLBUILDANDTEST) $(addsuffix -all,$(SUBPROJECTS)) wasm
.PHONY: wasm wasm-test list-targets list-raw-targets

#################################################
##
## Other dependencies
##
$(PREFIX)/jssdk/whdb/vendor/postgrejs/package.json:
	git -C $(SRCDIR) submodule update --init --recursive  #update triggered for $@


#################################################
##
## Setup libxml2 dependencies
##
LIBXML2_GENERATEDFILE=config.h
LIBXML2_NATIVE_GENERATEDFILE=$(addprefix vendor-native/libxml2/,$(LIBXML2_GENERATEDFILE))
LIBXML2_WASM_GENERATEDFILE=$(addprefix vendor-wasm/libxml2/,$(LIBXML2_GENERATEDFILE))

# cannot build blex tests or hsvm without libxml
$(LIBBLEX_NATIVE_TESTOBJS) $(LIBBLEX_NATIVE_SOURCEOBJS) $(LIBBLEX_LIBXML2_NATIVE_OBJS) $(LIBHSVM_NATIVE_SOURCEOBJS): $(LIBXML2_NATIVE_GENERATEDFILE)
$(LIBBLEX_WASM_SOURCEOBJS) $(LIBBLEX_WASM_SOURCEOBJS)   $(LIBBLEX_LIBXML2_WASM_OBJS)   $(LIBHSVM_WASM_SOURCEOBJS):   $(LIBXML2_WASM_GENERATEDFILE)

# Checkout submodule if still needed
$(SRCDIR)/vendor/libxml2/autogen.sh:
	git -C $(SRCDIR) submodule update --init --recursive #update triggered for $@

$(LIBXML2_NATIVE_GENERATEDFILE): $(SRCDIR)/vendor/setup-libxml2.sh $(SRCDIR)/vendor/libxml2/autogen.sh
	$(SRCDIR)/vendor/setup-libxml2.sh native "${WHBUILD_BUILDDIR}/vendor-native/libxml2"

$(LIBXML2_WASM_GENERATEDFILE): $(SRCDIR)/vendor/setup-libxml2.sh $(SRCDIR)/vendor/libxml2/autogen.sh
	CC="$(EMCC)" $(SRCDIR)/vendor/setup-libxml2.sh wasm "${WHBUILD_BUILDDIR}/vendor-wasm/libxml2"

#################################################
##
## Build instructions
##


clean-libxml2:
	rm -f -- $(LIBBLEX_LIBXML2_OBJS)

clean-libs:
	rm -f -- $(ALL_DEPLOYABLES) $(BUILDDIRPREFIX)blex/tests/dynamic$(DLL_SUFFIX)

clean-install:
	@rm -f $(addprefix $(PREFIX)/,$(ALL_INSTALLABLES_CLEAN))

clean: # Delete all build files
	rm -rf -- $(WEBHARE_BUILDDIR)/*

clean-pch: # Delete precompiled header files
	rm -f -- $(ALLPCHS_NATIVE) $(ALLPCHS_WASM)

%.wasm-obj: %.cpp $(EMSCRIPTEN_VERSION_FILE) | $(ALLPCHS_WASM)
	$(call CompileCPPWasm,$<,$@)

%.wasm-obj: %.c $(EMSCRIPTEN_VERSION_FILE) | $(ALLPCHS_WASM)
	$(call CompileCWasm,$<,$@)

%.native-obj: %.cpp | $(ALLPCHS_NATIVE)
	$(call CompileCPPNative,$<,$@)

%.native-obj: %.c | $(ALLPCHS_NATIVE)
	$(call CompileCNative,$<,$@)

$(ALLPCHS_NATIVE): gch-native/%.gch : % | dirs
	$(call GeneratePCHNative,,$<,$@,)

$(ALLPCHS_WASM): gch-wasm/%.gch : % $(EMSCRIPTEN_VERSION_FILE) | dirs
	$(call GeneratePCHWasm,,$<,$@,)

######
#
# BLEX
#

## build the various lists
blex-all: lib/libblex_base$(DLL_SUFFIX)

blex-clean:
	rm -rf -- blex $(blex_DEPLOYABLES) blex/tests/dynamiclib.native-obj

lib/libblex_base$(DLL_SUFFIX): $(LIBBLEX_NATIVE_SOURCEOBJS)
	$(call LinkShared,$^,$@,$(BLEX_BASE_LIBS))

blex/tests/dynamic$(DLL_SUFFIX): blex/tests/dynamiclib.native-obj
	$(call LinkModule,$^,$@,)

bin/blex-test-native: $(LIBBLEX_NATIVE_TESTOBJS) lib/libblex_base${DLL_SUFFIX}
	$(call LinkExecutable,$(LIBBLEX_NATIVE_TESTOBJS),$@,$(BLEX_LIBS))

success.blex: bin/blex-test-native blex/tests/dynamic$(DLL_SUFFIX)
	ulimit -n 1024 && bin/blex-test-native test bin/blex-test-native blex/tests/dynamic$(DLL_SUFFIX) $(SRCDIR)/blex/tests/data 1 ; test "$$?" = 241
	> success.blex

bin/blex-test-wasm: $(LIBBLEX_WASM_SOURCEOBJS) $(LIBBLEX_WASM_TESTOBJS) | $(SRCDIR)/harescript/vm/wasm-pre.js $(SRCDIR)/harescript/vm/fix-emcc-output.js
	$(call LinkWASMExecutable,$^,bin/blex-test-wasm,$(WHBUILD_BUILDDIR)/bin/)

# no dynamic libs, so no build necessary
build.wasm-blex:
	> build.wasm-blex

success.wasm-blex: build.wasm-blex bin/blex-test-wasm
	ulimit -n 1024 && $(WEBHARE_NODE_BINARY) --experimental-wasm-stack-switching --openssl-legacy-provider bin/blex-test-wasm test bin/blex-test-wasm blex/tests/dynamic$(DLL_SUFFIX) $(SRCDIR)/blex/tests/data 1 ; test "$$?" = 242
	> success.wasm-blex

wasm-test: success.wasm-blex

# Link a shared library


ALL_TESTFILES+=bin/$(RUNTEST)
#
# HARESCRIPT
#
harescript-all: success.harescript

harescript-clean:
	rm -rf -- harescript $(harescript_DEPLOYABLES)

build.harescript: $(harescript_DEPLOYABLES)
	>build.harescript

success.harescript: build.drawlib build.harescript build.parsers
	> success.harescript

build.harescriptvm: build.blex lib/libblex_hsvm$(DLL_SUFFIX) lib/libblex_hscompiler$(DLL_SUFFIX) $(HS_DEPLOYABLES_PREP)
	>build.harescriptvm

success.harescriptvm harescript-testvm: bin/vmtest build.harescriptvm
	$(TESTRUNNER) bin/vmtest --srcdir $(SRCDIR) --moduledir lib $(HARESCRIPTVMTESTOPTS)
	> success.harescriptvm

ALL_TESTFILES+=bin/vmtest

lib/libblex_hsvm$(DLL_SUFFIX): success.blex $(LIBHSVM_NATIVE_SOURCEOBJS)
	$(call LinkShared,$(LIBHSVM_NATIVE_SOURCEOBJS),$@,blex_base $(BLEX_HSVM_LIBS))

lib/libblex_hscompiler$(DLL_SUFFIX): $(LIBHSCOMPILER_OBJS) lib/libblex_hsvm$(DLL_SUFFIX)
	$(call LinkShared,$(LIBHSCOMPILER_OBJS),$@,blex_hsvm $(BLEX_LIBS))

bin/vmtest: $(HARESCRIPTVMTEST_OBJS) lib/libblex_hsvm$(DLL_SUFFIX) lib/libblex_hscompiler$(DLL_SUFFIX)
	$(call LinkExecutable,$(HARESCRIPTVMTEST_OBJS),$@,blex_hscompiler blex_hsvm $(BLEX_LIBS))

bin/libdumper: harescript/utils/LibDumper.native-obj lib/libblex_hscompiler$(DLL_SUFFIX) lib/libblex_hsvm$(DLL_SUFFIX)
	$(call LinkExecutable,$<,$@,blex_hsvm $(BLEX_LIBS))

# Create module compilation target.
# $1=module name, $2=library prefix (wh_ or nothing), $3=subfolder (parsers or harescript)
define HsModTarget

$3_$2$1_CPPFILES = $(call GetSrcFiles,$3/modules/$1/*.cpp)
$3_CPPFILES += $$($3_$2$1_CPPFILES)

$3_$2$1_OBJFILES = $$(call Src2ObjFiles, $$($3_$2$1_CPPFILES))

lib/hsm_$2$1$(DLL_SUFFIX): $$($3_$2$1_OBJFILES) $$($3_HsMod_AddDeps) $$($3_HsMod_$1_AddDeps)
	$$(call LinkModule,$$($3_$2$1_OBJFILES),$$@,$$($3_HsMod_AddLibs) $$($3_HsMod_$1_AddLibs) $(HS_LIBS))

endef

harescript_HsMod_AddDeps = lib/libblex_hsvm$(DLL_SUFFIX) lib/libblex_hscompiler$(DLL_SUFFIX)
harescript_HsMod_AddLibs = $(HS_LIBS)

$(foreach mod,$(HS_HS_MODULES),$(eval $(call HsModTarget,$(mod),wh_,harescript)))

clean-icu-provider:
	rm harescript/vm/icu_provider.native-obj

#
# DRAWLIB
#
drawlib-all: success.drawlib

drawlib-clean:
	rm -rf -- drawlib $(drawlib_DEPLOYABLES)

build.drawlib: $(drawlib_DEPLOYABLES)
	>build.drawlib

success.drawlib drawlib-test: bin/$(RUNDRAWLIBTEST)
	$(TESTRUNNER) bin/$(RUNDRAWLIBTEST) $(SRCDIR)/drawlib/drawlibv2_test/data $(SRCDIR)/whtree/fonts
ifeq ($(DRAWLIBTEST),)
	> success.drawlib
endif

lib/libblex_draw$(DLL_SUFFIX): success.blex $(DRAWLIB_OBJS)
	$(call LinkShared,$(DRAWLIB_OBJS),$@,$(DRAWLIB_STATIC_LIBS) $(DRAWLIB_BASE_LIBS)  $(BLEX_LIBS) )

bin/$(RUNDRAWLIBTEST): $(DRAWLIBTEST_OBJS) lib/libblex_draw$(DLL_SUFFIX)
	$(call LinkExecutable,$(DRAWLIBTEST_OBJS),$@,$(DRAWLIB_LIBS) $(DRAWLIB_BASE_LIBS) $(BLEX_LIBS))

ALL_TESTFILES+=bin/$(RUNDRAWLIBTEST)

lib/hsm_whmod_graphics$(DLL_SUFFIX): $(DRAWLIBHSINTERFACE_OBJS) lib/libblex_draw$(DLL_SUFFIX) build.harescript
	$(call LinkModule,$(DRAWLIBHSINTERFACE_OBJS),$@,$(DRAWLIB_LIBS) $(HS_LIBS) $(BLEX_LIBS)  )

coffee:
	$(error Coffee not yet implemented)
#
# PARSERS
#
parsers-all: success.parsers

parsers-clean:
	rm -rf -- parsers $(parsers_DEPLOYABLES)

build.parsers: $(parsers_DEPLOYABLES)
	>build.parsers

success.parsers: build.parsers
	> success.parsers

parsers_HsMod_parser_office_msword_AddDeps = $(PARSERS_escherlib)
parsers_HsMod_parser_office_msword_AddLibs = blex_parser_office_escher

parsers_baselib_CPPFILES = $(call GetSrcFiles,parsers/base/*.cpp)
parsers_baselib_OBJFILES = $(call Src2ObjFiles, $(parsers_baselib_CPPFILES))

parsers_office_escher_CPPFILES = $(call GetSrcFiles,parsers/office_escher/*.cpp)
parsers_office_escher_OBJFILES = $(call Src2ObjFiles, $(parsers_office_escher_CPPFILES))

$(PARSERS_baselib): $(parsers_baselib_OBJFILES) success.drawlib build.harescript
	$(call LinkShared,$(parsers_baselib_OBJFILES),$@,$(DRAWLIB_LIBS) $(HS_LIBS))

$(PARSERS_escherlib): $(parsers_office_escher_OBJFILES) $(PARSERS_baselib)
	$(call LinkShared,$(parsers_office_escher_OBJFILES),$@,blex_parser_base $(DRAWLIB_LIBS) $(HS_LIBS))

parsers_CPPFILES = $(parsers_baselib_OBJFILES) $(parsers_office_escher_OBJFILES)

parsers_HsMod_AddDeps = $(PARSERS_baselib)
parsers_HsMod_AddLibs = blex_parser_base $(DRAWLIB_LIBS) $(HS_LIBS)
$(foreach mod,$(PARSERS_MODULES),$(eval $(call HsModTarget,$(mod),,parsers)))

#
# AP
#
ap-all: parsers-all success.ap

ap-clean:
	rm -rf -- ap $(ap_DEPLOYABLES)

build.ap: $(ap_DEPLOYABLES) $(ap_NONDEPLOYABLES)
	>build.ap

success.ap ap-test: build.ap
	> success.ap

ap_libwebhare_CPPFILES = $(call GetSrcFiles,ap/libwebhare/*.cpp)
ap_libwebhare_OBJFILES = $(call Src2ObjFiles, $(ap_libwebhare_CPPFILES))

HSM_SYSTEM_GEOIP_OBJS = $(HSM_SYSTEM_GEOIP_CPP_OBJS)
HSM_SYSTEM_GEOIP_CPP_OBJS = ap/addons/system_geoip/geoipdriver.native-obj

$(AP_libwebhare): $(ap_libwebhare_OBJFILES) success.harescript
	$(call LinkShared,$(ap_libwebhare_OBJFILES),$@,$(HS_LIBS) $(BLEX_LIBS))

lib/hsm_system_geoip$(DLL_SUFFIX): $(HSM_SYSTEM_GEOIP_OBJS) $(AP_libwebhare)
	$(call LinkModule,$(HSM_SYSTEM_GEOIP_OBJS),$@,maxminddb $(HS_LIBS) $(BLEX_LIBS))

define ApServerTarget
bin/$(1): $(call GetObjFiles,ap/$1/*.cpp) $(AP_libwebhare)
	$$(call LinkExecutable,$(call GetObjFiles,ap/$1/*.cpp),$$@,blex_webhare $(HS_LIBS))
endef

define ApUtilTarget
bin/$(1): ap/utils/$1.native-obj $($(1)_EXTRALINKFILES) $(AP_libwebhare)
	$$(call LinkExecutable,$$< $($(1)_EXTRALINKFILES),$$@,blex_webhare $(HS_LIBS))
endef

$(foreach mod,$(AP_DEPLOYABLES_SERVERS),$(eval $(call ApServerTarget,$(mod))))
$(foreach mod,$(AP_DEPLOYABLES_UTILS),$(eval $(call ApUtilTarget,$(mod))))

########################
#
# WASM
#

# Note that wasm targets are easier as we don't bother with dynamic linking.
# Make 4.4 allows to define grouped targets (lib/harescript.js lib/harescript.wasm &: ...) but ubuntu 20.4 is still on 4.3
# We use build.harescript-wasm as a barrier to ensure these targets waiting for the build
lib/harescript.js lib/harescript.wasm &: $(LIBHSVM_WASM_SOURCEOBJS) success.wasm-blex $(SRCDIR)/harescript/vm/wasm-suspending-functions.txt $(SRCDIR)/harescript/vm/wasm-pre.js $(SRCDIR)/harescript/vm/fix-emcc-output.js
	$(call LinkWASMImportable,$(LIBHSVM_WASM_SOURCEOBJS),lib/harescript.js,$(PREFIX)/lib/)
	> build.harescript-wasm

lib/harescript-interface.ts: harescript/vm/hsvm_dllinterface.wasm-obj harescript/vm/wasm-harescript.wasm-obj $(SRCDIR)/harescript/vm/generate-wasm-interface.js $(SRCDIR)/harescript/vm/wasm-suspending-functions.txt
	$(HIDE)echo "- Generating lib/harescript-interface.ts"
	$(HIDE)$(EMCC) -E -C -x c++-header -D__EMSCRIPTEN__=1 $(SRCDIR)/harescript/vm/hsvm_dllinterface.h > harescript/vm/hsvm_dllinterface.processed.h
	$(HIDE)$(EMCC) -E -C -x c++-header -D__EMSCRIPTEN__=1 $(SRCDIR)/harescript/vm/wasm-harescript.h > harescript/vm/wasm-harescript.processed.h
	$(HIDE)node $(SRCDIR)/harescript/vm/generate-wasm-interface.js harescript/vm/hsvm_dllinterface.processed.h harescript/vm/wasm-harescript.processed.h > lib/harescript-interface.ts

build.wasm: $(wasm_DEPLOYABLES_WHAP)
	> build.wasm

success.wasm: build.wasm
	# TODO test?
	> success.wasm

wasm-clean: # Clean all wasm deployables to force a rebuild after eg. switching emcc versions or options
	rm -f $(wasm_DEPLOYABLES_WHAP) $(WASM_ALL_OBJS)

wasm: lib/harescript.js lib/harescript.wasm success.wasm

#################################################
##
## Installation
##

uninstall:
	-rm -f -- $(addprefix $(PREFIX)/,$(ALL_DEPLOYABLES))

# Lists all test targets. This causes the 'install' phase to be blocked by any subproject (or wasm, which is a testtarget but not one of the SUBPROJECTS)
ALLBUILDANDTEST=$(foreach file,$(SUBPROJECTS),success.${file}) success.wasm

define InstallOurDeployable
$(PREFIX)/$(1): $(1) | $(ALLBUILDANDTEST)
	$(HIDE)echo "- Installing $$< -> $$@" && rm -f $$@; cp -af $$< $$(dir $$@)  #cp 2
endef

$(foreach dep,$(ALL_DEPLOYABLES), $(eval $(call InstallOurDeployable,$(dep))))

#################################################
##
## Misc stuff
##

# Call installables, with .debug files in 'symbols' dir, and .debug links
HSENGINE_INSTALLABLES_DEBUG = $(FINAL_EXTERNAL_LIBS) $(HSENGINE_DEPLOYABLES)
WHAP_INSTALLABLES_DEBUG = $(WHAP_DEPLOYABLES)

HSENGINE_INSTALLABLES = $(HSENGINE_DEPLOYABLES) $(FINAL_EXTERNAL_LIBS)
WHAP_INSTALLABLES = $(WHAP_DEPLOYABLES)

# For cleaning, also include the .debug stuff
ALL_INSTALLABLES_CLEAN = $(HSENGINE_INSTALLABLES_DEBUG) $(WHAP_INSTALLABLES_DEBUG)

# Rule to generate dependencies for object files
# TODO don't use the wildcards but create exactly the gchs we want
$(NATIVE_ALL_OBJS_DEPFILES): %.native-d: %.cpp $(LIBXML2_NATIVE_GENERATEDFILE) | dirs
	$(call GenerateDepsNative,$<,$@,)

$(WASM_ALL_OBJS_DEPFILES): %.wasm-d: %.cpp $(LIBXML2_WASM_GENERATEDFILE) | dirs
	$(call GenerateDepsWasm,$<,$@,)

$(ALLPCHS_NATIVE_DEPFILES): gch-native/%.native-d : % $(LIBXML2_NATIVE_GENERATEDFILE) | dirs
	$(call GeneratePCHDepsNative,$<,$@,)

$(ALLPCHS_WASM_DEPFILES): gch-wasm/%.wasm-d : % $(LIBXML2_WASM_GENERATEDFILE) | dirs
	$(call GeneratePCHDepsWasm,$<,$@,)

sandwich:
	@if [ "`id -u`" != "0" ]; then echo "What? Make it yourself."; else echo "Nice try. It's open source, make it yourself."; fi

#################################################
##
## File listings
##

# install also cleans up old targets. we didn't really use to care, but it can put people on the wrong track ("appserver is crashing! no, it was removed")
# we invoke 'wasm' (a PHONY) explicitly to ensure it's always rechecked as the toplevel make cannot check the wasm's sub-make dependencies
install: $(ALLINSTALLDIRS) postinstall | \
         success.blex \
         success.harescript \
         success.drawlib \
         $(addprefix $(PREFIX)/,$(WHAP_INSTALLABLES)) \
         success.ap \
         success.wasm
	${HIDE}rm $(PREFIX)/bin/{appserver,backup,consilio,dbserver,dumpcomplexfslog,dumprawtable} 2>/dev/null || true #cleanup old bins
	${HIDE}rm $(PREFIX)/lib/{hsm_parser_office_excel,hsm_parser_office_powerpoint}.* 2>/dev/null || true #cleanup old bins

ifeq ($(WEBHARE_IN_DOCKER),1)

postuninstall:

postinstall:

else #so, not WEBHARE_IN_DOCKER

# FIXME nativedeps mode should just not bother with a local node install and use the system's main node

postuninstall:
	# Cleanup node modules (except linked modules)
	find $(PREFIX)/node_modules -mindepth 1 -maxdepth 1 -type d -print0 | xargs -0 rm -rf
	rm -f success.node

postinstall: success.node $(PREFIX)/jssdk/tsrun/dist/resolveplugin.js

# Prevent deleting these files when finalize-webhare is interrupted
.PRECIOUS: $(PREFIX)/jssdk/tsrun/dist/resolveplugin.js $(PREFIX)/modules/platform/generated/buildinfo

success.node $(PREFIX)/jssdk/tsrun/dist/resolveplugin.js $(PREFIX)/modules/platform/generated/buildinfo &: \
			$(PREFIX)/tsconfig.yml \
			$(PREFIX)/package.json \
			$(PREFIX)/package-lock.json \
			$(wildcard $(SRCDIR)/whtree/jssdk/*/package.json) \
			$(PREFIX)/jssdk/whdb/vendor/postgrejs/package.json \
			$(PREFIX)/modules/devkit/package.json \
			$(PREFIX)/modules/platform/scripts/bootstrap/finalize-webhare.sh \
			$(PREFIX)/etc/platform.conf \
			$(addprefix $(PREFIX)/,$(WHAP_INSTALLABLES))
	$(PREFIX)/bin/wh finalize-webhare
	touch $@

endif #WEBHARE_IN_DOCKER


#####################################################################
#
# Dependencies
#

ifneq ($(WHBUILD_NODEPS),1) # Dependencies not needed in docker builds (no recompilation needed there)
  DEPENDENCY_INCLUDES=$(ALLPCHS_NATIVE_DEPFILES) $(ALLPCHS_WASM_DEPFILES) $(NATIVE_ALL_OBJS_DEPFILES) $(WASM_ALL_OBJS_DEPFILES)
  -include $(DEPENDENCY_INCLUDES)
endif

# Directories dependency - but if a symlink exists(docker build) don't create it
$(sort $(ALLDIRS)):
	${HIDE}[ -h $@ ] || mkdir -p $@

# Make all directories in one
dirs: $(ALLDIRS)
deps: dirs $(DEPENDENCY_INCLUDES)

clean-deps:
	rm -f -- $(DEPENDENCY_INCLUDES)


####################################################################
#
# Homebrew explicit dependencies
#

ifeq ($(WEBHARE_PLATFORM),darwin)

# Brew extracts files with dates in the past, except for the INSTALL_RECEIPT.json. So explicitly depend on that to trigger the neded rebuilds
# Unfortunately this does generate some harmless linker warnings 'ld: warning: ignoring file .../INSTALL_RECEIPT.json, ... unknown-unsupported file format'

# Recompile all if ICU is updated, it hooks too deeply now (even hsm_whmod_graphics is looking for it these days)
$(ALLOBJS): $(BREWPREFIX)/opt/icu4c/INSTALL_RECEIPT.json
$(blex_DEPLOYABLES_HSENGINE) harescript/vm/bl_crypto.native-obj: | $(BREWPREFIX)/opt/openssl/INSTALL_RECEIPT.json

endif # end darwin check

###
# Aliases for easy building
#

#ADDME autogenerate lists below
BIN_ALIASES = webserver webhare runscript $(RUNTEST) whmanager vmtest whcompile
MOD_ALIASES = libblex_draw libblex_hscompiler libblex_hsvm libblex_parser_office_escher libblex_webhare hsm_parser hsm_parser_office_msword hsm_parser_adobe_pdf hsm_parser_format_hsxml hsm_parser_format_html
WASM_ALIASES = harescript

list-targets:    # List all available targets
	@printf "%-21s %s\n" "Target" "Description"
	@cat $(SRCDIR)/builder/base_makefile | grep -E '^[-a-z0-9]+: .*#.*$$'|sed -e 's/: .*#/:/'|awk '{x=$$1;$$1="";printf "%-20s %s\n", x, $$0}' | sort
	@echo ""
	@echo "Additional we support the following commands that directly build a target:"
	@echo "Executables: $(sort $(BIN_ALIASES))"
	@echo "Libraries:   $(sort $(MOD_ALIASES))"


#Convenience overwrite targets
wordconv-overwrite: libblex_parser_office_escher-overwrite hsm_parser_office_msword-overwrite libblex_draw-overwrite  # Overwrite the word conversion related modules in the install dir
wordconv-uninstall: libblex_parser_office_escher-uninstall hsm_parser_office_msword-uninstall # Remove the word conversion related modules

wasm-overwrite: $(addprefix $(PREFIX)/,$(wasm_DEPLOYABLES_WHAP))  #Overwrite WASM files in the install dir

# Helper to add 'wh make list-targets' - https://stackoverflow.com/a/26339924 - a future make version should allow 'wh make --print-targets'
list-raw-targets: # List all targets including undocumented ones
	@LC_ALL=C $(MAKE) -pRrq -f $(firstword $(MAKEFILE_LIST)) : 2>/dev/null | awk -v RS= -F: '/(^|\n)# Files(\n|$$)/,/(^|\n)# Finished Make data base/ {if ($$1 !~ "^[#.]") {print $$1}}' | sort | grep -E -v -e '^[^[:alnum:]]' -e '^$@$$'

define GenerateBinAlias
$1: bin/$1
$1-install: $(PREFIX)/bin/$1
$1-uninstall:
	rm $(PREFIX)/bin/$1

$1-overwrite: bin/$1
	cp -f $$< $(PREFIX)/bin/$1 #cp 8
endef

define GenerateModAlias
$1: lib/$1$(DLL_SUFFIX)
$1-install: $(PREFIX)/lib/$1$(DLL_SUFFIX)
$1-uninstall:
	rm $(PREFIX)/lib/$1$(DLL_SUFFIX)

$1-overwrite: lib/$1$(DLL_SUFFIX)
	cp $$< $(PREFIX)/lib/$1$(DLL_SUFFIX) #cp 9
endef

define GenerateWasmAlias
$1-install: $(PREFIX)/lib/$1.js $(PREFIX)/lib/$1.wasm
$1-uninstall:
	rm $(PREFIX)/lib/$1.js $(PREFIX)/lib/$1.wasm

$1-overwrite: lib/$1.js lib/$1-interface.ts
	cp lib/$1.js lib/$1.wasm lib/$1-interface.ts $(PREFIX)/lib/ #cp 10
ifeq ($(WHBUILD_DEBUG),1)
	cp lib/$1.wasm.map $(PREFIX)/lib/ #cp 10b
endif
endef

$(foreach bin,$(BIN_ALIASES),$(eval $(call GenerateBinAlias,$(bin))))
$(foreach mod,$(MOD_ALIASES),$(eval $(call GenerateModAlias,$(mod))))
$(foreach mod,$(WASM_ALIASES),$(eval $(call GenerateWasmAlias,$(mod))))
